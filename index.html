<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLfyXPpdNHMP8Wr56cbgeXiL5CB3hRIGg",
            authDomain: "annual-leave-bidding.firebaseapp.com",
            projectId: "annual-leave-bidding",
            storageBucket: "annual-leave-bidding.firebasestorage.app",
            messagingSenderId: "921060646626",
            appId: "1:921060646626:web:10d03441b267f8094e08bb",
            measurementId: "G-51PP25CGME"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Firebase Service
        const FirebaseService = {
            async saveData(key, data) {
                try {
                    await db.collection('system').doc(key).set({ data: JSON.stringify(data), updatedAt: new Date() });
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    return false;
                }
            },
            async getData(key) {
                try {
                    const doc = await db.collection('system').doc(key).get();
                    return doc.exists ? JSON.parse(doc.data().data) : null;
                } catch (error) {
                    console.error('Get error:', error);
                    return null;
                }
            }
        };

        // Icons
        const Calendar = (p) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...p}><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Upload = (p) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const Users = (p) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const X = (p) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const AlertCircle = (p) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;

        const LeaveBiddingSystem = () => {
            const [employees, setEmployees] = useState([]);
            const [bids, setBids] = useState([]);
            const [results, setResults] = useState([]);
            const [config, setConfig] = useState({ slotCapacities: {}, biddingYear: 2026, plannerPassword: 'admin123' });
            const [passwords, setPasswords] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            const [activeView, setActiveView] = useState('login');
            const [currentUser, setCurrentUser] = useState(null);
            const [verifiedEmployee, setVerifiedEmployee] = useState(null);

            const slotTypes = [
                { id: 'slotA', name: 'Slot A', days: 15 },
                { id: 'slotB', name: 'Slot B', days: 15 },
                { id: 'slotC', name: 'Slot C', days: 20 }
            ];

            useEffect(() => { loadAllData(); }, []);

            const loadAllData = async () => {
                setIsLoading(true);
                const [emp, bid, res, cfg, pwd] = await Promise.all([
                    FirebaseService.getData('employees'),
                    FirebaseService.getData('bids'),
                    FirebaseService.getData('results'),
                    FirebaseService.getData('config'),
                    FirebaseService.getData('passwords')
                ]);
                if (emp) setEmployees(emp);
                if (bid) setBids(bid);
                if (res) setResults(res);
                if (cfg) setConfig(cfg);
                if (pwd) setPasswords(pwd);
                setIsLoading(false);
            };

            const saveAll = async () => {
                await Promise.all([
                    FirebaseService.saveData('employees', employees),
                    FirebaseService.saveData('bids', bids),
                    FirebaseService.saveData('results', results),
                    FirebaseService.saveData('config', config),
                    FirebaseService.saveData('passwords', passwords)
                ]);
            };

            useEffect(() => { if (!isLoading && employees.length > 0) saveAll(); }, [employees, bids, results, config, passwords]);

            const getEmployeeEntitlement = (emp) => {
                const years = (new Date() - new Date(emp.seniorityDate)) / (1000 * 60 * 60 * 24 * 365.25);
                return years >= 5 ? 35 : 30;
            };

            const calculateDaysBetween = (start, end) => {
                return Math.ceil(Math.abs(new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
            };

            const LoginView = () => {
                const [type, setType] = useState('employee');
                const [id, setId] = useState('');
                const [pwd, setPwd] = useState('');

                const handleLogin = () => {
                    if (type === 'planner') {
                        if (pwd === config.plannerPassword) {
                            setCurrentUser({ type: 'planner', name: 'Admin' });
                            setActiveView('upload');
                        } else alert('Incorrect password');
                    } else {
                        const emp = employees.find(e => e.id === id);
                        if (!emp) return alert('Employee not found');
                        const correct = passwords[id] || id;
                        if (pwd === correct) {
                            setCurrentUser(emp);
                            setVerifiedEmployee(emp);
                            setActiveView('bidding');
                        } else alert('Incorrect password');
                    }
                };

                return (
                    <div className="max-w-md mx-auto mt-20">
                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <h1 className="text-3xl font-bold text-center mb-6 text-blue-600">Annual Leave Bidding System</h1>
                            <div className="flex gap-4 mb-6">
                                <button onClick={() => setType('employee')} className={`flex-1 px-4 py-3 rounded-lg font-semibold ${type === 'employee' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Employee</button>
                                <button onClick={() => setType('planner')} className={`flex-1 px-4 py-3 rounded-lg font-semibold ${type === 'planner' ? 'bg-purple-600 text-white' : 'bg-gray-200'}`}>Planner</button>
                            </div>
                            {type === 'employee' && employees.length === 0 && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                    <AlertCircle className="inline mr-2 text-yellow-600" />
                                    <span className="text-sm">Planner must upload employee data first</span>
                                </div>
                            )}
                            <div className="space-y-4">
                                <input type="text" value={id} onChange={e => setId(e.target.value)} placeholder={type === 'employee' ? 'Employee ID' : ''} className="w-full px-4 py-2 border-2 rounded-lg" disabled={type === 'planner' || employees.length === 0} />
                                <input type="password" value={pwd} onChange={e => setPwd(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} placeholder="Password" className="w-full px-4 py-2 border-2 rounded-lg" />
                            </div>
                            <button onClick={handleLogin} disabled={type === 'employee' && employees.length === 0} className="w-full mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold disabled:bg-gray-400">Login</button>
                        </div>
                    </div>
                );
            };

            const UploadView = () => {
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        const empData = jsonData.map(row => ({
                            id: String(row['Personnel number'] || '').trim(),
                            name: String((row['Forename'] || '') + ' ' + (row['Surname'] || '')).trim(),
                            seniorityDate: row['Start of staff membership'] || new Date(),
                            role: String(row['Role'] || '').trim(),
                            department: String(row['Scheduling row'] || '').split('.')[0].trim(),
                            gender: String(row['Gender'] || '').trim(),
                            nationality: String(row['Nationality'] || '').trim()
                        })).filter(e => e.id && e.name);
                        empData.sort((a, b) => new Date(a.seniorityDate) - new Date(b.seniorityDate));
                        setEmployees(empData);
                        alert(`Loaded ${empData.length} employees`);
                    };
                    reader.readAsArrayBuffer(file);
                };

                return (
                    <div className="max-w-2xl mx-auto text-center">
                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <Upload className="w-16 h-16 mx-auto mb-4 text-blue-600" />
                            <h2 className="text-2xl font-bold mb-4">Upload Employee Data</h2>
                            <input type="file" accept=".xlsx,.xls" onChange={handleFileUpload} className="mb-4" />
                            {employees.length > 0 && <div className="bg-green-50 p-4 rounded"><span className="text-green-800 font-semibold">✓ {employees.length} employees loaded</span></div>}
                        </div>
                    </div>
                );
            };

            const BiddingView = () => {
                const [selectedSlot, setSelectedSlot] = useState('slotA');
                const [selectedMonth, setSelectedMonth] = useState('January');
                const [startDate, setStartDate] = useState('');
                const [endDate, setEndDate] = useState('');
                
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const userBids = bids.filter(b => b.employeeId === verifiedEmployee.id);
                const slot = slotTypes.find(s => s.id === selectedSlot);
                const days = startDate && endDate ? calculateDaysBetween(startDate, endDate) : 0;

                const handleSubmit = () => {
                    if (userBids.length >= 2) return alert('Maximum 2 bids allowed');
                    if (days !== slot.days) return alert(`${slot.name} requires ${slot.days} days`);
                    setBids([...bids, { employeeId: verifiedEmployee.id, employeeName: verifiedEmployee.name, department: verifiedEmployee.department, slotType: selectedSlot, month: selectedMonth, startDate, endDate, days, timestamp: new Date() }]);
                    alert('Bid placed successfully!');
                    setStartDate('');
                    setEndDate('');
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-2xl font-bold mb-4">Leave Bidding for {config.biddingYear}</h2>
                            <p className="text-blue-700">You have placed {userBids.length}/2 bids</p>
                        </div>
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h3 className="text-xl font-bold mb-4">Place New Bid</h3>
                            <div className="space-y-4">
                                <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="w-full px-4 py-2 border-2 rounded-lg">
                                    {months.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <div className="space-y-2">
                                    {slotTypes.map(s => (
                                        <button key={s.id} onClick={() => setSelectedSlot(s.id)} className={`w-full p-3 rounded-lg ${selectedSlot === s.id ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>{s.name} - {s.days} days</button>
                                    ))}
                                </div>
                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full px-4 py-2 border-2 rounded-lg" />
                                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full px-4 py-2 border-2 rounded-lg" />
                                {days > 0 && <p className={`text-sm ${days === slot.days ? 'text-green-600' : 'text-red-600'}`}>Selected: {days} days {days === slot.days ? '✓' : ''}</p>}
                                <button onClick={handleSubmit} disabled={!startDate || !endDate || days !== slot.days} className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold disabled:bg-gray-400">Submit Bid</button>
                            </div>
                        </div>
                    </div>
                );
            };

            if (isLoading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div></div>;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="mb-6">
                        <h1 className="text-4xl font-bold text-center text-gray-800 mb-2">Annual Leave Bidding System</h1>
                        {currentUser && (
                            <div className="flex justify-center items-center gap-4">
                                <div className="bg-white px-4 py-2 rounded-lg shadow">
                                    <span className="text-sm text-gray-600">Logged in as: </span>
                                    <span className="font-semibold">{currentUser.name || 'Admin'}</span>
                                </div>
                                <button onClick={() => { setCurrentUser(null); setActiveView('login'); }} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Logout</button>
                            </div>
                        )}
                    </div>
                    {!currentUser ? <LoginView /> : currentUser.type === 'planner' ? <UploadView /> : <BiddingView />}
                </div>
            );
        };

        ReactDOM.render(<LeaveBiddingSystem />, document.getElementById('root'));
    </script>
</body>
</html>
