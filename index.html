<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                Annual Leave Bidding System
            </h1>
            <div id="userInfo" class="hidden flex justify-center items-center gap-4 mt-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span class="text-sm text-gray-600">Logged in as: </span>
                    <span id="currentUserName" class="font-semibold"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button
                    onclick="app.handleLogout()"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                >
                    Logout
                </button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="max-w-md mx-auto mt-10">
            <div class="bg-white rounded-xl shadow-xl p-8">
                <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
                    Annual Leave Bidding System
                </h1>
                
                <div class="mb-4 text-center">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                        <p class="text-sm font-semibold text-blue-800">System Status:</p>
                        <p id="systemStatus" class="text-xs text-blue-700">Initializing...</p>
                    </div>
                    
                    <button onclick="app.syncWithSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-semibold mb-4">
                        üîÑ Sync with Database
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-3">Login As:</label>
                    <div class="flex gap-4">
                        <button
                            onclick="app.setLoginType('employee')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white"
                        >
                            Employee
                        </button>
                        <button
                            onclick="app.setLoginType('planner')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300"
                        >
                            Planner
                        </button>
                        <button
                            onclick="app.setLoginType('goldencommand')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-yellow-400 text-yellow-900 hover:bg-yellow-500"
                        >
                            ‚≠ê Golden Command
                        </button>
                    </div>
                </div>

                <div id="loginForm">
                    <!-- Default employee login form -->
                    <div class="space-y-4">
                        <div id="noDataWarning" class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input
                                type="text"
                                id="loginId"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your ID"
                                disabled
                            />
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your password"
                                disabled
                            />
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button
                    onclick="app.handleLogin()"
                    class="w-full mt-6 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold"
                >
                    Login
                </button>
            </div>
        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üì§ Upload Data
            </button>
            <button onclick="app.setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                ‚öôÔ∏è Configure Slots
            </button>
            <button onclick="app.setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üõ†Ô∏è Admin Panel
            </button>
            <button onclick="app.publishToSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                üíæ Save to Database
            </button>
            <button onclick="app.setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîê Change Password
            </button>
            <button onclick="app.setActiveView('results')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìä View Results
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìÖ Place Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìã My Results
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Golden Command Navigation -->
        <div id="goldenCommandNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('goldenCommand')" class="px-4 py-2 rounded-lg font-semibold bg-yellow-400 text-yellow-900 hover:bg-yellow-500 border border-yellow-500">
                ‚≠ê Place GC Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìã My Results
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
    </div>

    <!-- Scripts - Load at the end -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://wniqprjtwiyeqryplfdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduaXFwcmp0d2l5ZXFyeXBsZmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODc3NTAsImV4cCI6MjA4NDE2Mzc1MH0.sbfoW8pNmDauQQxFV97DUvvbNg0S1ls8AqkufRHnh70';
        
        // ==================== APP OBJECT ====================
        const app = {
            supabase: null,
            
            // ==================== STATE ====================
            state: {
                employees: [],
                employeePasswords: {},
                bids: [],
                biddingDeadline: '',
                biddingYear: 2026,
                isProcessed: false,
                activeView: 'login',
                selectedEmployeeId: '',
                verifiedEmployee: null,
                currentUser: null,
                userType: null,
                plannerPassword: 'admin123',
                goldenCommandPassword: 'gc123',
                goldenCommandUsers: [
                    { id: 'GC001', name: 'Golden Command 1', password: 'GC001' },
                    { id: 'GC002', name: 'Golden Command 2', password: 'GC002' }
                ],
                results: [],
                selectedDepartment: 'all',
                slotCapacities: {},
                
                // Complete departments list (only L3, L46, L5 prefixes)
                departments: [
                    'L3-DEP-DC', 'L3-DEP-TC', 'L3-DEP-DM', 'L3-DEP- LTSS/TSS',
                    'L3-DEP-EFC', 'L3-DEP-GSM', 'L3-TA-T', 'L3-DS', 'L3-P&R',
                    'L3-LSS/SS', 'L3-DEP-SC', 'L3-SA', 'L3 SAMB',
                    'L46-DEP-TC', 'L46-DEP- LTSS/TSS', 'L46-TA-T', 'L46-DEP-DC',
                    'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC', 'L46 SAMB',
                    'L46-P&R', 'L46-AOCC',
                    'L5-LSS/SS', 'L5-DEP-DC', 'L5-DEP-DM', 'L5-DEP-GSM', 'L5-DEP-SC',
                    'L5-DEP- LTSS/TSS', 'L5-DEP-TC', 'L5-DEP-EFC', 'L5 SA', 'L5 SAMB',
                    'L5 - TA-T'
                ],
                
                slotTypes: [
                    { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                    { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                    { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
                ],
                
                months: [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ],
                loginType: 'employee'
            },

            // ==================== SUPABASE FUNCTIONS ====================
            async initSupabase() {
                try {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Supabase init failed:', error);
                    return false;
                }
            },

            async loadFromSupabase() {
                if (!this.supabase) {
                    console.log('Supabase not initialized');
                    return false;
                }

                try {
                    this.updateSystemStatus('Loading from Supabase...');
                    
                    // FIX FOR 1000 STAFF LIMIT: Use range queries with pagination
                    console.log('Loading employees with pagination to avoid 1000 limit...');
                    let allEmployees = [];
                    let from = 0;
                    const batchSize = 1000;
                    let hasMore = true;

                    // Load employees with pagination
                    while (hasMore) {
                        const { data: employeesBatch, error: empError } = await this.supabase
                            .from('employees')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        
                        if (empError) throw empError;
                        
                        if (employeesBatch && employeesBatch.length > 0) {
                            allEmployees = [...allEmployees, ...employeesBatch];
                            hasMore = employeesBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load bids (leave_requests)
                    let allBids = [];
                    from = 0;
                    hasMore = true;
                    
                    while (hasMore) {
                        const { data: bidsBatch, error: bidsError } = await this.supabase
                            .from('leave_requests')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        
                        if (bidsError) {
                            if (bidsError.code !== 'PGRST116') {
                                console.warn('No bids found or error:', bidsError);
                            }
                            hasMore = false;
                        } else if (bidsBatch && bidsBatch.length > 0) {
                            allBids = [...allBids, ...bidsBatch];
                            hasMore = bidsBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load system config
                    const { data: config, error: configError } = await this.supabase
                        .from('system_config')
                        .select('*')
                        .single();
                    
                    if (configError && configError.code !== 'PGRST116') {
                        console.warn('Config error:', configError);
                    }
                    
                    // Update state
                    if (allEmployees && allEmployees.length > 0) {
                        this.state.employees = allEmployees.map(emp => ({
                            id: emp.id,
                            name: emp.name,
                            seniorityDate: emp.seniority_date,
                            role: emp.role || '',
                            department: emp.department || 'Unassigned',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || ''
                        }));
                        
                        // Set default passwords
                        this.state.employees.forEach(emp => {
                            if (!this.state.employeePasswords[emp.id]) {
                                this.state.employeePasswords[emp.id] = emp.id;
                            }
                        });
                        
                        console.log(`‚úÖ Loaded ${this.state.employees.length} employees from Supabase (with pagination)`);
                    }
                    
                    // Load bids ‚Äî Supabase is source of truth
                    // Map Supabase rows to app bid format
                    const supabaseBids = (allBids || []).map(bid => ({
                        employeeId: bid.employee_id,
                        employeeName: bid.employee_name || this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                        seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                        department: bid.department || this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                        slotType: bid.slot_type || 'slotA',
                        startDate: bid.start_date,
                        endDate: bid.end_date,
                        days: bid.days_requested,
                        timestamp: bid.created_at
                    }));

                    // Also grab any locally-stored bids not yet in Supabase (safety net)
                    const localBids = JSON.parse(localStorage.getItem('bids') || '[]');
                    const supabaseKeys = new Set(supabaseBids.map(b => `${b.employeeId}|${b.slotType}|${b.startDate}`));
                    const localOnly = localBids.filter(b => !supabaseKeys.has(`${b.employeeId}|${b.slotType}|${b.startDate}`));

                    // Push any local-only bids up to Supabase now
                    if (localOnly.length > 0) {
                        console.log(`‚ÑπÔ∏è Found ${localOnly.length} local bid(s) not yet in Supabase ‚Äî pushing now...`);
                        localOnly.forEach(bid => this.saveBidToSupabase(bid));
                    }

                    this.state.bids = [...supabaseBids, ...localOnly];
                    console.log(`‚úÖ Loaded ${supabaseBids.length} bids from Supabase + ${localOnly.length} local-only bid(s)`);
                    
                    if (config) {
                        this.state.biddingDeadline = config.bidding_deadline || '';
                        this.state.biddingYear = config.bidding_year || 2026;
                        this.state.isProcessed = config.is_processed || false;
                        this.state.plannerPassword = config.planner_password || 'admin123';
                        this.state.slotCapacities = config.slot_capacities || {};
                        this.state.results = config.results || [];
                        console.log('‚úÖ Loaded system config from Supabase');
                    }

                    // Load Golden Command users from dedicated table
                    const { data: gcUsers, error: gcError } = await this.supabase
                        .from('golden_command_users')
                        .select('*')
                        .order('created_at', { ascending: true });

                    if (gcError) {
                        console.warn('‚ö†Ô∏è Could not load GC users:', gcError.message);
                    } else if (gcUsers && gcUsers.length > 0) {
                        this.state.goldenCommandUsers = gcUsers.map(u => ({
                            id: u.id,
                            name: u.name,
                            password: u.password
                        }));
                        console.log(`‚úÖ Loaded ${gcUsers.length} Golden Command users from dedicated table`);
                    } else {
                        // Table exists but is empty ‚Äî keep whatever is in localStorage
                        console.log('‚ÑπÔ∏è No GC users found in dedicated table');
                    }
                    
                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees loaded`);
                    this.renderLoginForm();
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Error loading from Supabase:', error);
                    this.updateSystemStatus('‚ö†Ô∏è Could not load from database');
                    return false;
                }
            },

            async publishToSupabase() {
                if (!this.supabase) {
                    alert('Supabase not connected');
                    return;
                }

                if (this.state.employees.length === 0) {
                    alert('‚ö†Ô∏è No employee data to save');
                    return;
                }

                if (!confirm(`Save all data to Supabase database?\n\n‚Ä¢ ${this.state.employees.length} employees\n‚Ä¢ ${this.state.bids.length} bids\n‚Ä¢ System configuration`)) return;

                // Helper: split array into chunks
                const chunk = (arr, size) => {
                    const chunks = [];
                    for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
                    return chunks;
                };

                try {
                    // ‚îÄ‚îÄ 1. Save employees in batches of 500 ‚îÄ‚îÄ
                    const empTotal = this.state.employees.length;
                    const empChunks = chunk(this.state.employees, 500);
                    this.updateSystemStatus(`Saving employees (0/${empTotal})...`);

                    for (let i = 0; i < empChunks.length; i++) {
                        const batch = empChunks[i].map(emp => ({
                            id: emp.id,
                            name: emp.name,
                            seniority_date: emp.seniorityDate,
                            role: emp.role || '',
                            department: emp.department || '',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || '',
                            updated_at: new Date().toISOString()
                        }));

                        const { error } = await this.supabase
                            .from('employees')
                            .upsert(batch, { onConflict: 'id' });

                        if (error) throw new Error(`Employee batch ${i + 1} failed: ${error.message}`);

                        const saved = Math.min((i + 1) * 500, empTotal);
                        this.updateSystemStatus(`Saving employees (${saved}/${empTotal})...`);
                    }

                    // ‚îÄ‚îÄ 2. Save system config ‚îÄ‚îÄ
                    this.updateSystemStatus('Saving system config...');
                    const { error: configError } = await this.supabase
                        .from('system_config')
                        .upsert({
                            id: 1,
                            bidding_deadline: this.state.biddingDeadline,
                            bidding_year: this.state.biddingYear,
                            is_processed: this.state.isProcessed,
                            planner_password: this.state.plannerPassword,
                            slot_capacities: this.state.slotCapacities,
                            results: this.state.results,
                            last_updated: new Date().toISOString()
                        }, { onConflict: 'id' });

                    if (configError) console.warn('Config save warning:', configError.message);

                    // ‚îÄ‚îÄ 3. Save bids in batches of 500 ‚îÄ‚îÄ
                    if (this.state.bids.length > 0) {
                        const bidTotal = this.state.bids.length;
                        const bidChunks = chunk(this.state.bids, 500);
                        this.updateSystemStatus(`Saving bids (0/${bidTotal})...`);

                        for (let i = 0; i < bidChunks.length; i++) {
                            const batch = bidChunks[i].map(bid => ({
                                employee_id: bid.employeeId,
                                employee_name: bid.employeeName || '',
                                department: bid.department || '',
                                start_date: bid.startDate,
                                end_date: bid.endDate,
                                days_requested: bid.days,
                                status: 'pending',
                                slot_type: bid.slotType,
                                created_at: bid.timestamp || new Date().toISOString()
                            }));

                            const { error } = await this.supabase
                                .from('leave_requests')
                                .upsert(batch, { onConflict: 'employee_id,slot_type,start_date' });

                            if (error) throw new Error(`Bid batch ${i + 1} failed: ${error.message}`);

                            const saved = Math.min((i + 1) * 500, bidTotal);
                            this.updateSystemStatus(`Saving bids (${saved}/${bidTotal})...`);
                        }
                    }

                    this.updateSystemStatus(`‚úÖ Saved: ${empTotal} employees, ${this.state.bids.length} bids`);
                    alert(`‚úÖ All data saved to Supabase!\n\n‚Ä¢ ${empTotal} employees\n‚Ä¢ ${this.state.bids.length} bids\n‚Ä¢ System configuration`);
                    setTimeout(() => this.updateSystemStatus('Ready'), 4000);

                } catch (error) {
                    console.error('‚ùå Error saving to Supabase:', error);
                    this.updateSystemStatus('‚ùå Save failed ‚Äî check console');
                    alert(`‚ùå Save failed:\n${error.message}\n\nCheck browser console (F12) for details.`);
                }
            },

            async syncWithSupabase() {
                this.updateSystemStatus('Syncing with Supabase...');
                
                // First try to load from Supabase
                const loaded = await this.loadFromSupabase();
                
                if (!loaded) {
                    // If Supabase fails, try localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('‚ö†Ô∏è No data found locally or in database');
                    }
                }
                
                this.renderLoginForm();
            },

            // ==================== UTILITY FUNCTIONS ====================
            saveState() {
                try {
                    localStorage.setItem('employees', JSON.stringify(this.state.employees));
                    localStorage.setItem('employeePasswords', JSON.stringify(this.state.employeePasswords));
                    localStorage.setItem('bids', JSON.stringify(this.state.bids));
                    localStorage.setItem('biddingDeadline', this.state.biddingDeadline);
                    localStorage.setItem('biddingYear', this.state.biddingYear.toString());
                    localStorage.setItem('isProcessed', JSON.stringify(this.state.isProcessed));
                    localStorage.setItem('plannerPassword', this.state.plannerPassword);
                    localStorage.setItem('results', JSON.stringify(this.state.results));
                    localStorage.setItem('slotCapacities', JSON.stringify(this.state.slotCapacities));
                    localStorage.setItem('goldenCommandUsers', JSON.stringify(this.state.goldenCommandUsers || []));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('employees');
                    if (saved) {
                        this.state.employees = JSON.parse(saved);
                        this.state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords') || '{}');
                        this.state.bids = JSON.parse(localStorage.getItem('bids') || '[]');
                        this.state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                        this.state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                        this.state.isProcessed = JSON.parse(localStorage.getItem('isProcessed') || 'false');
                        this.state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                        this.state.results = JSON.parse(localStorage.getItem('results') || '[]');
                        this.state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities') || '{}');
                        this.state.goldenCommandUsers = JSON.parse(localStorage.getItem('goldenCommandUsers') || '[]');
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
                return false;
            },

            updateSystemStatus(message) {
                const el = document.getElementById('systemStatus');
                if (el) el.textContent = message;
            },

            // ==================== VIEW FUNCTIONS ====================
            setLoginType(type) {
                console.log('Setting login type to:', type);
                this.state.loginType = type;
                
                const empBtn = document.querySelector('[onclick*="employee"]');
                const planBtn = document.querySelector('[onclick*="planner"]');
                
                if (type === 'employee') {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                } else {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-purple-500 text-white';
                }
                
                this.renderLoginForm();
            },

            renderLoginForm() {
                const form = document.getElementById('loginForm');
                if (!form) return;
                
                if (this.state.loginType === 'planner') {
                    form.innerHTML = `
                        <div>
                            <label class="block font-semibold mb-2">Planner Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                placeholder="Enter planner password"
                            />
                        </div>
                    `;
                } else if (this.state.loginType === 'goldencommand') {
                    const gcUsers = this.state.goldenCommandUsers || [];
                    const hasGCUsers = gcUsers.length > 0;
                    form.innerHTML = `
                        <div class="space-y-4">
                            ${!hasGCUsers ? `
                                <div class="bg-yellow-50 border border-yellow-300 rounded p-4 mb-4">
                                    <span class="text-sm text-yellow-800">No Golden Command users configured. Ask the planner to add GC users in Admin Panel.</span>
                                </div>
                            ` : ''}
                            <div>
                                <label class="block font-semibold mb-2">Golden Command ID:</label>
                                <input
                                    type="text"
                                    id="gcLoginId"
                                    class="w-full px-4 py-2 border-2 border-yellow-400 rounded-lg focus:border-yellow-600 focus:outline-none"
                                    placeholder="Enter your GC ID"
                                    ${!hasGCUsers ? 'disabled' : ''}
                                />
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full px-4 py-2 border-2 border-yellow-400 rounded-lg focus:border-yellow-600 focus:outline-none"
                                    placeholder="Enter your password"
                                    ${!hasGCUsers ? 'disabled' : ''}
                                />
                                <div class="mt-2"></div>
                            </div>
                        </div>
                        </div>
                    `;
                } else {
                    const hasData = this.state.employees.length > 0;
                    
                    form.innerHTML = `
                        <div class="space-y-4">
                            ${!hasData ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                    <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                                </div>
                            ` : ''}
                            <div>
                                <label class="block font-semibold mb-2">Employee ID:</label>
                                <input
                                    type="text"
                                    id="loginId"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your ID"
                                    ${!hasData ? 'disabled' : ''}
                                />
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your password"
                                    ${!hasData ? 'disabled' : ''}
                                />
                                <div class="mt-2"></div>
                            </div>
                        </div>
                    `;
                }
            },

            handleLogin() {
                if (this.state.loginType === 'planner') {
                    const input = document.getElementById('loginPassword');
                    const password = input ? input.value : '';
                    
                    if (password === this.state.plannerPassword) {
                        this.state.currentUser = { name: 'Planner Admin' };
                        this.state.userType = 'planner';
                        this.state.activeView = 'upload';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('plannerNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = 'Planner Admin';
                        document.getElementById('userTypeBadge').textContent = 'Planner';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800';
                        
                        this.renderView();
                        alert('‚úÖ Welcome, Planner!');
                    } else {
                        alert('‚ùå Incorrect planner password.');
                    }
                } else if (this.state.loginType === 'goldencommand') {
                    const gcIdInput = document.getElementById('gcLoginId');
                    const passInput = document.getElementById('loginPassword');
                    const gcId = gcIdInput ? gcIdInput.value.trim() : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!gcId || !password) {
                        alert('‚ö†Ô∏è Please enter both GC ID and password');
                        return;
                    }
                    
                    const gcUsers = this.state.goldenCommandUsers || [];
                    const gcUser = gcUsers.find(u => u.id === gcId);
                    
                    if (!gcUser) {
                        alert('‚ùå Golden Command ID not found. Please contact the planner.');
                        return;
                    }
                    
                    const storedPass = gcUser.password || gcUser.id;
                    if (password !== storedPass) {
                        alert(`‚ùå Incorrect password.`);
                        return;
                    }
                    
                    this.state.currentUser = gcUser;
                    this.state.userType = 'goldencommand';
                    this.state.verifiedEmployee = { id: gcUser.id, name: gcUser.name, department: 'Golden Command', seniorityDate: '2000-01-01' };
                    this.state.activeView = 'goldenCommand';
                    
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('loginView').classList.add('hidden');
                    document.getElementById('goldenCommandNav').classList.remove('hidden');
                    
                    document.getElementById('currentUserName').textContent = gcUser.name;
                    document.getElementById('userTypeBadge').textContent = '‚≠ê Golden Command';
                    document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800';
                    
                    this.renderView();
                    alert(`‚úÖ Welcome, ${gcUser.name}!`);
                } else {
                    const idInput = document.getElementById('loginId');
                    const passInput = document.getElementById('loginPassword');
                    
                    const id = idInput ? idInput.value : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!id || !password) {
                        alert('‚ö†Ô∏è Please enter both ID and password');
                        return;
                    }
                    
                    const employee = this.state.employees.find(e => e.id === id);
                    if (!employee) {
                        alert('‚ùå Employee ID not found. Please upload data first.');
                        return;
                    }
                    
                    const storedPass = this.state.employeePasswords[id] || id;
                    if (password === storedPass) {
                        this.state.currentUser = employee;
                        this.state.userType = 'employee';
                        this.state.verifiedEmployee = employee;
                        this.state.activeView = 'employee';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('employeeNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = employee.name;
                        document.getElementById('userTypeBadge').textContent = 'Employee';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
                        
                        this.renderView();
                        alert(`‚úÖ Welcome, ${employee.name}!`);
                    } else {
                        alert(`‚ùå Incorrect password.`);
                    }
                }
            },

            handleLogout() {
                this.state.currentUser = null;
                this.state.userType = null;
                this.state.verifiedEmployee = null;
                this.state.activeView = 'login';
                
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('plannerNav').classList.add('hidden');
                document.getElementById('employeeNav').classList.add('hidden');
                document.getElementById('goldenCommandNav').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
                
                this.renderLoginForm();
            },

            setActiveView(view) {
                console.log('Setting view to:', view);
                // Stop any existing admin polling when navigating away
                if (view !== 'admin') this.stopAdminPolling();
                this.state.activeView = view;
                // Auto-refresh bids from Supabase when planner opens Admin Panel
                if (view === 'admin' && this.state.userType === 'planner' && this.supabase) {
                    this.refreshBidsFromSupabase(false).then(() => this.startAdminPolling());
                } else {
                    this.renderView();
                }
            },

            renderView() {
                const content = document.getElementById('contentArea');
                if (!content) return;
                
                content.innerHTML = '';
                
                switch(this.state.activeView) {
                    case 'upload':
                        this.renderUploadView();
                        break;
                    case 'configureSlots':
                        this.renderConfigureSlotsView();
                        break;
                    case 'admin':
                        this.renderAdminView();
                        break;
                    case 'employee':
                        this.renderEmployeeBiddingView();
                        break;
                    case 'myResults':
                        this.renderMyResultsView();
                        break;
                    case 'results':
                        this.renderResultsView();
                        break;
                    case 'changePassword':
                        this.renderChangePasswordView();
                        break;
                    case 'changePlannerPassword':
                        this.renderChangePlannerPasswordView();
                        break;
                    case 'goldenCommand':
                        this.renderGoldenCommandBiddingView();
                        break;
                }
                
                this.saveState();
            },

            // ==================== VIEW RENDERING ====================
            renderUploadView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                                <select
                                    id="biddingYearSelect"
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    ${this.state.isProcessed || this.state.bids.length > 0 ? 'disabled' : ''}
                                >
                                    ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                        <option value="${year}" ${year === this.state.biddingYear ? 'selected' : ''}>${year}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                            <p class="text-gray-600 mb-6">
                                Upload an Excel file with employee information. The file should have columns like:
                                "Personnel number", "Name", "Seniority Date", "Department", etc.
                            </p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4">
                                <p class="mb-4 text-gray-600">
                                    Drag and drop your Excel file here or click to browse
                                </p>
                                <label class="cursor-pointer">
                                    <input
                                        type="file"
                                        id="excelFile"
                                        accept=".xlsx,.xls"
                                        class="hidden"
                                        onchange="app.handleFileUpload(event)"
                                    />
                                    <span class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 inline-block">
                                        üìÅ Browse Files
                                    </span>
                                </label>
                            </div>

                            ${this.state.employees.length > 0 ? `
                                <div class="mt-6">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span class="text-green-800 font-semibold">
                                            ‚úì ${this.state.employees.length} employees loaded for ${this.state.biddingYear}
                                        </span>
                                        <div class="text-xs text-green-600 mt-1">
                                            Departments found: ${[...new Set(this.state.employees.map(e => e.department || 'Unassigned'))].join(', ')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Add year select listener
                const yearSelect = document.getElementById('biddingYearSelect');
                if (yearSelect) {
                    yearSelect.addEventListener('change', (e) => {
                        this.state.biddingYear = parseInt(e.target.value);
                    });
                }
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    alert('Please upload a valid Excel file (.xlsx or .xls)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        console.log('Excel data loaded:', jsonData.length, 'rows');
                        
                        // Process data - more robust parsing
                        const employees = jsonData.map((row, idx) => {
                            // Find ID from common column names
                            let id = '';
                            const idColumns = ['Personnel number', 'Personnel Number', 'Personnel_number', 
                                              'Personnelnumber', 'ID', 'id', 'EmployeeID', 'Employee ID', 
                                              'Employee No', 'Employee Number'];
                            
                            for (const col of idColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    id = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // Find name from common column names
                            let name = '';
                            const nameColumns = ['Name', 'Employee Name', 'Full Name', 
                                                'FORENAME SURNAME', 'Forename Surname'];
                            
                            for (const col of nameColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    name = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // If name not found, try forename + surname
                            if (!name) {
                                const forename = row['Forename'] || row['FORENAME'] || '';
                                const surname = row['Surname'] || row['SURNAME'] || '';
                                name = `${forename} ${surname}`.trim();
                            }
                            
                            // Find department
                            let department = '';
                            const deptColumns = ['Department', 'Scheduling row', 'Scheduling_row', 
                                               'SchedulingRow', 'DEPARTMENT'];
                            
                            for (const col of deptColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    department = String(row[col]).trim();
                                    // Clean up department name
                                    department = department.split('.')[0].trim();
                                    break;
                                }
                            }
                            
                            // Find seniority date
                            let seniorityDate = '';
                            const dateColumns = ['Seniority Date', 'SeniorityDate', 'seniorityDate',
                                                'Start of staff membership', 'Start_of_staff_membership',
                                                'Start Date', 'StartDate', 'Joining Date', 'JoiningDate'];
                            
                            for (const col of dateColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    const dateVal = row[col];
                                    if (typeof dateVal === 'number') {
                                        // Excel date number
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                                        seniorityDate = jsDate.toISOString();
                                    } else {
                                        // String date
                                        const jsDate = new Date(dateVal);
                                        if (!isNaN(jsDate.getTime())) {
                                            seniorityDate = jsDate.toISOString();
                                        }
                                    }
                                    break;
                                }
                            }
                            
                            // If no date found, use default
                            if (!seniorityDate) {
                                seniorityDate = new Date('2020-01-01').toISOString();
                            }
                            
                            // Use default ID if none found
                            if (!id) {
                                id = `EMP${idx + 1000}`;
                            }
                            
                            // Use default name if none found
                            if (!name) {
                                name = `Employee ${idx + 1}`;
                            }
                            
                            // Use default department if none found
                            if (!department) {
                                department = 'Unassigned';
                            }
                            
                            return {
                                id: id,
                                name: name,
                                seniorityDate: seniorityDate,
                                department: department,
                                role: row['Role'] || row['Position'] || row['Job Title'] || '',
                                gender: row['Gender'] || row['gender'] || '',
                                nationality: row['Nationality'] || row['nationality'] || ''
                            };
                        }).filter(emp => emp.id && emp.name); // Remove empty rows
                        
                        if (employees.length > 0) {
                            this.state.employees = employees;
                            employees.forEach(emp => {
                                this.state.employeePasswords[emp.id] = emp.id;
                            });
                            
                            this.saveState();
                            
                            // Show summary of departments found
                            const departmentsFound = [...new Set(employees.map(e => e.department))];
                            const message = `‚úÖ Successfully loaded ${employees.length} employees\n\n` +
                                          `Departments found (${departmentsFound.length}):\n` +
                                          departmentsFound.join(', ');
                            
                            alert(message);
                            this.renderUploadView();
                            this.renderLoginForm(); // Update login form with new IDs
                        } else {
                            alert('‚ö†Ô∏è No valid employee data found in the file. Please check the format.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error processing Excel file. Please check the format and try again.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            // ==================== VIEW RENDERING ====================
            renderEmployeeBiddingView() {
                const content = document.getElementById('contentArea');
                if (!this.state.verifiedEmployee) {
                    content.innerHTML = '<p class="text-center">Please login first.</p>';
                    return;
                }
            
                // Calculate employee's leave entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
            
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
            
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                const yearsOfService = calculateYearsOfService(this.state.verifiedEmployee.seniorityDate);
                
                // Get employee's bids
                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                const remainingLeave = entitlement - totalBidDays;
            
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <!-- Header with leave entitlement -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4">Leave Bidding for ${this.state.biddingYear}</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-gray-500">${yearsOfService.toFixed(1)} years of service</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${userBids.length}/2</p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Used</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${remainingLeave}</p>
                                    <p class="text-sm text-gray-600">Days Remaining</p>
                                </div>
                            </div>
            
                            <!-- Slot types summary -->
                            <div class="border-t pt-4">
                                <p class="font-semibold mb-2">Available Slot Types:</p>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
            
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">Place New Bid</h3>
                                
                                ${this.state.isProcessed ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>
                                ` : ''}
                                
                                ${userBids.length >= 2 ? `
                                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ùå Maximum of 2 bids reached.</p>
                                    </div>
                                ` : ''}
                                
                                <!-- Month Selection -->
                                <div class="mb-4">
                                    <label class="block font-semibold mb-2">Select Month:</label>
                                    <select id="selectedMonth" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" onchange="app.updateMonthText()">
                                        ${this.state.months.map(month => `
                                            <option value="${month}">${month} ${this.state.biddingYear}</option>
                                        `).join('')}
                                    </select>
                                </div>
            
                                <!-- Slot Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => {
                                            const hasBidForThisSlot = userBids.some(bid => bid.slotType === slot.id);
                                            const isDisabled = hasBidForThisSlot || userBids.length >= 2 || this.state.isProcessed;
                                            
                                            return `
                                                <button
                                                    data-slot="${slot.id}"
                                                    data-hasbid="${hasBidForThisSlot}"
                                                    onclick="${!isDisabled ? `app.setSelectedSlot('${slot.id}')` : ''}"
                                                    class="slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all ${isDisabled ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'}"
                                                    ${isDisabled ? 'disabled' : ''}
                                                >
                                                    ${slot.name} - ${slot.days} days
                                                    ${hasBidForThisSlot ? '<span class="float-right">‚úì</span>' : ''}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
            
                                <!-- Date Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select dates within <span id="selectedMonthText">January ${this.state.biddingYear}</span>:</label>
                                    
                                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                        <p class="font-semibold text-blue-800">
                                            <span id="selectedSlotText">No slot selected</span> requires exactly 
                                            <span id="selectedSlotDays">0</span> consecutive days
                                        </p>
                                    </div>
            
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block font-semibold mb-2">Start Date:</label>
                                            <input
                                                type="date"
                                                id="startDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateEndDate()"
                                            />
                                        </div>
                                        <div>
                                            <label class="block font-semibold mb-2">End Date (Auto-calculated):</label>
                                            <input
                                                type="date"
                                                id="endDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg bg-gray-50"
                                                readonly
                                            />
                                        </div>
                                    </div>
                                    
                                    <div id="dateInfo" class="hidden"></div>
                                    
                                    <p class="text-sm text-gray-600 mt-2">
                                        End date is automatically calculated based on slot type
                                    </p>
                                </div>
            
                                <!-- Submit Button -->
                                <button
                                    onclick="app.submitBid()"
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 disabled:opacity-50"
                                    ${this.state.isProcessed || userBids.length >= 2 ? 'disabled' : ''}
                                >
                                    Submit Bid
                                </button>
                            </div>
            
                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">My Current Bids</h3>
                                
                                ${userBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p>No bids placed yet</p>
                                        <p class="text-sm mt-2">Place your first bid on the left</p>
                                    </div>
                                ` : `
                                    <div class="space-y-4">
                                        ${userBids.map(bid => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            return `
                                                <div class="border border-gray-200 rounded p-4">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold">${slot?.name || 'Slot'}</p>
                                                            <p class="text-sm text-gray-600">${bid.startDate} to ${bid.endDate}</p>
                                                            <p class="text-sm font-semibold">${bid.days} days</p>
                                                        </div>
                                                        <button
                                                            onclick="app.removeBid('${bid.employeeId}', '${bid.slotType}', '${bid.startDate}')"
                                                            class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                                                            ${this.state.isProcessed ? 'disabled' : ''}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                
                                <!-- Bid Summary -->
                                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <p class="font-semibold mb-2">Bid Summary:</p>
                                    <p class="text-sm">Bids placed: ${userBids.length}/2</p>
                                    <p class="text-sm">Days used: ${totalBidDays}/${entitlement}</p>
                                    <p class="text-sm">Remaining leave: ${remainingLeave} days</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            
                // Initialize selected slot if none selected
                if (!window.selectedSlot && this.state.slotTypes.length > 0) {
                    window.selectedSlot = this.state.slotTypes[0].id;
                }
                
                // Update UI elements
                this.updateMonthText();
                this.updateSlotText();
                
                // Initialize slot buttons
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === window.selectedSlot) {
                        btn.className = btn.className.replace('bg-gray-100', 'bg-blue-500 text-white');
                    }
                });
            },

            renderGoldenCommandBiddingView() {
                const content = document.getElementById('contentArea');
                const gcUser = this.state.verifiedEmployee;
                if (!gcUser) { content.innerHTML = '<p class="text-center">Please login first.</p>'; return; }

                // Filter bids for THIS specific GC user
                const gcBids = this.state.bids.filter(bid => bid.employeeId === gcUser.id);
                const totalBidDays = gcBids.reduce((sum, bid) => sum + bid.days, 0);
                const entitlement = 35; // Golden Command always gets 35 days
            
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <!-- Header with GC styling -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-yellow-400">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-3xl">‚≠ê</span>
                                <h2 class="text-2xl font-bold">Golden Command ‚Äî ${gcUser.name} ‚Äî Leave Bidding ${this.state.biddingYear}</h2>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <p class="text-2xl font-bold text-yellow-800">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-yellow-600">Golden Command Entitlement</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${gcBids.length} <span class="text-sm font-normal text-gray-500">unlimited</span></p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-700">‚àû</p>
                                    <p class="text-sm text-gray-600">GC Privilege ‚Äî No Limit</p>
                                </div>
                            </div>
            
                            <!-- Slot types summary -->
                            <div class="border-t pt-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <p class="font-semibold">Available Slot Types:</p>
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">‚≠ê GC: Unlimited selections, free date range</span>
                                </div>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                    <div class="flex-1 p-3 rounded-lg border border-yellow-400 bg-yellow-50">
                                        <p class="font-bold text-yellow-800">‚≠ê Custom</p>
                                        <p class="text-sm text-yellow-700">Any date range ‚Äî free choice</p>
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6 border-l-4 border-yellow-400">
                                <h3 class="text-xl font-bold mb-4">‚≠ê Place New GC Bid</h3>
                                
                                ${this.state.isProcessed ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>
                                ` : ''}

                                <!-- Slot Type Selection -->
                                <div class="mb-5">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => {
                                            const colorMap = { green: 'border-green-300 bg-green-50 hover:bg-green-100 text-green-900', blue: 'border-blue-300 bg-blue-50 hover:bg-blue-100 text-blue-900', purple: 'border-purple-300 bg-purple-50 hover:bg-purple-100 text-purple-900' };
                                            const activeMap = { green: 'bg-green-500 text-white border-green-600', blue: 'bg-blue-500 text-white border-blue-600', purple: 'bg-purple-500 text-white border-purple-600' };
                                            const isActive = window.gcSelectedSlot === slot.id;
                                            return `
                                                <button
                                                    data-slot="${slot.id}"
                                                    onclick="app.setGCSelectedSlot('${slot.id}')"
                                                    class="gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border ${this.state.isProcessed ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : (isActive ? (activeMap[slot.color] || 'bg-yellow-400 text-yellow-900 border-yellow-500') : (colorMap[slot.color] || 'bg-yellow-50 hover:bg-yellow-100 text-gray-800 border-yellow-300'))}"
                                                    ${this.state.isProcessed ? 'disabled' : ''}
                                                >
                                                    ${slot.name} ‚Äî ${slot.days} consecutive days
                                                    ${isActive ? '<span class="float-right">‚úì Selected</span>' : ''}
                                                </button>
                                            `;
                                        }).join('')}
                                        <!-- Custom / Free Choice option -->
                                        <button
                                            data-slot="gcCustom"
                                            onclick="app.setGCSelectedSlot('gcCustom')"
                                            class="gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border ${this.state.isProcessed ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : (window.gcSelectedSlot === 'gcCustom' ? 'bg-yellow-400 text-yellow-900 border-yellow-500' : 'bg-yellow-50 hover:bg-yellow-100 text-yellow-900 border-yellow-400')}"
                                            ${this.state.isProcessed ? 'disabled' : ''}
                                        >
                                            ‚≠ê Custom ‚Äî Choose any start &amp; end date freely
                                            ${window.gcSelectedSlot === 'gcCustom' ? '<span class="float-right">‚úì Selected</span>' : ''}
                                        </button>
                                    </div>
                                </div>
            
                                <!-- Date Selection -->
                                <div class="mb-6">
                                    <div class="mb-3 p-3 bg-yellow-50 border border-yellow-300 rounded">
                                        <p class="font-semibold text-yellow-800 text-sm" id="gcSlotInfoText">
                                            ${window.gcSelectedSlot === 'gcCustom' ? '‚≠ê Custom: Pick any start and end date' : (this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot) ? `${this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot).name} ‚Äî end date auto-calculated (${this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot).days} days)` : 'Select a slot type above')}
                                        </p>
                                    </div>
            
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block font-semibold mb-2">Start Date:</label>
                                            <input
                                                type="date"
                                                id="gcStartDate"
                                                class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateGCEndDate()"
                                            />
                                        </div>
                                        <div>
                                            <label class="block font-semibold mb-2">End Date:</label>
                                            <input
                                                type="date"
                                                id="gcEndDate"
                                                class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateGCDateInfo()"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div id="gcDateInfo" class="hidden mt-2"></div>
                                </div>
            
                                <!-- Submit Button -->
                                <button
                                    onclick="app.submitGCBid()"
                                    class="w-full px-6 py-3 bg-yellow-400 text-yellow-900 rounded-lg font-semibold hover:bg-yellow-500 transition-colors shadow-sm"
                                    ${this.state.isProcessed ? 'disabled' : ''}
                                >
                                    ‚≠ê Submit Golden Command Bid
                                </button>
                            </div>
            
                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">‚≠ê My GC Bids</h3>
                                    <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">${gcBids.length} bid${gcBids.length !== 1 ? 's' : ''}</span>
                                </div>
                                
                                ${gcBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p class="text-4xl mb-2">‚≠ê</p>
                                        <p class="font-semibold">No bids placed yet</p>
                                        <p class="text-sm mt-2">Use the form on the left ‚Äî no limit on bids</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3 max-h-96 overflow-y-auto pr-1">
                                        ${gcBids.map((bid, i) => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            const slotLabel = bid.slotType === 'gcCustom' ? '‚≠ê Custom' : (slot?.name || bid.slotType);
                                            const colorBadge = bid.slotType === 'gcCustom' ? 'bg-yellow-100 text-yellow-800' : (bid.slotType === 'slotA' ? 'bg-green-100 text-green-800' : bid.slotType === 'slotB' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800');
                                            return `
                                                <div class="border border-yellow-200 rounded-lg p-3 bg-yellow-50">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="text-xs font-bold text-gray-500">#${i+1}</span>
                                                                <span class="px-2 py-0.5 rounded text-xs font-semibold ${colorBadge}">${slotLabel}</span>
                                                            </div>
                                                            <p class="text-sm text-gray-700 font-semibold">${bid.startDate} ‚Üí ${bid.endDate}</p>
                                                            <p class="text-xs text-gray-500 mt-0.5">${bid.days} day${bid.days !== 1 ? 's' : ''}</p>
                                                        </div>
                                                        <button
                                                            onclick="app.removeGCBid('${bid.slotType}', '${bid.startDate}')"
                                                            class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                                            ${this.state.isProcessed ? 'disabled' : ''}
                                                        >
                                                            ‚úï Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                
                                <!-- Bid Summary -->
                                <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <p class="font-semibold mb-2 text-yellow-800">GC Bid Summary:</p>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <p class="text-gray-600">Total bids:</p><p class="font-semibold">${gcBids.length} <span class="text-yellow-600 text-xs">(unlimited)</span></p>
                                        <p class="text-gray-600">Total days bid:</p><p class="font-semibold">${totalBidDays} days</p>
                                        <p class="text-gray-600">Leave entitlement:</p><p class="font-semibold">${entitlement} days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            
                // Initialize GC slot state ‚Äî default to Custom (free selection)
                if (!window.gcSelectedSlot) {
                    window.gcSelectedSlot = 'gcCustom';
                }
            },

            setGCSelectedSlot(slotId) {
                window.gcSelectedSlot = slotId;
                
                // Update button styles
                const buttons = document.querySelectorAll('.gc-slot-btn');
                buttons.forEach(btn => {
                    const isSelected = btn.dataset.slot === slotId;
                    if (this.state.isProcessed) {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-gray-200 text-gray-500 cursor-not-allowed';
                    } else if (isSelected) {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-yellow-400 text-yellow-900 border-yellow-500';
                    } else {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-yellow-50 hover:bg-yellow-100 text-yellow-900 border-yellow-300';
                    }
                });

                // Update info text
                const infoEl = document.getElementById('gcSlotInfoText');
                if (infoEl) {
                    if (slotId === 'gcCustom') {
                        infoEl.textContent = '‚≠ê Custom: Pick any start and end date freely';
                    } else {
                        const slot = this.state.slotTypes.find(s => s.id === slotId);
                        infoEl.textContent = slot
                            ? `${slot.name} ‚Äî end date auto-calculated (${slot.days} days)`
                            : 'Select a slot type above';
                    }
                }

                // Clear date inputs when switching slots
                const startDate = document.getElementById('gcStartDate');
                const endDate = document.getElementById('gcEndDate');
                const dateInfo = document.getElementById('gcDateInfo');
                if (startDate) startDate.value = '';
                if (endDate) {
                    endDate.value = '';
                    // Custom slot: end date is freely editable; others: readonly
                    endDate.readOnly = slotId !== 'gcCustom';
                    endDate.className = `w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none ${slotId !== 'gcCustom' ? 'bg-gray-50' : ''}`;
                }
                if (dateInfo) dateInfo.classList.add('hidden');
            },

            updateGCSlotText() {
                const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                if (slot) {
                    const slotText = document.getElementById('gcSelectedSlotText');
                    const slotDays = document.getElementById('gcSelectedSlotDays');
                    if (slotText) slotText.textContent = slot.name;
                    if (slotDays) slotDays.textContent = slot.days;
                }
            },

            updateGCMonthText() {
                const monthSelect = document.getElementById('gcSelectedMonth');
                if (monthSelect) {
                    const monthText = document.getElementById('gcSelectedMonthText');
                    if (monthText) monthText.textContent = monthSelect.value + ' ' + this.state.biddingYear;
                }
            },

            updateGCEndDate() {
                const startDateInput = document.getElementById('gcStartDate');
                const endDateInput = document.getElementById('gcEndDate');
                
                if (!startDateInput || !startDateInput.value) {
                    if (endDateInput) endDateInput.value = '';
                    return;
                }

                if (window.gcSelectedSlot === 'gcCustom') {
                    // Custom: end date is free ‚Äî just update info if both dates set
                    this.updateGCDateInfo();
                    return;
                }

                if (!window.gcSelectedSlot) return;
                
                const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                if (!slot) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + slot.days - 1);
                
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                this.updateGCDateInfo();
            },

            updateGCDateInfo() {
                const startDateInput = document.getElementById('gcStartDate');
                const endDateInput = document.getElementById('gcEndDate');
                const dateInfo = document.getElementById('gcDateInfo');

                if (!startDateInput?.value || !endDateInput?.value || !dateInfo) return;

                const days = Math.ceil(Math.abs(new Date(endDateInput.value) - new Date(startDateInput.value)) / (1000 * 60 * 60 * 24)) + 1;

                let validMsg = '';
                if (window.gcSelectedSlot === 'gcCustom') {
                    validMsg = `<p class="font-semibold text-yellow-800">‚≠ê Custom selection: ${days} day${days !== 1 ? 's' : ''} ‚úì</p>`;
                    dateInfo.className = 'p-3 rounded mb-2 bg-yellow-50 border border-yellow-300';
                } else {
                    const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                    const ok = slot && days === slot.days;
                    validMsg = `<p class="font-semibold ${ok ? 'text-green-800' : 'text-red-800'}">${days} day${days !== 1 ? 's' : ''} selected ${ok ? '‚úì' : `(${slot?.name} requires exactly ${slot?.days} days)`}</p>`;
                    dateInfo.className = `p-3 rounded mb-2 ${ok ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
                }
                dateInfo.innerHTML = validMsg + `<p class="text-sm text-gray-600 mt-1">${startDateInput.value} ‚Üí ${endDateInput.value}</p>`;
                dateInfo.classList.remove('hidden');
            },

            submitGCBid() {
                if (this.state.isProcessed) {
                    alert('Bidding has been processed. No more bids allowed.');
                    return;
                }

                const gcUser = this.state.verifiedEmployee;
                if (!gcUser) { alert('Please login first.'); return; }

                if (!window.gcSelectedSlot) {
                    alert('Please select a slot type first.');
                    return;
                }

                const startDate = document.getElementById('gcStartDate')?.value;
                const endDate = document.getElementById('gcEndDate')?.value;

                if (!startDate) {
                    alert('Please select a start date.');
                    return;
                }
                if (!endDate) {
                    alert('Please select an end date.');
                    return;
                }

                const days = Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

                if (days < 1) {
                    alert('End date must be on or after start date.');
                    return;
                }

                // For fixed slot types, validate exact day count
                if (window.gcSelectedSlot !== 'gcCustom') {
                    const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                    if (slot && days !== slot.days) {
                        alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.\n\nTo choose a free date range, select the "‚≠ê Custom" option instead.`);
                        return;
                    }
                }

                // Check date overlap with existing GC bids
                const gcBids = this.state.bids.filter(bid => bid.employeeId === gcUser.id);
                for (const bid of gcBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        alert(`Date overlap with an existing bid (${bid.startDate} ‚Üí ${bid.endDate}). Please choose non-overlapping dates.`);
                        return;
                    }
                }

                const slotLabel = window.gcSelectedSlot === 'gcCustom'
                    ? 'Custom'
                    : (this.state.slotTypes.find(s => s.id === window.gcSelectedSlot)?.name || window.gcSelectedSlot);

                const newBid = {
                    employeeId: gcUser.id,
                    employeeName: gcUser.name,
                    seniorityDate: gcUser.seniorityDate || '2000-01-01',
                    department: 'Golden Command',
                    slotType: window.gcSelectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();

                // Save bid immediately to Supabase so it survives refresh
                this.saveBidToSupabase(newBid).then(saved => {
                    if (saved) console.log('‚úÖ GC Bid saved to Supabase');
                });

                alert(`‚≠ê GC Bid placed!\n${slotLabel} ‚Äî ${startDate} ‚Üí ${endDate} (${days} day${days !== 1 ? 's' : ''})`);
                this.renderGoldenCommandBiddingView();
            },

            removeGCBid(slotType, startDate) {
                if (this.state.isProcessed) {
                    alert('Cannot remove bids after processing.');
                    return;
                }
                const gcUser = this.state.verifiedEmployee;
                if (confirm('Remove this Golden Command bid?')) {
                    // Remove the first matching bid (slotType + startDate)
                    const idx = this.state.bids.findIndex(bid =>
                        bid.employeeId === gcUser.id && bid.slotType === slotType && bid.startDate === startDate
                    );
                    if (idx !== -1) this.state.bids.splice(idx, 1);
                    this.saveState();

                    // Delete from Supabase immediately
                    if (this.supabase) {
                        this.supabase
                            .from('leave_requests')
                            .delete()
                            .eq('employee_id', gcUser.id)
                            .eq('slot_type', slotType)
                            .eq('start_date', startDate)
                            .then(({ error }) => {
                                if (error) console.warn('‚ö†Ô∏è Could not delete GC bid from Supabase:', error.message);
                                else console.log('‚úÖ GC Bid deleted from Supabase');
                            });
                    }

                    this.renderGoldenCommandBiddingView();
                }
            },

            renderConfigureSlotsView() {
                const content = document.getElementById('contentArea');
                
                // Get all unique departments from employees AND the predefined list
                // Filter: only L3, L46, L5 prefixes
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allRawDepartments = [...new Set([...this.state.departments, ...employeeDepts])];
                const filteredDepts = allRawDepartments.filter(d => /^(L3|L46|L5)[-\s]/i.test(d) || d === 'L3-SA' || d === 'L5 SA' || d === 'L3 SAMB' || d === 'L5 SAMB' || d === 'L46 SAMB').sort();
                const allDepartments = ['all', ...filteredDepts];
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">üìÖ Configure Bid Slot Calendar for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Define specific calendar date ranges for each bid slot per department per month (Jan‚ÄìDec). 
                                Each department has Slot A, Slot B, and Slot C for each of the 12 months, with individual capacity limits.
                            </p>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="deptFilter"
                                    class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg font-semibold"
                                    onchange="app.filterDepartments()"
                                >
                                    ${allDepartments.map(dept => `
                                        <option value="${dept}">
                                            ${dept === 'all' ? 'All Departments (L3 / L46 / L5)' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
            
                            <div id="configArea">
                                ${this.renderDeptConfig('all')}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            filterDepartments() {
                const filter = document.getElementById('deptFilter').value;
                const configArea = document.getElementById('configArea');
                
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filter);
                }
            },
            
            renderDeptConfig(filter) {
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allRawDepartments = [...new Set([...this.state.departments, ...employeeDepts])];
                const allDepartments = allRawDepartments.filter(d => /^(L3|L46|L5)[-\s]/i.test(d) || d === 'L3-SA' || d === 'L5 SA' || d === 'L3 SAMB' || d === 'L5 SAMB' || d === 'L46 SAMB').sort();
                
                let departmentsToConfigure = [];
                
                if (filter === 'all') {
                    departmentsToConfigure = allDepartments;
                } else {
                    departmentsToConfigure = [filter];
                }
                
                if (departmentsToConfigure.length === 0) {
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-6 text-center">
                            <p class="text-lg font-semibold">No departments found!</p>
                            <p class="mt-2">Please upload employee data first.</p>
                        </div>
                    `;
                }
                
                let html = '';
                
                if (filter === 'all') {
                    html += `
                        <div class="mb-6 p-4 bg-green-50 border border-green-300 rounded">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">üìÖ Calendar Slot Configuration ‚Äî All Departments</h3>
                            <p class="text-green-700">Configure specific date ranges for each bid slot period across ${departmentsToConfigure.length} departments.</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                            <h3 class="text-xl font-semibold text-blue-800 mb-2">üìÖ Calendar Slot Configuration ‚Äî ${filter}</h3>
                            <p class="text-blue-700">Configure specific date ranges for each bid slot period for this department.</p>
                        </div>
                    `;
                }
                
                html += `<div class="space-y-8">`;
                
                departmentsToConfigure.forEach(dept => {
                    const hasEmployees = employeeDepts.includes(dept);
                    const employeeCount = this.state.employees.filter(e => (e.department || 'Unassigned') === dept).length;
                    
                    // Calendar slots: Slot A, Slot B, Slot C (date range based)
                    const periods = [
                        { id: 'SA', label: 'Slot A', colorClass: 'green', borderColor: 'border-green-400', bgColor: 'bg-green-50' },
                        { id: 'SB', label: 'Slot B', colorClass: 'blue', borderColor: 'border-blue-400', bgColor: 'bg-blue-50' },
                        { id: 'SC', label: 'Slot C', colorClass: 'purple', borderColor: 'border-purple-400', bgColor: 'bg-purple-50' }
                    ];
                    
                    html += `
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold">${dept}</h3>
                                    <div class="flex gap-2 mt-1">
                                        ${hasEmployees ? 
                                            `<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">${employeeCount} employees</span>` : 
                                            `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">No employees</span>`
                                        }
                                    </div>
                                </div>
                                <span class="text-sm text-gray-500">12-Month Slot Configuration</span>
                            </div>
                            <div class="p-4 overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-200 px-3 py-2 text-left font-semibold text-gray-700">Month</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî Max</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî Max</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.state.months.map((month, monthIdx) => {
                                            const year = this.state.biddingYear;
                                            // Default start = 1st of month, end = last day of month
                                            const pad = n => String(n).padStart(2, '0');
                                            const lastDay = new Date(year, monthIdx + 1, 0).getDate();
                                            const defaultStart = `${year}-${pad(monthIdx + 1)}-01`;
                                            const defaultEnd   = `${year}-${pad(monthIdx + 1)}-${pad(lastDay)}`;
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="border border-gray-200 px-3 py-2 font-semibold text-gray-800 bg-gray-50 whitespace-nowrap">${month}</td>
                                                    ${['SA','SB','SC'].map((slotId, si) => {
                                                        const colors = ['border-green-300 focus:border-green-500','border-blue-300 focus:border-blue-500','border-purple-300 focus:border-purple-500'];
                                                        const bgCols = ['bg-green-50','bg-blue-50','bg-purple-50'];
                                                        const savedStart    = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-start`];
                                                        const savedEnd      = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-end`];
                                                        const savedCapacity = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-capacity`];
                                                        const startVal    = savedStart    !== undefined ? savedStart    : defaultStart;
                                                        const endVal      = savedEnd      !== undefined ? savedEnd      : defaultEnd;
                                                        const capacityVal = savedCapacity !== undefined ? savedCapacity : 1;
                                                        return `
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="date"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="start"
                                                                    class="cal-slot-input w-full px-1 py-1 border ${colors[si]} rounded text-xs"
                                                                    min="${year}-01-01" max="${year}-12-31"
                                                                    value="${startVal}"
                                                                />
                                                            </td>
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="date"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="end"
                                                                    class="cal-slot-input w-full px-1 py-1 border ${colors[si]} rounded text-xs"
                                                                    min="${year}-01-01" max="${year}-12-31"
                                                                    value="${endVal}"
                                                                />
                                                            </td>
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="number" min="0" max="200"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="capacity"
                                                                    class="cal-slot-input slot-input w-full px-1 py-1 border ${colors[si]} rounded text-center text-xs"
                                                                    placeholder="1"
                                                                    value="${capacityVal}"
                                                                />
                                                            </td>
                                                        `;
                                                    }).join('')}
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                html += `
                    <div class="mt-8">
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <p class="font-semibold text-yellow-800 mb-2">üìã Calendar Configuration Summary:</p>
                            <p class="text-sm text-yellow-700">
                                ‚Ä¢ Departments: ${departmentsToConfigure.length} department${departmentsToConfigure.length === 1 ? '' : 's'}<br>
                                ‚Ä¢ Bid slots per department: 3 (Slot A, Slot B, Slot C) √ó 12 months<br>
                                ‚Ä¢ Each slot: custom start date, end date, and max capacity<br>
                                ‚Ä¢ Total configurations: ${departmentsToConfigure.length * 3} bid slots √ó 12 months
                            </p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="app.saveSlotConfiguration()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600">
                                üíæ Save All Slot Configurations
                            </button>
                            <button onclick="app.setActiveView('upload')" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            },
            
            copyToAllMonths() {
                const filter = document.getElementById('deptFilter')?.value || 'all';
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = [...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                let departmentsToCopy = [];
                if (filter === 'all') {
                    departmentsToCopy = allDepartments;
                } else {
                    departmentsToCopy = [filter];
                }
                
                // Get January values for each department and slot
                const januaryValues = {};
                
                departmentsToCopy.forEach(dept => {
                    ['A', 'B', 'C'].forEach(slot => {
                        const key = `January-${dept}-${slot}`;
                        januaryValues[`${dept}-${slot}`] = this.state.slotCapacities[key] || 1;
                    });
                });
                
                // Apply to all months
                this.state.months.forEach(month => {
                    if (month === 'January') return; // Skip January since it's our source
                    
                    departmentsToCopy.forEach(dept => {
                        ['A', 'B', 'C'].forEach(slot => {
                            const key = `${month}-${dept}-${slot}`;
                            this.state.slotCapacities[key] = januaryValues[`${dept}-${slot}`];
                        });
                    });
                });
                
                // Update the UI
                const filterVal = document.getElementById('deptFilter')?.value || 'all';
                const configArea = document.getElementById('configArea');
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filterVal);
                }
                
                this.saveState();
                alert(`‚úÖ Copied January values to all months for ${departmentsToCopy.length} department(s)!`);
            },
            
            saveSlotConfiguration() {
                // Save calendar-based slot inputs (new format: cal-dept-month-slotId-field)
                const calInputs = document.querySelectorAll('.cal-slot-input');
                let savedCount = 0;
                
                calInputs.forEach(input => {
                    const dept = input.dataset.dept;
                    const month = input.dataset.month;
                    const slot = input.dataset.slot;
                    const field = input.dataset.field;
                    let value;
                    if (field === 'capacity') {
                        value = parseInt(input.value);
                        if (isNaN(value)) value = 1; // default capacity = 1
                    } else {
                        value = input.value;
                    }
                    
                    if (dept && slot && field) {
                        const key = month 
                            ? `cal-${dept}-${month}-${slot}-${field}` 
                            : `cal-${dept}-${slot}-${field}`;
                        this.state.slotCapacities[key] = value;
                        savedCount++;
                    }
                });
                
                this.saveState();

                // Also push slot config to Supabase so other browsers get it
                if (this.supabase) {
                    this.supabase.from('system_config').upsert({
                        id: 1,
                        bidding_deadline: this.state.biddingDeadline,
                        bidding_year: this.state.biddingYear,
                        is_processed: this.state.isProcessed,
                        planner_password: this.state.plannerPassword,
                        slot_capacities: this.state.slotCapacities,
                        results: this.state.results,
                        last_updated: new Date().toISOString()
                    }, { onConflict: 'id' }).then(({ error }) => {
                        if (error) console.warn('‚ö†Ô∏è Could not push slot config to Supabase:', error.message);
                        else console.log('‚úÖ Slot config pushed to Supabase');
                    });
                }
                
                alert(`‚úÖ Slot configurations saved!\n\n‚Ä¢ ${savedCount} fields saved.\n‚Ä¢ Each department now has Slot A, B, C configured per month (Jan‚ÄìDec).`);
                
                this.setActiveView('admin');
            },

            async refreshBidsFromSupabase(silent = false) {
                if (!this.supabase) {
                    if (!silent) alert('‚ö†Ô∏è Not connected to database.');
                    return false;
                }
                if (!silent) this.updateSystemStatus('Refreshing bids...');
                try {
                    let allBids = [];
                    let from = 0;
                    const batchSize = 1000;

                    while (true) {
                        const { data: batch, error } = await this.supabase
                            .from('leave_requests')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        if (error) { console.error('‚ùå Bids fetch error:', error.message); break; }
                        if (!batch || batch.length === 0) break;
                        allBids = [...allBids, ...batch];
                        if (batch.length < batchSize) break;
                        from += batchSize;
                    }

                    console.log(`‚úÖ Fetched ${allBids.length} bids from Supabase`);

                    this.state.bids = allBids.map(bid => ({
                        employeeId: bid.employee_id,
                        employeeName: bid.employee_name || this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                        seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                        department: bid.department || this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                        slotType: bid.slot_type || 'slotA',
                        startDate: bid.start_date,
                        endDate: bid.end_date,
                        days: bid.days_requested,
                        timestamp: bid.created_at
                    }));

                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.bids.length} bid${this.state.bids.length !== 1 ? 's' : ''} loaded`);

                    if (silent) {
                        // Silent auto-poll: update only the live elements without full re-render
                        this._liveUpdateAdminPanel();
                    } else {
                        this.renderAdminView();
                    }
                    return true;
                } catch (e) {
                    console.error('Refresh bids error:', e);
                    this.updateSystemStatus('‚ö†Ô∏è Refresh failed');
                    if (!silent) alert('Failed to refresh bids: ' + e.message);
                    return false;
                }
            },

            _liveUpdateAdminPanel() {
                // Update stats badges
                const bidCountEl = document.getElementById('adminBidCount');
                if (bidCountEl) bidCountEl.textContent = this.state.bids.length;
                const bidCount2El = document.getElementById('adminBidCount2');
                if (bidCount2El) bidCount2El.textContent = this.state.bids.length;
                const uniqueBiddersEl = document.getElementById('adminUniqueBidders');
                if (uniqueBiddersEl) uniqueBiddersEl.textContent = new Set(this.state.bids.map(b => b.employeeId)).size;
                const uniqueBidders2El = document.getElementById('adminUniqueBidders2');
                if (uniqueBidders2El) uniqueBidders2El.textContent = new Set(this.state.bids.map(b => b.employeeId)).size;
                const lastRefreshEl = document.getElementById('adminLastRefresh');
                if (lastRefreshEl) lastRefreshEl.textContent = new Date().toLocaleTimeString();
                // Re-render bids table
                const tableContainer = document.getElementById('adminBidsTableContainer');
                if (tableContainer) tableContainer.innerHTML = this._renderBidsTableHTML();
            },

            _renderBidsTableHTML() {
                if (this.state.bids.length === 0) {
                    return `
                        <div class="text-center py-10 text-gray-400">
                            <p class="text-4xl mb-3">üì≠</p>
                            <p class="font-semibold">No bids submitted yet</p>
                            <p class="text-sm mt-1">Auto-refreshing every 15 seconds. Bids appear here as soon as employees submit them.</p>
                        </div>`;
                }
                const sortedBids = [...this.state.bids].sort((a, b) => {
                    const dA = new Date(this.state.employees.find(e => e.id === a.employeeId)?.seniorityDate || 0);
                    const dB = new Date(this.state.employees.find(e => e.id === b.employeeId)?.seniorityDate || 0);
                    return dA - dB;
                });
                const colorMap = { slotA: 'bg-green-100 text-green-800', slotB: 'bg-blue-100 text-blue-800', slotC: 'bg-purple-100 text-purple-800' };
                return `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-left">
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">#</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Employee ID</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Name</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Department</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Slot Type</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Start Date</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">End Date</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Days</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Submitted</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedBids.map((bid, idx) => {
                                    const emp = this.state.employees.find(e => e.id === bid.employeeId);
                                    const slotColor = colorMap[bid.slotType] || 'bg-gray-100 text-gray-700';
                                    const slotDisplay = this.state.slotTypes.find(s => s.id === bid.slotType)?.name || bid.slotType;
                                    const submitted = bid.timestamp ? new Date(bid.timestamp).toLocaleString() : 'N/A';
                                    return `
                                        <tr class="${idx % 2 === 0 ? '' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">
                                            <td class="border border-gray-200 px-3 py-2 text-gray-500 text-center">${idx + 1}</td>
                                            <td class="border border-gray-200 px-3 py-2 font-mono text-xs text-gray-700">${bid.employeeId}</td>
                                            <td class="border border-gray-200 px-3 py-2 font-semibold text-gray-800">${bid.employeeName || emp?.name || 'Unknown'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-600">${bid.department || emp?.department || 'Unassigned'}</td>
                                            <td class="border border-gray-200 px-3 py-2"><span class="px-2 py-1 rounded text-xs font-semibold ${slotColor}">${slotDisplay}</span></td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-700">${bid.startDate || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-700">${bid.endDate || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-center font-semibold text-gray-800">${bid.days || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-xs text-gray-500">${submitted}</td>
                                        </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            },

            startAdminPolling() {
                this.stopAdminPolling(); // clear any existing timer
                console.log('üîÑ Starting admin bid auto-poll (15s interval)');
                this._adminPollTimer = setInterval(async () => {
                    if (this.state.activeView === 'admin' && this.state.userType === 'planner') {
                        await this.refreshBidsFromSupabase(true); // silent poll
                    } else {
                        this.stopAdminPolling(); // stop if planner left admin view
                    }
                }, 15000);
            },

            stopAdminPolling() {
                if (this._adminPollTimer) {
                    clearInterval(this._adminPollTimer);
                    this._adminPollTimer = null;
                    console.log('‚èπ Admin poll stopped');
                }
            },

            renderAdminView() {
                const content = document.getElementById('contentArea');
                const allDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const depts = ['all', ...allDepts].sort();
                
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Admin Panel</h2>
                                <div class="flex items-center gap-2 bg-green-50 border border-green-200 px-3 py-1.5 rounded-lg text-sm text-green-700">
                                    <span class="inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    Live &mdash; auto-refreshes every 15s &nbsp;|&nbsp; Last: <span id="adminLastRefresh">${new Date().toLocaleTimeString()}</span>
                                </div>
                            </div>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <label class="block font-semibold mb-2">Set Bidding Deadline:</label>
                                <input
                                    type="datetime-local"
                                    id="biddingDeadline"
                                    value="${this.state.biddingDeadline}"
                                    class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg"
                                    onchange="app.state.biddingDeadline = this.value; app.saveState()"
                                />
                            </div>

                            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="adminDeptFilter"
                                    class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    onchange="app.state.selectedDepartment = this.value;"
                                >
                                    ${depts.map(dept => `
                                        <option value="${dept}" ${dept === this.state.selectedDepartment ? 'selected' : ''}>
                                            ${dept === 'all' ? 'All Departments' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.employees.length}</p>
                                    <p class="text-sm text-gray-600">Total Employees</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold" id="adminBidCount">${this.state.bids.length}</p>
                                    <p class="text-sm text-gray-600">Total Bids</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold" id="adminUniqueBidders">${new Set(this.state.bids.map(b => b.employeeId)).size}</p>
                                    <p class="text-sm text-gray-600">Employees Who Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.isProcessed ? 'Yes' : 'No'}</p>
                                    <p class="text-sm text-gray-600">Processed</p>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <button
                                    onclick="app.processBids()"
                                    ${this.state.isProcessed || this.state.employees.length === 0 ? 'disabled' : ''}
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold ${this.state.isProcessed ? 'opacity-50' : ''}"
                                >
                                    ${this.state.isProcessed ? '‚úÖ Bids Already Processed' : 'üöÄ Process All Bids'}
                                </button>
                                
                                ${this.state.isProcessed ? `
                                    <button onclick="app.exportResults()" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-semibold">
                                        üìä Export Results to Excel
                                    </button>
                                ` : ''}
                                
                                <button onclick="app.refreshBidsFromSupabase(false)" class="w-full px-6 py-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                                    üîÑ Refresh Bids Now
                                </button>
                                
                                <button onclick="app.resetSystem()" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg font-semibold">
                                    üîÑ Reset System
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">System Information</h3>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>&bull; Departments: ${allDepts.length}</p>
                                    <p>&bull; Slot capacities configured: ${Object.keys(this.state.slotCapacities).length > 0 ? 'Yes' : 'No'}</p>
                                    <p>&bull; Bidding year: ${this.state.biddingYear}</p>
                                    <p>&bull; Last sync: ${this.state.employees.length > 0 ? 'Data loaded' : 'No data'}</p>
                                </div>
                            </div>

                            <!-- Golden Command User Management -->
                            <div class="mt-6 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                                <h3 class="font-bold text-yellow-800 text-lg mb-3">‚≠ê Golden Command Users</h3>
                                <p class="text-sm text-yellow-700 mb-4">Add or remove Golden Command users. Their default password is their GC ID.</p>
                                <div class="space-y-2 mb-4">
                                    ${(this.state.goldenCommandUsers || []).map((u, i) => `
                                        <div class="flex items-center justify-between bg-white border border-yellow-200 rounded p-3">
                                            <div>
                                                <span class="font-semibold text-yellow-900">‚≠ê ${u.name}</span>
                                                <span class="ml-3 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono">ID: ${u.id}</span>
                                                <span class="ml-2 text-xs text-gray-500">Password: ${u.password || u.id}</span>
                                            </div>
                                            <button onclick="app.removeGCUser(${i})" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">Remove</button>
                                        </div>
                                    `).join('')}
                                    ${(this.state.goldenCommandUsers || []).length === 0 ? `<p class="text-sm text-yellow-600 italic">No Golden Command users yet.</p>` : ''}
                                </div>
                                <div class="bg-white border border-yellow-300 rounded p-4">
                                    <p class="font-semibold text-yellow-800 mb-3">Add New GC User:</p>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">GC ID (username)</label>
                                            <input type="text" id="newGCId" placeholder="e.g. GC001" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Full Name</label>
                                            <input type="text" id="newGCName" placeholder="e.g. John Smith" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Password (optional)</label>
                                            <input type="text" id="newGCPassword" placeholder="Leave blank = same as ID" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                        </div>
                                    </div>
                                    <button onclick="app.addGCUser()" class="mt-3 px-5 py-2 bg-yellow-400 text-yellow-900 rounded-lg font-semibold hover:bg-yellow-500 text-sm">
                                        ‚≠ê Add Golden Command User
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Bids Details Section -->
                        <div class="mt-6 bg-white border-2 border-indigo-200 rounded-xl overflow-hidden">
                            <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-200 flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold text-indigo-900">üìã Staff Bid Details</h3>
                                    <p class="text-sm text-indigo-600 mt-1">All bids from staff, sorted by seniority. Updates automatically every 15 seconds.</p>
                                </div>
                                <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    <span id="adminBidCount2">${this.state.bids.length}</span> bids from <span id="adminUniqueBidders2">${new Set(this.state.bids.map(b => b.employeeId)).size}</span> staff
                                </span>
                            </div>
                            <div class="p-4" id="adminBidsTableContainer">
                                ${this._renderBidsTableHTML()}
                            </div>
                        </div>

                    </div>
                `;
            },

            addGCUser() {
                const id = document.getElementById('newGCId')?.value?.trim();
                const name = document.getElementById('newGCName')?.value?.trim();
                const password = document.getElementById('newGCPassword')?.value?.trim();
                
                if (!id || !name) {
                    alert('Please enter both a GC ID and a name.');
                    return;
                }
                
                const existing = (this.state.goldenCommandUsers || []).find(u => u.id === id);
                if (existing) {
                    alert(`GC ID "${id}" already exists.`);
                    return;
                }
                
                if (!this.state.goldenCommandUsers) this.state.goldenCommandUsers = [];
                
                this.state.goldenCommandUsers.push({
                    id: id,
                    name: name,
                    password: password || id
                });
                
                this.saveState();
                this.saveGCUsersToSupabase();
                alert(`‚úÖ Golden Command user "${name}" (ID: ${id}) added and saved to database!`);
                this.renderAdminView();
            },

            removeGCUser(index) {
                const users = this.state.goldenCommandUsers || [];
                if (index < 0 || index >= users.length) return;
                
                const user = users[index];
                if (confirm(`Remove Golden Command user "${user.name}" (${user.id})?`)) {
                    this.state.goldenCommandUsers.splice(index, 1);
                    this.saveState();
                    this.saveGCUsersToSupabase();
                    this.renderAdminView();
                }
            },

            async saveGCUsersToSupabase() {
                // Syncs the full golden_command_users table with current state:
                // 1. Upsert every user in state (add new, update existing)
                // 2. Delete any rows in the table that are no longer in state
                if (!this.supabase) return;
                try {
                    const currentUsers = this.state.goldenCommandUsers || [];

                    // Step 1: Upsert all current users
                    if (currentUsers.length > 0) {
                        const { error: upsertError } = await this.supabase
                            .from('golden_command_users')
                            .upsert(
                                currentUsers.map(u => ({
                                    id: u.id,
                                    name: u.name,
                                    password: u.password,
                                    updated_at: new Date().toISOString()
                                })),
                                { onConflict: 'id' }
                            );
                        if (upsertError) throw upsertError;
                    }

                    // Step 2: Delete rows no longer in state
                    // Fetch all IDs currently in the table
                    const { data: tableRows, error: fetchError } = await this.supabase
                        .from('golden_command_users')
                        .select('id');
                    if (fetchError) throw fetchError;

                    const currentIds = currentUsers.map(u => u.id);
                    const toDelete = (tableRows || []).map(r => r.id).filter(id => !currentIds.includes(id));

                    if (toDelete.length > 0) {
                        const { error: deleteError } = await this.supabase
                            .from('golden_command_users')
                            .delete()
                            .in('id', toDelete);
                        if (deleteError) throw deleteError;
                    }

                    console.log(`‚úÖ GC users synced to dedicated table (${currentUsers.length} users)`);
                } catch (e) {
                    console.warn('‚ö†Ô∏è GC users sync failed:', e.message);
                }
            },

            // ==================== OTHER FUNCTIONS ====================

            // ==================== OTHER FUNCTIONS ====================
            async processBids() {
                if (this.state.employees.length === 0) {
                    alert('No employees to process. Please upload data first.');
                    return;
                }
                
                if (Object.keys(this.state.slotCapacities).length === 0) {
                    alert('Please configure slot capacities first in "Configure Slots".');
                    this.setActiveView('configureSlots');
                    return;
                }
                
                // Sort employees by seniority (oldest first)
                const sortedEmployees = [...this.state.employees].sort((a, b) => {
                    return new Date(a.seniorityDate) - new Date(b.seniorityDate);
                });
                
                // Calculate entitlement for each employee
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    return (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                // Track slot availability per month per department
                const slotAvailability = {};
                const slotAssignments = [];

                // Build a lookup: slotDates[dept][month][slotId] = { start, end }
                // so assignSlotToEmployee can use the real configured dates
                const slotDates = {};

                // Initialize slot availability from capacities
                // New key format: cal-{dept}-{month}-{slotId}-{field}
                // e.g. cal-L3-DEP-DC-January-SA-capacity  (dept may contain dashes!)
                // We identify field as last segment, slotId as second-last, month as third-last,
                // and dept as everything between "cal" and month.
                const months = this.state.months; // ['January','February',...]
                Object.keys(this.state.slotCapacities).forEach(key => {
                    if (!key.startsWith('cal-')) return;
                    const withoutPrefix = key.slice(4); // remove leading "cal-"
                    // Last segment is field (start / end / capacity)
                    const lastDash = withoutPrefix.lastIndexOf('-');
                    const field = withoutPrefix.slice(lastDash + 1);
                    const withoutField = withoutPrefix.slice(0, lastDash);
                    // Second-last segment is slotId (SA / SB / SC)
                    const slotIdDash = withoutField.lastIndexOf('-');
                    const slotId = withoutField.slice(slotIdDash + 1); // e.g. "SA"
                    const withoutSlot = withoutField.slice(0, slotIdDash);
                    // Third-last segment is the month name
                    const monthDash = withoutSlot.lastIndexOf('-');
                    const month = withoutSlot.slice(monthDash + 1);
                    const dept = withoutSlot.slice(0, monthDash);

                    if (!months.includes(month)) return; // skip malformed keys
                    // Map SA‚ÜíA, SB‚ÜíB, SC‚ÜíC for the availability object
                    const slotLetter = slotId === 'SA' ? 'A' : slotId === 'SB' ? 'B' : slotId === 'SC' ? 'C' : null;
                    if (!slotLetter) return;

                    const value = this.state.slotCapacities[key];

                    if (field === 'capacity') {
                        const cap = parseInt(value) || 0;
                        if (!slotAvailability[month]) slotAvailability[month] = {};
                        if (!slotAvailability[month][dept]) slotAvailability[month][dept] = { A: 0, B: 0, C: 0 };
                        slotAvailability[month][dept][slotLetter] = cap;
                    } else if (field === 'start' || field === 'end') {
                        if (!slotDates[dept]) slotDates[dept] = {};
                        if (!slotDates[dept][month]) slotDates[dept][month] = {};
                        if (!slotDates[dept][month][slotLetter]) slotDates[dept][month][slotLetter] = {};
                        slotDates[dept][month][slotLetter][field] = value;
                    }
                });
                
                // Helper function to assign slot to employee using real configured dates
                const assignSlotToEmployee = (employee, month, slotType, slotNumber) => {
                    const slot = this.state.slotTypes.find(s => s.id === `slot${slotType}`);
                    const dept = employee.department || 'Unassigned';
                    const year = this.state.biddingYear;

                    // Use real configured dates if available
                    const configuredDates = slotDates[dept]?.[month]?.[slotType];
                    let startDateStr, endDateStr;

                    if (configuredDates?.start && configuredDates?.end) {
                        startDateStr = configuredDates.start;
                        endDateStr = configuredDates.end;
                    } else {
                        // Fallback: calculate from month index
                        const monthIndex = this.state.months.indexOf(month);
                        let startDate = new Date(year, monthIndex, 1);
                        if (slotNumber === 2) {
                            if (slotType === 'A') startDate.setDate(16);
                            if (slotType === 'B') startDate.setDate(16);
                            if (slotType === 'C') startDate.setDate(11);
                        }
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + (slot ? slot.days : 15) - 1);
                        startDateStr = startDate.toISOString().split('T')[0];
                        endDateStr = endDate.toISOString().split('T')[0];
                    }

                    const days = slot ? slot.days : Math.ceil((new Date(endDateStr) - new Date(startDateStr)) / (1000 * 60 * 60 * 24)) + 1;

                    return {
                        employeeId: employee.id,
                        employeeName: employee.name,
                        department: dept,
                        slotName: `${slot ? slot.name : slotType}`,
                        slotType: `slot${slotType}`,
                        slotNumber: slotNumber || 1,
                        startDate: startDateStr,
                        endDate: endDateStr,
                        days: days,
                        month: month,
                        year: year,
                        seniorityDate: employee.seniorityDate,
                        yearsOfService: calculateYearsOfService(employee.seniorityDate).toFixed(1)
                    };
                };
                
                // NEW: Function to find best slot combination for 35-day employees
                const findBestSlotsFor35Days = (employee, department, assignedDays, assignedSlots) => {
                    const slotCombinations = [
                        { slot1: 'C', slot2: 'A' }, // 20 + 15 = 35
                        { slot1: 'C', slot2: 'B' }, // 20 + 15 = 35
                        { slot1: 'A', slot2: 'C' }, // 15 + 20 = 35
                        { slot1: 'B', slot2: 'C' }  // 15 + 20 = 35
                    ];
                    
                    // Try each combination
                    for (const combo of slotCombinations) {
                        // Try to find available months for both slots
                        for (const month1 of this.state.months) {
                            if (!slotAvailability[month1] || !slotAvailability[month1][department]) continue;
                            if (slotAvailability[month1][department][combo.slot1] <= 0) continue;
                            
                            for (const month2 of this.state.months) {
                                if (month1 === month2) continue; // Different months for different slots
                                if (!slotAvailability[month2] || !slotAvailability[month2][department]) continue;
                                if (slotAvailability[month2][department][combo.slot2] <= 0) continue;
                                
                                // Check if these slots would exceed capacity when combined with existing assignments
                                const daysNeeded = (combo.slot1 === 'C' ? 20 : 15) + (combo.slot2 === 'C' ? 20 : 15);
                                if (assignedDays + daysNeeded <= 35) {
                                    return {
                                        month1, slot1: combo.slot1,
                                        month2, slot2: combo.slot2
                                    };
                                }
                            }
                        }
                    }
                    
                    return null;
                };
                
                // Process each employee by seniority
                sortedEmployees.forEach((employee, index) => {
                    const employeeBids = this.state.bids.filter(bid => bid.employeeId === employee.id);
                    const entitlement = getEmployeeEntitlement(employee);
                    const department = employee.department || 'Unassigned';
                    
                    // Track assigned slots for this employee
                    const assignedSlots = [];
                    let assignedDays = 0;
                    
                    // Phase 1: Try to assign based on employee's bids (by seniority)
                    // Sort employee's bids by seniority preference (they're already sorted by overall seniority)
                    if (employeeBids.length > 0) {
                        // Process bids in the order they were placed (or sort by slot preference)
                        employeeBids.forEach(bid => {
                            if (assignedSlots.length >= 2) return; // Already have 2 slots
                            
                            const month = this.state.months[new Date(bid.startDate).getMonth()];
                            const slotType = bid.slotType.charAt(bid.slotType.length - 1); // 'A', 'B', or 'C'
                            
                            // Check if slot is available in employee's department
                            if (slotAvailability[month] && 
                                slotAvailability[month][department] && 
                                slotAvailability[month][department][slotType] > 0) {
                                
                                // NEW: Check for conflicts with other employees (same department, same slot)
                                // Seniority already handled by processing order
                                
                                // Assign slot
                                const assignment = assignSlotToEmployee(employee, month, slotType, assignedSlots.length + 1);
                                assignedSlots.push(assignment);
                                assignedDays += assignment.days;
                                
                                // Decrease availability
                                slotAvailability[month][department][slotType]--;
                            }
                        });
                    }
                    
                    // Phase 2: Fill remaining slots (if employee doesn't have 2 slots yet)
                    while (assignedSlots.length < 2) {
                        // NEW: For 35-day employees, try to assign Slot C + another slot
                        if (entitlement === 35 && assignedDays < 35) {
                            const bestCombo = findBestSlotsFor35Days(employee, department, assignedDays, assignedSlots);
                            
                            if (bestCombo) {
                                // Assign first slot from combo
                                if (assignedSlots.length === 0) {
                                    const assignment1 = assignSlotToEmployee(employee, bestCombo.month1, bestCombo.slot1, 1);
                                    assignedSlots.push(assignment1);
                                    assignedDays += assignment1.days;
                                    slotAvailability[bestCombo.month1][department][bestCombo.slot1]--;
                                }
                                
                                // Assign second slot from combo
                                if (assignedSlots.length === 1) {
                                    const assignment2 = assignSlotToEmployee(employee, bestCombo.month2, bestCombo.slot2, 2);
                                    assignedSlots.push(assignment2);
                                    assignedDays += assignment2.days;
                                    slotAvailability[bestCombo.month2][department][bestCombo.slot2]--;
                                }
                                
                                continue; // Skip to next employee
                            }
                        }
                        
                        // Regular assignment logic for 30-day employees or if no 35-day combo found
                        // Find available slot for this employee
                        let slotAssigned = false;
                        
                        // For 35-day employees, prioritize Slot C
                        const slotPriority = entitlement === 35 ? ['C', 'A', 'B'] : ['A', 'B', 'C'];
                        
                        // Try each month
                        for (const month of this.state.months) {
                            if (!slotAvailability[month] || !slotAvailability[month][department]) continue;
                            
                            // Try each slot type based on priority
                            for (const slotType of slotPriority) {
                                if (slotAvailability[month][department][slotType] > 0) {
                                    const potentialAssignment = assignSlotToEmployee(employee, month, slotType, assignedSlots.length + 1);
                                    
                                    // Check if this would exceed entitlement
                                    if (assignedDays + potentialAssignment.days <= entitlement) {
                                        // NEW: Check if this creates a perfect 35-day combination
                                        if (entitlement === 35) {
                                            const remainingDays = entitlement - (assignedDays + potentialAssignment.days);
                                            // If this leaves exactly 15 or 20 days remaining, it's good
                                            if (remainingDays === 15 || remainingDays === 20 || remainingDays === 0) {
                                                assignedSlots.push(potentialAssignment);
                                                assignedDays += potentialAssignment.days;
                                                slotAvailability[month][department][slotType]--;
                                                slotAssigned = true;
                                                break;
                                            }
                                        } else {
                                            // For 30-day employees, any combination that doesn't exceed limit
                                            assignedSlots.push(potentialAssignment);
                                            assignedDays += potentialAssignment.days;
                                            slotAvailability[month][department][slotType]--;
                                            slotAssigned = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (slotAssigned) break;
                        }
                        
                        // If no slot found, assign default with consideration for 35-day requirement
                        if (!slotAssigned && assignedSlots.length < 2) {
                            const defaultMonth = this.state.months[assignedSlots.length % 12];
                            
                            // For 35-day employees, try to get Slot C if possible
                            let defaultSlotType;
                            if (entitlement === 35 && assignedDays === 0) {
                                defaultSlotType = 'C'; // Start with 20-day slot
                            } else if (entitlement === 35 && assignedDays === 20) {
                                defaultSlotType = 'A'; // Need 15 more days
                            } else {
                                defaultSlotType = assignedSlots.length % 3 === 0 ? 'A' : assignedSlots.length % 3 === 1 ? 'B' : 'C';
                            }
                            
                            const defaultAssignment = assignSlotToEmployee(employee, defaultMonth, defaultSlotType, assignedSlots.length + 1);
                            assignedSlots.push(defaultAssignment);
                            assignedDays += defaultAssignment.days;
                            
                            // Create availability if doesn't exist
                            if (!slotAvailability[defaultMonth]) slotAvailability[defaultMonth] = {};
                            if (!slotAvailability[defaultMonth][department]) slotAvailability[defaultMonth][department] = { A: 0, B: 0, C: 0 };
                            slotAvailability[defaultMonth][department][defaultSlotType] = Math.max(0, slotAvailability[defaultMonth][department][defaultSlotType] - 1);
                        }
                    }
                    
                    // Add all assignments to results
                    assignedSlots.forEach((assignment, slotIndex) => {
                        slotAssignments.push({
                            ...assignment,
                            seniorityRank: index + 1,
                            type: employeeBids.length > slotIndex ? 'Bid Awarded' : 'Auto-Assigned',
                            totalEmployeeSlots: 2,
                            slotOrder: slotIndex + 1,
                            entitlement: entitlement
                        });
                    });
                });
                
                // Save results
                this.state.results = slotAssignments;
                this.state.isProcessed = true;
                this.saveState();
                
                // Calculate statistics
                const totalSlots = slotAssignments.length;
                const totalEmployees = sortedEmployees.length;
                const bidAwarded = slotAssignments.filter(r => r.type === 'Bid Awarded').length;
                const autoAssigned = slotAssignments.filter(r => r.type === 'Auto-Assigned').length;
                const seniorEmployees = sortedEmployees.filter(e => getEmployeeEntitlement(e) === 35).length;
                const juniorEmployees = totalEmployees - seniorEmployees;
                
                const message = `‚úÖ Successfully processed ${totalEmployees} employees!\n\n` +
                               `‚Ä¢ Total slots assigned: ${totalSlots} (${totalEmployees} √ó 2)\n` +
                               `‚Ä¢ Senior employees (35 days): ${seniorEmployees}\n` +
                               `‚Ä¢ Junior employees (30 days): ${juniorEmployees}\n` +
                               `‚Ä¢ Bid Awards: ${bidAwarded} slots\n` +
                               `‚Ä¢ Auto-Assigned: ${autoAssigned} slots\n` +
                               `‚Ä¢ Each employee received exactly 2 slots\n` +
                               `‚Ä¢ Total leave days allocated: ${slotAssignments.reduce((sum, r) => sum + r.days, 0)}`;
                
                alert(message);
                
                this.renderAdminView();
            },
            exportResults() {
                if (this.state.results.length === 0) {
                    alert('No results to export');
                    return;
                }
                
                // Create Excel workbook
                const wsData = [
                    ['Seniority Rank', 'Employee ID', 'Employee Name', 'Department', 'Slot Type', 
                     'Month', 'Start Date', 'End Date', 'Days', 'Assignment Type']
                ];
                
                this.state.results.forEach(result => {
                    wsData.push([
                        result.seniorityRank,
                        result.employeeId,
                        result.employeeName,
                        result.department,
                        result.slotName,
                        result.month,
                        result.startDate,
                        result.endDate,
                        result.days,
                        result.type
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Leave Assignments');
                XLSX.writeFile(wb, `Leave_Assignments_${this.state.biddingYear}.xlsx`);
                
                alert('‚úÖ Results exported to Excel file!');
            },

            resetSystem() {
                if (confirm('‚ö†Ô∏è WARNING: This will reset ALL data including employees, bids, and results. Continue?')) {
                    localStorage.clear();
                    this.state.employees = [];
                    this.state.bids = [];
                    this.state.results = [];
                    this.state.isProcessed = false;
                    this.state.slotCapacities = {};
                    this.state.currentUser = null;
                    this.state.userType = null;
                    this.state.activeView = 'login';
                    
                    // Reset UI
                    document.getElementById('userInfo').classList.add('hidden');
                    document.getElementById('plannerNav').classList.add('hidden');
                    document.getElementById('employeeNav').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                    
                    this.updateSystemStatus('System reset');
                    this.renderLoginForm();
                    
                    alert('‚úÖ System has been completely reset!');
                }
            },

            // ==================== BIDDING FUNCTIONS ====================
            setSelectedSlot(slotId) {
                window.selectedSlot = slotId;
                this.updateSlotText();
                
                // Update button styles
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === slotId) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-blue-500 text-white';
                    } else if (btn.dataset.hasbid === 'true' || this.state.isProcessed) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-200 text-gray-500 cursor-not-allowed';
                    } else {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-100 hover:bg-gray-200 text-gray-800';
                    }
                });
                
                // Clear date inputs
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (startDate) startDate.value = '';
                if (endDate) endDate.value = '';
                if (dateInfo) dateInfo.classList.add('hidden');
            },

            updateSlotText() {
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (slot) {
                    const slotText = document.getElementById('selectedSlotText');
                    const slotDays = document.getElementById('selectedSlotDays');
                    if (slotText) slotText.textContent = slot.name;
                    if (slotDays) slotDays.textContent = slot.days;
                }
            },

            updateMonthText() {
                const monthSelect = document.getElementById('selectedMonth');
                if (monthSelect) {
                    const monthText = document.getElementById('selectedMonthText');
                    if (monthText) monthText.textContent = monthSelect.value + ' ' + this.state.biddingYear;
                }
            },

            updateEndDate() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (!startDateInput || !startDateInput.value || !window.selectedSlot) {
                    if (endDateInput) endDateInput.value = '';
                    if (dateInfo) dateInfo.classList.add('hidden');
                    return;
                }
                
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (!slot) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + slot.days - 1);
                
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDateInput.value, endDateInput.value);
                
                if (dateInfo) {
                    if (days === slot.days) {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-green-800">
                                Selected: ${days} days ‚úì
                            </p>
                            <p class="text-sm mt-1 text-green-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-green-50 border border-green-200';
                    } else {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-red-800">
                                Selected: ${days} days (Required: ${slot.days} days)
                            </p>
                            <p class="text-sm mt-1 text-red-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-red-50 border border-red-200';
                    }
                    dateInfo.classList.remove('hidden');
                }
            },

            checkDateOverlap(startDate1, endDate1, startDate2, endDate2) {
                const start1 = new Date(startDate1);
                const end1 = new Date(endDate1);
                const start2 = new Date(startDate2);
                const end2 = new Date(endDate2);
                
                return (start1 <= end2 && end1 >= start2);
            },

            submitBid() {
                if (!this.state.verifiedEmployee) {
                    alert('Please login first');
                    return;
                }

                if (this.state.isProcessed) {
                    alert('Bidding has been processed. No more bids allowed.');
                    return;
                }

                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                const monthSelect = document.getElementById('selectedMonth');
                const month = monthSelect ? monthSelect.value : this.state.months[0];

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }

                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDate, endDate);

                if (days !== slot.days) {
                    alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.`);
                    return;
                }

                const start = new Date(startDate);
                const yearStart = new Date(this.state.biddingYear, 0, 1);
                const yearEnd = new Date(this.state.biddingYear, 11, 31);

                if (start < yearStart || start > yearEnd) {
                    alert(`Start date must be within ${this.state.biddingYear}`);
                    return;
                }

                const existingBid = this.state.bids.find(
                    bid => bid.employeeId === this.state.verifiedEmployee.id && bid.slotType === window.selectedSlot
                );
                
                if (existingBid) {
                    alert(`You have already bid for ${slot.name}. You cannot bid for the same slot twice.`);
                    return;
                }

                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                
                // Calculate entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                
                if (userBids.length >= 2) {
                    alert('You can only place 2 bids maximum.');
                    return;
                }

                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                if (totalBidDays + days > entitlement) {
                    alert(`Your total leave days would exceed your entitlement of ${entitlement} days.\n\nCurrent bids: ${totalBidDays} days\nThis bid: ${days} days\nTotal: ${totalBidDays + days} days`);
                    return;
                }

                // Check for date overlaps
                for (const bid of userBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        const existingSlot = this.state.slotTypes.find(s => s.id === bid.slotType);
                        alert(`Date overlap detected with your existing ${existingSlot?.name || 'slot'} bid (${bid.startDate} to ${bid.endDate})`);
                        return;
                    }
                }

                const newBid = {
                    employeeId: this.state.verifiedEmployee.id,
                    employeeName: this.state.verifiedEmployee.name,
                    seniorityDate: this.state.verifiedEmployee.seniorityDate,
                    department: this.state.verifiedEmployee.department,
                    slotType: window.selectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();

                // Save bid immediately to Supabase so it survives refresh
                this.saveBidToSupabase(newBid).then(saved => {
                    if (saved) {
                        console.log('‚úÖ Bid saved to Supabase');
                    } else {
                        console.warn('‚ö†Ô∏è Bid saved locally only ‚Äî Supabase unavailable');
                        // Show warning so user knows the bid may not be visible to the planner
                        alert('‚ö†Ô∏è Your bid was recorded locally but could NOT be saved to the database.\n\nPlease check your internet connection and try submitting again, or contact the planner.');
                    }
                });

                alert(`‚úì Bid placed successfully for ${slot.name} (${days} days)!`);
                
                // Refresh view
                this.renderEmployeeBiddingView();
            },

            async saveBidToSupabase(bid) {
                if (!this.supabase) {
                    console.warn('‚ö†Ô∏è Supabase not initialised ‚Äî bid saved locally only');
                    return false;
                }
                try {
                    const row = {
                        employee_id: bid.employeeId,
                        start_date: bid.startDate,
                        end_date: bid.endDate,
                        days_requested: bid.days,
                        status: 'pending',
                        slot_type: bid.slotType,
                        department: bid.department || '',
                        employee_name: bid.employeeName || '',
                        created_at: bid.timestamp || new Date().toISOString()
                    };

                    // Step 1: Delete any existing row for this employee+slot combo to avoid duplicates
                    const { error: delError } = await this.supabase
                        .from('leave_requests')
                        .delete()
                        .eq('employee_id', bid.employeeId)
                        .eq('slot_type', bid.slotType);

                    if (delError) {
                        console.warn('‚ö†Ô∏è Pre-delete warning (non-fatal):', delError.message);
                    }

                    // Step 2: Insert the new bid row fresh
                    const { data, error: insertError } = await this.supabase
                        .from('leave_requests')
                        .insert(row)
                        .select();

                    if (insertError) {
                        console.error('‚ùå Supabase bid insert error:', insertError.message, insertError);
                        return false;
                    }

                    console.log('‚úÖ Bid saved to Supabase:', data);
                    return true;
                } catch (e) {
                    console.error('‚ùå Supabase bid save exception:', e.message);
                    return false;
                }
            },

            removeBid(employeeId, slotType, startDate) {
                if (this.state.isProcessed) {
                    alert('Cannot remove bids after processing');
                    return;
                }
                
                if (confirm('Are you sure you want to remove this bid?')) {
                    this.state.bids = this.state.bids.filter(bid => 
                        !(bid.employeeId === employeeId && 
                          bid.slotType === slotType && 
                          bid.startDate === startDate)
                    );
                    this.saveState();

                    // Delete from Supabase immediately
                    if (this.supabase) {
                        this.supabase
                            .from('leave_requests')
                            .delete()
                            .eq('employee_id', employeeId)
                            .eq('slot_type', slotType)
                            .eq('start_date', startDate)
                            .then(({ error }) => {
                                if (error) console.warn('‚ö†Ô∏è Could not delete bid from Supabase:', error.message);
                                else console.log('‚úÖ Bid deleted from Supabase');
                            });
                    }

                    this.renderEmployeeBiddingView();
                }
            },
               
            loadAvailableSlots() {
                const slotsContainer = document.getElementById('slotsContainer');
                if (!slotsContainer) return;

                slotsContainer.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Loading available slots...</p>';

                setTimeout(() => {
                    const employee = this.state.verifiedEmployee;
                    const dept = employee?.department || '';
                    const months = this.state.months;
                    const caps = this.state.slotCapacities;

                    // Parse all real configured slots from slotCapacities
                    // Key format: cal-{dept}-{month}-{slotId}-{field}
                    const slotMap = {}; // key: "dept||month||slotLetter" ‚Üí { start, end, capacity, dept, month, slotLetter }

                    Object.keys(caps).forEach(key => {
                        if (!key.startsWith('cal-')) return;
                        const withoutPrefix = key.slice(4);
                        const lastDash = withoutPrefix.lastIndexOf('-');
                        const field = withoutPrefix.slice(lastDash + 1);
                        const withoutField = withoutPrefix.slice(0, lastDash);
                        const slotIdDash = withoutField.lastIndexOf('-');
                        const slotId = withoutField.slice(slotIdDash + 1);
                        const withoutSlot = withoutField.slice(0, slotIdDash);
                        const monthDash = withoutSlot.lastIndexOf('-');
                        const month = withoutSlot.slice(monthDash + 1);
                        const deptKey = withoutSlot.slice(0, monthDash);

                        if (!months.includes(month)) return;
                        const slotLetter = slotId === 'SA' ? 'A' : slotId === 'SB' ? 'B' : slotId === 'SC' ? 'C' : null;
                        if (!slotLetter) return;

                        const mapKey = `${deptKey}||${month}||${slotLetter}`;
                        if (!slotMap[mapKey]) slotMap[mapKey] = { dept: deptKey, month, slotLetter, start: '', end: '', capacity: 0 };

                        if (field === 'start') slotMap[mapKey].start = caps[key];
                        if (field === 'end') slotMap[mapKey].end = caps[key];
                        if (field === 'capacity') slotMap[mapKey].capacity = parseInt(caps[key]) || 0;
                    });

                    // Convert to array and filter: only slots with dates + capacity > 0
                    let allSlots = Object.values(slotMap).filter(s => s.start && s.end && s.capacity > 0);

                    if (allSlots.length === 0) {
                        slotsContainer.innerHTML = `
                            <div class="text-center py-10 text-gray-400">
                                <p class="text-4xl mb-3">üì≠</p>
                                <p class="font-semibold text-gray-600">No slots configured yet</p>
                                <p class="text-sm mt-1">The planner needs to configure slots with dates and capacity in <strong>Configure Slots</strong> first.</p>
                            </div>`;
                        return;
                    }

                    // Sort slots: employee's own department first, then by month order
                    allSlots.sort((a, b) => {
                        const aIsMyDept = a.dept === dept ? 0 : 1;
                        const bIsMyDept = b.dept === dept ? 0 : 1;
                        if (aIsMyDept !== bIsMyDept) return aIsMyDept - bIsMyDept;
                        return months.indexOf(a.month) - months.indexOf(b.month);
                    });

                    // Count how many bids have already been placed per slot (dept+month+slot)
                    const bidCounts = {};
                    this.state.bids.forEach(bid => {
                        const bDept = bid.department || '';
                        const bMonth = bid.startDate ? months[new Date(bid.startDate).getMonth()] : '';
                        const bSlotLetter = bid.slotType === 'slotA' ? 'A' : bid.slotType === 'slotB' ? 'B' : bid.slotType === 'slotC' ? 'C' : '';
                        if (bDept && bMonth && bSlotLetter) {
                            const k = `${bDept}||${bMonth}||${bSlotLetter}`;
                            bidCounts[k] = (bidCounts[k] || 0) + 1;
                        }
                    });

                    const colorMap = { A: { bg: 'bg-green-50', border: 'border-green-300', badge: 'bg-green-100 text-green-800', label: 'Slot A' }, B: { bg: 'bg-blue-50', border: 'border-blue-300', badge: 'bg-blue-100 text-blue-800', label: 'Slot B' }, C: { bg: 'bg-purple-50', border: 'border-purple-300', badge: 'bg-purple-100 text-purple-800', label: 'Slot C' } };

                    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    allSlots.forEach(slot => {
                        const isMyDept = slot.dept === dept;
                        const mapKey = `${slot.dept}||${slot.month}||${slot.slotLetter}`;
                        const taken = bidCounts[mapKey] || 0;
                        const remaining = Math.max(0, slot.capacity - taken);
                        const isFull = remaining === 0;
                        const c = colorMap[slot.slotLetter] || colorMap['A'];
                        const slotTypeDef = this.state.slotTypes.find(s => s.id === `slot${slot.slotLetter}`);
                        const days = slotTypeDef ? slotTypeDef.days : '?';

                        html += `
                            <div class="border-2 ${isFull ? 'border-gray-200 bg-gray-50 opacity-60' : (isMyDept ? 'border-yellow-400 ' + c.bg : c.border + ' ' + c.bg)} rounded-lg p-4 transition hover:shadow-md">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="flex items-center gap-2 flex-wrap mb-1">
                                            <span class="px-2 py-0.5 rounded text-xs font-bold ${c.badge}">${c.label}</span>
                                            ${isMyDept ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">‚≠ê Your Dept</span>' : ''}
                                            ${isFull ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700">Full</span>' : ''}
                                        </div>
                                        <p class="font-semibold text-gray-800 text-sm">${slot.dept}</p>
                                        <p class="text-xs text-gray-500">${slot.month} ${this.state.biddingYear}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-gray-800">${days} <span class="text-xs font-normal text-gray-500">days</span></p>
                                        <p class="text-xs ${isFull ? 'text-red-600' : 'text-green-600'} font-semibold">${remaining}/${slot.capacity} spots left</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mb-3 font-mono">${slot.start} ‚Üí ${slot.end}</p>
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center gap-2 cursor-pointer ${isFull ? 'opacity-40 cursor-not-allowed' : ''}">
                                        <input type="checkbox" class="slot-checkbox w-4 h-4" value="${mapKey}" ${isFull ? 'disabled' : ''}>
                                        <span class="text-sm text-gray-700">Select to bid</span>
                                    </label>
                                    <span class="text-xs text-gray-400">${slot.start}</span>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                    slotsContainer.innerHTML = html;
                }, 300);
            },

            previewSlot(slotId) {
                alert(`Previewing slot #${slotId}. In a real application, this would show detailed information about the selected slot.`);
            },

            renderMyResultsView() {
                const content = document.getElementById('contentArea');
                const myResults = this.state.results.filter(r => r.employeeId === this.state.verifiedEmployee?.id);
                
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">My Leave Assignment</h2>
                            
                            ${myResults.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results available yet.</p>
                                    ${this.state.isProcessed ? '' : '<p class="text-sm mt-2">Bids have not been processed yet.</p>'}
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${myResults.map(result => `
                                        <div class="border border-gray-200 rounded p-4">
                                            <p class="font-bold text-lg">${result.slotName}</p>
                                            <p class="text-sm text-gray-600">${result.startDate} to ${result.endDate}</p>
                                            <p class="text-sm font-semibold">${result.days} days</p>
                                            <span class="px-2 py-1 rounded text-xs ${result.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                ${result.type}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderResultsView() {
                const content = document.getElementById('contentArea');
                
                // Group results by employee
                const employeeResults = {};
                this.state.results.forEach(result => {
                    if (!employeeResults[result.employeeId]) {
                        employeeResults[result.employeeId] = [];
                    }
                    employeeResults[result.employeeId].push(result);
                });
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-6">Leave Assignments for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Each employee receives exactly 2 slots. Senior employees (5+ years) get 35 days total,
                                others get 30 days total.
                            </p>
                            
                            ${this.state.results.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results yet. Process bids first.</p>
                                    <button onclick="app.setActiveView('admin')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                        Go to Admin Panel
                                    </button>
                                </div>
                            ` : `
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">Rank</th>
                                                <th class="p-3">Employee</th>
                                                <th class="p-3">Department</th>
                                                <th class="p-3">Seniority</th>
                                                <th class="p-3">Slot 1</th>
                                                <th class="p-3">Slot 2</th>
                                                <th class="p-3">Total Days</th>
                                                <th class="p-3">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(employeeResults).map(([empId, slots]) => {
                                                const employee = this.state.employees.find(e => e.id === empId);
                                                const slot1 = slots.find(s => s.slotOrder === 1);
                                                const slot2 = slots.find(s => s.slotOrder === 2);
                                                const totalDays = slots.reduce((sum, s) => sum + s.days, 0);
                                                const allAwarded = slots.every(s => s.type === 'Bid Awarded');
                                                const anyAwarded = slots.some(s => s.type === 'Bid Awarded');
                                                
                                                return `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-3">#${slot1?.seniorityRank || 'N/A'}</td>
                                                        <td class="p-3">${employee?.name || 'Unknown'}<br>
                                                            <span class="text-xs text-gray-500">${empId}</span>
                                                        </td>
                                                        <td class="p-3">${employee?.department || 'Unassigned'}</td>
                                                        <td class="p-3">${slot1?.yearsOfService || 'N/A'} yrs</td>
                                                        <td class="p-3">
                                                            ${slot1?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot1?.startDate || ''} to ${slot1?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot1?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot1?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3">
                                                            ${slot2?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot2?.startDate || ''} to ${slot2?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot2?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot2?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3 font-bold">${totalDays} days</td>
                                                        <td class="p-3">
                                                            <span class="px-2 py-1 rounded text-xs ${
                                                                allAwarded ? 'bg-green-100 text-green-800' : 
                                                                anyAwarded ? 'bg-yellow-100 text-yellow-800' : 
                                                                'bg-blue-100 text-blue-800'
                                                            }">
                                                                ${allAwarded ? 'All Bids Awarded' : 
                                                                  anyAwarded ? 'Partial Award' : 
                                                                  'Auto-Assigned'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderChangePasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderChangePlannerPasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Planner Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ==================== INITIALIZATION ====================
            async init() {
                console.log('App initializing...');
                this.updateSystemStatus('Initializing...');
                
                // Initialize Supabase
                const supabaseReady = await this.initSupabase();
                if (supabaseReady) {
                    this.updateSystemStatus('Connected to Supabase');
                    
                    // Try to load from Supabase first
                    setTimeout(async () => {
                        await this.loadFromSupabase();
                    }, 500);
                } else {
                    // Fallback to localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('Ready - No data loaded');
                    }
                }
                
                this.renderLoginForm();
                
                // Add Enter key support
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && this.state.activeView === 'login') {
                        this.handleLogin();
                    }
                });
                
                console.log('App ready');
            }
        };

        // Initialize when page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>
