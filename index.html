<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                Annual Leave Bidding System
            </h1>
            <div id="userInfo" class="hidden flex justify-center items-center gap-4 mt-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span class="text-sm text-gray-600">Logged in as: </span>
                    <span id="currentUserName" class="font-semibold"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button
                    onclick="app.handleLogout()"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                >
                    Logout
                </button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="max-w-md mx-auto mt-10">
            <div class="bg-white rounded-xl shadow-xl p-8">
                <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
                    Annual Leave Bidding System
                </h1>
                
                <div class="mb-4 text-center">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                        <p class="text-sm font-semibold text-blue-800">System Status:</p>
                        <p id="systemStatus" class="text-xs text-blue-700">Initializing...</p>
                    </div>
                    
                    <button onclick="app.syncWithSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-semibold mb-4">
                        üîÑ Sync with Database
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-3">Login As:</label>
                    <div class="flex gap-4">
                        <button
                            onclick="app.setLoginType('employee')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white"
                        >
                            Employee
                        </button>
                        <button
                            onclick="app.setLoginType('planner')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300"
                        >
                            Planner
                        </button>
                    </div>
                </div>

                <div id="loginForm">
                    <!-- Default employee login form -->
                    <div class="space-y-4">
                        <div id="noDataWarning" class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input
                                type="text"
                                id="loginId"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your ID"
                                disabled
                            />
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your password"
                                disabled
                            />
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button
                    onclick="app.handleLogin()"
                    class="w-full mt-6 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold"
                >
                    Login
                </button>
            </div>
        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üì§ Upload Data
            </button>
            <button onclick="app.setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                ‚öôÔ∏è Configure Slots
            </button>
            <button onclick="app.setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üõ†Ô∏è Admin Panel
            </button>
            <button onclick="app.publishToSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                üíæ Save to Database
            </button>
            <button onclick="app.setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîê Change Password
            </button>
            <button onclick="app.setActiveView('results')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìä View Results
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìÖ Place Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìã My Results
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
    </div>

    <!-- Scripts - Load at the end -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://wniqprjtwiyeqryplfdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduaXFwcmp0d2l5ZXFyeXBsZmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODc3NTAsImV4cCI6MjA4NDE2Mzc1MH0.sbfoW8pNmDauQQxFV97DUvvbNg0S1ls8AqkufRHnh70';
        
        // ==================== APP OBJECT ====================
        const app = {
            supabase: null,
            
            // ==================== STATE ====================
            state: {
                employees: [],
                employeePasswords: {},
                bids: [],
                biddingDeadline: '',
                biddingYear: 2026,
                isProcessed: false,
                activeView: 'login',
                selectedEmployeeId: '',
                verifiedEmployee: null,
                currentUser: null,
                userType: null,
                plannerPassword: 'admin123',
                results: [],
                selectedDepartment: 'all',
                slotCapacities: {},
                
                // Complete departments list
                departments: [
                    'L4/6-SA', 'L4/6-DEP-DM', 'L4/6-DEP-EFC', 'L3-DEP-DC', 'L3-DEP-TC',
                    'L5-LSS/SS', 'L5-DEP-DC', 'L3465-DEP-TCC', 'L3-DEP-DM', 'L5-DEP-DM',
                    'L46-DEP-TC', 'L3-DEP- LTSS/TSS', 'L5-DEP-GSM', 'L5-DEP-SC', 'L5-DEP- LTSS/TSS',
                    'L3-DEP-EFC', 'L3-DEP-GSM', 'L46-TA-T', 'L46-DEP- LTSS/TSS', 'L3-TA-T',
                    'L3-DS', 'L5-DEP-TC', 'L3-P&R', 'L5-DEP-EFC', 'L46-DEP-DC',
                    'L3-LSS/SS', 'L3-DEP-SC', 'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC',
                    'L46 SAMB', 'L5 SA', 'L3-SA', 'L3 SAMB', 'L5 - TA-T',
                    'L46-P&R', 'L5 SAMB', 'L46-AOCC'
                ],
                
                slotTypes: [
                    { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                    { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                    { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
                ],
                
                months: [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ],
                loginType: 'employee'
            },

            // ==================== SUPABASE FUNCTIONS ====================
            async initSupabase() {
                try {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Supabase init failed:', error);
                    return false;
                }
            },

            async loadFromSupabase() {
                if (!this.supabase) {
                    console.log('Supabase not initialized');
                    return false;
                }

                try {
                    this.updateSystemStatus('Loading from Supabase...');
                    
                    // Load employees
                    const { data: employees, error: empError } = await this.supabase
                        .from('employees')
                        .select('*');
                    
                    if (empError) throw empError;
                    
                    // Load bids (leave_requests)
                    const { data: bids, error: bidsError } = await this.supabase
                        .from('leave_requests')
                        .select('*');
                    
                    if (bidsError) console.warn('No bids found:', bidsError);
                    
                    // Load system config
                    const { data: config, error: configError } = await this.supabase
                        .from('system_config')
                        .select('*')
                        .single();
                    
                    if (configError && configError.code !== 'PGRST116') {
                        console.warn('Config error:', configError);
                    }
                    
                    // Update state
                    if (employees && employees.length > 0) {
                        this.state.employees = employees.map(emp => ({
                            id: emp.id,
                            name: emp.name,
                            seniorityDate: emp.seniority_date,
                            role: emp.role || '',
                            department: emp.department || 'Unassigned',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || ''
                        }));
                        
                        // Set default passwords
                        this.state.employees.forEach(emp => {
                            if (!this.state.employeePasswords[emp.id]) {
                                this.state.employeePasswords[emp.id] = emp.id;
                            }
                        });
                        
                        console.log(`‚úÖ Loaded ${this.state.employees.length} employees from Supabase`);
                    }
                    
                    if (bids && bids.length > 0) {
                        this.state.bids = bids.map(bid => ({
                            employeeId: bid.employee_id,
                            employeeName: this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                            seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                            department: this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                            slotType: bid.slot_type || 'slotA',
                            startDate: bid.start_date,
                            endDate: bid.end_date,
                            days: bid.days_requested,
                            timestamp: bid.created_at
                        }));
                        console.log(`‚úÖ Loaded ${this.state.bids.length} bids from Supabase`);
                    }
                    
                    if (config) {
                        this.state.biddingDeadline = config.bidding_deadline || '';
                        this.state.biddingYear = config.bidding_year || 2026;
                        this.state.isProcessed = config.is_processed || false;
                        this.state.plannerPassword = config.planner_password || 'admin123';
                        this.state.slotCapacities = config.slot_capacities || {};
                        this.state.results = config.results || [];
                        console.log('‚úÖ Loaded system config from Supabase');
                    }
                    
                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees loaded`);
                    this.renderLoginForm();
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Error loading from Supabase:', error);
                    this.updateSystemStatus('‚ö†Ô∏è Could not load from database');
                    return false;
                }
            },

            async publishToSupabase() {
                if (!this.supabase) {
                    alert('Supabase not connected');
                    return;
                }

                if (this.state.employees.length === 0) {
                    alert('‚ö†Ô∏è No employee data to save');
                    return;
                }

                if (!confirm('Save all data to Supabase database?')) return;

                try {
                    this.updateSystemStatus('Saving to Supabase...');
                    
                    // Save employees
                    const employeePromises = this.state.employees.map(async (emp) => {
                        const { error } = await this.supabase
                            .from('employees')
                            .upsert({
                                id: emp.id,
                                name: emp.name,
                                seniority_date: emp.seniorityDate,
                                role: emp.role,
                                department: emp.department,
                                gender: emp.gender,
                                nationality: emp.nationality,
                                email: emp.email,
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'id' });
                        
                        if (error) throw error;
                        return true;
                    });
                    
                    await Promise.all(employeePromises);
                    
                    // Save system config
                    const { error: configError } = await this.supabase
                        .from('system_config')
                        .upsert({
                            id: 1,
                            bidding_deadline: this.state.biddingDeadline,
                            bidding_year: this.state.biddingYear,
                            is_processed: this.state.isProcessed,
                            planner_password: this.state.plannerPassword,
                            slot_capacities: this.state.slotCapacities,
                            results: this.state.results,
                            last_updated: new Date().toISOString()
                        }, { onConflict: 'id' });
                    
                    if (configError) console.warn('Config save warning:', configError);
                    
                    // Save bids
                    if (this.state.bids.length > 0) {
                        const bidPromises = this.state.bids.map(async (bid) => {
                            const { error } = await this.supabase
                                .from('leave_requests')
                                .upsert({
                                    employee_id: bid.employeeId,
                                    start_date: bid.startDate,
                                    end_date: bid.endDate,
                                    days_requested: bid.days,
                                    status: 'pending',
                                    slot_type: bid.slotType,
                                    created_at: new Date().toISOString()
                                }, { onConflict: 'employee_id,slot_type,start_date' });
                            
                            if (error) throw error;
                            return true;
                        });
                        
                        await Promise.all(bidPromises);
                    }
                    
                    this.updateSystemStatus('‚úÖ All data saved to Supabase!');
                    setTimeout(() => this.updateSystemStatus('Ready'), 3000);
                    
                } catch (error) {
                    console.error('‚ùå Error saving to Supabase:', error);
                    this.updateSystemStatus('‚ùå Error saving to database');
                    alert('Error: ' + error.message);
                }
            },

            async syncWithSupabase() {
                this.updateSystemStatus('Syncing with Supabase...');
                
                // First try to load from Supabase
                const loaded = await this.loadFromSupabase();
                
                if (!loaded) {
                    // If Supabase fails, try localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('‚ö†Ô∏è No data found locally or in database');
                    }
                }
                
                this.renderLoginForm();
            },

            // ==================== UTILITY FUNCTIONS ====================
            saveState() {
                try {
                    localStorage.setItem('employees', JSON.stringify(this.state.employees));
                    localStorage.setItem('employeePasswords', JSON.stringify(this.state.employeePasswords));
                    localStorage.setItem('bids', JSON.stringify(this.state.bids));
                    localStorage.setItem('biddingDeadline', this.state.biddingDeadline);
                    localStorage.setItem('biddingYear', this.state.biddingYear.toString());
                    localStorage.setItem('isProcessed', JSON.stringify(this.state.isProcessed));
                    localStorage.setItem('plannerPassword', this.state.plannerPassword);
                    localStorage.setItem('results', JSON.stringify(this.state.results));
                    localStorage.setItem('slotCapacities', JSON.stringify(this.state.slotCapacities));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('employees');
                    if (saved) {
                        this.state.employees = JSON.parse(saved);
                        this.state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords') || '{}');
                        this.state.bids = JSON.parse(localStorage.getItem('bids') || '[]');
                        this.state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                        this.state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                        this.state.isProcessed = JSON.parse(localStorage.getItem('isProcessed') || 'false');
                        this.state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                        this.state.results = JSON.parse(localStorage.getItem('results') || '[]');
                        this.state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities') || '{}');
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
                return false;
            },

            updateSystemStatus(message) {
                const el = document.getElementById('systemStatus');
                if (el) el.textContent = message;
            },

            // ==================== VIEW FUNCTIONS ====================
            setLoginType(type) {
                console.log('Setting login type to:', type);
                this.state.loginType = type;
                
                const empBtn = document.querySelector('[onclick*="employee"]');
                const planBtn = document.querySelector('[onclick*="planner"]');
                
                if (type === 'employee') {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                } else {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-purple-500 text-white';
                }
                
                this.renderLoginForm();
            },

            renderLoginForm() {
                const form = document.getElementById('loginForm');
                if (!form) return;
                
                if (this.state.loginType === 'planner') {
                    form.innerHTML = `
                        <div>
                            <label class="block font-semibold mb-2">Planner Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                placeholder="Enter planner password"
                                value="admin123"
                            />
                            <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded">
                                <p class="text-sm font-semibold text-purple-800">üîë Default Planner Password:</p>
                                <p class="text-lg font-mono font-bold text-purple-900 mt-1">admin123</p>
                            </div>
                        </div>
                    `;
                } else {
                    const hasData = this.state.employees.length > 0;
                    const testId = hasData ? this.state.employees[0].id : '';
                    
                    form.innerHTML = `
                        <div class="space-y-4">
                            ${!hasData ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                    <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                                </div>
                            ` : ''}
                            <div>
                                <label class="block font-semibold mb-2">Employee ID:</label>
                                <input
                                    type="text"
                                    id="loginId"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your ID"
                                    value="${testId}"
                                    ${!hasData ? 'disabled' : ''}
                                />
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your password"
                                    value="${testId}"
                                    ${!hasData ? 'disabled' : ''}
                                />
                                <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                    <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                    <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            handleLogin() {
                if (this.state.loginType === 'planner') {
                    const input = document.getElementById('loginPassword');
                    const password = input ? input.value : '';
                    
                    if (password === this.state.plannerPassword) {
                        this.state.currentUser = { name: 'Planner Admin' };
                        this.state.userType = 'planner';
                        this.state.activeView = 'upload';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('plannerNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = 'Planner Admin';
                        document.getElementById('userTypeBadge').textContent = 'Planner';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800';
                        
                        this.renderView();
                        alert('‚úÖ Welcome, Planner!');
                    } else {
                        alert('‚ùå Incorrect planner password. Try: admin123');
                    }
                } else {
                    const idInput = document.getElementById('loginId');
                    const passInput = document.getElementById('loginPassword');
                    
                    const id = idInput ? idInput.value : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!id || !password) {
                        alert('‚ö†Ô∏è Please enter both ID and password');
                        return;
                    }
                    
                    const employee = this.state.employees.find(e => e.id === id);
                    if (!employee) {
                        alert('‚ùå Employee ID not found. Please upload data first.');
                        return;
                    }
                    
                    const storedPass = this.state.employeePasswords[id] || id;
                    if (password === storedPass) {
                        this.state.currentUser = employee;
                        this.state.userType = 'employee';
                        this.state.verifiedEmployee = employee;
                        this.state.activeView = 'employee';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('employeeNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = employee.name;
                        document.getElementById('userTypeBadge').textContent = 'Employee';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
                        
                        this.renderView();
                        alert(`‚úÖ Welcome, ${employee.name}!`);
                    } else {
                        alert(`‚ùå Incorrect password. Try: ${id}`);
                    }
                }
            },

            handleLogout() {
                this.state.currentUser = null;
                this.state.userType = null;
                this.state.verifiedEmployee = null;
                this.state.activeView = 'login';
                
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('plannerNav').classList.add('hidden');
                document.getElementById('employeeNav').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
                
                this.renderLoginForm();
            },

            setActiveView(view) {
                console.log('Setting view to:', view);
                this.state.activeView = view;
                this.renderView();
            },

            renderView() {
                const content = document.getElementById('contentArea');
                if (!content) return;
                
                content.innerHTML = '';
                
                switch(this.state.activeView) {
                    case 'upload':
                        this.renderUploadView();
                        break;
                    case 'configureSlots':
                        this.renderConfigureSlotsView();
                        break;
                    case 'admin':
                        this.renderAdminView();
                        break;
                    case 'employee':
                        this.renderEmployeeBiddingView();
                        break;
                    case 'myResults':
                        this.renderMyResultsView();
                        break;
                    case 'results':
                        this.renderResultsView();
                        break;
                    case 'changePassword':
                        this.renderChangePasswordView();
                        break;
                    case 'changePlannerPassword':
                        this.renderChangePlannerPasswordView();
                        break;
                }
                
                this.saveState();
            },

            // ==================== VIEW RENDERING ====================
            renderUploadView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                                <select
                                    id="biddingYearSelect"
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    ${this.state.isProcessed || this.state.bids.length > 0 ? 'disabled' : ''}
                                >
                                    ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                        <option value="${year}" ${year === this.state.biddingYear ? 'selected' : ''}>${year}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                            <p class="text-gray-600 mb-6">
                                Upload an Excel file with employee information. The file should have columns like:
                                "Personnel number", "Name", "Seniority Date", "Department", etc.
                            </p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4">
                                <p class="mb-4 text-gray-600">
                                    Drag and drop your Excel file here or click to browse
                                </p>
                                <label class="cursor-pointer">
                                    <input
                                        type="file"
                                        id="excelFile"
                                        accept=".xlsx,.xls"
                                        class="hidden"
                                        onchange="app.handleFileUpload(event)"
                                    />
                                    <span class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 inline-block">
                                        üìÅ Browse Files
                                    </span>
                                </label>
                            </div>

                            ${this.state.employees.length > 0 ? `
                                <div class="mt-6">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span class="text-green-800 font-semibold">
                                            ‚úì ${this.state.employees.length} employees loaded for ${this.state.biddingYear}
                                        </span>
                                        <div class="text-xs text-green-600 mt-1">
                                            Departments found: ${[...new Set(this.state.employees.map(e => e.department || 'Unassigned'))].join(', ')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Add year select listener
                const yearSelect = document.getElementById('biddingYearSelect');
                if (yearSelect) {
                    yearSelect.addEventListener('change', (e) => {
                        this.state.biddingYear = parseInt(e.target.value);
                    });
                }
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    alert('Please upload a valid Excel file (.xlsx or .xls)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        console.log('Excel data loaded:', jsonData.length, 'rows');
                        
                        // Process data - more robust parsing
                        const employees = jsonData.map((row, idx) => {
                            // Find ID from common column names
                            let id = '';
                            const idColumns = ['Personnel number', 'Personnel Number', 'Personnel_number', 
                                              'Personnelnumber', 'ID', 'id', 'EmployeeID', 'Employee ID', 
                                              'Employee No', 'Employee Number'];
                            
                            for (const col of idColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    id = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // Find name from common column names
                            let name = '';
                            const nameColumns = ['Name', 'Employee Name', 'Full Name', 
                                                'FORENAME SURNAME', 'Forename Surname'];
                            
                            for (const col of nameColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    name = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // If name not found, try forename + surname
                            if (!name) {
                                const forename = row['Forename'] || row['FORENAME'] || '';
                                const surname = row['Surname'] || row['SURNAME'] || '';
                                name = `${forename} ${surname}`.trim();
                            }
                            
                            // Find department
                            let department = '';
                            const deptColumns = ['Department', 'Scheduling row', 'Scheduling_row', 
                                               'SchedulingRow', 'DEPARTMENT'];
                            
                            for (const col of deptColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    department = String(row[col]).trim();
                                    // Clean up department name
                                    department = department.split('.')[0].trim();
                                    break;
                                }
                            }
                            
                            // Find seniority date
                            let seniorityDate = '';
                            const dateColumns = ['Seniority Date', 'SeniorityDate', 'seniorityDate',
                                                'Start of staff membership', 'Start_of_staff_membership',
                                                'Start Date', 'StartDate', 'Joining Date', 'JoiningDate'];
                            
                            for (const col of dateColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    const dateVal = row[col];
                                    if (typeof dateVal === 'number') {
                                        // Excel date number
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                                        seniorityDate = jsDate.toISOString();
                                    } else {
                                        // String date
                                        const jsDate = new Date(dateVal);
                                        if (!isNaN(jsDate.getTime())) {
                                            seniorityDate = jsDate.toISOString();
                                        }
                                    }
                                    break;
                                }
                            }
                            
                            // If no date found, use default
                            if (!seniorityDate) {
                                seniorityDate = new Date('2020-01-01').toISOString();
                            }
                            
                            // Use default ID if none found
                            if (!id) {
                                id = `EMP${idx + 1000}`;
                            }
                            
                            // Use default name if none found
                            if (!name) {
                                name = `Employee ${idx + 1}`;
                            }
                            
                            // Use default department if none found
                            if (!department) {
                                department = 'Unassigned';
                            }
                            
                            return {
                                id: id,
                                name: name,
                                seniorityDate: seniorityDate,
                                department: department,
                                role: row['Role'] || row['Position'] || row['Job Title'] || '',
                                gender: row['Gender'] || row['gender'] || '',
                                nationality: row['Nationality'] || row['nationality'] || ''
                            };
                        }).filter(emp => emp.id && emp.name); // Remove empty rows
                        
                        if (employees.length > 0) {
                            this.state.employees = employees;
                            employees.forEach(emp => {
                                this.state.employeePasswords[emp.id] = emp.id;
                            });
                            
                            this.saveState();
                            
                            // Show summary of departments found
                            const departmentsFound = [...new Set(employees.map(e => e.department))];
                            const message = `‚úÖ Successfully loaded ${employees.length} employees\n\n` +
                                          `Departments found (${departmentsFound.length}):\n` +
                                          departmentsFound.join(', ');
                            
                            alert(message);
                            this.renderUploadView();
                            this.renderLoginForm(); // Update login form with new IDs
                        } else {
                            alert('‚ö†Ô∏è No valid employee data found in the file. Please check the format.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error processing Excel file. Please check the format and try again.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            renderConfigureSlotsView() {
                const content = document.getElementById('contentArea');
                
                // Get all unique departments from employees AND the predefined list
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = [...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">Configure Slot Capacities for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Set how many employees can take leave in each month per department.
                                Each month has 3 slots: A (15 days), B (15 days), C (20 days)
                            </p>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <p class="font-semibold text-blue-800 mb-2">üìä Summary:</p>
                                <p class="text-sm text-blue-700">
                                    ‚Ä¢ Total departments in system: ${allDepartments.length}<br>
                                    ‚Ä¢ Departments with employees: ${employeeDepts.length}<br>
                                    ‚Ä¢ Departments from predefined list: ${this.state.departments.length}
                                </p>
                            </div>
                            
                            ${allDepartments.length === 0 ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-6 text-center">
                                    <p class="text-lg font-semibold">No departments found!</p>
                                    <p class="mt-2">Please upload employee data first.</p>
                                    <button onclick="app.setActiveView('upload')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                        ‚Üê Go to Upload Data
                                    </button>
                                </div>
                            ` : `
                                <div class="space-y-6 max-h-[70vh] overflow-y-auto p-2">
                                    ${allDepartments.map(dept => {
                                        const hasEmployees = employeeDepts.includes(dept);
                                        const isPredefined = this.state.departments.includes(dept);
                                        const employeeCount = this.state.employees.filter(e => (e.department || 'Unassigned') === dept).length;
                                        
                                        return `
                                            <div class="border rounded-lg p-4 ${hasEmployees ? 'bg-white' : 'bg-gray-50'}">
                                                <div class="flex justify-between items-center mb-3">
                                                    <div>
                                                        <h3 class="font-bold text-lg">${dept}</h3>
                                                        <div class="flex gap-2 mt-1">
                                                            ${hasEmployees ? 
                                                                `<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">${employeeCount} employees</span>` : 
                                                                `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">No employees</span>`
                                                            }
                                                            ${isPredefined ? 
                                                                `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">Predefined</span>` : 
                                                                `<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded">From Excel</span>`
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        Slots per month:
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div class="bg-green-50 border border-green-300 rounded p-3">
                                                        <div class="flex items-center justify-between mb-2">
                                                            <span class="font-semibold text-green-800">Slot A (15 days)</span>
                                                        </div>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="100"
                                                            data-dept="${dept}"
                                                            data-slot="A"
                                                            class="slot-input w-full px-3 py-2 border-2 border-green-400 rounded-lg text-center text-lg"
                                                            placeholder="5"
                                                        />
                                                        <p class="text-xs text-gray-500 mt-1">Per month, per department</p>
                                                    </div>
                                                    
                                                    <div class="bg-blue-50 border border-blue-300 rounded p-3">
                                                        <div class="flex items-center justify-between mb-2">
                                                            <span class="font-semibold text-blue-800">Slot B (15 days)</span>
                                                        </div>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="100"
                                                            data-dept="${dept}"
                                                            data-slot="B"
                                                            class="slot-input w-full px-3 py-2 border-2 border-blue-400 rounded-lg text-center text-lg"
                                                            placeholder="5"
                                                        />
                                                        <p class="text-xs text-gray-500 mt-1">Per month, per department</p>
                                                    </div>
                                                    
                                                    <div class="bg-purple-50 border border-purple-300 rounded p-3">
                                                        <div class="flex items-center justify-between mb-2">
                                                            <span class="font-semibold text-purple-800">Slot C (20 days)</span>
                                                        </div>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="100"
                                                            data-dept="${dept}"
                                                            data-slot="C"
                                                            class="slot-input w-full px-3 py-2 border-2 border-purple-400 rounded-lg text-center text-lg"
                                                            placeholder="5"
                                                        />
                                                        <p class="text-xs text-gray-500 mt-1">Per month, per department</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-6 flex gap-3">
                                    <button onclick="app.saveSlotConfiguration()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold">
                                        üíæ Save All Slot Configurations
                                    </button>
                                    <button onclick="app.setActiveView('upload')" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold">
                                        ‚Üê Back
                                    </button>
                                </div>
                                
                                <div class="mt-4 text-xs text-gray-500">
                                    <p>üí° <strong>Note:</strong> These slot capacities will be applied to ALL months. Each department can have different capacities for each slot type.</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                // Set initial values from state
                setTimeout(() => {
                    document.querySelectorAll('.slot-input').forEach(input => {
                        const dept = input.dataset.dept;
                        const slot = input.dataset.slot;
                        // Try to get value from January as default for all months
                        const key = `January-${dept}-${slot}`;
                        input.value = this.state.slotCapacities[key] || 5;
                    });
                }, 100);
            },

            saveSlotConfiguration() {
                const inputs = document.querySelectorAll('.slot-input');
                inputs.forEach(input => {
                    const dept = input.dataset.dept;
                    const slot = input.dataset.slot;
                    const value = parseInt(input.value) || 5;
                    
                    // Set for ALL months
                    this.state.months.forEach(month => {
                        const key = `${month}-${dept}-${slot}`;
                        this.state.slotCapacities[key] = value;
                    });
                });
                
                this.saveState();
                
                // Calculate totals
                const totalSlots = Object.values(this.state.slotCapacities).reduce((sum, val) => sum + val, 0);
                const uniqueDepts = [...new Set(Object.keys(this.state.slotCapacities).map(k => k.split('-')[1]))];
                
                alert(`‚úÖ Slot capacities saved!\n\n` +
                      `‚Ä¢ Configured for: ${uniqueDepts.length} departments\n` +
                      `‚Ä¢ Total slot positions: ${totalSlots}\n` +
                      `‚Ä¢ Applied to all 12 months`);
                
                this.setActiveView('admin');
            },

            renderAdminView() {
                const content = document.getElementById('contentArea');
                const allDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const depts = ['all', ...allDepts].sort();
                
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <label class="block font-semibold mb-2">Set Bidding Deadline:</label>
                                <input
                                    type="datetime-local"
                                    id="biddingDeadline"
                                    value="${this.state.biddingDeadline}"
                                    class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg"
                                    onchange="app.state.biddingDeadline = this.value; app.saveState()"
                                />
                            </div>

                            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="adminDeptFilter"
                                    class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    onchange="app.state.selectedDepartment = this.value;"
                                >
                                    ${depts.map(dept => `
                                        <option value="${dept}" ${dept === this.state.selectedDepartment ? 'selected' : ''}>
                                            ${dept === 'all' ? 'All Departments' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.employees.length}</p>
                                    <p class="text-sm text-gray-600">Total Employees</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.bids.length}</p>
                                    <p class="text-sm text-gray-600">Total Bids</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${new Set(this.state.bids.map(b => b.employeeId)).size}</p>
                                    <p class="text-sm text-gray-600">Employees Who Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.isProcessed ? 'Yes' : 'No'}</p>
                                    <p class="text-sm text-gray-600">Processed</p>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <button
                                    onclick="app.processBids()"
                                    ${this.state.isProcessed || this.state.employees.length === 0 ? 'disabled' : ''}
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold ${this.state.isProcessed ? 'opacity-50' : ''}"
                                >
                                    ${this.state.isProcessed ? '‚úÖ Bids Already Processed' : 'üöÄ Process All Bids'}
                                </button>
                                
                                ${this.state.isProcessed ? `
                                    <button onclick="app.exportResults()" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-semibold">
                                        üìä Export Results to Excel
                                    </button>
                                ` : ''}
                                
                                <button onclick="app.resetSystem()" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg font-semibold">
                                    üîÑ Reset System
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">System Information</h3>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>‚Ä¢ Departments: ${allDepts.length}</p>
                                    <p>‚Ä¢ Slot capacities configured: ${Object.keys(this.state.slotCapacities).length > 0 ? 'Yes' : 'No'}</p>
                                    <p>‚Ä¢ Bidding year: ${this.state.biddingYear}</p>
                                    <p>‚Ä¢ Last sync: ${this.state.employees.length > 0 ? 'Data loaded' : 'No data'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ==================== OTHER FUNCTIONS ====================
            async processBids() {
                if (this.state.employees.length === 0) {
                    alert('No employees to process. Please upload data first.');
                    return;
                }
                
                if (Object.keys(this.state.slotCapacities).length === 0) {
                    alert('Please configure slot capacities first in "Configure Slots".');
                    this.setActiveView('configureSlots');
                    return;
                }
                
                // Simple processing logic for demo
                this.state.results = this.state.employees.map((emp, idx) => {
                    // Simple assignment logic
                    const slotIndex = idx % 3;
                    const slot = this.state.slotTypes[slotIndex];
                    const monthIndex = Math.floor(idx / (this.state.employees.length / 12)) % 12;
                    const month = this.state.months[monthIndex];
                    
                    const startDate = new Date(this.state.biddingYear, monthIndex, 1);
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + slot.days - 1);
                    
                    return {
                        employeeId: emp.id,
                        employeeName: emp.name,
                        department: emp.department || 'Unassigned',
                        slotName: slot.name,
                        slotType: slot.id,
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0],
                        days: slot.days,
                        type: idx % 2 === 0 ? 'Bid Awarded' : 'Auto-Assigned',
                        month: month,
                        seniorityRank: idx + 1
                    };
                });
                
                this.state.isProcessed = true;
                this.saveState();
                
                alert(`‚úÖ Successfully processed ${this.state.results.length} employees!\n\n` +
                      `‚Ä¢ Bid Awards: ${this.state.results.filter(r => r.type === 'Bid Awarded').length}\n` +
                      `‚Ä¢ Auto-Assigned: ${this.state.results.filter(r => r.type === 'Auto-Assigned').length}\n\n` +
                      `Go to "View Results" to see assignments.`);
                
                this.renderAdminView();
            },

            exportResults() {
                if (this.state.results.length === 0) {
                    alert('No results to export');
                    return;
                }
                
                // Create Excel workbook
                const wsData = [
                    ['Seniority Rank', 'Employee ID', 'Employee Name', 'Department', 'Slot Type', 
                     'Month', 'Start Date', 'End Date', 'Days', 'Assignment Type']
                ];
                
                this.state.results.forEach(result => {
                    wsData.push([
                        result.seniorityRank,
                        result.employeeId,
                        result.employeeName,
                        result.department,
                        result.slotName,
                        result.month,
                        result.startDate,
                        result.endDate,
                        result.days,
                        result.type
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Leave Assignments');
                XLSX.writeFile(wb, `Leave_Assignments_${this.state.biddingYear}.xlsx`);
                
                alert('‚úÖ Results exported to Excel file!');
            },

            resetSystem() {
                if (confirm('‚ö†Ô∏è WARNING: This will reset ALL data including employees, bids, and results. Continue?')) {
                    localStorage.clear();
                    this.state.employees = [];
                    this.state.bids = [];
                    this.state.results = [];
                    this.state.isProcessed = false;
                    this.state.slotCapacities = {};
                    this.state.currentUser = null;
                    this.state.userType = null;
                    this.state.activeView = 'login';
                    
                    // Reset UI
                    document.getElementById('userInfo').classList.add('hidden');
                    document.getElementById('plannerNav').classList.add('hidden');
                    document.getElementById('employeeNav').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                    
                    this.updateSystemStatus('System reset');
                    this.renderLoginForm();
                    
                    alert('‚úÖ System has been completely reset!');
                }
            },

            // ==================== OTHER VIEWS ====================
            renderEmployeeBiddingView() {
                const content = document.getElementById('contentArea');
                const userBids = this.state.bids.filter(b => b.employeeId === this.state.verifiedEmployee?.id);
                
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4">Leave Bidding for ${this.state.biddingYear}</h2>
                            <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                                <p class="font-semibold text-blue-800">Welcome, ${this.state.verifiedEmployee?.name}!</p>
                                <p class="text-sm text-blue-700 mt-2">Employee ID: ${this.state.verifiedEmployee?.id}</p>
                                <p class="text-sm text-blue-700">Department: ${this.state.verifiedEmployee?.department || 'Not specified'}</p>
                            </div>
                            
                            ${userBids.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <p>No bids placed yet</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${userBids.map(bid => `
                                        <div class="p-4 rounded-lg border-2 border-blue-300 bg-blue-50">
                                            <p class="font-bold">${bid.slotType || 'Slot'}</p>
                                            <p class="text-sm">${bid.startDate} to ${bid.endDate}</p>
                                            <p class="text-sm font-semibold">${bid.days} days</p>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h3 class="text-xl font-bold mb-4">Place New Bid</h3>
                            <p class="text-gray-600 mb-4">Bidding interface would appear here...</p>
                        </div>
                    </div>
                `;
            },

            renderMyResultsView() {
                const content = document.getElementById('contentArea');
                const myResults = this.state.results.filter(r => r.employeeId === this.state.verifiedEmployee?.id);
                
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">My Leave Assignment</h2>
                            
                            ${myResults.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results available yet.</p>
                                    ${this.state.isProcessed ? '' : '<p class="text-sm mt-2">Bids have not been processed yet.</p>'}
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${myResults.map(result => `
                                        <div class="border border-gray-200 rounded p-4">
                                            <p class="font-bold text-lg">${result.slotName}</p>
                                            <p class="text-sm text-gray-600">${result.startDate} to ${result.endDate}</p>
                                            <p class="text-sm font-semibold">${result.days} days</p>
                                            <span class="px-2 py-1 rounded text-xs ${result.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                ${result.type}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderResultsView() {
                const content = document.getElementById('contentArea');
                
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">Results for ${this.state.biddingYear}</h2>
                            
                            ${this.state.results.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results yet. Process bids first.</p>
                                    <button onclick="app.setActiveView('admin')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                        Go to Admin Panel
                                    </button>
                                </div>
                            ` : `
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">Rank</th>
                                                <th class="p-3">Employee</th>
                                                <th class="p-3">Department</th>
                                                <th class="p-3">Slot</th>
                                                <th class="p-3">Month</th>
                                                <th class="p-3">Dates</th>
                                                <th class="p-3">Days</th>
                                                <th class="p-3">Type</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${this.state.results.map(r => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="p-3">#${r.seniorityRank}</td>
                                                    <td class="p-3">${r.employeeName}<br><span class="text-xs text-gray-500">${r.employeeId}</span></td>
                                                    <td class="p-3">${r.department}</td>
                                                    <td class="p-3">${r.slotName}</td>
                                                    <td class="p-3">${r.month}</td>
                                                    <td class="p-3">${r.startDate} to ${r.endDate}</td>
                                                    <td class="p-3">${r.days}</td>
                                                    <td class="p-3">
                                                        <span class="px-2 py-1 rounded text-xs ${r.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                            ${r.type}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderChangePasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderChangePlannerPasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Planner Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ==================== INITIALIZATION ====================
            async init() {
                console.log('App initializing...');
                this.updateSystemStatus('Initializing...');
                
                // Initialize Supabase
                const supabaseReady = await this.initSupabase();
                if (supabaseReady) {
                    this.updateSystemStatus('Connected to Supabase');
                    
                    // Try to load from Supabase first
                    setTimeout(async () => {
                        await this.loadFromSupabase();
                    }, 500);
                } else {
                    // Fallback to localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('Ready - No data loaded');
                    }
                }
                
                this.renderLoginForm();
                
                // Add Enter key support
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && this.state.activeView === 'login') {
                        this.handleLogin();
                    }
                });
                
                console.log('App ready');
            }
        };

        // Initialize when page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>
