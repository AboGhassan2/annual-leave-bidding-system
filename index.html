<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                Annual Leave Bidding System
            </h1>
            <div id="userInfo" class="hidden flex justify-center items-center gap-4 mt-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span class="text-sm text-gray-600">Logged in as: </span>
                    <span id="currentUserName" class="font-semibold"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button
                    onclick="app.handleLogout()"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                >
                    Logout
                </button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="max-w-md mx-auto mt-10">
            <div class="bg-white rounded-xl shadow-xl p-8">
                <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
                    Annual Leave Bidding System
                </h1>
                
                <div class="mb-4 text-center">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                        <p class="text-sm font-semibold text-blue-800">System Status:</p>
                        <p id="systemStatus" class="text-xs text-blue-700">Initializing...</p>
                    </div>
                    
                    <button onclick="app.syncWithSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-semibold mb-4">
                        üîÑ Sync with Database
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-3">Login As:</label>
                    <div class="flex gap-4">
                        <button
                            onclick="app.setLoginType('employee')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white"
                        >
                            Employee
                        </button>
                        <button
                            onclick="app.setLoginType('planner')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300"
                        >
                            Planner
                        </button>
                    </div>
                </div>

                <div id="loginForm">
                    <!-- Default employee login form -->
                    <div class="space-y-4">
                        <div id="noDataWarning" class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input
                                type="text"
                                id="loginId"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your ID"
                                disabled
                            />
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your password"
                                disabled
                            />
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button
                    onclick="app.handleLogin()"
                    class="w-full mt-6 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold"
                >
                    Login
                </button>
            </div>
        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üì§ Upload Data
            </button>
            <button onclick="app.setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                ‚öôÔ∏è Configure Slots
            </button>
            <button onclick="app.setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üõ†Ô∏è Admin Panel
            </button>
            <button onclick="app.publishToSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                üíæ Save to Database
            </button>
            <button onclick="app.setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîê Change Password
            </button>
            <button onclick="app.setActiveView('results')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìä View Results
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìÖ Place Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìã My Results
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
    </div>

    <!-- Scripts - Load at the end -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://wniqprjtwiyeqryplfdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduaXFwcmp0d2l5ZXFyeXBsZmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODc3NTAsImV4cCI6MjA4NDE2Mzc1MH0.sbfoW8pNmDauQQxFV97DUvvbNg0S1ls8AqkufRHnh70';
        
        // ==================== APP OBJECT ====================
        const app = {
            supabase: null,
            
            // ==================== STATE ====================
            state: {
                employees: [],
                employeePasswords: {},
                bids: [],
                biddingDeadline: '',
                biddingYear: 2026,
                isProcessed: false,
                activeView: 'login',
                selectedEmployeeId: '',
                verifiedEmployee: null,
                currentUser: null,
                userType: null,
                plannerPassword: 'admin123',
                results: [],
                selectedDepartment: 'all',
                slotCapacities: {},
                
                // Complete departments list
                departments: [
                    'L4/6-SA', 'L4/6-DEP-DM', 'L4/6-DEP-EFC', 'L3-DEP-DC', 'L3-DEP-TC',
                    'L5-LSS/SS', 'L5-DEP-DC', 'L3465-DEP-TCC', 'L3-DEP-DM', 'L5-DEP-DM',
                    'L46-DEP-TC', 'L3-DEP- LTSS/TSS', 'L5-DEP-GSM', 'L5-DEP-SC', 'L5-DEP- LTSS/TSS',
                    'L3-DEP-EFC', 'L3-DEP-GSM', 'L46-TA-T', 'L46-DEP- LTSS/TSS', 'L3-TA-T',
                    'L3-DS', 'L5-DEP-TC', 'L3-P&R', 'L5-DEP-EFC', 'L46-DEP-DC',
                    'L3-LSS/SS', 'L3-DEP-SC', 'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC',
                    'L46 SAMB', 'L5 SA', 'L3-SA', 'L3 SAMB', 'L5 - TA-T',
                    'L46-P&R', 'L5 SAMB', 'L46-AOCC'
                ],
                
                slotTypes: [
                    { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                    { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                    { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
                ],
                
                months: [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ],
                loginType: 'employee'
            },

            // ==================== SUPABASE FUNCTIONS ====================
            async initSupabase() {
                try {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Supabase init failed:', error);
                    return false;
                }
            },

            async loadFromSupabase() {
                if (!this.supabase) {
                    console.log('Supabase not initialized');
                    return false;
                }

                try {
                    this.updateSystemStatus('Loading from Supabase...');
                    
                    // FIX FOR 1000 STAFF LIMIT: Use range queries with pagination
                    console.log('Loading employees with pagination to avoid 1000 limit...');
                    let allEmployees = [];
                    let from = 0;
                    const batchSize = 1000;
                    let hasMore = true;

                    // Load employees with pagination
                    while (hasMore) {
                        const { data: employeesBatch, error: empError } = await this.supabase
                            .from('employees')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        
                        if (empError) throw empError;
                        
                        if (employeesBatch && employeesBatch.length > 0) {
                            allEmployees = [...allEmployees, ...employeesBatch];
                            hasMore = employeesBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load bids (leave_requests)
                    let allBids = [];
                    from = 0;
                    hasMore = true;
                    
                    while (hasMore) {
                        const { data: bidsBatch, error: bidsError } = await this.supabase
                            .from('leave_requests')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        
                        if (bidsError) {
                            if (bidsError.code !== 'PGRST116') {
                                console.warn('No bids found or error:', bidsError);
                            }
                            hasMore = false;
                        } else if (bidsBatch && bidsBatch.length > 0) {
                            allBids = [...allBids, ...bidsBatch];
                            hasMore = bidsBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load system config
                    const { data: config, error: configError } = await this.supabase
                        .from('system_config')
                        .select('*')
                        .single();
                    
                    if (configError && configError.code !== 'PGRST116') {
                        console.warn('Config error:', configError);
                    }
                    
                    // Update state
                    if (allEmployees && allEmployees.length > 0) {
                        this.state.employees = allEmployees.map(emp => ({
                            id: emp.id,
                            name: emp.name,
                            seniorityDate: emp.seniority_date,
                            role: emp.role || '',
                            department: emp.department || 'Unassigned',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || ''
                        }));
                        
                        // Set default passwords
                        this.state.employees.forEach(emp => {
                            if (!this.state.employeePasswords[emp.id]) {
                                this.state.employeePasswords[emp.id] = emp.id;
                            }
                        });
                        
                        console.log(`‚úÖ Loaded ${this.state.employees.length} employees from Supabase (with pagination)`);
                    }
                    
                    if (allBids && allBids.length > 0) {
                        this.state.bids = allBids.map(bid => ({
                            employeeId: bid.employee_id,
                            employeeName: this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                            seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                            department: this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                            slotType: bid.slot_type || 'slotA',
                            startDate: bid.start_date,
                            endDate: bid.end_date,
                            days: bid.days_requested,
                            timestamp: bid.created_at
                        }));
                        console.log(`‚úÖ Loaded ${this.state.bids.length} bids from Supabase (with pagination)`);
                    }
                    
                    if (config) {
                        this.state.biddingDeadline = config.bidding_deadline || '';
                        this.state.biddingYear = config.bidding_year || 2026;
                        this.state.isProcessed = config.is_processed || false;
                        this.state.plannerPassword = config.planner_password || 'admin123';
                        this.state.slotCapacities = config.slot_capacities || {};
                        this.state.results = config.results || [];
                        console.log('‚úÖ Loaded system config from Supabase');
                    }
                    
                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees loaded`);
                    this.renderLoginForm();
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Error loading from Supabase:', error);
                    this.updateSystemStatus('‚ö†Ô∏è Could not load from database');
                    return false;
                }
            },

            async publishToSupabase() {
                if (!this.supabase) {
                    alert('Supabase not connected');
                    return;
                }

                if (this.state.employees.length === 0) {
                    alert('‚ö†Ô∏è No employee data to save');
                    return;
                }

                if (!confirm('Save all data to Supabase database?')) return;

                try {
                    this.updateSystemStatus('Saving to Supabase...');
                    
                    // Save employees
                    const employeePromises = this.state.employees.map(async (emp) => {
                        const { error } = await this.supabase
                            .from('employees')
                            .upsert({
                                id: emp.id,
                                name: emp.name,
                                seniority_date: emp.seniorityDate,
                                role: emp.role,
                                department: emp.department,
                                gender: emp.gender,
                                nationality: emp.nationality,
                                email: emp.email,
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'id' });
                        
                        if (error) throw error;
                        return true;
                    });
                    
                    await Promise.all(employeePromises);
                    
                    // Save system config
                    const { error: configError } = await this.supabase
                        .from('system_config')
                        .upsert({
                            id: 1,
                            bidding_deadline: this.state.biddingDeadline,
                            bidding_year: this.state.biddingYear,
                            is_processed: this.state.isProcessed,
                            planner_password: this.state.plannerPassword,
                            slot_capacities: this.state.slotCapacities,
                            results: this.state.results,
                            last_updated: new Date().toISOString()
                        }, { onConflict: 'id' });
                    
                    if (configError) console.warn('Config save warning:', configError);
                    
                    // Save bids
                    if (this.state.bids.length > 0) {
                        const bidPromises = this.state.bids.map(async (bid) => {
                            const { error } = await this.supabase
                                .from('leave_requests')
                                .upsert({
                                    employee_id: bid.employeeId,
                                    start_date: bid.startDate,
                                    end_date: bid.endDate,
                                    days_requested: bid.days,
                                    status: 'pending',
                                    slot_type: bid.slotType,
                                    created_at: new Date().toISOString()
                                }, { onConflict: 'employee_id,slot_type,start_date' });
                            
                            if (error) throw error;
                            return true;
                        });
                        
                        await Promise.all(bidPromises);
                    }
                    
                    this.updateSystemStatus('‚úÖ All data saved to Supabase!');
                    setTimeout(() => this.updateSystemStatus('Ready'), 3000);
                    
                } catch (error) {
                    console.error('‚ùå Error saving to Supabase:', error);
                    this.updateSystemStatus('‚ùå Error saving to database');
                    alert('Error: ' + error.message);
                }
            },

            async syncWithSupabase() {
                this.updateSystemStatus('Syncing with Supabase...');
                
                // First try to load from Supabase
                const loaded = await this.loadFromSupabase();
                
                if (!loaded) {
                    // If Supabase fails, try localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('‚ö†Ô∏è No data found locally or in database');
                    }
                }
                
                this.renderLoginForm();
            },

            // ==================== UTILITY FUNCTIONS ====================
            saveState() {
                try {
                    localStorage.setItem('employees', JSON.stringify(this.state.employees));
                    localStorage.setItem('employeePasswords', JSON.stringify(this.state.employeePasswords));
                    localStorage.setItem('bids', JSON.stringify(this.state.bids));
                    localStorage.setItem('biddingDeadline', this.state.biddingDeadline);
                    localStorage.setItem('biddingYear', this.state.biddingYear.toString());
                    localStorage.setItem('isProcessed', JSON.stringify(this.state.isProcessed));
                    localStorage.setItem('plannerPassword', this.state.plannerPassword);
                    localStorage.setItem('results', JSON.stringify(this.state.results));
                    localStorage.setItem('slotCapacities', JSON.stringify(this.state.slotCapacities));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('employees');
                    if (saved) {
                        this.state.employees = JSON.parse(saved);
                        this.state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords') || '{}');
                        this.state.bids = JSON.parse(localStorage.getItem('bids') || '[]');
                        this.state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                        this.state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                        this.state.isProcessed = JSON.parse(localStorage.getItem('isProcessed') || 'false');
                        this.state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                        this.state.results = JSON.parse(localStorage.getItem('results') || '[]');
                        this.state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities') || '{}');
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
                return false;
            },

            updateSystemStatus(message) {
                const el = document.getElementById('systemStatus');
                if (el) el.textContent = message;
            },

            // ==================== VIEW FUNCTIONS ====================
            setLoginType(type) {
                console.log('Setting login type to:', type);
                this.state.loginType = type;
                
                const empBtn = document.querySelector('[onclick*="employee"]');
                const planBtn = document.querySelector('[onclick*="planner"]');
                
                if (type === 'employee') {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-500 text-white';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                } else {
                    if (empBtn) empBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                    if (planBtn) planBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-purple-500 text-white';
                }
                
                this.renderLoginForm();
            },

            renderLoginForm() {
                const form = document.getElementById('loginForm');
                if (!form) return;
                
                if (this.state.loginType === 'Planner') {
                    form.innerHTML = `
                        <div>
                            <label class="block font-semibold mb-2">Planner Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                placeholder="Enter planner password"
                            />
                            <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded">
                                <p class="text-sm font-semibold text-purple-800">üîë Default Planner Password:</p>
                                <p class="text-xs text-purple-700 mt-1">Default "admin123" if not change </p>
                            </div>
                        </div>
                    `;
                } else {
                    const hasData = this.state.employees.length > 0;
                    
                    form.innerHTML = `
                        <div class="space-y-4">
                            ${!hasData ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                    <span class="text-sm">No employee data loaded. Click "Sync with Database" or upload data.</span>
                                </div>
                            ` : ''}
                            <div>
                                <label class="block font-semibold mb-2">Employee ID:</label>
                                <input
                                    type="text"
                                    id="loginId"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your ID"
                                    ${!hasData ? 'disabled' : ''}
                                />
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter your password"
                                    ${!hasData ? 'disabled' : ''}
                                />
                                <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                    <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                    <p class="text-xs text-blue-700 mt-1">Your default password is the same as your Employee ID</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            handleLogin() {
                if (this.state.loginType === 'Planner') {
                    const input = document.getElementById('loginPassword');
                    const password = input ? input.value : '';
                    
                    if (password === this.state.plannerPassword) {
                        this.state.currentUser = { name: 'Planner Admin' };
                        this.state.userType = 'planner';
                        this.state.activeView = 'upload';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('plannerNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = 'Planner Admin';
                        document.getElementById('userTypeBadge').textContent = 'Planner';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800';
                        
                        this.renderView();
                        alert('‚úÖ Welcome, Planner!');
                    } else {
                        alert('‚ùå Incorrect planner password. Try: Please check with your administrator');
                    }
                } else {
                    const idInput = document.getElementById('loginId');
                    const passInput = document.getElementById('loginPassword');
                    
                    const id = idInput ? idInput.value : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!id || !password) {
                        alert('‚ö†Ô∏è Please enter both ID and password');
                        return;
                    }
                    
                    const employee = this.state.employees.find(e => e.id === id);
                    if (!employee) {
                        alert('‚ùå Employee ID not found. Please upload data first.');
                        return;
                    }
                    
                    const storedPass = this.state.employeePasswords[id] || id;
                    if (password === storedPass) {
                        this.state.currentUser = employee;
                        this.state.userType = 'employee';
                        this.state.verifiedEmployee = employee;
                        this.state.activeView = 'employee';
                        
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('employeeNav').classList.remove('hidden');
                        
                        document.getElementById('currentUserName').textContent = employee.name;
                        document.getElementById('userTypeBadge').textContent = 'Employee';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
                        
                        this.renderView();
                        alert(`‚úÖ Welcome, ${employee.name}!`);
                    } else {
                        alert(`‚ùå Incorrect password. Try: ${id}`);
                    }
                }
            },

            handleLogout() {
                this.state.currentUser = null;
                this.state.userType = null;
                this.state.verifiedEmployee = null;
                this.state.activeView = 'login';
                
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('plannerNav').classList.add('hidden');
                document.getElementById('employeeNav').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
                
                this.renderLoginForm();
            },

            setActiveView(view) {
                console.log('Setting view to:', view);
                this.state.activeView = view;
                this.renderView();
            },

            renderView() {
                const content = document.getElementById('contentArea');
                if (!content) return;
                
                content.innerHTML = '';
                
                switch(this.state.activeView) {
                    case 'upload':
                        this.renderUploadView();
                        break;
                    case 'configureSlots':
                        this.renderConfigureSlotsView();
                        break;
                    case 'admin':
                        this.renderAdminView();
                        break;
                    case 'employee':
                        this.renderEmployeeBiddingView();
                        break;
                    case 'myResults':
                        this.renderMyResultsView();
                        break;
                    case 'results':
                        this.renderResultsView();
                        break;
                    case 'changePassword':
                        this.renderChangePasswordView();
                        break;
                    case 'changePlannerPassword':
                        this.renderChangePlannerPasswordView();
                        break;
                }
                
                this.saveState();
            },

            // ==================== VIEW RENDERING ====================
            renderUploadView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                                <select
                                    id="biddingYearSelect"
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    ${this.state.isProcessed || this.state.bids.length > 0 ? 'disabled' : ''}
                                >
                                    ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                        <option value="${year}" ${year === this.state.biddingYear ? 'selected' : ''}>${year}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                            <p class="text-gray-600 mb-6">
                                Upload an Excel file with employee information. The file should have columns like:
                                "Personnel number", "Name", "Seniority Date", "Department", etc.
                            </p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4">
                                <p class="mb-4 text-gray-600">
                                    Drag and drop your Excel file here or click to browse
                                </p>
                                <label class="cursor-pointer">
                                    <input
                                        type="file"
                                        id="excelFile"
                                        accept=".xlsx,.xls"
                                        class="hidden"
                                        onchange="app.handleFileUpload(event)"
                                    />
                                    <span class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 inline-block">
                                        üìÅ Browse Files
                                    </span>
                                </label>
                            </div>

                            ${this.state.employees.length > 0 ? `
                                <div class="mt-6">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span class="text-green-800 font-semibold">
                                            ‚úì ${this.state.employees.length} employees loaded for ${this.state.biddingYear}
                                        </span>
                                        <div class="text-xs text-green-600 mt-1">
                                            Departments found: ${[...new Set(this.state.employees.map(e => e.department || 'Unassigned'))].join(', ')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Add year select listener
                const yearSelect = document.getElementById('biddingYearSelect');
                if (yearSelect) {
                    yearSelect.addEventListener('change', (e) => {
                        this.state.biddingYear = parseInt(e.target.value);
                    });
                }
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    alert('Please upload a valid Excel file (.xlsx or .xls)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        console.log('Excel data loaded:', jsonData.length, 'rows');
                        
                        // Process data - more robust parsing
                        const employees = jsonData.map((row, idx) => {
                            // Find ID from common column names
                            let id = '';
                            const idColumns = ['Personnel number', 'Personnel Number', 'Personnel_number', 
                                              'Personnelnumber', 'ID', 'id', 'EmployeeID', 'Employee ID', 
                                              'Employee No', 'Employee Number'];
                            
                            for (const col of idColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    id = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // Find name from common column names
                            let name = '';
                            const nameColumns = ['Name', 'Employee Name', 'Full Name', 
                                                'FORENAME SURNAME', 'Forename Surname'];
                            
                            for (const col of nameColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    name = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // If name not found, try forename + surname
                            if (!name) {
                                const forename = row['Forename'] || row['FORENAME'] || '';
                                const surname = row['Surname'] || row['SURNAME'] || '';
                                name = `${forename} ${surname}`.trim();
                            }
                            
                            // Find department
                            let department = '';
                            const deptColumns = ['Department', 'Scheduling row', 'Scheduling_row', 
                                               'SchedulingRow', 'DEPARTMENT'];
                            
                            for (const col of deptColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    department = String(row[col]).trim();
                                    // Clean up department name
                                    department = department.split('.')[0].trim();
                                    break;
                                }
                            }
                            
                            // Find seniority date
                            let seniorityDate = '';
                            const dateColumns = ['Seniority Date', 'SeniorityDate', 'seniorityDate',
                                                'Start of staff membership', 'Start_of_staff_membership',
                                                'Start Date', 'StartDate', 'Joining Date', 'JoiningDate'];
                            
                            for (const col of dateColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    const dateVal = row[col];
                                    if (typeof dateVal === 'number') {
                                        // Excel date number
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                                        seniorityDate = jsDate.toISOString();
                                    } else {
                                        // String date
                                        const jsDate = new Date(dateVal);
                                        if (!isNaN(jsDate.getTime())) {
                                            seniorityDate = jsDate.toISOString();
                                        }
                                    }
                                    break;
                                }
                            }
                            
                            // If no date found, use default
                            if (!seniorityDate) {
                                seniorityDate = new Date('2020-01-01').toISOString();
                            }
                            
                            // Use default ID if none found
                            if (!id) {
                                id = `EMP${idx + 1000}`;
                            }
                            
                            // Use default name if none found
                            if (!name) {
                                name = `Employee ${idx + 1}`;
                            }
                            
                            // Use default department if none found
                            if (!department) {
                                department = 'Unassigned';
                            }
                            
                            return {
                                id: id,
                                name: name,
                                seniorityDate: seniorityDate,
                                department: department,
                                role: row['Role'] || row['Position'] || row['Job Title'] || '',
                                gender: row['Gender'] || row['gender'] || '',
                                nationality: row['Nationality'] || row['nationality'] || ''
                            };
                        }).filter(emp => emp.id && emp.name); // Remove empty rows
                        
                        if (employees.length > 0) {
                            this.state.employees = employees;
                            employees.forEach(emp => {
                                this.state.employeePasswords[emp.id] = emp.id;
                            });
                            
                            this.saveState();
                            
                            // Show summary of departments found
                            const departmentsFound = [...new Set(employees.map(e => e.department))];
                            const message = `‚úÖ Successfully loaded ${employees.length} employees\n\n` +
                                          `Departments found (${departmentsFound.length}):\n` +
                                          departmentsFound.join(', ');
                            
                            alert(message);
                            this.renderUploadView();
                            this.renderLoginForm(); // Update login form with new IDs
                        } else {
                            alert('‚ö†Ô∏è No valid employee data found in the file. Please check the format.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error processing Excel file. Please check the format and try again.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            // ==================== VIEW RENDERING ====================
            renderEmployeeBiddingView() {
                const content = document.getElementById('contentArea');
                if (!this.state.verifiedEmployee) {
                    content.innerHTML = '<p class="text-center">Please login first.</p>';
                    return;
                }
            
                // Calculate employee's leave entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
            
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
            
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                const yearsOfService = calculateYearsOfService(this.state.verifiedEmployee.seniorityDate);
                
                // Get employee's bids
                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                const remainingLeave = entitlement - totalBidDays;
            
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <!-- Header with leave entitlement -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4">Leave Bidding for ${this.state.biddingYear}</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-gray-500">${yearsOfService.toFixed(1)} years of service</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${userBids.length}/2</p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Used</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${remainingLeave}</p>
                                    <p class="text-sm text-gray-600">Days Remaining</p>
                                </div>
                            </div>
            
                            <!-- Slot types summary -->
                            <div class="border-t pt-4">
                                <p class="font-semibold mb-2">Available Slot Types:</p>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
            
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">Place New Bid</h3>
                                
                                ${this.state.isProcessed ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>
                                ` : ''}
                                
                                ${userBids.length >= 2 ? `
                                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ùå Maximum of 2 bids reached.</p>
                                    </div>
                                ` : ''}
                                
                                <!-- Month Selection -->
                                <div class="mb-4">
                                    <label class="block font-semibold mb-2">Select Month:</label>
                                    <select id="selectedMonth" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" onchange="app.updateMonthText()">
                                        ${this.state.months.map(month => `
                                            <option value="${month}">${month} ${this.state.biddingYear}</option>
                                        `).join('')}
                                    </select>
                                </div>
            
                                <!-- Slot Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => {
                                            const hasBidForThisSlot = userBids.some(bid => bid.slotType === slot.id);
                                            const isDisabled = hasBidForThisSlot || userBids.length >= 2 || this.state.isProcessed;
                                            
                                            return `
                                                <button
                                                    data-slot="${slot.id}"
                                                    data-hasbid="${hasBidForThisSlot}"
                                                    onclick="${!isDisabled ? `app.setSelectedSlot('${slot.id}')` : ''}"
                                                    class="slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all ${isDisabled ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'}"
                                                    ${isDisabled ? 'disabled' : ''}
                                                >
                                                    ${slot.name} - ${slot.days} days
                                                    ${hasBidForThisSlot ? '<span class="float-right">‚úì</span>' : ''}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
            
                                <!-- Date Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select dates within <span id="selectedMonthText">January ${this.state.biddingYear}</span>:</label>
                                    
                                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                        <p class="font-semibold text-blue-800">
                                            <span id="selectedSlotText">No slot selected</span> requires exactly 
                                            <span id="selectedSlotDays">0</span> consecutive days
                                        </p>
                                    </div>
            
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block font-semibold mb-2">Start Date:</label>
                                            <input
                                                type="date"
                                                id="startDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateEndDate()"
                                            />
                                        </div>
                                        <div>
                                            <label class="block font-semibold mb-2">End Date (Auto-calculated):</label>
                                            <input
                                                type="date"
                                                id="endDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg bg-gray-50"
                                                readonly
                                            />
                                        </div>
                                    </div>
                                    
                                    <div id="dateInfo" class="hidden"></div>
                                    
                                    <p class="text-sm text-gray-600 mt-2">
                                        End date is automatically calculated based on slot type
                                    </p>
                                </div>
            
                                <!-- Submit Button -->
                                <button
                                    onclick="app.submitBid()"
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 disabled:opacity-50"
                                    ${this.state.isProcessed || userBids.length >= 2 ? 'disabled' : ''}
                                >
                                    Submit Bid
                                </button>
                            </div>
            
                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">My Current Bids</h3>
                                
                                ${userBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p>No bids placed yet</p>
                                        <p class="text-sm mt-2">Place your first bid on the left</p>
                                    </div>
                                ` : `
                                    <div class="space-y-4">
                                        ${userBids.map(bid => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            return `
                                                <div class="border border-gray-200 rounded p-4">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold">${slot?.name || 'Slot'}</p>
                                                            <p class="text-sm text-gray-600">${bid.startDate} to ${bid.endDate}</p>
                                                            <p class="text-sm font-semibold">${bid.days} days</p>
                                                        </div>
                                                        <button
                                                            onclick="app.removeBid('${bid.employeeId}', '${bid.slotType}', '${bid.startDate}')"
                                                            class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                                                            ${this.state.isProcessed ? 'disabled' : ''}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                
                                <!-- Bid Summary -->
                                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <p class="font-semibold mb-2">Bid Summary:</p>
                                    <p class="text-sm">Bids placed: ${userBids.length}/2</p>
                                    <p class="text-sm">Days used: ${totalBidDays}/${entitlement}</p>
                                    <p class="text-sm">Remaining leave: ${remainingLeave} days</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            
                // Initialize selected slot if none selected
                if (!window.selectedSlot && this.state.slotTypes.length > 0) {
                    window.selectedSlot = this.state.slotTypes[0].id;
                }
                
                // Update UI elements
                this.updateMonthText();
                this.updateSlotText();
                
                // Initialize slot buttons
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === window.selectedSlot) {
                        btn.className = btn.className.replace('bg-gray-100', 'bg-blue-500 text-white');
                    }
                });
            },

            renderConfigureSlotsView() {
                const content = document.getElementById('contentArea');
                
                // Get all unique departments from employees AND the predefined list
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = ['all', ...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">Configure Slot Capacities for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Set how many employees can take leave in each month per department.
                                Each month has 3 slots: A (15 days), B (15 days), C (20 days)
                            </p>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="deptFilter"
                                    class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg font-semibold"
                                    onchange="app.filterDepartments()"
                                >
                                    ${allDepartments.map(dept => `
                                        <option value="${dept}">
                                            ${dept === 'all' ? 'All Departments' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
            
                            <div id="configArea">
                                <!-- Configuration will be loaded here based on filter -->
                                ${this.renderDeptConfig('all')}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            filterDepartments() {
                const filter = document.getElementById('deptFilter').value;
                const configArea = document.getElementById('configArea');
                
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filter);
                }
            },
            
            renderDeptConfig(filter) {
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = [...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                let departmentsToConfigure = [];
                
                if (filter === 'all') {
                    departmentsToConfigure = allDepartments;
                } else {
                    departmentsToConfigure = [filter];
                }
                
                if (departmentsToConfigure.length === 0) {
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-6 text-center">
                            <p class="text-lg font-semibold">No departments found!</p>
                            <p class="mt-2">Please upload employee data first.</p>
                        </div>
                    `;
                }
                
                let html = '';
                
                if (filter === 'all') {
                    html += `
                        <div class="mb-6 p-4 bg-green-50 border border-green-300 rounded">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">Configuring for all departments</h3>
                            <p class="text-green-700">Setting slot capacities for all ${departmentsToConfigure.length} departments across all months.</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                            <h3 class="text-xl font-semibold text-blue-800 mb-2">Configuring for ${filter} only</h3>
                            <p class="text-blue-700">Setting slot capacities for this department across all months.</p>
                        </div>
                    `;
                }
                
                // For ALL months
                html += `<div class="space-y-8">`;
                
                this.state.months.forEach(month => {
                    html += `
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-100 p-4 border-b">
                                <h3 class="text-xl font-bold">${month} ${this.state.biddingYear}</h3>
                            </div>
                            <div class="p-4">
                                ${departmentsToConfigure.map(dept => {
                                    const hasEmployees = employeeDepts.includes(dept);
                                    const isPredefined = this.state.departments.includes(dept);
                                    const employeeCount = this.state.employees.filter(e => (e.department || 'Unassigned') === dept).length;
                                    
                                    return `
                                        <div class="mb-6 ${dept !== departmentsToConfigure[departmentsToConfigure.length - 1] ? 'border-b pb-6' : ''}">
                                            <div class="flex justify-between items-center mb-3">
                                                <div>
                                                    <h4 class="font-bold text-lg">${dept}</h4>
                                                    <div class="flex gap-2 mt-1">
                                                        ${hasEmployees ? 
                                                            `<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">${employeeCount} employees</span>` : 
                                                            `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">No employees</span>`
                                                        }
                                                        ${isPredefined ? 
                                                            `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">Predefined</span>` : 
                                                            `<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded">From Excel</span>`
                                                        }
                                                    </div>
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    Slots for ${month}
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div class="bg-green-50 border border-green-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-green-800">Slot A (15 days)</span>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        data-month="${month}"
                                                        data-dept="${dept}"
                                                        data-slot="A"
                                                        class="slot-input w-full px-3 py-2 border-2 border-green-400 rounded-lg text-center text-lg"
                                                        placeholder="5"
                                                        value="${this.state.slotCapacities[`${month}-${dept}-A`] || 5}"
                                                    />
                                                    <p class="text-xs text-gray-500 mt-1">Employees per month</p>
                                                </div>
                                                
                                                <div class="bg-blue-50 border border-blue-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-blue-800">Slot B (15 days)</span>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        data-month="${month}"
                                                        data-dept="${dept}"
                                                        data-slot="B"
                                                        class="slot-input w-full px-3 py-2 border-2 border-blue-400 rounded-lg text-center text-lg"
                                                        placeholder="5"
                                                        value="${this.state.slotCapacities[`${month}-${dept}-B`] || 5}"
                                                    />
                                                    <p class="text-xs text-gray-500 mt-1">Employees per month</p>
                                                </div>
                                                
                                                <div class="bg-purple-50 border border-purple-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-purple-800">Slot C (20 days)</span>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        data-month="${month}"
                                                        data-dept="${dept}"
                                                        data-slot="C"
                                                        class="slot-input w-full px-3 py-2 border-2 border-purple-400 rounded-lg text-center text-lg"
                                                        placeholder="5"
                                                        value="${this.state.slotCapacities[`${month}-${dept}-C`] || 5}"
                                                    />
                                                    <p class="text-xs text-gray-500 mt-1">Employees per month</p>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                html += `
                    <div class="mt-8">
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <p class="font-semibold text-yellow-800 mb-2">üìã Summary of what you're configuring:</p>
                            <p class="text-sm text-yellow-700">
                                ‚Ä¢ Departments: ${departmentsToConfigure.length} department${departmentsToConfigure.length === 1 ? '' : 's'}<br>
                                ‚Ä¢ Months: All 12 months (${this.state.months.join(', ')})<br>
                                ‚Ä¢ Slots per department per month: 3 (A, B, C)<br>
                                ‚Ä¢ Total configurations: ${departmentsToConfigure.length * 12 * 3} slot positions
                            </p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="app.saveSlotConfiguration()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600">
                                üíæ Save All Slot Configurations
                            </button>
                            <button onclick="app.copyToAllMonths()" class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">
                                üìã Copy January to All Months
                            </button>
                            <button onclick="app.setActiveView('upload')" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            },
            
            copyToAllMonths() {
                const filter = document.getElementById('deptFilter')?.value || 'all';
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = [...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                let departmentsToCopy = [];
                if (filter === 'all') {
                    departmentsToCopy = allDepartments;
                } else {
                    departmentsToCopy = [filter];
                }
                
                // Get January values for each department and slot
                const januaryValues = {};
                
                departmentsToCopy.forEach(dept => {
                    ['A', 'B', 'C'].forEach(slot => {
                        const key = `January-${dept}-${slot}`;
                        januaryValues[`${dept}-${slot}`] = this.state.slotCapacities[key] || 5;
                    });
                });
                
                // Apply to all months
                this.state.months.forEach(month => {
                    if (month === 'January') return; // Skip January since it's our source
                    
                    departmentsToCopy.forEach(dept => {
                        ['A', 'B', 'C'].forEach(slot => {
                            const key = `${month}-${dept}-${slot}`;
                            this.state.slotCapacities[key] = januaryValues[`${dept}-${slot}`];
                        });
                    });
                });
                
                // Update the UI
                const filterVal = document.getElementById('deptFilter')?.value || 'all';
                const configArea = document.getElementById('configArea');
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filterVal);
                }
                
                this.saveState();
                alert(`‚úÖ Copied January values to all months for ${departmentsToCopy.length} department(s)!`);
            },
            
            saveSlotConfiguration() {
                const inputs = document.querySelectorAll('.slot-input');
                let savedCount = 0;
                
                inputs.forEach(input => {
                    const month = input.dataset.month;
                    const dept = input.dataset.dept;
                    const slot = input.dataset.slot;
                    const value = parseInt(input.value) || 5;
                    
                    const key = `${month}-${dept}-${slot}`;
                    this.state.slotCapacities[key] = value;
                    savedCount++;
                });
                
                this.saveState();
                
                // Calculate totals
                const uniqueDepts = [...new Set(Object.keys(this.state.slotCapacities).map(k => k.split('-')[1]))];
                const uniqueMonths = [...new Set(Object.keys(this.state.slotCapacities).map(k => k.split('-')[0]))];
                const totalSlots = Object.keys(this.state.slotCapacities).length;
                
                alert(`‚úÖ Slot capacities saved!\n\n` +
                      `‚Ä¢ Configured for: ${uniqueDepts.length} department(s)\n` +
                      `‚Ä¢ Months configured: ${uniqueMonths.length}\n` +
                      `‚Ä¢ Total slot positions saved: ${totalSlots}\n\n` +
                      `Each department has 3 slots (A, B, C) for each month throughout the year.`);
                
                this.setActiveView('admin');
            },

            renderAdminView() {
                const content = document.getElementById('contentArea');
                const allDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const depts = ['all', ...allDepts].sort();
                
                // Calculate employee entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    return (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                // Get unique bidders
                const bidders = [...new Set(this.state.bids.map(b => b.employeeId))].map(empId => {
                    const employee = this.state.employees.find(e => e.id === empId);
                    const employeeBids = this.state.bids.filter(b => b.employeeId === empId);
                    const totalBidDays = employeeBids.reduce((sum, bid) => sum + bid.days, 0);
                    const entitlement = employee ? getEmployeeEntitlement(employee) : 30;
                    
                    return {
                        id: empId,
                        name: employee ? employee.name : 'Unknown',
                        department: employee ? employee.department : 'Unassigned',
                        seniorityDate: employee ? employee.seniorityDate : '',
                        yearsOfService: employee ? calculateYearsOfService(employee.seniorityDate).toFixed(1) : '0',
                        entitlement: entitlement,
                        bids: employeeBids,
                        totalBidDays: totalBidDays,
                        remainingDays: entitlement - totalBidDays
                    };
                }).sort((a, b) => new Date(a.seniorityDate) - new Date(b.seniorityDate)); // Sort by seniority
                
                // Calculate statistics
                const totalEmployees = this.state.employees.length;
                const biddersCount = bidders.length;
                const nonBiddersCount = totalEmployees - biddersCount;
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <label class="block font-semibold mb-2">Set Bidding Deadline:</label>
                                <input
                                    type="datetime-local"
                                    id="biddingDeadline"
                                    value="${this.state.biddingDeadline}"
                                    class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg"
                                    onchange="app.state.biddingDeadline = this.value; app.saveState()"
                                />
                            </div>
            
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="adminDeptFilter"
                                    class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    onchange="app.state.selectedDepartment = this.value; app.renderAdminView();"
                                >
                                    ${depts.map(dept => `
                                        <option value="${dept}" ${dept === this.state.selectedDepartment ? 'selected' : ''}>
                                            ${dept === 'all' ? 'All Departments' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalEmployees}</p>
                                    <p class="text-sm text-gray-600">Total Employees</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.bids.length}</p>
                                    <p class="text-sm text-gray-600">Total Bids</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${biddersCount}</p>
                                    <p class="text-sm text-gray-600">Employees Who Bid</p>
                                    <p class="text-xs text-gray-500">${nonBiddersCount} haven't bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.isProcessed ? 'Yes' : 'No'}</p>
                                    <p class="text-sm text-gray-600">Processed</p>
                                </div>
                            </div>
            
                            <!-- Bidders Details Section -->
                            <div class="mb-6">
                                <h3 class="text-xl font-bold mb-4">Bidders Details</h3>
                                
                                ${bidders.length === 0 ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-center">
                                        <p class="text-yellow-700">No bids placed yet.</p>
                                    </div>
                                ` : `
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="p-3 text-left">#</th>
                                                    <th class="p-3 text-left">Employee ID</th>
                                                    <th class="p-3 text-left">Name</th>
                                                    <th class="p-3 text-left">Department</th>
                                                    <th class="p-3 text-left">Seniority (Years)</th>
                                                    <th class="p-3 text-left">Entitlement</th>
                                                    <th class="p-3 text-left">Bid Choices</th>
                                                    <th class="p-3 text-left">Bid Days</th>
                                                    <th class="p-3 text-left">Remaining Days</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${bidders.map((bidder, index) => {
                                                    const filtered = this.state.selectedDepartment === 'all' || 
                                                                   bidder.department === this.state.selectedDepartment;
                                                    if (!filtered) return '';
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="p-3">${index + 1}</td>
                                                            <td class="p-3 font-mono">${bidder.id}</td>
                                                            <td class="p-3">${bidder.name}</td>
                                                            <td class="p-3">
                                                                <span class="px-2 py-1 text-xs rounded bg-gray-100">
                                                                    ${bidder.department}
                                                                </span>
                                                            </td>
                                                            <td class="p-3">${bidder.yearsOfService}</td>
                                                            <td class="p-3">
                                                                <span class="px-2 py-1 text-xs rounded ${
                                                                    bidder.entitlement === 35 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                                                }">
                                                                    ${bidder.entitlement} days
                                                                </span>
                                                            </td>
                                                            <td class="p-3">
                                                                ${bidder.bids.map(bid => {
                                                                    const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                                                    return `
                                                                        <div class="mb-1">
                                                                            <span class="px-2 py-1 text-xs rounded ${
                                                                                slot?.color === 'green' ? 'bg-green-100 text-green-800' :
                                                                                slot?.color === 'blue' ? 'bg-blue-100 text-blue-800' :
                                                                                'bg-purple-100 text-purple-800'
                                                                            }">
                                                                                ${slot?.name || 'Slot'}: ${bid.startDate} to ${bid.endDate}
                                                                            </span>
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                                ${bidder.bids.length === 0 ? '<span class="text-gray-400 text-xs">No bids</span>' : ''}
                                                            </td>
                                                            <td class="p-3 font-semibold">${bidder.totalBidDays}</td>
                                                            <td class="p-3">
                                                                <span class="px-2 py-1 text-xs rounded ${
                                                                    bidder.remainingDays > 0 ? 'bg-green-100 text-green-800' : 
                                                                    bidder.remainingDays === 0 ? 'bg-yellow-100 text-yellow-800' : 
                                                                    'bg-red-100 text-red-800'
                                                                }">
                                                                    ${bidder.remainingDays} days
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Summary -->
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="bg-gray-50 p-3 rounded">
                                            <p class="text-sm font-semibold">Bidding Summary:</p>
                                            <p class="text-xs mt-1">
                                                ‚Ä¢ ${bidders.length} employees placed bids<br>
                                                ‚Ä¢ ${this.state.bids.length} total bids submitted<br>
                                                ‚Ä¢ Average bids per employee: ${(this.state.bids.length / Math.max(bidders.length, 1)).toFixed(1)}
                                            </p>
                                        </div>
                                        <div class="bg-blue-50 p-3 rounded">
                                            <p class="text-sm font-semibold">Entitlement Summary:</p>
                                            <p class="text-xs mt-1">
                                                ‚Ä¢ 35-day employees: ${bidders.filter(b => b.entitlement === 35).length}<br>
                                                ‚Ä¢ 30-day employees: ${bidders.filter(b => b.entitlement === 30).length}<br>
                                                ‚Ä¢ Total entitlement days: ${bidders.reduce((sum, b) => sum + b.entitlement, 0)}
                                            </p>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded">
                                            <p class="text-sm font-semibold">Bid Days Summary:</p>
                                            <p class="text-xs mt-1">
                                                ‚Ä¢ Total bid days: ${bidders.reduce((sum, b) => sum + b.totalBidDays, 0)}<br>
                                                ‚Ä¢ Days remaining: ${bidders.reduce((sum, b) => sum + b.remainingDays, 0)}<br>
                                                ‚Ä¢ Utilization: ${((bidders.reduce((sum, b) => sum + b.totalBidDays, 0) / 
                                                                 bidders.reduce((sum, b) => sum + b.entitlement, 0)) * 100 || 0).toFixed(1)}%
                                            </p>
                                        </div>
                                    </div>
                                `}
                            </div>
            
                            <!-- Action Buttons -->
                            <div class="space-y-4 mb-6">
                                <button
                                    onclick="app.processBids()"
                                    ${this.state.isProcessed || this.state.employees.length === 0 ? 'disabled' : ''}
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold ${this.state.isProcessed ? 'opacity-50' : ''}"
                                >
                                    ${this.state.isProcessed ? '‚úÖ Bids Already Processed' : 'üöÄ Process All Bids'}
                                </button>
                                
                                ${this.state.isProcessed ? `
                                    <button onclick="app.exportResults()" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-semibold">
                                        üìä Export Results to Excel
                                    </button>
                                ` : ''}
                                
                                <button onclick="app.resetSystem()" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg font-semibold">
                                    üîÑ Reset System
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">System Information</h3>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>‚Ä¢ Departments: ${allDepts.length}</p>
                                    <p>‚Ä¢ Slot capacities configured: ${Object.keys(this.state.slotCapacities).length > 0 ? 'Yes' : 'No'}</p>
                                    <p>‚Ä¢ Bidding year: ${this.state.biddingYear}</p>
                                    <p>‚Ä¢ Last sync: ${this.state.employees.length > 0 ? 'Data loaded' : 'No data'}</p>
                                    <p>‚Ä¢ Bidders/Total: ${biddersCount}/${totalEmployees} (${((biddersCount/totalEmployees)*100 || 0).toFixed(1)}%)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ==================== OTHER FUNCTIONS ====================
            async processBids() {
                if (this.state.employees.length === 0) {
                    alert('No employees to process. Please upload data first.');
                    return;
                }
                
                if (Object.keys(this.state.slotCapacities).length === 0) {
                    alert('Please configure slot capacities first in "Configure Slots".');
                    this.setActiveView('configureSlots');
                    return;
                }
                
                // Sort employees by seniority (oldest first)
                const sortedEmployees = [...this.state.employees].sort((a, b) => {
                    return new Date(a.seniorityDate) - new Date(b.seniorityDate);
                });
                
                // Calculate entitlement for each employee
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    return (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                // Track slot availability per month per department
                const slotAvailability = {};
                const slotAssignments = [];
                
                // Initialize slot availability from capacities
                Object.keys(this.state.slotCapacities).forEach(key => {
                    const [month, department, slot] = key.split('-');
                    if (!slotAvailability[month]) slotAvailability[month] = {};
                    if (!slotAvailability[month][department]) slotAvailability[month][department] = { A: 0, B: 0, C: 0 };
                    slotAvailability[month][department][slot] = this.state.slotCapacities[key];
                });
                
                // Helper function to assign slot to employee
                const assignSlotToEmployee = (employee, month, slotType, slotNumber) => {
                    const slot = this.state.slotTypes.find(s => s.id === `slot${slotType}`);
                    const monthIndex = this.state.months.indexOf(month);
                    const year = this.state.biddingYear;
                    
                    // Calculate start date (1st of month for demo)
                    let startDate = new Date(year, monthIndex, 1);
                    
                    // Adjust start date based on slot position
                    if (slotNumber === 2) {
                        if (slotType === 'A') startDate.setDate(16); // Slot A2 starts 16th
                        if (slotType === 'B') startDate.setDate(16); // Slot B2 starts 16th
                        if (slotType === 'C') startDate.setDate(11); // Slot C2 starts 11th (20 days)
                    }
                    
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + slot.days - 1);
                    
                    return {
                        employeeId: employee.id,
                        employeeName: employee.name,
                        department: employee.department || 'Unassigned',
                        slotName: `${slot.name}${slotNumber || ''}`,
                        slotType: `slot${slotType}`,
                        slotNumber: slotNumber || 1,
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0],
                        days: slot.days,
                        month: month,
                        year: year,
                        seniorityDate: employee.seniorityDate,
                        yearsOfService: calculateYearsOfService(employee.seniorityDate).toFixed(1)
                    };
                };
                
                // NEW: Function to find best slot combination for 35-day employees
                const findBestSlotsFor35Days = (employee, department, assignedDays, assignedSlots) => {
                    const slotCombinations = [
                        { slot1: 'C', slot2: 'A' }, // 20 + 15 = 35
                        { slot1: 'C', slot2: 'B' }, // 20 + 15 = 35
                        { slot1: 'A', slot2: 'C' }, // 15 + 20 = 35
                        { slot1: 'B', slot2: 'C' }  // 15 + 20 = 35
                    ];
                    
                    // Try each combination
                    for (const combo of slotCombinations) {
                        // Try to find available months for both slots
                        for (const month1 of this.state.months) {
                            if (!slotAvailability[month1] || !slotAvailability[month1][department]) continue;
                            if (slotAvailability[month1][department][combo.slot1] <= 0) continue;
                            
                            for (const month2 of this.state.months) {
                                if (month1 === month2) continue; // Different months for different slots
                                if (!slotAvailability[month2] || !slotAvailability[month2][department]) continue;
                                if (slotAvailability[month2][department][combo.slot2] <= 0) continue;
                                
                                // Check if these slots would exceed capacity when combined with existing assignments
                                const daysNeeded = (combo.slot1 === 'C' ? 20 : 15) + (combo.slot2 === 'C' ? 20 : 15);
                                if (assignedDays + daysNeeded <= 35) {
                                    return {
                                        month1, slot1: combo.slot1,
                                        month2, slot2: combo.slot2
                                    };
                                }
                            }
                        }
                    }
                    
                    return null;
                };
                
                // Process each employee by seniority
                sortedEmployees.forEach((employee, index) => {
                    const employeeBids = this.state.bids.filter(bid => bid.employeeId === employee.id);
                    const entitlement = getEmployeeEntitlement(employee);
                    const department = employee.department || 'Unassigned';
                    
                    // Track assigned slots for this employee
                    const assignedSlots = [];
                    let assignedDays = 0;
                    
                    // Phase 1: Try to assign based on employee's bids (by seniority)
                    // Sort employee's bids by seniority preference (they're already sorted by overall seniority)
                    if (employeeBids.length > 0) {
                        // Process bids in the order they were placed (or sort by slot preference)
                        employeeBids.forEach(bid => {
                            if (assignedSlots.length >= 2) return; // Already have 2 slots
                            
                            const month = this.state.months[new Date(bid.startDate).getMonth()];
                            const slotType = bid.slotType.charAt(bid.slotType.length - 1); // 'A', 'B', or 'C'
                            
                            // Check if slot is available in employee's department
                            if (slotAvailability[month] && 
                                slotAvailability[month][department] && 
                                slotAvailability[month][department][slotType] > 0) {
                                
                                // NEW: Check for conflicts with other employees (same department, same slot)
                                // Seniority already handled by processing order
                                
                                // Assign slot
                                const assignment = assignSlotToEmployee(employee, month, slotType, assignedSlots.length + 1);
                                assignedSlots.push(assignment);
                                assignedDays += assignment.days;
                                
                                // Decrease availability
                                slotAvailability[month][department][slotType]--;
                            }
                        });
                    }
                    
                    // Phase 2: Fill remaining slots (if employee doesn't have 2 slots yet)
                    while (assignedSlots.length < 2) {
                        // NEW: For 35-day employees, try to assign Slot C + another slot
                        if (entitlement === 35 && assignedDays < 35) {
                            const bestCombo = findBestSlotsFor35Days(employee, department, assignedDays, assignedSlots);
                            
                            if (bestCombo) {
                                // Assign first slot from combo
                                if (assignedSlots.length === 0) {
                                    const assignment1 = assignSlotToEmployee(employee, bestCombo.month1, bestCombo.slot1, 1);
                                    assignedSlots.push(assignment1);
                                    assignedDays += assignment1.days;
                                    slotAvailability[bestCombo.month1][department][bestCombo.slot1]--;
                                }
                                
                                // Assign second slot from combo
                                if (assignedSlots.length === 1) {
                                    const assignment2 = assignSlotToEmployee(employee, bestCombo.month2, bestCombo.slot2, 2);
                                    assignedSlots.push(assignment2);
                                    assignedDays += assignment2.days;
                                    slotAvailability[bestCombo.month2][department][bestCombo.slot2]--;
                                }
                                
                                continue; // Skip to next employee
                            }
                        }
                        
                        // Regular assignment logic for 30-day employees or if no 35-day combo found
                        // Find available slot for this employee
                        let slotAssigned = false;
                        
                        // For 35-day employees, prioritize Slot C
                        const slotPriority = entitlement === 35 ? ['C', 'A', 'B'] : ['A', 'B', 'C'];
                        
                        // Try each month
                        for (const month of this.state.months) {
                            if (!slotAvailability[month] || !slotAvailability[month][department]) continue;
                            
                            // Try each slot type based on priority
                            for (const slotType of slotPriority) {
                                if (slotAvailability[month][department][slotType] > 0) {
                                    const potentialAssignment = assignSlotToEmployee(employee, month, slotType, assignedSlots.length + 1);
                                    
                                    // Check if this would exceed entitlement
                                    if (assignedDays + potentialAssignment.days <= entitlement) {
                                        // NEW: Check if this creates a perfect 35-day combination
                                        if (entitlement === 35) {
                                            const remainingDays = entitlement - (assignedDays + potentialAssignment.days);
                                            // If this leaves exactly 15 or 20 days remaining, it's good
                                            if (remainingDays === 15 || remainingDays === 20 || remainingDays === 0) {
                                                assignedSlots.push(potentialAssignment);
                                                assignedDays += potentialAssignment.days;
                                                slotAvailability[month][department][slotType]--;
                                                slotAssigned = true;
                                                break;
                                            }
                                        } else {
                                            // For 30-day employees, any combination that doesn't exceed limit
                                            assignedSlots.push(potentialAssignment);
                                            assignedDays += potentialAssignment.days;
                                            slotAvailability[month][department][slotType]--;
                                            slotAssigned = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            if (slotAssigned) break;
                        }
                        
                        // If no slot found, assign default with consideration for 35-day requirement
                        if (!slotAssigned && assignedSlots.length < 2) {
                            const defaultMonth = this.state.months[assignedSlots.length % 12];
                            
                            // For 35-day employees, try to get Slot C if possible
                            let defaultSlotType;
                            if (entitlement === 35 && assignedDays === 0) {
                                defaultSlotType = 'C'; // Start with 20-day slot
                            } else if (entitlement === 35 && assignedDays === 20) {
                                defaultSlotType = 'A'; // Need 15 more days
                            } else {
                                defaultSlotType = assignedSlots.length % 3 === 0 ? 'A' : assignedSlots.length % 3 === 1 ? 'B' : 'C';
                            }
                            
                            const defaultAssignment = assignSlotToEmployee(employee, defaultMonth, defaultSlotType, assignedSlots.length + 1);
                            assignedSlots.push(defaultAssignment);
                            assignedDays += defaultAssignment.days;
                            
                            // Create availability if doesn't exist
                            if (!slotAvailability[defaultMonth]) slotAvailability[defaultMonth] = {};
                            if (!slotAvailability[defaultMonth][department]) slotAvailability[defaultMonth][department] = { A: 0, B: 0, C: 0 };
                            slotAvailability[defaultMonth][department][defaultSlotType] = Math.max(0, slotAvailability[defaultMonth][department][defaultSlotType] - 1);
                        }
                    }
                    
                    // Add all assignments to results
                    assignedSlots.forEach((assignment, slotIndex) => {
                        slotAssignments.push({
                            ...assignment,
                            seniorityRank: index + 1,
                            type: employeeBids.length > slotIndex ? 'Bid Awarded' : 'Auto-Assigned',
                            totalEmployeeSlots: 2,
                            slotOrder: slotIndex + 1,
                            entitlement: entitlement
                        });
                    });
                });
                
                // Save results
                this.state.results = slotAssignments;
                this.state.isProcessed = true;
                this.saveState();
                
                // Calculate statistics
                const totalSlots = slotAssignments.length;
                const totalEmployees = sortedEmployees.length;
                const bidAwarded = slotAssignments.filter(r => r.type === 'Bid Awarded').length;
                const autoAssigned = slotAssignments.filter(r => r.type === 'Auto-Assigned').length;
                const seniorEmployees = sortedEmployees.filter(e => getEmployeeEntitlement(e) === 35).length;
                const juniorEmployees = totalEmployees - seniorEmployees;
                
                const message = `‚úÖ Successfully processed ${totalEmployees} employees!\n\n` +
                               `‚Ä¢ Total slots assigned: ${totalSlots} (${totalEmployees} √ó 2)\n` +
                               `‚Ä¢ Senior employees (35 days): ${seniorEmployees}\n` +
                               `‚Ä¢ Junior employees (30 days): ${juniorEmployees}\n` +
                               `‚Ä¢ Bid Awards: ${bidAwarded} slots\n` +
                               `‚Ä¢ Auto-Assigned: ${autoAssigned} slots\n` +
                               `‚Ä¢ Each employee received exactly 2 slots\n` +
                               `‚Ä¢ Total leave days allocated: ${slotAssignments.reduce((sum, r) => sum + r.days, 0)}`;
                
                alert(message);
                
                this.renderAdminView();
            },
            exportResults() {
                if (this.state.results.length === 0) {
                    alert('No results to export');
                    return;
                }
                
                // Create Excel workbook
                const wsData = [
                    ['Seniority Rank', 'Employee ID', 'Employee Name', 'Department', 'Slot Type', 
                     'Month', 'Start Date', 'End Date', 'Days', 'Assignment Type']
                ];
                
                this.state.results.forEach(result => {
                    wsData.push([
                        result.seniorityRank,
                        result.employeeId,
                        result.employeeName,
                        result.department,
                        result.slotName,
                        result.month,
                        result.startDate,
                        result.endDate,
                        result.days,
                        result.type
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Leave Assignments');
                XLSX.writeFile(wb, `Leave_Assignments_${this.state.biddingYear}.xlsx`);
                
                alert('‚úÖ Results exported to Excel file!');
            },

            resetSystem() {
                if (confirm('‚ö†Ô∏è WARNING: This will reset ALL data including employees, bids, and results. Continue?')) {
                    localStorage.clear();
                    this.state.employees = [];
                    this.state.bids = [];
                    this.state.results = [];
                    this.state.isProcessed = false;
                    this.state.slotCapacities = {};
                    this.state.currentUser = null;
                    this.state.userType = null;
                    this.state.activeView = 'login';
                    
                    // Reset UI
                    document.getElementById('userInfo').classList.add('hidden');
                    document.getElementById('plannerNav').classList.add('hidden');
                    document.getElementById('employeeNav').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                    
                    this.updateSystemStatus('System reset');
                    this.renderLoginForm();
                    
                    alert('‚úÖ System has been completely reset!');
                }
            },

            // ==================== BIDDING FUNCTIONS ====================
            setSelectedSlot(slotId) {
                window.selectedSlot = slotId;
                this.updateSlotText();
                
                // Update button styles
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === slotId) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-blue-500 text-white';
                    } else if (btn.dataset.hasbid === 'true' || this.state.isProcessed) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-200 text-gray-500 cursor-not-allowed';
                    } else {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-100 hover:bg-gray-200 text-gray-800';
                    }
                });
                
                // Clear date inputs
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (startDate) startDate.value = '';
                if (endDate) endDate.value = '';
                if (dateInfo) dateInfo.classList.add('hidden');
            },

            updateSlotText() {
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (slot) {
                    const slotText = document.getElementById('selectedSlotText');
                    const slotDays = document.getElementById('selectedSlotDays');
                    if (slotText) slotText.textContent = slot.name;
                    if (slotDays) slotDays.textContent = slot.days;
                }
            },

            updateMonthText() {
                const monthSelect = document.getElementById('selectedMonth');
                if (monthSelect) {
                    const monthText = document.getElementById('selectedMonthText');
                    if (monthText) monthText.textContent = monthSelect.value + ' ' + this.state.biddingYear;
                }
            },

            updateEndDate() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (!startDateInput || !startDateInput.value || !window.selectedSlot) {
                    if (endDateInput) endDateInput.value = '';
                    if (dateInfo) dateInfo.classList.add('hidden');
                    return;
                }
                
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (!slot) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + slot.days - 1);
                
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDateInput.value, endDateInput.value);
                
                if (dateInfo) {
                    if (days === slot.days) {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-green-800">
                                Selected: ${days} days ‚úì
                            </p>
                            <p class="text-sm mt-1 text-green-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-green-50 border border-green-200';
                    } else {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-red-800">
                                Selected: ${days} days (Required: ${slot.days} days)
                            </p>
                            <p class="text-sm mt-1 text-red-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-red-50 border border-red-200';
                    }
                    dateInfo.classList.remove('hidden');
                }
            },

            checkDateOverlap(startDate1, endDate1, startDate2, endDate2) {
                const start1 = new Date(startDate1);
                const end1 = new Date(endDate1);
                const start2 = new Date(startDate2);
                const end2 = new Date(endDate2);
                
                return (start1 <= end2 && end1 >= start2);
            },

            submitBid() {
                if (!this.state.verifiedEmployee) {
                    alert('Please login first');
                    return;
                }

                if (this.state.isProcessed) {
                    alert('Bidding has been processed. No more bids allowed.');
                    return;
                }

                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                const monthSelect = document.getElementById('selectedMonth');
                const month = monthSelect ? monthSelect.value : this.state.months[0];

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }

                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDate, endDate);

                if (days !== slot.days) {
                    alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.`);
                    return;
                }

                const start = new Date(startDate);
                const yearStart = new Date(this.state.biddingYear, 0, 1);
                const yearEnd = new Date(this.state.biddingYear, 11, 31);

                if (start < yearStart || start > yearEnd) {
                    alert(`Start date must be within ${this.state.biddingYear}`);
                    return;
                }

                const existingBid = this.state.bids.find(
                    bid => bid.employeeId === this.state.verifiedEmployee.id && bid.slotType === window.selectedSlot
                );
                
                if (existingBid) {
                    alert(`You have already bid for ${slot.name}. You cannot bid for the same slot twice.`);
                    return;
                }

                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                
                // Calculate entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                
                if (userBids.length >= 2) {
                    alert('You can only place 2 bids maximum.');
                    return;
                }

                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                if (totalBidDays + days > entitlement) {
                    alert(`Your total leave days would exceed your entitlement of ${entitlement} days.\n\nCurrent bids: ${totalBidDays} days\nThis bid: ${days} days\nTotal: ${totalBidDays + days} days`);
                    return;
                }

                // Check for date overlaps
                for (const bid of userBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        const existingSlot = this.state.slotTypes.find(s => s.id === bid.slotType);
                        alert(`Date overlap detected with your existing ${existingSlot?.name || 'slot'} bid (${bid.startDate} to ${bid.endDate})`);
                        return;
                    }
                }

                const newBid = {
                    employeeId: this.state.verifiedEmployee.id,
                    employeeName: this.state.verifiedEmployee.name,
                    seniorityDate: this.state.verifiedEmployee.seniorityDate,
                    department: this.state.verifiedEmployee.department,
                    slotType: window.selectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();
                alert(`‚úì Bid placed successfully for ${slot.name} (${days} days)!`);
                
                // Refresh view
                this.renderEmployeeBiddingView();
            },

            removeBid(employeeId, slotType, startDate) {
                if (this.state.isProcessed) {
                    alert('Cannot remove bids after processing');
                    return;
                }
                
                if (confirm('Are you sure you want to remove this bid?')) {
                    this.state.bids = this.state.bids.filter(bid => 
                        !(bid.employeeId === employeeId && 
                          bid.slotType === slotType && 
                          bid.startDate === startDate)
                    );
                    this.saveState();
                    this.renderEmployeeBiddingView();
                }
            },
               
            loadAvailableSlots() {
                const slotsContainer = document.getElementById('slotsContainer');
                if (!slotsContainer) return;
                
                slotsContainer.innerHTML = '<p class="text-gray-600">Loading available slots...</p>';
                
                // Simulate loading with timeout
                setTimeout(() => {
                    // Get filter values
                    const includeWeekends = document.getElementById('filterWeekends')?.checked || true;
                    const includeHolidays = document.getElementById('filterHolidays')?.checked || true;
                    const departmentPriority = document.getElementById('departmentPriority')?.value || 'all';
                    const minDuration = parseInt(document.getElementById('minDuration')?.value || '3');
                    
                    // Sample slot data (in real app, this would come from your database)
                    const sampleSlots = [
                        { id: 1, name: 'Summer Break', month: 'July', duration: 15, type: 'Slot A', startDate: '2027-07-01', endDate: '2027-07-15', department: 'L3 SAMB' },
                        { id: 2, name: 'Winter Holidays', month: 'December', duration: 20, type: 'Slot C', startDate: '2027-12-15', endDate: '2028-01-03', department: 'L3 SAMB' },
                        { id: 3, name: 'Spring Break', month: 'April', duration: 15, type: 'Slot B', startDate: '2027-04-10', endDate: '2027-04-24', department: 'L4/6-SA' },
                        { id: 4, name: 'Autumn Leave', month: 'October', duration: 10, type: 'Slot A', startDate: '2027-10-01', endDate: '2027-10-10', department: 'L5 SAMB' },
                        { id: 5, name: 'New Year Break', month: 'January', duration: 7, type: 'Slot B', startDate: '2027-01-03', endDate: '2027-01-09', department: 'L3 SAMB' },
                    ];
                    
                    // Apply filters
                    let filteredSlots = sampleSlots.filter(slot => {
                        // Filter by minimum duration
                        if (slot.duration < minDuration) return false;
                        
                        // Filter by department priority
                        if (departmentPriority === 'same' && slot.department !== this.state.verifiedEmployee?.department) {
                            return false;
                        }
                        
                        // Note: Weekend and holiday filtering would be implemented in real app
                        
                        return true;
                    });
                    
                    if (filteredSlots.length === 0) {
                        slotsContainer.innerHTML = '<p class="text-gray-600">No slots available with current filters. Try adjusting your filters.</p>';
                        return;
                    }
                    
                    // Display slots
                    let slotsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    
                    filteredSlots.forEach(slot => {
                        const isMyDept = slot.department === this.state.verifiedEmployee?.department;
                        slotsHTML += `
                            <div class="border border-gray-300 rounded p-4 hover:border-blue-500 hover:bg-blue-50 transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h5 class="font-semibold text-lg">${slot.name}</h5>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="px-2 py-1 text-xs rounded ${isMyDept ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                ${slot.department}
                                            </span>
                                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">
                                                ${slot.type}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm font-semibold">${slot.duration} days</span>
                                        <p class="text-xs text-gray-500">${slot.month}</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${slot.startDate} to ${slot.endDate}</p>
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="slot-checkbox mr-2" value="${slot.id}">
                                        <span class="text-sm">Select to bid</span>
                                    </label>
                                    <button 
                                        onclick="app.previewSlot(${slot.id})"
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                    >
                                        Preview
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    slotsHTML += '</div>';
                    slotsContainer.innerHTML = slotsHTML;
                }, 500);
            },

            previewSlot(slotId) {
                alert(`Previewing slot #${slotId}. In a real application, this would show detailed information about the selected slot.`);
            },

            renderMyResultsView() {
                const content = document.getElementById('contentArea');
                const myResults = this.state.results.filter(r => r.employeeId === this.state.verifiedEmployee?.id);
                
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">My Leave Assignment</h2>
                            
                            ${myResults.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results available yet.</p>
                                    ${this.state.isProcessed ? '' : '<p class="text-sm mt-2">Bids have not been processed yet.</p>'}
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${myResults.map(result => `
                                        <div class="border border-gray-200 rounded p-4">
                                            <p class="font-bold text-lg">${result.slotName}</p>
                                            <p class="text-sm text-gray-600">${result.startDate} to ${result.endDate}</p>
                                            <p class="text-sm font-semibold">${result.days} days</p>
                                            <span class="px-2 py-1 rounded text-xs ${result.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                ${result.type}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderResultsView() {
                const content = document.getElementById('contentArea');
                
                // Group results by employee
                const employeeResults = {};
                this.state.results.forEach(result => {
                    if (!employeeResults[result.employeeId]) {
                        employeeResults[result.employeeId] = [];
                    }
                    employeeResults[result.employeeId].push(result);
                });
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-6">Leave Assignments for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Each employee receives exactly 2 slots. Senior employees (5+ years) get 35 days total,
                                others get 30 days total.
                            </p>
                            
                            ${this.state.results.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results yet. Process bids first.</p>
                                    <button onclick="app.setActiveView('admin')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                        Go to Admin Panel
                                    </button>
                                </div>
                            ` : `
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">Rank</th>
                                                <th class="p-3">Employee</th>
                                                <th class="p-3">Department</th>
                                                <th class="p-3">Seniority</th>
                                                <th class="p-3">Slot 1</th>
                                                <th class="p-3">Slot 2</th>
                                                <th class="p-3">Total Days</th>
                                                <th class="p-3">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(employeeResults).map(([empId, slots]) => {
                                                const employee = this.state.employees.find(e => e.id === empId);
                                                const slot1 = slots.find(s => s.slotOrder === 1);
                                                const slot2 = slots.find(s => s.slotOrder === 2);
                                                const totalDays = slots.reduce((sum, s) => sum + s.days, 0);
                                                const allAwarded = slots.every(s => s.type === 'Bid Awarded');
                                                const anyAwarded = slots.some(s => s.type === 'Bid Awarded');
                                                
                                                return `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-3">#${slot1?.seniorityRank || 'N/A'}</td>
                                                        <td class="p-3">${employee?.name || 'Unknown'}<br>
                                                            <span class="text-xs text-gray-500">${empId}</span>
                                                        </td>
                                                        <td class="p-3">${employee?.department || 'Unassigned'}</td>
                                                        <td class="p-3">${slot1?.yearsOfService || 'N/A'} yrs</td>
                                                        <td class="p-3">
                                                            ${slot1?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot1?.startDate || ''} to ${slot1?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot1?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot1?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3">
                                                            ${slot2?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot2?.startDate || ''} to ${slot2?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot2?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot2?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3 font-bold">${totalDays} days</td>
                                                        <td class="p-3">
                                                            <span class="px-2 py-1 rounded text-xs ${
                                                                allAwarded ? 'bg-green-100 text-green-800' : 
                                                                anyAwarded ? 'bg-yellow-100 text-yellow-800' : 
                                                                'bg-blue-100 text-blue-800'
                                                            }">
                                                                ${allAwarded ? 'All Bids Awarded' : 
                                                                  anyAwarded ? 'Partial Award' : 
                                                                  'Auto-Assigned'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderChangePasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('employee')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderChangePlannerPasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Change Planner Password</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm Password:</label>
                                    <input type="password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg">
                                    Save
                                </button>
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ==================== INITIALIZATION ====================
            async init() {
                console.log('App initializing...');
                this.updateSystemStatus('Initializing...');
                
                // Initialize Supabase
                const supabaseReady = await this.initSupabase();
                if (supabaseReady) {
                    this.updateSystemStatus('Connected to Supabase');
                    
                    // Try to load from Supabase first
                    setTimeout(async () => {
                        await this.loadFromSupabase();
                    }, 500);
                } else {
                    // Fallback to localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('Ready - No data loaded');
                    }
                }
                
                this.renderLoginForm();
                
                // Add Enter key support
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && this.state.activeView === 'login') {
                        this.handleLogin();
                    }
                });
                
                console.log('App ready');
            }
        };

        // Initialize when page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>
