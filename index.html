<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles to match your React component */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Gradient buttons */
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .gradient-yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center fade-in">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                Annual Leave Bidding System
            </h1>
            <div id="userInfo" class="hidden flex justify-center items-center gap-4 mt-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span class="text-sm text-gray-600">Logged in as: </span>
                    <span id="currentUserName" class="font-semibold"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button
                    onclick="handleLogout()"
                    class="px-4 py-2 gradient-red text-white rounded-lg hover:shadow-lg font-semibold transition-shadow"
                >
                    Logout
                </button>
            </div>
        </div>

        <!-- Login View (initial view) -->
        <div id="loginView" class="max-w-md mx-auto mt-10 fade-in">
            <div class="bg-white rounded-xl shadow-xl p-8">
                <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
                    Annual Leave Bidding System
                </h1>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-3">Login As:</label>
                    <div class="flex gap-4">
                        <button
                            id="loginTypeEmployee"
                            onclick="setLoginType('employee')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold gradient-blue text-white"
                        >
                            Employee
                        </button>
                        <button
                            id="loginTypePlanner"
                            onclick="setLoginType('planner')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300"
                        >
                            Planner
                        </button>
                    </div>
                </div>

                <div id="loginForm">
                    <!-- Employee login fields will be inserted here -->
                </div>

                <button
                    onclick="handleLogin()"
                    class="w-full mt-6 px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold transition-shadow"
                >
                    Login
                </button>
            </div>
        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6 fade-in">
            <button onclick="setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Upload Data
            </button>
            <button onclick="setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Configure Slots
            </button>
            <button onclick="setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Admin Panel
                <button onclick="publishToCloud()" class="px-4 py-2 gradient-green text-white rounded-lg hover:shadow-lg font-semibold">
            üåê Publish Data
            </button>
            <button onclick="setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Change Password
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6 fade-in">
            <button onclick="setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Place Bids
            </button>
            <button onclick="setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
    </div>

    <!-- Lucide Icons (via CDN) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- XLSX for Excel processing -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        // ==================== CLOUD CONFIGURATION ====================
        // GitHub Gist Configuration (Free cloud storage)
        const GIST_ID = '2f3f246ef97e1165830bf95529d01b78'; // ‚Üê YOUR GIST ID HERE
        const GITHUB_TOKEN = ''; // Optional: For private gists
        const CLOUD_DATA_URL = `https://gist.githubusercontent.com/raw/${GIST_ID}/system_data.json`;
        // ==================== STATE MANAGEMENT ====================
        let state = {
            employees: [],
            employeePasswords: {},
            bids: [],
            biddingDeadline: '',
            biddingYear: parseInt(localStorage.getItem('biddingYear')) || 2026,
            isProcessed: JSON.parse(localStorage.getItem('isProcessed')) || false,
            activeView: 'login',
            selectedEmployeeId: '',
            verifiedEmployee: null,
            currentUser: null,
            userType: null,
            plannerPassword: localStorage.getItem('plannerPassword') || 'admin123',
            results: JSON.parse(localStorage.getItem('results')) || [],
            selectedDepartment: 'all',
            slotCapacities: JSON.parse(localStorage.getItem('slotCapacities')) || {},
            // ... rest of departments, slotTypes, months arrays stay the same
        };
            
            // Department list
            departments: [
                'L4/6-SA', 'L4/6-DEP-DM', 'L4/6-DEP-EFC', 'L3-DEP-DC', 'L3-DEP-TC',
                'L5-LSS/SS', 'L5-DEP-DC', 'L3465-DEP-TCC', 'L3-DEP-DM', 'L5-DEP-DM',
                'L46-DEP-TC', 'L3-DEP- LTSS/TSS', 'L5-DEP-GSM', 'L5-DEP-SC', 'L5-DEP- LTSS/TSS',
                'L3-DEP-EFC', 'L3-DEP-GSM', 'L46-TA-T', 'L46-DEP- LTSS/TSS', 'L3-TA-T',
                'L3-DS', 'L5-DEP-TC', 'L3-P&R', 'L5-DEP-EFC', 'L46-DEP-DC',
                'L3-LSS/SS', 'L3-DEP-SC', 'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC',
                'L46 SAMB', 'L5 SA', 'L3-SA', 'L3 SAMB', 'L5 - TA-T',
                'L46-P&R', 'L5 SAMB', 'L46-AOCC'
            ],
            
            slotTypes: [
                { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
            ],
            
            months: [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ]
        };

        // ==================== UTILITY FUNCTIONS ====================
        function saveState() {
            localStorage.setItem('employees', JSON.stringify(state.employees));
            localStorage.setItem('employeePasswords', JSON.stringify(state.employeePasswords));
            localStorage.setItem('bids', JSON.stringify(state.bids));
            localStorage.setItem('biddingDeadline', state.biddingDeadline);
            localStorage.setItem('biddingYear', state.biddingYear.toString());
            localStorage.setItem('isProcessed', JSON.stringify(state.isProcessed));
            localStorage.setItem('plannerPassword', state.plannerPassword);
            localStorage.setItem('results', JSON.stringify(state.results));
            localStorage.setItem('slotCapacities', JSON.stringify(state.slotCapacities));
        }

        function calculateYearsOfService(seniorityDate) {
            const today = new Date();
            const joinDate = new Date(seniorityDate);
            const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
            return years;
        }

        function getEmployeeEntitlement(employee) {
            const yearsOfService = calculateYearsOfService(employee.seniorityDate);
            return yearsOfService >= 5 ? 35 : 30;
        }

        function calculateDaysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function checkDateOverlap(startDate1, endDate1, startDate2, endDate2) {
            const start1 = new Date(startDate1);
            const end1 = new Date(endDate1);
            const start2 = new Date(startDate2);
            const end2 = new Date(endDate2);
            
            return (start1 <= end2 && end1 >= start2);
        }

        function formatExcelDate(dateValue) 
                // ==================== CLOUD FUNCTIONS ====================
        async function loadFromCloud() {
            try {
                console.log('Attempting to load from cloud...');
                
                const response = await fetch(CLOUD_DATA_URL + '?t=' + Date.now());
                
                if (response.ok) {
                    const cloudData = await response.json();
                    
                    // Validate the data
                    if (cloudData && cloudData.employees && Array.isArray(cloudData.employees)) {
                        state.employees = cloudData.employees || [];
                        state.employeePasswords = cloudData.employeePasswords || {};
                        state.bids = cloudData.bids || [];
                        state.biddingDeadline = cloudData.biddingDeadline || '';
                        state.biddingYear = cloudData.biddingYear || 2026;
                        state.isProcessed = cloudData.isProcessed || false;
                        state.plannerPassword = cloudData.plannerPassword || 'admin123';
                        state.results = cloudData.results || [];
                        state.slotCapacities = cloudData.slotCapacities || {};
                        
                        console.log('‚úÖ Data loaded from cloud:', state.employees.length, 'employees');
                        return true;
                    }
                }
            } catch (error) {
                console.log('No cloud data found, using localStorage');
            }
            
            // Fallback to localStorage
            return loadFromLocalStorage();
        }
        
        function loadFromLocalStorage() {
            try {
                const employees = JSON.parse(localStorage.getItem('employees'));
                if (employees && Array.isArray(employees) && employees.length > 0) {
                    state.employees = employees;
                    state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords')) || {};
                    state.bids = JSON.parse(localStorage.getItem('bids')) || [];
                    state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                    state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                    state.isProcessed = JSON.parse(localStorage.getItem('isProcessed')) || false;
                    state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                    state.results = JSON.parse(localStorage.getItem('results')) || [];
                    state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities')) || {};
                    
                    console.log('‚úÖ Data loaded from localStorage:', state.employees.length, 'employees');
                    return true;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
            return false;
        }
        
        function publishToCloud() {
            // Show cloud publish modal
            const employeeCount = state.employees.length;
            const slotConfigCount = Object.keys(state.slotCapacities).length;
            const bidCount = state.bids.length;
            const resultCount = state.results.length;
            
            const message = `üåê PUBLISH SYSTEM DATA\n\n` +
                            `üìä Current Data Summary:\n` +
                            `‚Ä¢ Employees: ${employeeCount}\n` +
                            `‚Ä¢ Slot Configurations: ${slotConfigCount}\n` +
                            `‚Ä¢ Bids: ${bidCount}\n` +
                            `‚Ä¢ Results: ${resultCount}\n\n` +
                            `This will publish your system data to the cloud so all employees can access it.`;
            
            if (confirm(message)) {
                saveToGist();
            }
        }
        
        async function saveToGist() {
            try {
                // Prepare system data
                const systemData = {
                    employees: state.employees,
                    employeePasswords: state.employeePasswords,
                    bids: state.bids,
                    biddingDeadline: state.biddingDeadline,
                    biddingYear: state.biddingYear,
                    isProcessed: state.isProcessed,
                    plannerPassword: state.plannerPassword,
                    results: state.results,
                    slotCapacities: state.slotCapacities,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(systemData, null, 2);
                
                // Create a downloadable JSON file for manual upload to GitHub
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `system_data_${state.biddingYear}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Instructions for planner
                alert(`‚úÖ System data ready for cloud publishing!\n\n` +
                      `1. A file named "system_data_${state.biddingYear}.json" has been downloaded\n` +
                      `2. Go to https://gist.github.com/AboGhassan2/2f3f246ef97e1165830bf95529d01b78\n` +
                      `3. Click "Edit" on your existing Gist\n` +
                      `4. Delete the current content\n` +
                      `5. Upload the downloaded JSON file\n` +
                      `6. Click "Update secret gist"\n\n` +
                      `After publishing, all employees will automatically get the latest data!`);
                
            } catch (error) {
                console.error('Error publishing data:', error);
                alert('Error publishing data. Please try again.');
            }
        }
        
        {
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return jsDate;
            } else if (typeof dateValue === 'string') {
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } else if (dateValue instanceof Date) {
                return dateValue;
            }
            
            return new Date();
        }

        // ==================== VIEW RENDERING ====================
        function renderView() {
            const contentArea = document.getElementById('contentArea');
            
            switch(state.activeView) {
                case 'login':
                    renderLoginView();
                    break;
                case 'upload':
                    renderUploadView();
                    break;
                case 'configureSlots':
                    renderConfigureSlotsView();
                    break;
                case 'admin':
                    renderAdminView();
                    break;
                case 'employee':
                    renderEmployeeBiddingView();
                    break;
                case 'changePassword':
                    renderChangePasswordView();
                    break;
                case 'changePlannerPassword':
                    renderChangePlannerPasswordView();
                    break;
                case 'myResults':
                    renderMyResultsView();
                    break;
                case 'results':
                    renderResultsView();
                    break;
            }
            
            // Update navigation visibility
            document.getElementById('plannerNav').classList.toggle('hidden', state.userType !== 'planner');
            document.getElementById('employeeNav').classList.toggle('hidden', state.userType !== 'employee');
            document.getElementById('userInfo').classList.toggle('hidden', !state.currentUser);
            
            if (state.currentUser) {
                document.getElementById('currentUserName').textContent = state.currentUser.name;
                const badge = document.getElementById('userTypeBadge');
                badge.textContent = state.userType === 'planner' ? 'Planner' : 'Employee';
                badge.className = state.userType === 'planner' 
                    ? 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800' 
                    : 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
            }
            
            saveState();
        }

        function renderLoginView() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('contentArea').innerHTML = '';
            
            const loginForm = document.getElementById('loginForm')
            if (state.loginType === 'planner') {
                loginForm.innerHTML = `
                    <div>
                        <label class="block font-semibold mb-2">Planner Password:</label>
                        <input
                            type="password"
                            id="loginPassword"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Enter planner password"
                        />
                        <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded">
                            <p class="text-sm font-semibold text-purple-800">üîë Default Planner Password:</p>
                            <p class="text-lg font-mono font-bold text-purple-900 mt-1">admin123</p>
                        </div>
                    </div>
                `;
            } else {
                loginForm.innerHTML = `
                    <div class="space-y-4">
                        ${state.employees.length === 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                <span class="text-sm">No employee data loaded. Please ask the planner to upload employee data first.</span>
                            </div>
                        ` : ''}
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input
                                type="text"
                                id="loginId"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your ID"
                                ${state.employees.length === 0 ? 'disabled' : ''}
                            />
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your password"
                                ${state.employees.length === 0 ? 'disabled' : ''}
                            />
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm font-semibold text-blue-800">üìå Default Password Info:</p>
                                <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderUploadView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-2xl mx-auto text-center fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                        <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                            <select
                                id="biddingYearSelect"
                                class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                ${state.isProcessed || state.bids.length > 0 ? 'disabled' : ''}
                            >
                                ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                    <option value="${year}" ${year === state.biddingYear ? 'selected' : ''}>${year}</option>
                                `).join('')}
                            </select>
                            ${(state.isProcessed || state.bids.length > 0) ? `
                                <p class="text-xs text-red-600 mt-2 font-semibold">
                                    ‚ö†Ô∏è Year cannot be changed after bids have been placed or processed
                                </p>
                            ` : ''}
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-blue-800 mb-2">Leave Entitlement Rules:</h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Employees with 5+ years of service: <span class="font-bold">35 days</span></li>
                                <li>‚Ä¢ Employees with less than 5 years: <span class="font-bold">30 days</span></li>
                                <li>‚Ä¢ Each employee can place <span class="font-bold">2 bids</span> only</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-xl p-8">
                        <i data-lucide="upload" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                        <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                        <p class="text-gray-600 mb-6">
                            Upload an Excel file with employee information
                        </p>
                        
                        <div
                            id="dropZone"
                            class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4 transition-colors hover:border-blue-500 hover:bg-blue-50"
                        >
                            <p class="mb-4 text-gray-600">
                                Drag and drop your Excel file here or click to browse
                            </p>
                            <label class="cursor-pointer">
                                <input
                                    type="file"
                                    id="excelFile"
                                    accept=".xlsx,.xls"
                                    class="hidden"
                                />
                                <span class="px-6 py-2 gradient-blue text-white rounded-lg hover:shadow-lg inline-block">
                                    Browse Files
                                </span>
                            </label>
                        </div>

                        ${state.employees.length > 0 ? `
                            <div class="mt-6">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <i data-lucide="check-circle" class="inline mr-2 text-green-600"></i>
                                    <span class="text-green-800 font-semibold">
                                        ‚úì ${state.employees.length} employees loaded for ${state.biddingYear}
                                    </span>
                                </div>
                                
                                <div class="max-h-96 overflow-y-auto mb-4">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th class="p-2 text-left">ID</th>
                                                <th class="p-2 text-left">Name</th>
                                                <th class="p-2 text-left">Department</th>
                                                <th class="p-2 text-left">Role</th>
                                                <th class="p-2 text-left">Years</th>
                                                <th class="p-2 text-left">Entitlement</th>
                                                <th class="p-2 text-left">Rank</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${state.employees.map((emp, idx) => {
                                                const years = calculateYearsOfService(emp.seniorityDate);
                                                const entitlement = getEmployeeEntitlement(emp);
                                                return `
                                                    <tr key="${emp.id}" class="border-b">
                                                        <td class="p-2">${emp.id}</td>
                                                        <td class="p-2">${emp.name}</td>
                                                        <td class="p-2 font-semibold text-blue-600">${emp.department || '-'}</td>
                                                        <td class="p-2">${emp.role || '-'}</td>
                                                        <td class="p-2">${years.toFixed(1)}</td>
                                                        <td class="p-2 font-bold">${entitlement} days</td>
                                                        <td class="p-2">${idx + 1}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            // Add event listeners
            document.getElementById('biddingYearSelect').addEventListener('change', (e) => {
                state.biddingYear = parseInt(e.target.value);
                renderView();
            });
            
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            
            // Add drag and drop functionality
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length) {
                    handleFileUpload({ target: { files: e.dataTransfer.files } });
                }
            });
        }

        function renderConfigureSlotsView() {
            document.getElementById('loginView').classList.add('hidden');
            
            // Initialize capacities if not exists - CHANGED DEFAULT FROM 0 TO 5
            const initialCapacities = {};
            const allDepts = ['All', ...new Set(state.employees.map(e => e.department || 'Unassigned'))];
            
            state.months.forEach(month => {
                allDepts.forEach(dept => {
                    // Check if value exists in saved state, otherwise default to 5
                    initialCapacities[`${month}-${dept}-A`] = state.slotCapacities[`${month}-${dept}-A`] !== undefined 
                        ? state.slotCapacities[`${month}-${dept}-A`] 
                        : 5;
                    initialCapacities[`${month}-${dept}-B`] = state.slotCapacities[`${month}-${dept}-B`] !== undefined
                        ? state.slotCapacities[`${month}-${dept}-B`]
                        : 5;
                    initialCapacities[`${month}-${dept}-C`] = state.slotCapacities[`${month}-${dept}-C`] !== undefined
                        ? state.slotCapacities[`${month}-${dept}-C`]
                        : 5;
                });
            });
            
            const uniqueDepartments = ['All', ...new Set(state.employees.map(e => e.department || 'Unassigned'))].sort((a, b) => {
                if (a === 'All') return -1;
                if (b === 'All') return 1;
                return a.localeCompare(b);
            });
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-7xl mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">Configure Slot Capacities for ${state.biddingYear}</h2>
                        <p class="text-gray-600 mb-6">
                            Set how many employees can take leave in each month per department. Each month has 3 slots: A (15 days), B (15 days), C (20 days)
                        </p>

                        <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <label class="block font-semibold mb-2">Filter by Department:</label>
                            <select
                                id="deptFilter"
                                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                            >
                                ${uniqueDepartments.map(dept => `
                                    <option value="${dept}">${dept}</option>
                                `).join('')}
                            </select>
                            <p id="filterInfo" class="text-sm text-gray-600 mt-2">
                                Configuring for all departments
                            </p>
                        </div>

                        <div id="slotConfigArea" class="space-y-4 max-h-96 overflow-y-auto">
                            ${state.months.map(month => `
                                <div class="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                                    <h3 class="font-bold text-lg mb-3 text-blue-600">${month} ${state.biddingYear}</h3>
                                    
                                    ${uniqueDepartments.filter(d => d !== 'All').map(dept => `
                                        <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200 department-config" data-dept="${dept}">
                                            <h4 class="font-semibold text-md mb-2 text-purple-600">${dept}</h4>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div class="bg-green-50 border border-green-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-green-800">Slot A (15 days)</span>
                                                        <i data-lucide="users" class="text-green-600 w-5 h-5"></i>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        data-key="${month}-${dept}-A"
                                                        value="${initialCapacities[`${month}-${dept}-A`] || 5}"
                                                        class="slot-input w-full px-3 py-2 border-2 border-green-400 rounded-lg text-center text-lg font-bold focus:border-green-600 focus:outline-none"
                                                        placeholder="5"
                                                    />
                                                </div>

                                                <div class="bg-blue-50 border border-blue-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-blue-800">Slot B (15 days)</span>
                                                        <i data-lucide="users" class="text-blue-600 w-5 h-5"></i>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        data-key="${month}-${dept}-B"
                                                        value="${initialCapacities[`${month}-${dept}-B`] || 5}"
                                                        class="slot-input w-full px-3 py-2 border-2 border-blue-400 rounded-lg text-center text-lg font-bold focus:border-blue-600 focus:outline-none"
                                                        placeholder="5"
                                                    />
                                                </div>

                                                <div class="bg-purple-50 border border-purple-300 rounded p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-semibold text-purple-800">Slot C (20 days)</span>
                                                        <i data-lucide="users" class="text-purple-600 w-5 h-5"></i>
                                                    </div>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        data-key="${month}-${dept}-C"
                                                        value="${initialCapacities[`${month}-${dept}-C`] || 5}"
                                                        class="slot-input w-full px-3 py-2 border-2 border-purple-400 rounded-lg text-center text-lg font-bold focus:border-purple-600 focus:outline-none"
                                                        placeholder="5"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-6 flex gap-3">
                            <button
                                onclick="saveSlotConfiguration()"
                                class="flex-1 px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold"
                            >
                                Save Configuration
                            </button>
                            <button
                                onclick="setActiveView('upload')"
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold"
                            >
                                Back
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            // Add filter functionality
            document.getElementById('deptFilter').addEventListener('change', (e) => {
                const selectedDept = e.target.value;
                document.getElementById('filterInfo').textContent = 
                    selectedDept === 'All' 
                        ? 'Configuring for all departments' 
                        : `Configuring for ${selectedDept} only`;
                
                const deptConfigs = document.querySelectorAll('.department-config');
                deptConfigs.forEach(config => {
                    if (selectedDept === 'All' || config.dataset.dept === selectedDept) {
                        config.classList.remove('hidden');
                    } else {
                        config.classList.add('hidden');
                    }
                });
            });
            
            // Update capacities on input
            document.querySelectorAll('.slot-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    initialCapacities[e.target.dataset.key] = parseInt(e.target.value) || 5;
                });
            });
        }

        function renderEmployeeBiddingView() {
            document.getElementById('loginView').classList.add('hidden');
            
            const userBids = state.bids.filter(bid => bid.employeeId === state.verifiedEmployee?.id);
            const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
            const entitlement = getEmployeeEntitlement(state.verifiedEmployee);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center">
                            <i data-lucide="calendar" class="mr-2"></i> Leave Bidding for ${state.biddingYear}
                        </h2>
                        <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                            <p class="font-semibold text-blue-800">
                                Your Leave Entitlement: ${entitlement} days
                                <span class="text-sm ml-2">
                                    (${calculateYearsOfService(state.verifiedEmployee.seniorityDate).toFixed(1)} years of service)
                                </span>
                            </p>
                            <p class="text-sm text-blue-700">Slot A: 15 days | Slot B: 15 days | Slot C: 20 days</p>
                            <p class="text-sm text-blue-700 mt-2">You have placed ${userBids.length}/2 bids totaling ${totalBidDays} days</p>
                            <p class="text-sm text-blue-700">Remaining leave: ${entitlement - totalBidDays} days</p>
                        </div>

                        ${state.isProcessed ? `
                            <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                                <i data-lucide="alert-circle" class="inline mr-2"></i>
                                <span class="font-semibold">Bidding has been processed and is now closed</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Place New Bid Form -->
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h3 class="text-xl font-bold mb-4">Place New Bid</h3>
                            
                            <div class="mb-4">
                                <label class="block font-semibold mb-2">Select Month:</label>
                                <select
                                    id="selectedMonth"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none ${state.isProcessed ? 'bg-gray-100' : ''}"
                                    ${state.isProcessed ? 'disabled' : ''}
                                >
                                    ${state.months.map(month => `
                                        <option value="${month}">${month} ${state.biddingYear}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="block font-semibold mb-2">Select Slot Type:</label>
                                <div class="space-y-2" id="slotButtons">
                                    ${state.slotTypes.map(slot => {
                                        const hasBid = userBids.some(b => b.slotType === slot.id);
                                        return `
                                            <button
                                                onclick="setSelectedSlot('${slot.id}')"
                                                ${hasBid || state.isProcessed ? 'disabled' : ''}
                                                class="slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all ${
                                                    'selectedSlot' in window && window.selectedSlot === slot.id
                                                        ? 'gradient-blue text-white'
                                                        : hasBid
                                                        ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                                                        : state.isProcessed
                                                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                        : 'bg-gray-100 hover:bg-gray-200 text-gray-800'
                                                }"
                                                data-slot="${slot.id}"
                                                ${hasBid ? 'data-hasbid="true"' : ''}
                                            >
                                                <div class="flex justify-between items-center">
                                                    <span>${slot.name} - ${slot.days} days</span>
                                                    ${hasBid ? '<span class="text-sm">‚úì Already Bid</span>' : ''}
                                                </div>
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
                                <p class="text-sm font-semibold text-yellow-800">
                                    üìÖ Select dates within <span id="selectedMonthText">January</span> ${state.biddingYear}
                                </p>
                                <p class="text-xs text-yellow-700 mt-1">
                                    <span id="selectedSlotText">Slot A</span> requires exactly <span id="selectedSlotDays">15</span> consecutive days
                                </p>
                            </div>

                            <div class="mb-4">
                                <label class="block font-semibold mb-2">Start Date:</label>
                                <input
                                    type="date"
                                    id="startDate"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none ${state.isProcessed ? 'bg-gray-100' : ''}"
                                    ${state.isProcessed ? 'disabled' : ''}
                                    onchange="updateEndDate()"
                                />
                            </div>

                            <div class="mb-4">
                                <label class="block font-semibold mb-2">End Date (Auto-calculated):</label>
                                <input
                                    type="date"
                                    id="endDate"
                                    readonly
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                                    ${state.isProcessed ? 'disabled' : ''}
                                />
                                <p class="text-xs text-gray-500 mt-1">
                                    End date is automatically calculated based on slot type
                                </p>
                            </div>

                            <div id="dateInfo" class="hidden p-3 rounded mb-4"></div>

                            <button
                                onclick="submitBid()"
                                ${state.isProcessed ? 'disabled' : ''}
                                class="w-full px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold ${state.isProcessed ? 'opacity-50 cursor-not-allowed' : ''}"
                            >
                                Submit Bid
                            </button>
                        </div>

                        <!-- Current Bids -->
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h3 class="text-xl font-bold mb-4">My Current Bids</h3>
                            
                            ${userBids.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <p>No bids placed yet</p>
                                </div>
                            ` : `
                                <div class="space-y-3" id="currentBids">
                                    ${userBids.map((bid, idx) => {
                                        const slot = state.slotTypes.find(s => s.id === bid.slotType);
                                        return `
                                            <div class="p-4 rounded-lg border-2 border-blue-300 bg-blue-50">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <p class="font-bold text-lg">${slot.name}</p>
                                                        <p class="text-sm text-gray-700 font-semibold">${bid.startDate} to ${bid.endDate}</p>
                                                        <p class="text-sm font-semibold text-gray-800">${bid.days} days</p>
                                                    </div>
                                                    ${!state.isProcessed ? `
                                                        <button
                                                            onclick="removeBid('${bid.employeeId}', '${bid.slotType}', '${bid.startDate}')"
                                                            class="ml-2 p-2 gradient-red text-white rounded hover:shadow-lg"
                                                        >
                                                            <i data-lucide="x" class="w-4 h-4"></i>
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            // Initialize selected slot
            if (!window.selectedSlot) {
                window.selectedSlot = 'slotA';
                updateSlotText();
            }
            
            document.getElementById('selectedMonth').addEventListener('change', updateMonthText);
            updateMonthText();
        }

        function renderAdminView() {
            document.getElementById('loginView').classList.add('hidden');
            
            const uniqueDepartments = ['all', ...new Set(state.employees.map(e => e.department || 'Unassigned'))].sort((a, b) => {
                if (a === 'all') return -1;
                if (b === 'all') return 1;
                return a.localeCompare(b);
            });
            
            const filteredEmployees = state.selectedDepartment === 'all' 
                ? state.employees 
                : state.employees.filter(e => (e.department || 'Unassigned') === state.selectedDepartment);
            
            const filteredBids = state.selectedDepartment === 'all'
                ? state.bids
                : state.bids.filter(b => {
                    const emp = state.employees.find(e => e.id === b.employeeId);
                    return emp && (emp.department || 'Unassigned') === state.selectedDepartment;
                });

            const employeesWhoBid = new Set(filteredBids.map(b => b.employeeId));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <label class="block font-semibold mb-2">Set Bidding Deadline:</label>
                            <input
                                type="datetime-local"
                                id="biddingDeadline"
                                value="${state.biddingDeadline}"
                                class="w-full px-4 py-2 border rounded-lg"
                                ${state.isProcessed ? 'disabled' : ''}
                            />
                            ${state.biddingDeadline ? `
                                <p class="text-sm text-gray-600 mt-2">
                                    Deadline: ${new Date(state.biddingDeadline).toLocaleString()}
                                </p>
                            ` : ''}
                        </div>

                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <label class="block font-semibold mb-2">Filter by Department:</label>
                            <select
                                id="adminDeptFilter"
                                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                            >
                                ${uniqueDepartments.map(dept => `
                                    <option value="${dept}" ${dept === state.selectedDepartment ? 'selected' : ''}>
                                        ${dept === 'all' ? 'All Departments' : dept}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <i data-lucide="users" class="mb-2 text-blue-600"></i>
                                <p class="text-2xl font-bold">${filteredEmployees.length}</p>
                                <p class="text-sm text-gray-600">
                                    ${state.selectedDepartment === 'all' ? 'Total Employees' : 'Employees in Department'}
                                </p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <i data-lucide="check-circle" class="mb-2 text-green-600"></i>
                                <p class="text-2xl font-bold">${filteredBids.length}</p>
                                <p class="text-sm text-gray-600">Total Bids Received</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <i data-lucide="clock" class="mb-2 text-yellow-600"></i>
                                <p class="text-2xl font-bold">${employeesWhoBid.size}</p>
                                <p class="text-sm text-gray-600">Employees Who Bid</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <button
                                onclick="processBids()"
                                ${state.isProcessed || state.employees.length === 0 ? 'disabled' : ''}
                                class="w-full px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold ${state.isProcessed || state.employees.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                            >
                                ${state.isProcessed ? 'Bids Already Processed' : 'Process All Bids'}
                            </button>
                            
                            ${state.isProcessed && state.results.length > 0 ? `
                                <button
                                    onclick="exportResults()"
                                    class="w-full px-6 py-3 gradient-green text-white rounded-lg hover:shadow-lg font-semibold"
                                >
                                    Export Results to Excel
                                </button>
                            ` : ''}
                            
                            <button
                                onclick="resetSystem()"
                                class="w-full px-6 py-3 gradient-red text-white rounded-lg hover:shadow-lg font-semibold"
                            >
                                Reset System
                            </button>
                        </div>

                        ${filteredBids.length > 0 ? `
                            <div class="mt-6">
                                <h3 class="font-bold mb-2">
                                    Current Bids Summary
                                    ${state.selectedDepartment !== 'all' ? ` - ${state.selectedDepartment}` : ''}
                                </h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-2 text-left">Rank</th>
                                                <th class="p-2 text-left">Employee Name</th>
                                                <th class="p-2 text-left">Employee ID</th>
                                                <th class="p-2 text-left">Department</th>
                                                <th class="p-2 text-left">Bids</th>
                                                <th class="p-2 text-left">Total Days</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Array.from(employeesWhoBid).map(empId => {
                                                const emp = state.employees.find(e => e.id === empId);
                                                const empBids = filteredBids.filter(b => b.employeeId === empId);
                                                const rank = filteredEmployees.findIndex(e => e.id === empId) + 1;
                                                const totalDays = empBids.reduce((sum, b) => sum + b.days, 0);
                                                
                                                return `
                                                    <tr class="border-b">
                                                        <td class="p-2">#${rank}</td>
                                                        <td class="p-2">${emp?.name || 'Unknown'}</td>
                                                        <td class="p-2">${empId}</td>
                                                        <td class="p-2">${emp?.department || 'Unassigned'}</td>
                                                        <td class="p-2">
                                                            ${empBids.map(b => {
                                                                const slot = state.slotTypes.find(s => s.id === b.slotType);
                                                                return slot.name;
                                                            }).join(', ')}
                                                        </td>
                                                        <td class="p-2 font-semibold">${totalDays} days</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            // Add event listeners
            document.getElementById('biddingDeadline').addEventListener('change', (e) => {
                state.biddingDeadline = e.target.value;
                saveState();
            });
            
            document.getElementById('adminDeptFilter').addEventListener('change', (e) => {
                state.selectedDepartment = e.target.value;
                renderView();
            });
        }

        function renderResultsView() {
            document.getElementById('loginView').classList.add('hidden');
            
            const uniqueDepartments = ['all', ...new Set(state.results.map(r => r.department))].sort((a, b) => {
                if (a === 'all') return -1;
                if (b === 'all') return 1;
                return a.localeCompare(b);
            });
            
            const filteredResults = state.selectedDepartment === 'all'
                ? state.results
                : state.results.filter(r => r.department === state.selectedDepartment);

            const employeeResults = {};
            filteredResults.forEach(result => {
                if (!employeeResults[result.employeeId]) {
                    employeeResults[result.employeeId] = {
                        employeeId: result.employeeId,
                        employeeName: result.employeeName,
                        department: result.department,
                        seniorityRank: result.seniorityRank,
                        slots: []
                    };
                }
                employeeResults[result.employeeId].slots.push(result);
            });

            const sortedEmployeeResults = Object.values(employeeResults).sort((a, b) => a.seniorityRank - b.seniorityRank);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Leave Assignment Results for ${state.biddingYear}</h2>
                            <button
                                onclick="exportResults()"
                                class="px-4 py-2 gradient-green text-white rounded-lg hover:shadow-lg font-semibold flex items-center gap-2"
                            >
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                Export to Excel
                            </button>
                        </div>

                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <label class="block font-semibold mb-2">Filter by Department:</label>
                            <select
                                id="resultsDeptFilter"
                                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                            >
                                ${uniqueDepartments.map(dept => `
                                    <option value="${dept}" ${dept === state.selectedDepartment ? 'selected' : ''}>
                                        ${dept === 'all' ? 'All Departments' : dept}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${state.results.length === 0 ? `
                            <div class="text-center py-8">
                                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                                <p class="text-gray-600">No results yet. Admin needs to process bids first.</p>
                            </div>
                        ` : `
                            <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                                <p class="font-semibold mb-2">Summary:</p>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Employees:</span>
                                        <p class="text-2xl font-bold text-blue-600">${sortedEmployeeResults.length}</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Total Slots:</span>
                                        <p class="text-2xl font-bold text-green-600">${filteredResults.length}</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Bid Awards:</span>
                                        <p class="text-2xl font-bold text-yellow-600">
                                            ${filteredResults.filter(r => r.type === 'Bid Awarded').length}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-left">Rank</th>
                                            <th class="p-3 text-left">Employee ID</th>
                                            <th class="p-3 text-left">Name</th>
                                            <th class="p-3 text-left">Department</th>
                                            <th class="p-3 text-left">Slot Type</th>
                                            <th class="p-3 text-left">Dates</th>
                                            <th class="p-3 text-left">Days</th>
                                            <th class="p-3 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedEmployeeResults.map((emp) => {
                                            return emp.slots.map((slot, idx) => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    ${idx === 0 ? `
                                                        <td class="p-3 font-semibold" rowspan="${emp.slots.length}">#${emp.seniorityRank}</td>
                                                        <td class="p-3" rowspan="${emp.slots.length}">${emp.employeeId}</td>
                                                        <td class="p-3" rowspan="${emp.slots.length}">${emp.employeeName}</td>
                                                        <td class="p-3" rowspan="${emp.slots.length}">${emp.department}</td>
                                                    ` : ''}
                                                    <td class="p-3 font-semibold text-blue-600">${slot.slotName}</td>
                                                    <td class="p-3 text-xs">${slot.startDate} to ${slot.endDate}</td>
                                                    <td class="p-3 font-semibold">${slot.days}</td>
                                                    <td class="p-3">
                                                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                                                            slot.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                                        }">
                                                            ${slot.type}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            document.getElementById('resultsDeptFilter').addEventListener('change', (e) => {
                state.selectedDepartment = e.target.value;
                renderView();
            });
        }

        function renderMyResultsView() {
            document.getElementById('loginView').classList.add('hidden');
            
            const myResults = state.results.filter(r => r.employeeId === state.verifiedEmployee?.id);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">My Leave Assignment</h2>
                        
                        ${myResults.length === 0 ? `
                            <div class="text-center py-8">
                                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                                <p class="text-gray-600">Results not yet available. Please wait for the planner to process bids.</p>
                            </div>
                        ` : `
                            <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                                <p class="font-semibold">Your Assigned Slots:</p>
                                <p class="text-sm text-gray-600">You have been assigned ${myResults.length} slot(s) for ${state.biddingYear}</p>
                                <p class="text-sm text-gray-600">Total: ${myResults.reduce((sum, r) => sum + r.days, 0)} days</p>
                            </div>
                            
                            <div class="space-y-3">
                                ${myResults.map((result, idx) => `
                                    <div class="border border-gray-200 rounded p-4">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="font-bold text-lg text-blue-600">${result.slotName}</p>
                                                <p class="text-sm text-gray-600">${result.startDate} to ${result.endDate}</p>
                                                <p class="text-sm font-semibold">${result.days} days</p>
                                            </div>
                                            <span class="px-3 py-1 rounded font-semibold ${
                                                result.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                            }">
                                                ${result.type}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        function renderChangePasswordView() {
            document.getElementById('loginView').classList.add('hidden');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-md mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold mb-6">Change Password</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold mb-2">Current Password:</label>
                                <input
                                    type="password"
                                    id="currentPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter current password"
                                />
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2">New Password:</label>
                                <input
                                    type="password"
                                    id="newPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter new password"
                                />
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2">Confirm New Password:</label>
                                <input
                                    type="password"
                                    id="confirmPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                    placeholder="Confirm new password"
                                />
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button
                                onclick="changePassword()"
                                class="flex-1 px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold"
                            >
                                Change Password
                            </button>
                            <button
                                onclick="setActiveView('employee')"
                                class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChangePlannerPasswordView() {
            document.getElementById('loginView').classList.add('hidden');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-md mx-auto fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold mb-6">Change Planner Password</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold mb-2">Current Password:</label>
                                <input
                                    type="password"
                                    id="currentPlannerPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    placeholder="Enter current password"
                                />
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2">New Password:</label>
                                <input
                                    type="password"
                                    id="newPlannerPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    placeholder="Enter new password (min 6 characters)"
                                />
                            </div>
                            
                            <div>
                                <label class="block font-semibold mb-2">Confirm New Password:</label>
                                <input
                                    type="password"
                                    id="confirmPlannerPassword"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    placeholder="Confirm new password"
                                />
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button
                                onclick="changePlannerPassword()"
                                class="flex-1 px-6 py-3 gradient-purple text-white rounded-lg hover:shadow-lg font-semibold"
                            >
                                Change Password
                            </button>
                            <button
                                onclick="setActiveView('admin')"
                                class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== EVENT HANDLERS ====================
        function setLoginType(type) {
            state.loginType = type;
            const employeeBtn = document.getElementById('loginTypeEmployee');
            const plannerBtn = document.getElementById('loginTypePlanner');
            
            if (type === 'employee') {
                employeeBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold gradient-blue text-white';
                plannerBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
            } else {
                employeeBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                plannerBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold gradient-purple text-white';
            }
            
            renderLoginView();
        }

        function handleLogin() {
            if (state.loginType === 'planner') {
                const password = document.getElementById('loginPassword').value;
                if (password === state.plannerPassword) {
                    state.currentUser = { type: 'planner', name: 'Planner Admin' };
                    state.userType = 'planner';
                    state.activeView = 'upload';
                    alert('Welcome, Planner!');
                    renderView();
                } else {
                    alert('Incorrect planner password');
                }
            } else {
                const id = document.getElementById('loginId')?.value;
                const password = document.getElementById('loginPassword')?.value;
                
                if (!id || !password) {
                    alert('Please enter both ID and password');
                    return;
                }
                
                const employee = state.employees.find(emp => emp.id === id);
                if (!employee) {
                    alert('Employee ID not found');
                    return;
                }
                
                const storedPassword = state.employeePasswords[id] || id;
                if (password === storedPassword) {
                    state.currentUser = { type: 'employee', ...employee };
                    state.userType = 'employee';
                    state.verifiedEmployee = employee;
                    state.selectedEmployeeId = id;
                    state.activeView = 'employee';
                    alert(`Welcome, ${employee.name}!`);
                    renderView();
                } else {
                    alert('Incorrect password');
                }
            }
        }

        function handleLogout() {
            state.currentUser = null;
            state.userType = null;
            state.verifiedEmployee = null;
            state.selectedEmployeeId = '';
            state.activeView = 'login';
            renderView();
        }

        function setActiveView(view) {
            state.activeView = view;
            renderView();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please upload a valid Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellText: false,
                        cellDates: true
                    });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        raw: false,
                        defval: ''
                    });

                    console.log('Processing Excel file...');
                    console.log('Total rows:', jsonData.length);

                    const employeeData = jsonData.map((row, index) => {
                        const id = String(
                            row['Personnel number'] || 
                            row['Personnel Number'] || 
                            row['Personnel_number'] ||
                            row['Personnelnumber'] ||
                            row['ID'] || 
                            row['id'] || 
                            row['EmployeeID'] || 
                            row['Employee ID'] || 
                            ''
                        );
                        
                        const forename = String(
                            row['Forename'] || 
                            row['forename'] ||
                            row['FORENAME'] ||
                            row['Name'] || 
                            row['name'] || 
                            row['First Name'] || 
                            row['EmployeeName'] || 
                            ''
                        );
                        
                        const surname = String(
                            row['Surname'] || 
                            row['surname'] ||
                            row['SURNAME'] ||
                            row['Last Name'] || 
                            row['LastName'] || 
                            ''
                        );
                        
                        const name = surname ? `${forename} ${surname}` : forename;
                        
                        const seniorityDate = row['Seniority Date'] || 
                            row['SeniorityDate'] || 
                            row['seniorityDate'] ||
                            row['Start of staff membership'] || 
                            row['Start_of_staff_membership'] ||
                            row['Start Date'] || 
                            row['start date'] ||
                            row['StartDate'] || 
                            row['Seniority'] ||
                            row['Joining Date'] ||
                            row['JoiningDate'] ||
                            row['Date of Joining'] ||
                            new Date();

                        const role = String(
                            row['Role'] ||
                            row['role'] ||
                            row['ROLE'] ||
                            row['Position'] ||
                            row['Job Title'] ||
                            row['Designation'] ||
                            row['Job title'] ||
                            ''
                        );

                        let department = '';
                        
                        // Check for "Scheduling row" column
                        if (row['Scheduling row'] || row['Scheduling_row'] || row['SchedulingRow']) {
                            const schedValue = String(row['Scheduling row'] || row['Scheduling_row'] || row['SchedulingRow'] || '');
                            if (schedValue.trim() !== '') {
                                department = schedValue.split('.')[0].trim();
                            }
                        }
                        
                        // Fallback: Try standard department columns
                        if (!department) {
                            const allKeys = Object.keys(row);
                            for (const key of allKeys) {
                                const value = row[key];
                                const lowerKey = key.toLowerCase();
                                
                                if (lowerKey === 'department' || 
                                    lowerKey === 'departments' ||
                                    lowerKey === 'dept') {
                                    
                                    if (value && String(value).trim() !== '') {
                                        department = String(value).trim();
                                        break;
                                    }
                                }
                            }
                        }

                        return {
                            id: id.trim(),
                            name: name.trim(),
                            seniorityDate: formatExcelDate(seniorityDate).toISOString(),
                            role: role.trim(),
                            department: department,
                            gender: String(row['Gender'] || row['gender'] || '').trim(),
                            nationality: String(row['Nationality'] || row['nationality'] || '').trim()
                        };
                    }).filter(emp => emp.id && emp.name);

                    employeeData.sort((a, b) => new Date(a.seniorityDate) - new Date(b.seniorityDate));
                    
                    state.employees = employeeData;
                    
                    // Initialize passwords for new employees
                    employeeData.forEach(emp => {
                        if (!state.employeePasswords[emp.id]) {
                            state.employeePasswords[emp.id] = emp.id;
                        }
                    });
                    
                    saveState();
                    renderView();
                    
                    alert(`Successfully loaded ${employeeData.length} employees`);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert('Error processing Excel file. Please check the format.');
                }
            };
            
            reader.onerror = () => {
                alert('Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function saveSlotConfiguration() {
            const inputs = document.querySelectorAll('.slot-input');
            inputs.forEach(input => {
                const key = input.dataset.key;
                const value = parseInt(input.value) || 5; // Default to 5 if empty
                state.slotCapacities[key] = value;
            });
            
            const totalSlots = Object.values(state.slotCapacities).reduce((sum, val) => sum + val, 0);
            
            alert(`‚úì Slot capacities saved successfully!\n\n` +
                  `Total slot positions configured: ${totalSlots}\n\n` +
                  `Returning to Admin Panel...`);
            
            saveState();
            setActiveView('admin');
        }

        function setSelectedSlot(slotId) {
            window.selectedSlot = slotId;
            updateSlotText();
            
            // Update button styles
            document.querySelectorAll('.slot-btn').forEach(btn => {
                if (btn.dataset.slot === slotId) {
                    btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all gradient-blue text-white';
                } else if (btn.dataset.hasbid === 'true' || state.isProcessed) {
                    btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-200 text-gray-500 cursor-not-allowed';
                } else {
                    btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-100 hover:bg-gray-200 text-gray-800';
                }
            });
            
            // Clear date inputs
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('dateInfo').classList.add('hidden');
        }

        function updateSlotText() {
            const slot = state.slotTypes.find(s => s.id === window.selectedSlot);
            if (slot) {
                document.getElementById('selectedSlotText').textContent = slot.name;
                document.getElementById('selectedSlotDays').textContent = slot.days;
            }
        }

        function updateMonthText() {
            const monthSelect = document.getElementById('selectedMonth');
            if (monthSelect) {
                document.getElementById('selectedMonthText').textContent = monthSelect.value;
            }
        }

        function updateEndDate() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const dateInfo = document.getElementById('dateInfo');
            
            if (!startDateInput.value || !window.selectedSlot) {
                endDateInput.value = '';
                dateInfo.classList.add('hidden');
                return;
            }
            
            const slot = state.slotTypes.find(s => s.id === window.selectedSlot);
            if (!slot) return;
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + slot.days - 1);
            
            endDateInput.value = endDate.toISOString().split('T')[0];
            
            const days = calculateDaysBetween(startDateInput.value, endDateInput.value);
            
            if (days === slot.days) {
                dateInfo.innerHTML = `
                    <p class="font-semibold text-green-800">
                        Selected: ${days} days ‚úì
                    </p>
                    <p class="text-sm mt-1 text-green-700">
                        ${startDateInput.value} to ${endDateInput.value}
                    </p>
                `;
                dateInfo.className = 'p-3 rounded mb-4 bg-green-50 border border-green-200';
            } else {
                dateInfo.innerHTML = `
                    <p class="font-semibold text-red-800">
                        Selected: ${days} days (Required: ${slot.days} days)
                    </p>
                    <p class="text-sm mt-1 text-red-700">
                        ${startDateInput.value} to ${endDateInput.value}
                    </p>
                `;
                dateInfo.className = 'p-3 rounded mb-4 bg-red-50 border border-red-200';
            }
            
            dateInfo.classList.remove('hidden');
        }

        function submitBid() {
            if (!state.verifiedEmployee) {
                alert('Please enter and verify your Employee ID first');
                return;
            }

            if (state.isProcessed) {
                alert('Bidding has been processed. No more bids allowed.');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const monthSelect = document.getElementById('selectedMonth');
            const month = monthSelect ? monthSelect.value : state.months[0];

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            const slot = state.slotTypes.find(s => s.id === window.selectedSlot);
            const days = calculateDaysBetween(startDate, endDate);

            if (days !== slot.days) {
                alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.`);
                return;
            }

            const start = new Date(startDate);
            const yearStart = new Date(state.biddingYear, 0, 1);
            const yearEnd = new Date(state.biddingYear, 11, 31);

            if (start < yearStart || start > yearEnd) {
                alert(`Start date must be within ${state.biddingYear}`);
                return;
            }

            const existingBid = state.bids.find(
                bid => bid.employeeId === state.verifiedEmployee.id && bid.slotType === window.selectedSlot
            );
            
            if (existingBid) {
                alert(`You have already bid for ${slot.name}. You cannot bid for the same slot twice.`);
                return;
            }

            const userBids = state.bids.filter(bid => bid.employeeId === state.verifiedEmployee.id);
            const entitlement = getEmployeeEntitlement(state.verifiedEmployee);
            
            if (userBids.length >= 2) {
                alert('You can only place 2 bids maximum.');
                return;
            }

            const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
            if (totalBidDays + days > entitlement) {
                alert(`Your total leave days would exceed your entitlement of ${entitlement} days.\n\nCurrent bids: ${totalBidDays} days\nThis bid: ${days} days\nTotal: ${totalBidDays + days} days`);
                return;
            }

            for (const bid of userBids) {
                if (checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                    alert(`Date overlap detected with your existing ${state.slotTypes.find(s => s.id === bid.slotType).name} bid (${bid.startDate} to ${bid.endDate})`);
                    return;
                }
            }

            const newBid = {
                employeeId: state.verifiedEmployee.id,
                employeeName: state.verifiedEmployee.name,
                seniorityDate: state.verifiedEmployee.seniorityDate,
                department: state.verifiedEmployee.department,
                slotType: window.selectedSlot,
                startDate,
                endDate,
                days,
                timestamp: new Date().toISOString()
            };

            state.bids.push(newBid);
            saveState();
            alert(`‚úì Bid placed successfully for ${slot.name} (${days} days)!`);
            
            // Clear form and refresh view
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('dateInfo').classList.add('hidden');
            renderView();
        }

        function removeBid(employeeId, slotType, startDate) {
            if (state.isProcessed) {
                alert('Cannot remove bids after processing');
                return;
            }
            
            if (confirm('Are you sure you want to remove this bid?')) {
                state.bids = state.bids.filter(bid => 
                    !(bid.employeeId === employeeId && 
                      bid.slotType === slotType && 
                      bid.startDate === startDate)
                );
                saveState();
                renderView();
            }
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            const storedPassword = state.employeePasswords[state.verifiedEmployee.id] || state.verifiedEmployee.id;
            
            if (currentPassword !== storedPassword) {
                alert('Current password is incorrect');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword.length < 4) {
                alert('Password must be at least 4 characters long');
                return;
            }

            state.employeePasswords[state.verifiedEmployee.id] = newPassword;
            saveState();
            alert('Password changed successfully!');
            setActiveView('employee');
        }

        function changePlannerPassword() {
            const currentPassword = document.getElementById('currentPlannerPassword').value;
            const newPassword = document.getElementById('newPlannerPassword').value;
            const confirmPassword = document.getElementById('confirmPlannerPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (currentPassword !== state.plannerPassword) {
                alert('Current password is incorrect');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            state.plannerPassword = newPassword;
            saveState();
            alert('‚úì Planner password changed successfully!');
            setActiveView('admin');
        }

        function processBids() {
            if (state.employees.length === 0) {
                alert('No employees to process');
                return;
            }

            console.log('Starting bid processing...');
            console.log('Total employees:', state.employees.length);
            console.log('Total bids:', state.bids.length);

            const employeesByDept = {};
            state.employees.forEach(emp => {
                const dept = emp.department || 'Unassigned';
                if (!employeesByDept[dept]) {
                    employeesByDept[dept] = [];
                }
                employeesByDept[dept].push(emp);
            });

            console.log('Departments:', Object.keys(employeesByDept));

            const allAssignments = [];

            Object.keys(employeesByDept).forEach(dept => {
                const deptEmployees = employeesByDept[dept];
                
                const sortedEmployees = [...deptEmployees].sort((a, b) => 
                    new Date(a.seniorityDate) - new Date(b.seniorityDate)
                );

                const employeesWhoBid = new Set(state.bids.filter(b => {
                    const emp = state.employees.find(e => e.id === b.employeeId);
                    return emp && (emp.department || 'Unassigned') === dept;
                }).map(bid => bid.employeeId));
                
                const biddingEmployees = sortedEmployees.filter(emp => employeesWhoBid.has(emp.id));
                const nonBiddingEmployees = sortedEmployees.filter(emp => !employeesWhoBid.has(emp.id));

                console.log(`Dept ${dept}: ${biddingEmployees.length} bidders, ${nonBiddingEmployees.length} non-bidders`);

                // Track used slots per month/slot type
                const usedSlots = {};

                // PHASE 1: Process bidding employees (SENIORITY MATTERS - most senior gets priority)
                biddingEmployees.forEach(employee => {
                    const employeeBids = state.bids
                        .filter(bid => bid.employeeId === employee.id)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    employeeBids.forEach(bid => {
                        const slot = state.slotTypes.find(s => s.id === bid.slotType);
                        
                        // Find which month this bid falls into
                        const bidStart = new Date(bid.startDate);
                        const bidMonth = state.months[bidStart.getMonth()];
                        
                        // Check if slot has available capacity - DEFAULT IS 5
                        const slotKey = `${bidMonth}-${bid.slotType}`;
                        const capacity = state.slotCapacities[`${bidMonth}-${bid.slotType.replace('slot', '')}`] !== undefined 
                            ? state.slotCapacities[`${bidMonth}-${bid.slotType.replace('slot', '')}`]
                            : 5; // Default to 5 if not configured
                        const used = usedSlots[slotKey] || 0;

                        if (used < capacity) {
                            // Award the bid
                            allAssignments.push({
                                employeeId: employee.id,
                                employeeName: employee.name,
                                department: dept,
                                slotType: bid.slotType,
                                slotName: slot.name,
                                startDate: bid.startDate,
                                endDate: bid.endDate,
                                days: bid.days,
                                type: 'Bid Awarded',
                                month: bidMonth,
                                seniorityRank: sortedEmployees.findIndex(e => e.id === employee.id) + 1
                            });

                            // Track this slot as used
                            if (!usedSlots[slotKey]) {
                                usedSlots[slotKey] = 0;
                            }
                            usedSlots[slotKey]++;
                        } else {
                            // Capacity exceeded - bid rejected
                            console.log(`Bid rejected for ${employee.name} - ${bidMonth} ${slot.name} at capacity`);
                        }
                    });
                });

                // PHASE 2: Auto-assign LEFTOVER slots to non-bidding employees
                nonBiddingEmployees.forEach(employee => {
                    const entitlement = getEmployeeEntitlement(employee);
                    let assignedDays = 0;
                    const employeeAssignments = [];

                    // Try to assign 2 slots from LEFTOVER capacity only
                    for (const month of state.months) {
                        if (assignedDays >= entitlement || employeeAssignments.length >= 2) break;

                        // Try each slot type (A, B, C) in order
                        for (const slotType of state.slotTypes) {
                            if (assignedDays >= entitlement || employeeAssignments.length >= 2) break;

                            const slotKey = `${month}-${slotType.id}`;
                            const capacity = state.slotCapacities[`${month}-${slotType.id.replace('slot', '')}`] !== undefined
                                ? state.slotCapacities[`${month}-${slotType.id.replace('slot', '')}`]
                                : 5; // Default to 5 if not configured
                            const used = usedSlots[slotKey] || 0;

                            // Only assign if there's LEFTOVER capacity and it fits their entitlement
                            if (used < capacity && assignedDays + slotType.days <= entitlement) {
                                // Calculate dates for this month
                                const year = state.biddingYear;
                                const monthIndex = state.months.indexOf(month);
                                const startDate = new Date(year, monthIndex, 1);
                                const endDate = new Date(startDate);
                                endDate.setDate(endDate.getDate() + slotType.days - 1);

                                employeeAssignments.push({
                                    employeeId: employee.id,
                                    employeeName: employee.name,
                                    department: dept,
                                    slotType: slotType.id,
                                    slotName: slotType.name,
                                    startDate: startDate.toISOString().split('T')[0],
                                    endDate: endDate.toISOString().split('T')[0],
                                    days: slotType.days,
                                    type: 'Auto-Assigned (Leftover)',
                                    month: month,
                                    seniorityRank: sortedEmployees.findIndex(e => e.id === employee.id) + 1
                                });

                                assignedDays += slotType.days;
                                
                                // Mark slot as used
                                if (!usedSlots[slotKey]) {
                                    usedSlots[slotKey] = 0;
                                }
                                usedSlots[slotKey]++;

                                // Stop after 2 slots
                                if (employeeAssignments.length >= 2) break;
                            }
                        }
                    }

                    // Add all assignments for this employee
                    allAssignments.push(...employeeAssignments);

                    // If couldn't assign enough, mark as not fully assigned
                    if (employeeAssignments.length === 0) {
                        // Add a "No Assignment" record
                        allAssignments.push({
                            employeeId: employee.id,
                            employeeName: employee.name,
                            department: dept,
                            slotType: 'none',
                            slotName: 'No Assignment',
                            startDate: '-',
                            endDate: '-',
                            days: 0,
                            type: 'Not Assigned (No Leftover)',
                            month: '-',
                            seniorityRank: sortedEmployees.findIndex(e => e.id === employee.id) + 1
                        });
                    }
                });
            });

            console.log('Total assignments:', allAssignments.length);

            if (allAssignments.length === 0) {
                alert('‚ö†Ô∏è No assignments created.\n\nPossible reasons:\n- No employees uploaded\n- No slot capacities configured\n\nPlease check Configure Slots and try again.');
                return;
            }

            state.results = allAssignments;
            state.isProcessed = true;
            
            const deptCount = Object.keys(employeesByDept).length;
            const bidderCount = new Set(state.bids.map(b => b.employeeId)).size;
            const autoAssignedCount = allAssignments.filter(a => a.type === 'Auto-Assigned (Leftover)').length;
            const nonBidderCount = state.employees.length - bidderCount;
            const notAssignedCount = allAssignments.filter(a => a.type === 'Not Assigned (No Leftover)').length;
            
            let message = `‚úì Processing complete!\n\n`;
            message += `${deptCount} departments processed\n`;
            message += `${bidderCount} employees with bids\n`;
            message += `${nonBidderCount} employees without bids\n`;
            message += `${autoAssignedCount} auto-assignments made\n`;
            message += `${allAssignments.length} total assignments\n`;
            
            if (notAssignedCount > 0) {
                message += `\n‚ö†Ô∏è ${notAssignedCount} employees could not be assigned (insufficient slot capacity)`;
            }
            
            alert(message);
            saveState();
            
            // Add Results button to navigation
            if (state.userType === 'planner') {
                const plannerNav = document.getElementById('plannerNav');
                if (!plannerNav.querySelector('[onclick="setActiveView(\'results\')"]')) {
                    const resultsBtn = document.createElement('button');
                    resultsBtn.onclick = () => setActiveView('results');
                    resultsBtn.className = 'px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100';
                    resultsBtn.textContent = 'View Results';
                    plannerNav.appendChild(resultsBtn);
                }
            }
            
            if (state.userType === 'employee') {
                const employeeNav = document.getElementById('employeeNav');
                if (!employeeNav.querySelector('[onclick="setActiveView(\'myResults\')"]')) {
                    const resultsBtn = document.createElement('button');
                    resultsBtn.onclick = () => setActiveView('myResults');
                    resultsBtn.className = 'px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100';
                    resultsBtn.textContent = 'My Results';
                    employeeNav.insertBefore(resultsBtn, employeeNav.children[1]);
                }
            }
            
            setActiveView('results');
        }

        function exportResults() {
            if (state.results.length === 0) {
                alert('No results to export.');
                return;
            }

            const exportData = state.results.map(result => {
                const employee = state.employees.find(e => e.id === result.employeeId);
                return {
                    'Seniority Rank': result.seniorityRank,
                    'Employee ID': result.employeeId,
                    'Employee Name': result.employeeName,
                    'Department': result.department,
                    'Role': employee?.role || '',
                    'Gender': employee?.gender || '',
                    'Nationality': employee?.nationality || '',
                    'Slot Type': result.slotName,
                    'Month': result.month || '',
                    'Start Date': result.startDate,
                    'End Date': result.endDate,
                    'Days': result.days,
                    'Assignment Type': result.type
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Leave Assignments');
            XLSX.writeFile(wb, `Leave_Assignments_${state.biddingYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('Results exported successfully!');
        }

        function resetSystem() {
            if (!confirm('Are you sure you want to reset the system? This will clear all bids and results for ALL users.')) {
                return;
            }
            
            // Clear all state
            localStorage.clear();
            
            // Reset state with default slot capacities of 5
            state = {
                employees: [],
                employeePasswords: {},
                bids: [],
                biddingDeadline: '',
                biddingYear: 2026,
                isProcessed: false,
                activeView: 'login',
                selectedEmployeeId: '',
                verifiedEmployee: null,
                currentUser: null,
                userType: null,
                plannerPassword: 'admin123',
                results: [],
                selectedDepartment: 'all',
                slotCapacities: {}, // Will default to 5 when not configured
                departments: state.departments,
                slotTypes: state.slotTypes,
                months: state.months,
                loginType: 'employee'
            };
            
            alert('‚úì System has been reset successfully for all users!');
            renderView();
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            // Set initial login type
            state.loginType = 'employee';
            
            // Try to load from cloud first
            try {
                const dataLoaded = await loadFromCloud();
                if (dataLoaded) {
                    console.log('‚úÖ System data loaded from cloud');
                }
            } catch (error) {
                console.log('Using local data');
            }
            
            // Render initial view
            renderView();
            
            // Add global event listeners for Enter key in login
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && state.activeView === 'login') {
                    handleLogin();
                }
            });
        }
        
        // Initialize the application
        init();
