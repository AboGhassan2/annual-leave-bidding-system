<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700&family=Barlow:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --metro-green: #2d6a4f;
            --metro-green-dark: #1b4332;
            --metro-green-mid: #40916c;
            --metro-green-light: #74c69d;
            --metro-accent: #52b788;
            --metro-bg: #081c15;
            --metro-card: rgba(255,255,255,0.06);
            --metro-border: rgba(255,255,255,0.12);
            --metro-text: #d8f3dc;
        }

        * { font-family: 'Barlow', sans-serif; box-sizing: border-box; }
        h1, h2, h3, .brand-font { font-family: 'Barlow Condensed', sans-serif; letter-spacing: 0.05em; }

        body {
            background: var(--metro-bg);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated metro background */
        #loginView {
            position: relative;
            z-index: 1;
        }

        .login-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            background:
                radial-gradient(ellipse 100% 60% at 50% 0%, #1b4332 0%, transparent 65%),
                radial-gradient(ellipse 70% 50% at 0% 50%, #2d6a4f22 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 100% 60%, #40916c22 0%, transparent 60%),
                linear-gradient(180deg, #081c15 0%, #0d2818 60%, #081c15 100%);
            pointer-events: none;
        }

        /* Subtle grid lines like metro map */
        .login-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(74,182,130,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(74,182,130,0.04) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Glowing orbs */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.25;
            pointer-events: none;
            animation: orbFloat 8s ease-in-out infinite;
        }
        .orb-1 { width: 500px; height: 500px; background: #2d6a4f; top: -100px; left: -100px; animation-delay: 0s; }
        .orb-2 { width: 400px; height: 400px; background: #40916c; bottom: -80px; right: -80px; animation-delay: -4s; }
        .orb-3 { width: 300px; height: 300px; background: #1b4332; top: 40%; left: 60%; animation-delay: -2s; }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20px, -20px) scale(1.05); }
            66% { transform: translate(-15px, 15px) scale(0.95); }
        }

        /* ===== NEW LANDING PAGE STYLES ===== */

        /* Top navbar */
        .lp-navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 32px;
            background: rgba(8,28,21,0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(82,183,136,0.12);
        }
        .lp-navbar-left { display: flex; align-items: center; gap: 16px; }
        .lp-nav-logo {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.6rem; font-weight: 700; color: #fff; letter-spacing: 0.08em;
        }
        .lp-nav-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.18); }
        .lp-nav-title {
            font-size: 0.7rem; font-weight: 600; letter-spacing: 0.2em;
            text-transform: uppercase; color: rgba(255,255,255,0.45);
        }
        .lp-navbar-center {
            display: flex; align-items: center; gap: 0;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            overflow: hidden;
        }
        .lp-role-select {
            background: transparent;
            border: none; outline: none;
            color: #fff; font-size: 0.88rem; font-weight: 600;
            padding: 8px 36px 8px 14px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }
        .lp-role-select option { background: #0d2818; }
        .lp-select-wrap {
            position: relative;
            display: flex; align-items: center;
            padding: 0 8px;
            border-left: 1px solid rgba(255,255,255,0.12);
        }
        .lp-select-wrap::after {
            content: '‚ñæ'; position: absolute; right: 16px;
            color: rgba(255,255,255,0.5); font-size: 0.8rem; pointer-events: none;
        }
        .lp-select-icon { font-size: 0.9rem; }
        .lp-navbar-right { display: flex; align-items: center; gap: 16px; }
        .lp-lang-toggle {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.8rem; color: rgba(255,255,255,0.6);
        }
        .lp-lang-toggle span.active { color: #fff; font-weight: 600; }
        .lp-theme-btn {
            background: none; border: none; cursor: pointer;
            color: rgba(255,255,255,0.55); font-size: 1.1rem; line-height: 1;
        }
        .lp-avatar {
            width: 38px; height: 38px; border-radius: 50%;
            background: linear-gradient(135deg, #40916c, #1b4332);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: #fff;
            border: 2px solid rgba(82,183,136,0.3);
            cursor: pointer;
        }

        /* Hero section */
        .lp-hero {
            min-height: 100vh;
            padding: 100px 5% 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .lp-hero-top {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 48px;
            align-items: center;
            margin-bottom: 56px;
        }
        .lp-headline {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: clamp(2.8rem, 5vw, 4rem);
            font-weight: 700;
            color: #fff;
            line-height: 1.05;
            letter-spacing: 0.01em;
            margin-bottom: 8px;
        }
        .lp-subheadline {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: clamp(1.8rem, 3vw, 2.5rem);
            font-weight: 500;
            color: rgba(255,255,255,0.75);
            margin-bottom: 16px;
        }
        .lp-desc {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.45);
            max-width: 420px;
            line-height: 1.6;
            margin-bottom: 32px;
        }
        .lp-cta-row { display: flex; gap: 14px; align-items: center; }
        .lp-btn-primary {
            padding: 13px 34px;
            background: linear-gradient(135deg, #8b6914 0%, #b8860b 50%, #d4a017 100%);
            color: #fff;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem; font-weight: 700; letter-spacing: 0.1em;
            border: none; border-radius: 10px; cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(180,130,20,0.35);
        }
        .lp-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(180,130,20,0.5); }
        .lp-btn-secondary {
            padding: 13px 28px;
            background: rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.75);
            font-family: 'Barlow', sans-serif;
            font-size: 0.9rem; font-weight: 500;
            border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .lp-btn-secondary:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }

        /* Stats card */
        .lp-stats-card {
            background: rgba(230,240,235,0.92);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px 28px 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.15);
            color: #1a2e22;
            animation: cardReveal 0.8s cubic-bezier(0.16,1,0.3,1) both;
        }
        .lp-stats-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }
        .lp-stat-label {
            font-size: 0.75rem; font-weight: 600; color: #5a7a66;
            text-transform: uppercase; letter-spacing: 0.08em;
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 4px;
        }
        .lp-stat-big {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.4rem; font-weight: 700; color: #1a2e22; line-height: 1;
        }
        .lp-stat-badge {
            background: #fff;
            border-radius: 10px;
            padding: 8px 14px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.4rem; font-weight: 700; color: #1a2e22;
            display: flex; align-items: center; gap: 6px;
        }
        .lp-stat-badge .arrow-up { color: #2d9f5f; font-size: 0.9rem; }
        .lp-stat-line {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.07);
            font-size: 0.85rem;
        }
        .lp-stat-line-label { color: #5a7a66; display: flex; align-items: center; gap: 7px; }
        .lp-stat-line-val { font-weight: 700; color: #1a2e22; }
        .lp-status-open { color: #1e8c4a; font-weight: 700; }
        .lp-status-check { color: #1e8c4a; font-size: 1rem; }
        .lp-quota-row {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 16px;
        }
        .lp-quota-left {}
        .lp-quota-label { font-size: 0.75rem; font-weight: 600; color: #5a7a66; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }
        .lp-quota-pct {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.2rem; font-weight: 700; color: #1a2e22;
        }
        .lp-quota-pct sup { font-size: 1rem; }
        .lp-quota-bar {
            width: 100px; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 8px;
        }
        .lp-quota-bar-fill {
            height: 100%; background: linear-gradient(90deg, #2d6a4f, #52b788);
            border-radius: 2px;
        }
        .lp-donut-wrap { position: relative; width: 90px; height: 90px; }
        .lp-donut-pct {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem; font-weight: 700; color: #1a2e22;
        }

        /* Login cards grid */
        .lp-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .lp-login-card {
            background: rgba(220,235,228,0.88);
            backdrop-filter: blur(16px);
            border-radius: 18px;
            padding: 28px 24px 24px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            animation: cardReveal 0.7s cubic-bezier(0.16,1,0.3,1) both;
            color: #1a2e22;
        }
        .lp-login-card.gc-card {
            background: rgba(240,232,210,0.92);
            border: 2px solid rgba(184,134,11,0.5);
            box-shadow: 0 8px 40px rgba(180,130,20,0.2);
        }
        .lp-login-card:nth-child(1) { animation-delay: 0.1s; }
        .lp-login-card:nth-child(2) { animation-delay: 0.2s; }
        .lp-login-card:nth-child(3) { animation-delay: 0.3s; }

        .lp-card-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 18px;
        }
        .lp-card-icon { font-size: 1.6rem; }
        .lp-card-title { font-family: 'Barlow Condensed', sans-serif; font-size: 1.3rem; font-weight: 700; color: #1a2e22; }
        .lp-card-subtitle { font-size: 0.78rem; color: #5a7a66; margin-top: 1px; }
        .lp-card-check { margin-left: auto; color: #2d9f5f; font-size: 1.1rem; }

        .gc-badge {
            background: linear-gradient(135deg, #8b6914, #d4a017);
            border-radius: 10px;
            padding: 6px 14px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.8rem; font-weight: 700; letter-spacing: 0.1em;
            color: #fff;
            text-transform: uppercase;
            display: flex; align-items: center; gap: 8px;
        }
        .gc-card-sub {
            font-size: 0.88rem; font-weight: 600; color: #1a2e22;
            margin-bottom: 18px;
        }

        .lp-input-wrap {
            position: relative; margin-bottom: 12px;
        }
        .lp-input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #5a7a66; font-size: 0.9rem;
        }
        .lp-input-icon-right {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            color: #8aa898; font-size: 0.85rem;
        }
        .lp-input {
            width: 100%; padding: 11px 36px 11px 34px;
            background: rgba(255,255,255,0.55);
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 10px;
            font-size: 0.88rem; color: #1a2e22;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .lp-input::placeholder { color: #8aa898; }
        .lp-input:focus {
            border-color: #40916c;
            box-shadow: 0 0 0 3px rgba(64,145,108,0.15);
            background: rgba(255,255,255,0.8);
        }
        .gc-card .lp-input:focus {
            border-color: #b8860b;
            box-shadow: 0 0 0 3px rgba(184,134,11,0.15);
        }

        .lp-card-footer {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 16px; margin-top: 4px;
        }
        .lp-remember { display: flex; align-items: center; gap: 5px; font-size: 0.78rem; color: #5a7a66; cursor: pointer; }
        .lp-forgot { margin-left: auto; font-size: 0.78rem; color: #2d6a4f; cursor: pointer; background: none; border: none; text-decoration: none; }
        .lp-forgot:hover { text-decoration: underline; }

        .lp-sign-btn {
            width: 100%; padding: 12px;
            background: linear-gradient(135deg, #1b4332, #2d6a4f);
            color: #fff;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem; font-weight: 700; letter-spacing: 0.08em;
            border: none; border-radius: 10px; cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(27,67,50,0.35);
        }
        .lp-sign-btn:hover { background: linear-gradient(135deg, #2d6a4f, #40916c); transform: translateY(-1px); }

        .gc-sign-btn {
            background: linear-gradient(135deg, #8b6914 0%, #b8860b 50%, #d4a017 100%);
            box-shadow: 0 4px 16px rgba(184,134,11,0.35);
        }
        .gc-sign-btn:hover { background: linear-gradient(135deg, #a07820, #d4a017); }

        /* Status bar */
        .lp-status-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(8,28,21,0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(82,183,136,0.15);
            padding: 12px 32px;
            display: flex; align-items: center; gap: 32px;
            z-index: 50;
        }
        .lp-status-item {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.78rem; color: rgba(255,255,255,0.6);
        }
        .lp-status-check-icon {
            width: 18px; height: 18px; border-radius: 50%;
            background: rgba(45,159,95,0.2); border: 1px solid #2d9f5f;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6rem; color: #2d9f5f;
        }

        @keyframes cardReveal {
            from { opacity: 0; transform: translateY(30px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Logo area (legacy) */
        .logo-area {
            border-bottom: 1px solid rgba(82,183,136,0.15);
            padding-bottom: 20px;
            margin-bottom: 24px;
        }

        .flow-logo {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.4rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #fff;
            line-height: 1;
        }
        .flow-logo span { color: var(--metro-green-light); }

        .logo-divider {
            width: 1px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            margin: 0 14px;
        }

        .logo-sub {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.18em;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            line-height: 1.4;
        }

        /* Clock */
        .clock-display {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: var(--metro-green-light);
            background: rgba(82,183,136,0.08);
            border: 1px solid rgba(82,183,136,0.15);
            border-radius: 8px;
            padding: 6px 14px;
            display: inline-block;
        }

        /* Status pill */
        .status-pill {
            background: rgba(82,183,136,0.1);
            border: 1px solid rgba(82,183,136,0.2);
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.75rem;
            color: var(--metro-green-light);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--metro-green-light);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Tab switcher */
        .tab-bar {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(82,183,136,0.15);
            border-radius: 12px;
            padding: 4px;
            display: flex;
            gap: 2px;
        }
        .tab-btn {
            flex: 1;
            padding: 9px 8px;
            border-radius: 9px;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: rgba(255,255,255,0.45);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            text-align: center;
        }
        .tab-btn:hover { color: rgba(255,255,255,0.75); background: rgba(255,255,255,0.05); }
        .tab-btn.active-emp {
            background: linear-gradient(135deg, #2d6a4f, #40916c);
            color: #fff;
            box-shadow: 0 2px 12px rgba(45,106,79,0.5);
        }
        .tab-btn.active-plan {
            background: linear-gradient(135deg, #1565c0, #1976d2);
            color: #fff;
            box-shadow: 0 2px 12px rgba(21,101,192,0.5);
        }
        .tab-btn.active-gc {
            background: linear-gradient(135deg, #b7791f, #d97706);
            color: #fff;
            box-shadow: 0 2px 12px rgba(183,121,31,0.5);
        }
        .tab-btn.active-cs {
            background: linear-gradient(135deg, #1565c0, #0288d1);
            color: #fff;
            box-shadow: 0 2px 12px rgba(21,101,192,0.5);
        }

        /* Inputs */
        .metro-input {
            width: 100%;
            padding: 11px 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(82,183,136,0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .metro-input::placeholder { color: rgba(255,255,255,0.25); }
        .metro-input:focus {
            border-color: var(--metro-accent);
            box-shadow: 0 0 0 3px rgba(82,183,136,0.12);
        }
        .metro-input:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .metro-label {
            display: block;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 7px;
        }

        /* Login button */
        .login-btn {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
            color: #fff;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 20px rgba(45,106,79,0.4);
            position: relative;
            overflow: hidden;
        }
        .login-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), transparent);
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(45,106,79,0.55);
            background: linear-gradient(135deg, #40916c 0%, #52b788 100%);
        }
        .login-btn:active { transform: translateY(0); }

        /* Sync button */
        .sync-btn {
            padding: 7px 16px;
            background: rgba(82,183,136,0.1);
            border: 1px solid rgba(82,183,136,0.25);
            border-radius: 8px;
            color: var(--metro-green-light);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sync-btn:hover { background: rgba(82,183,136,0.2); border-color: rgba(82,183,136,0.4); }

        /* Info hint */
        .info-hint {
            background: rgba(82,183,136,0.07);
            border: 1px solid rgba(82,183,136,0.15);
            border-radius: 8px;
            padding: 9px 13px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.45);
            margin-top: 8px;
        }

        /* Forgot password link */
        .forgot-link {
            color: rgba(116,198,157,0.7);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
            background: none;
            border: none;
        }
        .forgot-link:hover { color: var(--metro-green-light); text-decoration: underline; }

        /* Post-login header bar */
        .metro-header-bar {
            background: rgba(13,40,24,0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(82,183,136,0.15);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 24px;
        }

        /* Keep rest of app readable on light bg after login */
        body.logged-in {
            background: #f0f4f0;
        }
        body.logged-in .login-bg,
        body.logged-in .orb { display: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0d2818; }
        ::-webkit-scrollbar-thumb { background: #2d6a4f; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Background layers (hidden after login) -->
    <div class="login-bg" id="loginBg"></div>
    <div class="orb orb-1" id="loginOrb1"></div>
    <div class="orb orb-2" id="loginOrb2"></div>
    <div class="orb orb-3" id="loginOrb3"></div>

    <div id="app" class="max-w-7xl mx-auto relative" style="z-index:1">

        <!-- Post-login header (hidden on login screen) -->
        <div id="userInfo" class="hidden metro-header-bar rounded-xl mb-6">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="font-family:'Barlow Condensed',sans-serif;font-size:1.3rem;font-weight:700;color:#fff;letter-spacing:0.06em;">
                    FL<span style="color:#74c69d;">O</span>W
                </div>
                <div style="width:1px;height:22px;background:rgba(255,255,255,0.15)"></div>
                <div style="font-size:0.72rem;font-weight:600;color:rgba(255,255,255,0.45);letter-spacing:0.12em;text-transform:uppercase;">Annual Leave System</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="background:rgba(82,183,136,0.1);border:1px solid rgba(82,183,136,0.2);border-radius:8px;padding:5px 14px;">
                    <span style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Logged in as </span>
                    <span id="currentUserName" style="font-weight:600;color:#fff;font-size:0.85rem;"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button onclick="app.handleLogout()" style="padding:7px 16px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:#fca5a5;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.25)'" onmouseout="this.style.background='rgba(239,68,68,0.15)'">
                    Logout
                </button>
            </div>
        </div>

        <!-- LOGIN VIEW ‚Äî NEW LANDING PAGE -->
        <div id="loginView" style="min-height:100vh;position:relative;z-index:1;">

            <!-- Top Navbar -->
            <nav class="lp-navbar">
                <div class="lp-navbar-left">
                    <div class="lp-nav-logo">FLOW</div>
                    <div class="lp-nav-divider"></div>
                    <div class="lp-nav-title">Annual Leave System</div>
                </div>
                <div class="lp-navbar-center">
                    <span style="padding:8px 12px;font-size:0.9rem;">üîß</span>
                    <div class="lp-select-wrap">
                        <select class="lp-role-select" onchange="app.setLoginType(this.value)" id="navRoleSelect">
                            <option value="employee">Employee</option>
                            <option value="planner" selected>Planner</option>
                            <option value="goldencommand">GC</option>
                            <option value="corporatestaff">Corp Staff</option>
                        </select>
                    </div>
                </div>
                <div class="lp-navbar-right">
                    <button class="lp-theme-btn" title="Toggle theme">üåô</button>
                    <div class="lp-lang-toggle">
                        <span class="active">EN</span>
                        <span style="opacity:0.3">|</span>
                        <span>AR</span>
                    </div>
                    <div class="lp-avatar">üë∑</div>
                </div>
            </nav>

            <!-- Hero Section -->
            <div class="lp-hero">
                <!-- Top row: headline + stats card -->
                <div class="lp-hero-top">
                    <!-- Left: headline -->
                    <div>
                        <h1 class="lp-headline">Annual Leave Bidding</h1>
                        <h2 class="lp-subheadline">Made Transparent &amp; Fair</h2>
                        <p class="lp-desc">Seniority-based allocation with real-time tracking and automated quota management.</p>
                        <div class="lp-cta-row">
                            <button class="lp-btn-primary" onclick="document.querySelector('.lp-cards-grid').scrollIntoView({behavior:'smooth'})">Sign In</button>
                            <button class="lp-btn-secondary">
                                <span>üîç</span> View Bidding Calendar
                            </button>
                        </div>
                    </div>

                    <!-- Right: stats card -->
                    <div class="lp-stats-card">
                        <div class="lp-stats-row">
                            <div>
                                <div class="lp-stat-label">üë• Total Employees</div>
                                <div class="lp-stat-big" id="statsEmpCount">‚Äî</div>
                            </div>
                            <div class="lp-stat-badge">
                                <span id="statsEmpBadge">‚Äî</span>
                                <span class="arrow-up">‚Üó</span>
                            </div>
                        </div>
                        <div class="lp-stat-line">
                            <span class="lp-stat-line-label">üì∑ Bidding Phase</span>
                            <span class="lp-status-open">Open</span>
                        </div>
                        <div class="lp-stat-line">
                            <span class="lp-stat-line-label">üìã Current Slot</span>
                            <span class="lp-stat-line-val">Batch 3 <span class="lp-status-check">‚úì</span></span>
                        </div>
                        <div class="lp-quota-row">
                            <div class="lp-quota-left">
                                <div class="lp-quota-label">Available Quota</div>
                                <div class="lp-quota-pct">82<sup>%</sup></div>
                                <div class="lp-quota-bar"><div class="lp-quota-bar-fill" style="width:82%"></div></div>
                            </div>
                            <div class="lp-donut-wrap">
                                <svg width="90" height="90" viewBox="0 0 90 90">
                                    <circle cx="45" cy="45" r="36" fill="none" stroke="rgba(0,0,0,0.08)" stroke-width="10"/>
                                    <circle cx="45" cy="45" r="36" fill="none" stroke="#2d9f5f" stroke-width="10"
                                        stroke-dasharray="226" stroke-dashoffset="40.68"
                                        stroke-linecap="round"
                                        transform="rotate(-90 45 45)"/>
                                </svg>
                                <div class="lp-donut-pct">82%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom row: 4 login cards -->
                <div class="lp-cards-grid" style="grid-template-columns: repeat(4, 1fr); max-width: 1100px;">

                    <!-- 1. Employee Card -->
                    <div class="lp-login-card" style="animation-delay:0.1s">
                        <div class="lp-card-header">
                            <span class="lp-card-icon">üë§</span>
                            <div>
                                <div class="lp-card-title">Employee</div>
                                <div class="lp-card-subtitle">Submit leave</div>
                            </div>
                            <span class="lp-card-check">‚úî</span>
                        </div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üë§</span>
                            <input class="lp-input" type="text" placeholder="Employee ID" id="empLoginId" autocomplete="username" />
                        </div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üîí</span>
                            <input class="lp-input" type="password" placeholder="Password" id="empLoginPwd" autocomplete="current-password" />
                        </div>
                        <div class="lp-card-footer">
                            <label class="lp-remember"><input type="checkbox"> Remember me</label>
                            <button class="lp-forgot" onclick="app.renderForgotPasswordView()">Forgot password?</button>
                        </div>
                        <button class="lp-sign-btn" onclick="
                            app.setLoginType('employee');
                            document.getElementById('loginId').value = document.getElementById('empLoginId').value;
                            document.getElementById('loginPassword').value = document.getElementById('empLoginPwd').value;
                            app.handleLogin();
                        ">Sign In</button>
                    </div>

                    <!-- 2. Corp Staff Card -->
                    <div class="lp-login-card" style="animation-delay:0.2s">
                        <div class="lp-card-header">
                            <span class="lp-card-icon">üè¢</span>
                            <div>
                                <div class="lp-card-title">Corp Staff</div>
                                <div class="lp-card-subtitle">Oversight &amp; reporting</div>
                            </div>
                        </div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üë§</span>
                            <!-- Must use id="csLoginId" ‚Äî matches what handleLogin reads for corporatestaff -->
                            <input class="lp-input" type="text" placeholder="Staff ID" id="csLoginId" autocomplete="username" />
                        </div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üîí</span>
                            <input class="lp-input" type="password" placeholder="Password" id="csLoginPwd" autocomplete="current-password" />
                        </div>
                        <div class="lp-card-footer">
                            <label class="lp-remember"><input type="checkbox"> Remember me</label>
                            <button class="lp-forgot" onclick="app.renderForgotPasswordView()">Forgot password?</button>
                        </div>
                        <button class="lp-sign-btn" onclick="
                            app.setLoginType('corporatestaff');
                            document.getElementById('loginPassword').value = document.getElementById('csLoginPwd').value;
                            app.handleLogin();
                        ">Sign In</button>
                    </div>

                    <!-- 3. Planner Card -->
                    <div class="lp-login-card" style="animation-delay:0.3s">
                        <div class="lp-card-header">
                            <span class="lp-card-icon">üõ†Ô∏è</span>
                            <div>
                                <div class="lp-card-title">Planner</div>
                                <div class="lp-card-subtitle">Schedule &amp; configure</div>
                            </div>
                        </div>
                        <!-- Planner login only needs a password, no ID -->
                        <div class="lp-input-wrap" style="margin-top:8px;">
                            <span class="lp-input-icon">üîí</span>
                            <input class="lp-input" type="password" placeholder="Planner Password" id="plannerLoginPwd" autocomplete="current-password" />
                        </div>
                        <div class="lp-card-footer" style="margin-top:8px;">
                            <label class="lp-remember"><input type="checkbox"> Remember me</label>
                            <button class="lp-forgot" onclick="app.renderForgotPasswordView()">Forgot password?</button>
                        </div>
                        <button class="lp-sign-btn" style="margin-top:4px;" onclick="
                            app.setLoginType('planner');
                            document.getElementById('loginPassword').value = document.getElementById('plannerLoginPwd').value;
                            app.handleLogin();
                        ">Sign In</button>
                    </div>

                    <!-- 4. Golden Command Card (gold) -->
                    <div class="lp-login-card gc-card" style="animation-delay:0.4s">
                        <div class="lp-card-header">
                            <div class="gc-badge">‚≠ê Golden Command</div>
                        </div>
                        <div class="gc-card-sub">Sign in to your account</div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üë§</span>
                            <!-- Must use id="gcLoginId" ‚Äî matches what handleLogin reads for goldencommand -->
                            <input class="lp-input" type="text" placeholder="GC Employee ID" id="gcLoginId" autocomplete="username" />
                        </div>
                        <div class="lp-input-wrap">
                            <span class="lp-input-icon">üîí</span>
                            <input class="lp-input" type="password" placeholder="Password" id="gcLoginPwd" autocomplete="current-password" />
                        </div>
                        <div class="lp-card-footer">
                            <label class="lp-remember"><input type="checkbox"> Remember me</label>
                            <button class="lp-forgot" style="color:#b8860b;" onclick="app.renderForgotPasswordView()">Forgot password?</button>
                        </div>
                        <button class="lp-sign-btn gc-sign-btn" onclick="
                            app.setLoginType('goldencommand');
                            document.getElementById('loginPassword').value = document.getElementById('gcLoginPwd').value;
                            app.handleLogin();
                        ">Sign In</button>
                    </div>

                </div>
            </div>

            <!-- Bottom Status Bar -->
            <div class="lp-status-bar">
                <div class="lp-status-item">
                    <div class="lp-status-check-icon">‚úì</div>
                    Database synced at <span id="liveClock" style="color:rgba(255,255,255,0.85);font-weight:600;margin-left:4px;">--:-- --</span>
                </div>
                <div class="lp-status-item">
                    <div class="lp-status-check-icon">‚úì</div>
                    <span id="statsEmpStatus">‚Äî</span> employees active
                </div>
                <div class="lp-status-item">
                    <div class="lp-status-check-icon">‚úì</div>
                    System healthy
                    <span class="status-pill" style="margin-left:8px;">
                        <div class="status-dot"></div>
                        <span id="systemStatus">Initializing...</span>
                    </span>
                </div>
            </div>

            <!-- Hidden legacy inputs for app.js compatibility -->
            <input type="hidden" id="loginId" />
            <input type="hidden" id="loginPassword" />
            <div id="loginForm" style="display:none"></div>
            <div id="liveDate" style="display:none"></div>

        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6 flex-wrap gap-2">
            <button onclick="app.setActiveView('dashboard')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìä Dashboard
            </button>
            <button onclick="app.setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üì§ Upload Data
            </button>
            <button onclick="app.setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                ‚öôÔ∏è Configure Slots
            </button>
            <button onclick="app.setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üõ†Ô∏è Admin Panel
            </button>
            <button onclick="app.publishToSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                üíæ Save to Database
            </button>
            <button onclick="app.setActiveView('manageOnCall')" class="px-4 py-2 rounded-lg font-semibold bg-red-50 text-red-700 hover:bg-red-100 border border-red-300">
                üìÖ On-Call Manager
            </button>
            <button onclick="app.setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîê Change Password
            </button>
            <button onclick="app.setActiveView('results')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìã View Results
            </button>
            <button onclick="app.setActiveView('auditLog')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîç Audit Log
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üìÖ Place Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border relative" id="myResultsNavBtn">
                üìã My Results
                <span id="resultsReadyBadge" class="hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">!</span>
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Golden Command Navigation -->
        <div id="goldenCommandNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('goldenCommand')" class="px-4 py-2 rounded-lg font-semibold bg-yellow-400 text-yellow-900 hover:bg-yellow-500 border border-yellow-500">
                ‚≠ê Place GC Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border relative" id="gcResultsNavBtn">
                üìã My Results
                <span id="gcResultsReadyBadge" class="hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">!</span>
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Corporate Staff Navigation -->
        <div id="corporateStaffNav" class="hidden flex justify-center space-x-4 mb-6">
            <button onclick="app.setActiveView('corporateStaff')" class="px-4 py-2 rounded-lg font-semibold bg-blue-500 text-white hover:bg-blue-600 border border-blue-600">
                üè¢ Place CS Bids
            </button>
            <button onclick="app.setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border relative" id="csResultsNavBtn">
                üìã My Results
                <span id="csResultsReadyBadge" class="hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">!</span>
            </button>
            <button onclick="app.setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 border">
                üîë Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
    </div>

    <!-- Scripts - Load at the end -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://wniqprjtwiyeqryplfdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduaXFwcmp0d2l5ZXFyeXBsZmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODc3NTAsImV4cCI6MjA4NDE2Mzc1MH0.sbfoW8pNmDauQQxFV97DUvvbNg0S1ls8AqkufRHnh70';
        
        // ==================== APP OBJECT ====================
        const app = {
            supabase: null,
            
            // ==================== STATE ====================
            state: {
                tenantId: '00000000-0000-0000-0000-000000000001',
                authUser: null,
                employees: [],
                employeePasswords: {},
                bids: [],
                biddingDeadline: '',
                biddingYear: 2026,
                isProcessed: false,
                activeView: 'login',
                selectedEmployeeId: '',
                verifiedEmployee: null,
                currentUser: null,
                userType: null,
                plannerPassword: 'admin123',
                goldenCommandPassword: 'gc123',
                goldenCommandUsers: [
                    { id: 'GC001', name: 'Golden Command 1', password: 'GC001' },
                    { id: 'GC002', name: 'Golden Command 2', password: 'GC002' }
                ],
                corporateStaffUsers: [],
                results: [],

                // On-Call dates per employee (extracted from Director_On-Call.xlsx)
                // Keyed by Employee ID ‚Üí array of 'YYYY-MM-DD' strings
                onCallDates: {
                    "1003752": ["2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-03-29","2026-03-30","2026-03-31","2026-04-01","2026-04-02","2026-04-03","2026-04-04","2026-05-17","2026-05-18","2026-05-19","2026-05-20","2026-05-21","2026-05-22","2026-05-23","2026-07-05","2026-07-06","2026-07-07","2026-07-08","2026-07-09","2026-07-10","2026-07-11","2026-08-23","2026-08-24","2026-08-25","2026-08-26","2026-08-27","2026-08-28","2026-08-29","2026-10-11","2026-10-12","2026-10-13","2026-10-14","2026-10-15","2026-10-16","2026-10-17","2026-11-29","2026-11-30","2026-12-01","2026-12-02","2026-12-03","2026-12-04","2026-12-05"],
                    "1007066": ["2025-12-28","2025-12-29","2025-12-30","2025-12-31","2026-01-01","2026-01-02","2026-01-03","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20","2026-02-21","2026-04-05","2026-04-06","2026-04-07","2026-04-08","2026-04-09","2026-04-10","2026-04-11","2026-05-24","2026-05-25","2026-05-26","2026-05-27","2026-05-28","2026-05-29","2026-05-30","2026-07-12","2026-07-13","2026-07-14","2026-07-15","2026-07-16","2026-07-17","2026-07-18","2026-08-30","2026-08-31","2026-09-01","2026-09-02","2026-09-03","2026-09-04","2026-09-05","2026-10-18","2026-10-19","2026-10-20","2026-10-21","2026-10-22","2026-10-23","2026-10-24","2026-12-06","2026-12-07","2026-12-08","2026-12-09","2026-12-10","2026-12-11","2026-12-12"],
                    "10015":   ["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-03-22","2026-03-23","2026-03-24","2026-03-25","2026-03-26","2026-03-27","2026-03-28","2026-05-10","2026-05-11","2026-05-12","2026-05-13","2026-05-14","2026-05-15","2026-05-16","2026-06-28","2026-06-29","2026-06-30","2026-07-01","2026-07-02","2026-07-03","2026-07-04","2026-08-16","2026-08-17","2026-08-18","2026-08-19","2026-08-20","2026-08-21","2026-08-22","2026-10-04","2026-10-05","2026-10-06","2026-10-07","2026-10-08","2026-10-09","2026-10-10","2026-11-22","2026-11-23","2026-11-24","2026-11-25","2026-11-26","2026-11-27","2026-11-28"],
                    "10020":   ["2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31","2026-03-15","2026-03-16","2026-03-17","2026-03-18","2026-03-19","2026-03-20","2026-03-21","2026-05-03","2026-05-04","2026-05-05","2026-05-06","2026-05-07","2026-05-08","2026-05-09","2026-06-21","2026-06-22","2026-06-23","2026-06-24","2026-06-25","2026-06-26","2026-06-27","2026-08-09","2026-08-10","2026-08-11","2026-08-12","2026-08-13","2026-08-14","2026-08-15","2026-09-27","2026-09-28","2026-09-29","2026-09-30","2026-10-01","2026-10-02","2026-10-03","2026-11-15","2026-11-16","2026-11-17","2026-11-18","2026-11-19","2026-11-20","2026-11-21"]
                },
                selectedDepartment: 'all',
                slotCapacities: {},
                
                // Complete departments list (only L3, L46, L5 prefixes)
                departments: [
                    'L3-DEP-DC', 'L3-DEP-TC', 'L3-DEP-DM', 'L3-DEP- LTSS/TSS',
                    'L3-DEP-EFC', 'L3-DEP-GSM', 'L3-TA-T', 'L3-DS', 'L3-P&R',
                    'L3-LSS/SS', 'L3-DEP-SC', 'L3-SA', 'L3 SAMB',
                    'L46-DEP-TC', 'L46-DEP- LTSS/TSS', 'L46-TA-T', 'L46-DEP-DC',
                    'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC', 'L46 SAMB',
                    'L46-P&R', 'L46-AOCC',
                    'L5-LSS/SS', 'L5-DEP-DC', 'L5-DEP-DM', 'L5-DEP-GSM', 'L5-DEP-SC',
                    'L5-DEP- LTSS/TSS', 'L5-DEP-TC', 'L5-DEP-EFC', 'L5 SA', 'L5 SAMB',
                    'L5 - TA-T'
                ],
                
                slotTypes: [
                    { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                    { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                    { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
                ],
                
                months: [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ],
                loginType: 'employee'
            },

            // ==================== SUPABASE FUNCTIONS ====================
            async initSupabase() {
                try {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase initialized');

                    // Check for existing Supabase Auth session
                    const { data: { session } } = await this.supabase.auth.getSession();
                    if (session?.user) await this._applyAuthSession(session);

                    // Listen for auth state changes
                    this.supabase.auth.onAuthStateChange(async (event, session) => {
                        if (session?.user) await this._applyAuthSession(session);
                        else if (event === 'SIGNED_OUT') {
                            this.state.authUser = null;
                            this.state.tenantId = '00000000-0000-0000-0000-000000000001';
                        }
                    });
                    return true;
                } catch (error) {
                    console.error('‚ùå Supabase init failed:', error);
                    return false;
                }
            },

            async _applyAuthSession(session) {
                this.state.authUser = session.user;
                const claims = session.access_token
                    ? JSON.parse(atob(session.access_token.split('.')[1]))
                    : {};
                if (claims.tenant_id) this.state.tenantId = claims.tenant_id;
                if (claims.user_role)  this.state.userType  = claims.user_role;
            },

            _tid() {
                return this.state.tenantId || '00000000-0000-0000-0000-000000000001';
            },

            async loadFromSupabase() {
                if (!this.supabase) {
                    console.log('Supabase not initialized');
                    return false;
                }

                try {
                    this.updateSystemStatus('Loading from Supabase...');
                    
                    // FIX FOR 1000 STAFF LIMIT: Use range queries with pagination
                    console.log('Loading employees with pagination to avoid 1000 limit...');
                    let allEmployees = [];
                    let from = 0;
                    const batchSize = 1000;
                    let hasMore = true;

                    // Load employees with pagination
                    while (hasMore) {
                        const { data: employeesBatch, error: empError } = await this.supabase
                            .from('employees')
                            .select('*')
                            .eq('tenant_id', this._tid())
                            .range(from, from + batchSize - 1);
                        
                        if (empError) throw empError;
                        
                        if (employeesBatch && employeesBatch.length > 0) {
                            allEmployees = [...allEmployees, ...employeesBatch];
                            hasMore = employeesBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load bids (leave_requests)
                    let allBids = [];
                    from = 0;
                    hasMore = true;
                    
                    while (hasMore) {
                        const { data: bidsBatch, error: bidsError } = await this.supabase
                            .from('leave_requests')
                            .select('*')
                            .eq('tenant_id', this._tid())
                            .range(from, from + batchSize - 1);
                        
                        if (bidsError) {
                            if (bidsError.code !== 'PGRST116') {
                                console.warn('No bids found or error:', bidsError);
                            }
                            hasMore = false;
                        } else if (bidsBatch && bidsBatch.length > 0) {
                            allBids = [...allBids, ...bidsBatch];
                            hasMore = bidsBatch.length === batchSize;
                            from += batchSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Load system config
                    const { data: config, error: configError } = await this.supabase
                        .from('system_config')
                        .select('*')
                        .eq('tenant_id', this._tid())
                        .single();
                    
                    if (configError && configError.code !== 'PGRST116') {
                        console.warn('Config error:', configError);
                    }
                    
                    // Update state
                    if (allEmployees && allEmployees.length > 0) {
                        this.state.employees = allEmployees.map(emp => ({
                            id: emp.id,
                            name: emp.name,
                            seniorityDate: emp.seniority_date,
                            position: emp.position || '',
                            department: emp.department || 'Unassigned',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || ''
                        }));
                        
                        // Set default passwords
                        this.state.employees.forEach(emp => {
                            if (!this.state.employeePasswords[emp.id]) {
                                this.state.employeePasswords[emp.id] = emp.id;
                            }
                        });
                        
                        console.log(`‚úÖ Loaded ${this.state.employees.length} employees from Supabase (with pagination)`);
                    }
                    
                    // Load bids ‚Äî Supabase is source of truth
                    // Map Supabase rows to app bid format
                    const supabaseBids = (allBids || []).map(bid => ({
                        employeeId: bid.employee_id,
                        employeeName: bid.employee_name || this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                        seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                        department: bid.department || this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                        slotType: bid.slot_type || 'slotA',
                        startDate: bid.start_date,
                        endDate: bid.end_date,
                        days: bid.days_requested,
                        timestamp: bid.created_at
                    }));

                    // Also grab any locally-stored bids not yet in Supabase (safety net)
                    const localBids = JSON.parse(localStorage.getItem('bids') || '[]');
                    const supabaseKeys = new Set(supabaseBids.map(b => `${b.employeeId}|${b.slotType}|${b.startDate}`));
                    const localOnly = localBids.filter(b => !supabaseKeys.has(`${b.employeeId}|${b.slotType}|${b.startDate}`));

                    // Push any local-only bids up to Supabase now
                    if (localOnly.length > 0) {
                        console.log(`‚ÑπÔ∏è Found ${localOnly.length} local bid(s) not yet in Supabase ‚Äî pushing now...`);
                        localOnly.forEach(bid => this.saveBidToSupabase(bid));
                    }

                    this.state.bids = [...supabaseBids, ...localOnly];
                    console.log(`‚úÖ Loaded ${supabaseBids.length} bids from Supabase + ${localOnly.length} local-only bid(s)`);
                    
                    if (config) {
                        this.state.biddingDeadline = config.bidding_deadline || '';
                        this.state.biddingYear = config.bidding_year || 2026;
                        this.state.isProcessed = config.is_processed || false;
                        this.state.plannerPassword = config.planner_password || 'admin123';
                        this.state.slotCapacities = config.slot_capacities || {};
                        this.state.results = config.results || [];
                        console.log('‚úÖ Loaded system config from Supabase');
                    }

                    // Load on-call dates from dedicated oncall_dates table
                    const { data: ocRows, error: ocError } = await this.supabase
                        .from('oncall_dates')
                        .select('employee_id, date')
                        .eq('tenant_id', this._tid());

                    if (ocError) {
                        console.warn('‚ö†Ô∏è Could not load oncall_dates:', ocError.message);
                    } else if (ocRows && ocRows.length > 0) {
                        const built = {};
                        for (const row of ocRows) {
                            if (!built[row.employee_id]) built[row.employee_id] = [];
                            built[row.employee_id].push(row.date);
                        }
                        // Sort each employee's dates
                        for (const id of Object.keys(built)) built[id].sort();
                        // Merge with any hardcoded defaults
                        this.state.onCallDates = { ...(this.state.onCallDates || {}), ...built };
                        console.log(`‚úÖ Loaded on-call dates from oncall_dates table: ${ocRows.length} rows, ${Object.keys(built).length} staff entries`);
                    } else {
                        console.log('‚ÑπÔ∏è No on-call dates in oncall_dates table yet');
                    }

                    // Load Golden Command users from dedicated table
                    const { data: gcUsers, error: gcError } = await this.supabase
                        .from('golden_command_users')
                        .select('*')
                        .eq('tenant_id', this._tid())
                        .order('created_at', { ascending: true });

                    if (gcError) {
                        console.warn('‚ö†Ô∏è Could not load GC users:', gcError.message);
                    } else if (gcUsers && gcUsers.length > 0) {
                        this.state.goldenCommandUsers = gcUsers.map(u => ({
                            id: u.id,
                            name: u.name,
                            password: u.password
                        }));
                        console.log(`‚úÖ Loaded ${gcUsers.length} Golden Command users from dedicated table`);
                    } else {
                        // Table exists but is empty ‚Äî keep whatever is in localStorage
                        console.log('‚ÑπÔ∏è No GC users found in dedicated table');
                    }

                    // Load Corporate Staff users from dedicated table
                    const { data: csUsers, error: csError } = await this.supabase
                        .from('corporate_staff_users')
                        .select('*')
                        .eq('tenant_id', this._tid())
                        .order('created_at', { ascending: true });

                    if (csError) {
                        console.warn('‚ö†Ô∏è Could not load Corporate Staff users:', csError.message);
                    } else if (csUsers && csUsers.length > 0) {
                        this.state.corporateStaffUsers = csUsers.map(u => ({
                            id: u.id,
                            name: u.name,
                            password: u.password
                        }));
                        console.log(`‚úÖ Loaded ${csUsers.length} Corporate Staff users from dedicated table`);
                    } else {
                        console.log('‚ÑπÔ∏è No Corporate Staff users found in dedicated table');
                    }
                    
                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees loaded`);
                    this.renderLoginForm();
                    this._updateLandingStats();
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Error loading from Supabase:', error);
                    this.updateSystemStatus('‚ö†Ô∏è Could not load from database');
                    return false;
                }
            },

            async publishToSupabase() {
                if (!this.supabase) {
                    alert('Supabase not connected');
                    return;
                }

                if (this.state.employees.length === 0) {
                    alert('‚ö†Ô∏è No employee data to save');
                    return;
                }

                if (!confirm(`Save all data to Supabase database?\n\n‚Ä¢ ${this.state.employees.length} employees\n‚Ä¢ ${this.state.bids.length} bids\n‚Ä¢ System configuration`)) return;

                // Helper: split array into chunks
                const chunk = (arr, size) => {
                    const chunks = [];
                    for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
                    return chunks;
                };

                try {
                    // ‚îÄ‚îÄ 1. Save employees in batches of 500 ‚îÄ‚îÄ
                    const empTotal = this.state.employees.length;
                    const empChunks = chunk(this.state.employees, 500);
                    this.updateSystemStatus(`Saving employees (0/${empTotal})...`);

                    for (let i = 0; i < empChunks.length; i++) {
                        const batch = empChunks[i].map(emp => ({
                            id: emp.id,
                            tenant_id: this._tid(),
                            name: emp.name,
                            seniority_date: emp.seniorityDate,
                            position: emp.position || '',
                            department: emp.department || '',
                            gender: emp.gender || '',
                            nationality: emp.nationality || '',
                            email: emp.email || '',
                            updated_at: new Date().toISOString()
                        }));

                        const { error } = await this.supabase
                            .from('employees')
                            .upsert(batch, { onConflict: 'id' });

                        if (error) throw new Error(`Employee batch ${i + 1} failed: ${error.message}`);

                        const saved = Math.min((i + 1) * 500, empTotal);
                        this.updateSystemStatus(`Saving employees (${saved}/${empTotal})...`);
                    }

                    // ‚îÄ‚îÄ 2. Save system config ‚îÄ‚îÄ
                    this.updateSystemStatus('Saving system config...');
                    const { error: configError } = await this.supabase
                        .from('system_config')
                        .upsert({
    
                            tenant_id: this._tid(),
                            bidding_deadline: this.state.biddingDeadline,
                            bidding_year: this.state.biddingYear,
                            is_processed: this.state.isProcessed,
                            planner_password: this.state.plannerPassword,
                            slot_capacities: this.state.slotCapacities,
                            results: this.state.results,
                            last_updated: new Date().toISOString()
                            // on_call_dates intentionally omitted ‚Äî stored in oncall_dates table
                        }, { onConflict: 'id' });

                    if (configError) console.warn('Config save warning:', configError.message);

                    // ‚îÄ‚îÄ 2b. Save on-call dates to dedicated table ‚îÄ‚îÄ
                    this.updateSystemStatus('Saving on-call dates...');
                    await this.saveOnCallDatesToSupabase();

                    // ‚îÄ‚îÄ 3. Save bids in batches of 500 ‚îÄ‚îÄ
                    if (this.state.bids.length > 0) {
                        const bidTotal = this.state.bids.length;
                        const bidChunks = chunk(this.state.bids, 500);
                        this.updateSystemStatus(`Saving bids (0/${bidTotal})...`);

                        for (let i = 0; i < bidChunks.length; i++) {
                            const batch = bidChunks[i].map(bid => ({
                                tenant_id: this._tid(),
                                employee_id: bid.employeeId,
                                employee_name: bid.employeeName || '',
                                department: bid.department || '',
                                start_date: bid.startDate,
                                end_date: bid.endDate,
                                days_requested: bid.days,
                                status: 'pending',
                                slot_type: bid.slotType,
                                created_at: bid.timestamp || new Date().toISOString()
                            }));

                            const { error } = await this.supabase
                                .from('leave_requests')
                                .upsert(batch, { onConflict: 'employee_id,slot_type,start_date' });

                            if (error) throw new Error(`Bid batch ${i + 1} failed: ${error.message}`);

                            const saved = Math.min((i + 1) * 500, bidTotal);
                            this.updateSystemStatus(`Saving bids (${saved}/${bidTotal})...`);
                        }
                    }

                    this.updateSystemStatus(`‚úÖ Saved: ${empTotal} employees, ${this.state.bids.length} bids`);
                    alert(`‚úÖ All data saved to Supabase!\n\n‚Ä¢ ${empTotal} employees\n‚Ä¢ ${this.state.bids.length} bids\n‚Ä¢ System configuration\n‚Ä¢ ${Object.keys(this.state.onCallDates || {}).length} on-call staff entries`);
                    setTimeout(() => this.updateSystemStatus('Ready'), 4000);

                } catch (error) {
                    console.error('‚ùå Error saving to Supabase:', error);
                    this.updateSystemStatus('‚ùå Save failed ‚Äî check console');
                    alert(`‚ùå Save failed:\n${error.message}\n\nCheck browser console (F12) for details.`);
                }
            },

            async syncWithSupabase() {
                this.updateSystemStatus('Syncing with Supabase...');
                
                // First try to load from Supabase
                const loaded = await this.loadFromSupabase();
                
                if (!loaded) {
                    // If Supabase fails, try localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('‚ö†Ô∏è No data found locally or in database');
                    }
                }
                
                this.renderLoginForm();
            },

            // ==================== UTILITY FUNCTIONS ====================
            saveState() {
                try {
                    localStorage.setItem('employees', JSON.stringify(this.state.employees));
                    localStorage.setItem('employeePasswords', JSON.stringify(this.state.employeePasswords));
                    localStorage.setItem('bids', JSON.stringify(this.state.bids));
                    localStorage.setItem('biddingDeadline', this.state.biddingDeadline);
                    localStorage.setItem('biddingYear', this.state.biddingYear.toString());
                    localStorage.setItem('isProcessed', JSON.stringify(this.state.isProcessed));
                    localStorage.setItem('plannerPassword', this.state.plannerPassword);
                    localStorage.setItem('results', JSON.stringify(this.state.results));
                    localStorage.setItem('slotCapacities', JSON.stringify(this.state.slotCapacities));
                    localStorage.setItem('goldenCommandUsers', JSON.stringify(this.state.goldenCommandUsers || []));
                    localStorage.setItem('corporateStaffUsers', JSON.stringify(this.state.corporateStaffUsers || []));
                    localStorage.setItem('onCallDates', JSON.stringify(this.state.onCallDates || {}));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('employees');
                    if (saved) {
                        this.state.employees = JSON.parse(saved);
                        this.state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords') || '{}');
                        this.state.bids = JSON.parse(localStorage.getItem('bids') || '[]');
                        this.state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                        this.state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                        this.state.isProcessed = JSON.parse(localStorage.getItem('isProcessed') || 'false');
                        this.state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                        this.state.results = JSON.parse(localStorage.getItem('results') || '[]');
                        this.state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities') || '{}');
                        this.state.goldenCommandUsers = JSON.parse(localStorage.getItem('goldenCommandUsers') || '[]');
                        this.state.corporateStaffUsers = JSON.parse(localStorage.getItem('corporateStaffUsers') || '[]');
                        this.state.onCallDates = JSON.parse(localStorage.getItem('onCallDates') || '{}');
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
                return false;
            },

            updateSystemStatus(message) {
                const el = document.getElementById('systemStatus');
                if (el) el.textContent = message;
            },

            // ==================== VIEW FUNCTIONS ====================
            setLoginType(type) {
                console.log('Setting login type to:', type);
                this.state.loginType = type;

                // Update tab bar active states
                ['employee','planner','goldencommand','corporatestaff'].forEach(t => {
                    const btn = document.getElementById('tab-' + t);
                    if (!btn) return;
                    btn.className = 'tab-btn';
                    if (t === type) {
                        if (t === 'employee') btn.classList.add('active-emp');
                        else if (t === 'planner') btn.classList.add('active-plan');
                        else if (t === 'goldencommand') btn.classList.add('active-gc');
                        else if (t === 'corporatestaff') btn.classList.add('active-cs');
                    }
                });

                this.renderLoginForm();
            },

            renderLoginForm() {
                const form = document.getElementById('loginForm');
                if (!form) return;
                
                if (this.state.loginType === 'planner') {
                    form.innerHTML = `
                        <div>
                            <label class="metro-label">Planner Password</label>
                            <input type="password" id="loginPassword" class="metro-input" placeholder="Enter planner password" />
                        </div>
                    `;
                } else if (this.state.loginType === 'goldencommand') {
                    const gcUsers = this.state.goldenCommandUsers || [];
                    const hasGCUsers = gcUsers.length > 0;
                    form.innerHTML = `
                        <div style="margin-bottom:14px;">
                            ${!hasGCUsers ? `<div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.75rem;color:rgba(251,191,36,0.8);">No Golden Command users configured. Contact the planner.</div>` : ''}
                            <label class="metro-label">Golden Command ID</label>
                            <input type="text" id="gcLoginId" class="metro-input" placeholder="Enter your GC ID" ${!hasGCUsers ? 'disabled' : ''} />
                        </div>
                        <div>
                            <label class="metro-label">Password</label>
                            <input type="password" id="loginPassword" class="metro-input" placeholder="Enter your password" ${!hasGCUsers ? 'disabled' : ''} />
                        </div>
                    `;
                } else if (this.state.loginType === 'corporatestaff') {
                    const csUsers = this.state.corporateStaffUsers || [];
                    const hasCSUsers = csUsers.length > 0;
                    form.innerHTML = `
                        <div style="margin-bottom:14px;">
                            ${!hasCSUsers ? `<div style="background:rgba(2,136,209,0.08);border:1px solid rgba(2,136,209,0.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.75rem;color:rgba(2,136,209,0.9);">No Corporate Staff users configured. Contact the planner.</div>` : ''}
                            <label class="metro-label">Corporate Staff ID</label>
                            <input type="text" id="csLoginId" class="metro-input" placeholder="Enter your Staff ID" ${!hasCSUsers ? 'disabled' : ''} />
                        </div>
                        <div>
                            <label class="metro-label">Password</label>
                            <input type="password" id="loginPassword" class="metro-input" placeholder="Enter your password" ${!hasCSUsers ? 'disabled' : ''} />
                        </div>
                    `;
                } else {
                    const hasData = this.state.employees.length > 0;
                    form.innerHTML = `
                        <div style="margin-bottom:14px;">
                            ${!hasData ? `<div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.75rem;color:rgba(251,191,36,0.8);">No employee data loaded. Click "Sync with Database" above.</div>` : ''}
                            <label class="metro-label">Employee ID</label>
                            <input type="text" id="loginId" class="metro-input" placeholder="Enter your ID" ${!hasData ? 'disabled' : ''} />
                        </div>
                        <div>
                            <label class="metro-label">Password</label>
                            <input type="password" id="loginPassword" class="metro-input" placeholder="Enter your password" ${!hasData ? 'disabled' : ''} />

                        </div>
                    `;
                }
            },

            handleLogin() {
                if (this.state.loginType === 'planner') {
                    // Read from the dedicated planner card input, fall back to hidden field
                    const input = document.getElementById('plannerLoginPwd') || document.getElementById('loginPassword');
                    const password = input ? input.value : '';
                    
                    if (password === this.state.plannerPassword) {
                        this.state.currentUser = { name: 'Planner Admin' };
                        this.state.userType = 'planner';
                        this.state.activeView = 'dashboard';
                        
                        document.body.classList.add('logged-in');
                        ['loginBg','loginOrb1','loginOrb2','loginOrb3'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
                        document.getElementById('loginView').style.display = 'none';
                        const uip = document.getElementById('userInfo');
                        uip.style.display = 'flex'; uip.classList.remove('hidden');
                        document.getElementById('plannerNav').classList.remove('hidden');
                        document.getElementById('currentUserName').textContent = 'Planner Admin';
                        document.getElementById('userTypeBadge').textContent = 'Planner';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800';
                        
                        this.renderView();
                        this.writeAuditLog('LOGIN', { role: 'planner' });
                        alert('‚úÖ Welcome, Planner!');
                    } else {
                        alert('‚ùå Incorrect planner password.');
                    }
                } else if (this.state.loginType === 'goldencommand') {
                    const gcIdInput = document.getElementById('gcLoginId');
                    // Read from the GC card password input, fall back to hidden field
                    const passInput = document.getElementById('gcLoginPwd') || document.getElementById('loginPassword');
                    const gcId = gcIdInput ? gcIdInput.value.trim() : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!gcId || !password) {
                        alert('‚ö†Ô∏è Please enter both GC ID and password');
                        return;
                    }
                    
                    const gcUsers = this.state.goldenCommandUsers || [];
                    const gcUser = gcUsers.find(u => u.id === gcId);
                    
                    if (!gcUser) {
                        alert('‚ùå Golden Command ID not found. Please contact the planner.');
                        return;
                    }
                    
                    const storedPass = gcUser.password || gcUser.id;
                    if (password !== storedPass) {
                        alert(`‚ùå Incorrect password.`);
                        return;
                    }
                    
                    this.state.currentUser = gcUser;
                    this.state.userType = 'goldencommand';
                    this.state.verifiedEmployee = { id: gcUser.id, name: gcUser.name, department: 'Golden Command', seniorityDate: '2000-01-01' };
                    this.state.activeView = 'goldenCommand';
                    
                    // Hide login, show app
                    document.body.classList.add('logged-in');
                    ['loginBg','loginOrb1','loginOrb2','loginOrb3'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
                    document.getElementById('loginView').style.display = 'none';
                    const ui = document.getElementById('userInfo');
                    ui.style.display = 'flex'; ui.classList.remove('hidden');
                    document.getElementById('goldenCommandNav').classList.remove('hidden');
                    document.getElementById('currentUserName').textContent = gcUser.name;
                    document.getElementById('userTypeBadge').textContent = '‚≠ê Golden Command';
                    document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800';
                    
                    this.renderView();
                    this.writeAuditLog('LOGIN', { name: gcUser.name, id: gcUser.id, role: 'goldencommand' });
                    alert(`‚úÖ Welcome, ${gcUser.name}!`);
                } else if (this.state.loginType === 'corporatestaff') {
                    const csIdInput = document.getElementById('csLoginId');
                    // Read from the Corp Staff card password input, fall back to hidden field
                    const passInput = document.getElementById('csLoginPwd') || document.getElementById('loginPassword');
                    const csId = csIdInput ? csIdInput.value.trim() : '';
                    const password = passInput ? passInput.value : '';

                    if (!csId || !password) {
                        alert('‚ö†Ô∏è Please enter both Staff ID and password');
                        return;
                    }

                    const csUsers = this.state.corporateStaffUsers || [];
                    const csUser = csUsers.find(u => u.id === csId);

                    if (!csUser) {
                        alert('‚ùå Corporate Staff ID not found. Please contact the planner.');
                        return;
                    }

                    const storedPass = csUser.password || csUser.id;
                    if (password !== storedPass) {
                        alert('‚ùå Incorrect password.');
                        return;
                    }

                    this.state.currentUser = csUser;
                    this.state.userType = 'corporatestaff';
                    this.state.verifiedEmployee = { id: csUser.id, name: csUser.name, department: 'Corporate Staff', seniorityDate: '2000-01-01' };
                    this.state.activeView = 'corporateStaff';

                    // Hide login, show app
                    document.body.classList.add('logged-in');
                    ['loginBg','loginOrb1','loginOrb2','loginOrb3'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
                    document.getElementById('loginView').style.display = 'none';
                    const csUi = document.getElementById('userInfo');
                    csUi.style.display = 'flex'; csUi.classList.remove('hidden');
                    document.getElementById('corporateStaffNav').classList.remove('hidden');
                    document.getElementById('currentUserName').textContent = csUser.name;
                    document.getElementById('userTypeBadge').textContent = 'üè¢ Corporate Staff';
                    document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';

                    this.renderView();
                    this.writeAuditLog('LOGIN', { name: csUser.name, id: csUser.id, role: 'corporatestaff' });
                    alert(`‚úÖ Welcome, ${csUser.name}!`);
                } else {
                    // Employee login ‚Äî read from card inputs, fall back to hidden fields
                    const idInput = document.getElementById('empLoginId') || document.getElementById('loginId');
                    const passInput = document.getElementById('empLoginPwd') || document.getElementById('loginPassword');
                    
                    const id = idInput ? idInput.value.trim() : '';
                    const password = passInput ? passInput.value : '';
                    
                    if (!id || !password) {
                        alert('‚ö†Ô∏è Please enter both ID and password');
                        return;
                    }
                    
                    const employee = this.state.employees.find(e => e.id === id);
                    if (!employee) {
                        alert('‚ùå Employee ID not found. Please upload data first.');
                        return;
                    }
                    
                    const storedPass = this.state.employeePasswords[id] || id;
                    if (password === storedPass) {
                        this.state.currentUser = employee;
                        this.state.userType = 'employee';
                        this.state.verifiedEmployee = employee;
                        this.state.activeView = 'employee';
                        
                        // Hide login, show app
                        document.body.classList.add('logged-in');
                        ['loginBg','loginOrb1','loginOrb2','loginOrb3'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
                        document.getElementById('loginView').style.display = 'none';
                        const ui2 = document.getElementById('userInfo');
                        ui2.style.display = 'flex'; ui2.classList.remove('hidden');
                        document.getElementById('employeeNav').classList.remove('hidden');
                        document.getElementById('currentUserName').textContent = employee.name;
                        document.getElementById('userTypeBadge').textContent = 'Employee';
                        document.getElementById('userTypeBadge').className = 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
                        
                        this.renderView();
                        this.writeAuditLog('LOGIN', { name: employee.name, id: employee.id, department: employee.department });
                        alert(`‚úÖ Welcome, ${employee.name}!`);
                    } else {
                        alert(`‚ùå Incorrect password.`);
                    }
                }
            },

            handleLogout() {
                this.writeAuditLog('LOGOUT', { name: this.state.currentUser?.name, role: this.state.userType });
                this.state.currentUser = null;
                this.state.userType = null;
                this.state.verifiedEmployee = null;
                this.state.activeView = 'login';
                
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('plannerNav').classList.add('hidden');
                document.getElementById('employeeNav').classList.add('hidden');
                document.getElementById('goldenCommandNav').classList.add('hidden');
                document.getElementById('corporateStaffNav').classList.add('hidden');
                document.getElementById('loginView').style.display = 'flex';
                document.getElementById('contentArea').innerHTML = '';

                // Restore dark bg
                document.body.classList.remove('logged-in');
                ['loginBg','loginOrb1','loginOrb2','loginOrb3'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = '';
                });

                // Clear all login card inputs so credentials don't persist
                ['empLoginId','empLoginPwd','csLoginId','csLoginPwd',
                 'plannerLoginPwd','gcLoginId','gcLoginPwd',
                 'loginId','loginPassword'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                
                this.renderLoginForm();
            },

            setActiveView(view) {
                console.log('Setting view to:', view);
                // Stop any existing admin polling when navigating away
                if (view !== 'admin') this.stopAdminPolling();
                this.state.activeView = view;
                // Auto-refresh bids from Supabase when planner opens Admin Panel
                if (view === 'admin' && this.state.userType === 'planner' && this.supabase) {
                    this.refreshBidsFromSupabase(false).then(() => this.startAdminPolling());
                } else {
                    this.renderView();
                }
            },

            renderView() {
                const content = document.getElementById('contentArea');
                if (!content) return;
                
                content.innerHTML = '';

                // Show/hide results ready badge
                const userId = this.state.verifiedEmployee?.id;
                const hasMyResults = userId && this.state.isProcessed && this.state.results.some(r => r.employeeId === userId);
                ['resultsReadyBadge', 'gcResultsReadyBadge', 'csResultsReadyBadge'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.toggle('hidden', !hasMyResults);
                });
                
                switch(this.state.activeView) {
                    case 'dashboard':
                        this.renderDashboardView();
                        break;
                    case 'upload':
                        this.renderUploadView();
                        break;
                    case 'configureSlots':
                        this.renderConfigureSlotsView();
                        break;
                    case 'admin':
                        this.renderAdminView();
                        break;
                    case 'employee':
                        this.renderEmployeeBiddingView();
                        break;
                    case 'myResults':
                        this.renderMyResultsView();
                        break;
                    case 'results':
                        this.renderResultsView();
                        break;
                    case 'manualOverride':
                        this.renderManualOverrideView();
                        break;
                    case 'auditLog':
                        this.renderAuditLogView();
                        break;
                    case 'changePassword':
                        this.renderChangePasswordView();
                        break;
                    case 'changePlannerPassword':
                        this.renderChangePlannerPasswordView();
                        break;
                    case 'manageOnCall':
                        this.renderManageOnCallView();
                        break;
                    case 'goldenCommand':
                        this.renderGoldenCommandBiddingView();
                        break;
                    case 'corporateStaff':
                        this.renderCorporateStaffBiddingView();
                        break;
                }
                
                this.saveState();
            },

            // ==================== VIEW RENDERING ====================
            renderUploadView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                                <select
                                    id="biddingYearSelect"
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    ${this.state.isProcessed || this.state.bids.length > 0 ? 'disabled' : ''}
                                >
                                    ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                        <option value="${year}" ${year === this.state.biddingYear ? 'selected' : ''}>${year}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                            <p class="text-gray-600 mb-6">
                                Upload an Excel file with employee information. The file should have columns like:
                                "Personnel number", "Name", "Seniority Date", "Department" (Position), "Scheduling row" (L-code), etc.
                            </p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4">
                                <p class="mb-4 text-gray-600">
                                    Drag and drop your Excel file here or click to browse
                                </p>
                                <label class="cursor-pointer">
                                    <input
                                        type="file"
                                        id="excelFile"
                                        accept=".xlsx,.xls"
                                        class="hidden"
                                        onchange="app.handleFileUpload(event)"
                                    />
                                    <span class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 inline-block">
                                        üìÅ Browse Files
                                    </span>
                                </label>
                            </div>

                            ${this.state.employees.length > 0 ? `
                                <div class="mt-6">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span class="text-green-800 font-semibold">
                                            ‚úì ${this.state.employees.length} employees loaded for ${this.state.biddingYear}
                                        </span>
                                        <div class="text-xs text-green-600 mt-1">
                                            Positions found: ${[...new Set(this.state.employees.map(e => e.position || e.department || 'Unassigned'))].join(', ')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Golden Command User Management -->
                        <div class="bg-white rounded-xl shadow-xl p-8 mt-6">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="text-2xl">‚≠ê</span>
                                <h2 class="text-2xl font-bold text-yellow-800">Golden Command Users</h2>
                            </div>
                            <p class="text-sm text-gray-500 mb-6">Manage Golden Command accounts. Their default password is their GC ID. Changes are saved directly to Supabase.</p>
                            <div class="space-y-2 mb-6" id="gcUserList">
                                ${(this.state.goldenCommandUsers || []).map((u, i) => `
                                    <div class="flex items-center justify-between bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                        <div class="flex items-center gap-3 flex-wrap">
                                            <span class="font-semibold text-yellow-900">‚≠ê ${u.name}</span>
                                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono border border-yellow-300">ID: ${u.id}</span>
                                            <span class="text-xs text-gray-400">Password: ${u.password || u.id}</span>
                                        </div>
                                        <button onclick="app.removeGCUser(${i})" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold">‚úï Remove</button>
                                    </div>
                                `).join('')}
                                ${(this.state.goldenCommandUsers || []).length === 0 ? `<p class="text-sm text-yellow-600 italic py-2">No Golden Command users yet. Add one below.</p>` : ''}
                            </div>
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-5">
                                <p class="font-semibold text-yellow-800 mb-3">‚ûï Add New GC User</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">GC ID (username)</label>
                                        <input type="text" id="newGCId" placeholder="e.g. GC001" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Full Name</label>
                                        <input type="text" id="newGCName" placeholder="e.g. John Smith" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Password (optional)</label>
                                        <input type="text" id="newGCPassword" placeholder="Leave blank = same as ID" class="w-full px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-500 focus:outline-none" />
                                    </div>
                                </div>
                                <button onclick="app.addGCUser()" class="px-6 py-2.5 bg-yellow-400 text-yellow-900 rounded-lg font-bold hover:bg-yellow-500 text-sm transition">
                                    ‚≠ê Add Golden Command User
                                </button>
                            </div>
                        </div>

                        <!-- Corporate Staff User Management -->
                        <div class="bg-white rounded-xl shadow-xl p-8 mt-6">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="text-2xl">üè¢</span>
                                <h2 class="text-2xl font-bold text-blue-800">Corporate Staff Users</h2>
                            </div>
                            <p class="text-sm text-gray-500 mb-6">Manage Corporate Staff accounts. Their default password is their Staff ID. Changes are saved directly to Supabase.</p>
                            <div class="space-y-2 mb-6" id="csUserList">
                                ${(this.state.corporateStaffUsers || []).map((u, i) => `
                                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <div class="flex items-center gap-3 flex-wrap">
                                            <span class="font-semibold text-blue-900">üè¢ ${u.name}</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono border border-blue-300">ID: ${u.id}</span>
                                            <span class="text-xs text-gray-400">Password: ${u.password || u.id}</span>
                                        </div>
                                        <button onclick="app.removeCSUser(${i})" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold">‚úï Remove</button>
                                    </div>
                                `).join('')}
                                ${(this.state.corporateStaffUsers || []).length === 0 ? `<p class="text-sm text-blue-600 italic py-2">No Corporate Staff users yet. Add one below.</p>` : ''}
                            </div>
                            <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-5">
                                <p class="font-semibold text-blue-800 mb-3">‚ûï Add New Corporate Staff User</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Staff ID (username)</label>
                                        <input type="text" id="newCSId" placeholder="e.g. CS001" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Full Name</label>
                                        <input type="text" id="newCSName" placeholder="e.g. Jane Doe" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Password (optional)</label>
                                        <input type="text" id="newCSPassword" placeholder="Leave blank = same as ID" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none" />
                                    </div>
                                </div>
                                <button onclick="app.addCSUser()" class="px-6 py-2.5 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 text-sm transition">
                                    üè¢ Add Corporate Staff User
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add year select listener
                const yearSelect = document.getElementById('biddingYearSelect');
                if (yearSelect) {
                    yearSelect.addEventListener('change', (e) => {
                        this.state.biddingYear = parseInt(e.target.value);
                        this.saveConfigToSupabase();
                    });
                }
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    alert('Please upload a valid Excel file (.xlsx or .xls)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        console.log('Excel data loaded:', jsonData.length, 'rows');
                        
                        // Process data - more robust parsing
                        const employees = jsonData.map((row, idx) => {
                            // Find ID from common column names
                            let id = '';
                            const idColumns = ['Personnel number', 'Personnel Number', 'Personnel_number', 
                                              'Personnelnumber', 'ID', 'id', 'EmployeeID', 'Employee ID', 
                                              'Employee No', 'Employee Number'];
                            
                            for (const col of idColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    id = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // Find name from common column names
                            let name = '';
                            const nameColumns = ['Name', 'Employee Name', 'Full Name', 
                                                'FORENAME SURNAME', 'Forename Surname'];
                            
                            for (const col of nameColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    name = String(row[col]).trim();
                                    break;
                                }
                            }
                            
                            // If name not found, try forename + surname
                            if (!name) {
                                const forename = row['Forename'] || row['FORENAME'] || '';
                                const surname = row['Surname'] || row['SURNAME'] || '';
                                name = `${forename} ${surname}`.trim();
                            }
                            
                            // Read position (display name, e.g. 'Depot Controller') from Department column
                            let position = '';
                            const positionColumns = ['Department', 'DEPARTMENT', 'Position', 'Job Title', 'Role'];
                            for (const col of positionColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    position = String(row[col]).trim().split('.')[0].trim();
                                    break;
                                }
                            }

                            // Read department (L-code, e.g. 'L3-DEP-DC') from Scheduling row column
                            let department = '';
                            const deptColumns = [
                                'Scheduling row', 'Scheduling_row', 'SchedulingRow',
                                'Org. Unit', 'Org Unit', 'OrgUnit'
                            ];
                            for (const col of deptColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    const raw = String(row[col]).trim().split('.')[0].trim();
                                    if (/^(L3|L46|L5)[-\s]/i.test(raw) || /^(L3-SA|L5 SA|L3 SAMB|L5 SAMB|L46 SAMB)$/i.test(raw)) {
                                        department = raw;
                                        break;
                                    }
                                }
                            }
                            // Fallback: if no L-code found, use position as department
                            if (!department) department = position;
                            
                            // Find seniority date
                            let seniorityDate = '';
                            const dateColumns = ['Seniority Date', 'SeniorityDate', 'seniorityDate',
                                                'Start of staff membership', 'Start_of_staff_membership',
                                                'Start Date', 'StartDate', 'Joining Date', 'JoiningDate'];
                            
                            for (const col of dateColumns) {
                                if (row[col] !== undefined && row[col] !== '') {
                                    const dateVal = row[col];
                                    if (typeof dateVal === 'number') {
                                        // Excel date number
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                                        seniorityDate = jsDate.toISOString();
                                    } else {
                                        // String date
                                        const jsDate = new Date(dateVal);
                                        if (!isNaN(jsDate.getTime())) {
                                            seniorityDate = jsDate.toISOString();
                                        }
                                    }
                                    break;
                                }
                            }
                            
                            // If no date found, use default
                            if (!seniorityDate) {
                                seniorityDate = new Date('2020-01-01').toISOString();
                            }
                            
                            // Use default ID if none found
                            if (!id) {
                                id = `EMP${idx + 1000}`;
                            }
                            
                            // Use default name if none found
                            if (!name) {
                                name = `Employee ${idx + 1}`;
                            }
                            
                            // Use default department if none found
                            if (!department) {
                                department = 'Unassigned';
                            }
                            
                            return {
                                id: id,
                                name: name,
                                seniorityDate: seniorityDate,
                                department: department,
                                position: position,
                                gender: row['Gender'] || row['gender'] || '',
                                nationality: row['Nationality'] || row['nationality'] || ''
                            };
                        }).filter(emp => emp.id && emp.name); // Remove empty rows
                        
                        if (employees.length > 0) {
                            this.state.employees = employees;
                            employees.forEach(emp => {
                                this.state.employeePasswords[emp.id] = emp.id;
                            });
                            
                            this.saveState();
                            this.writeAuditLog('DATA_UPLOADED', { count: employees.length, year: this.state.biddingYear });
                            
                            // Show summary of departments found
                            const departmentsFound = [...new Set(employees.map(e => e.position || e.department))];
                            const message = `‚úÖ Successfully loaded ${employees.length} employees\n\n` +
                                          `Positions found (${departmentsFound.length}):\n` +
                                          departmentsFound.join(', ');
                            
                            alert(message);
                            this.renderUploadView();
                            this.renderLoginForm(); // Update login form with new IDs
                        } else {
                            alert('‚ö†Ô∏è No valid employee data found in the file. Please check the format.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error processing Excel file. Please check the format and try again.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            // ==================== VIEW RENDERING ====================
            renderEmployeeBiddingView() {
                const content = document.getElementById('contentArea');
                if (!this.state.verifiedEmployee) {
                    content.innerHTML = '<p class="text-center">Please login first.</p>';
                    return;
                }
            
                // Calculate employee's leave entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
            
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
            
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                const yearsOfService = calculateYearsOfService(this.state.verifiedEmployee.seniorityDate);
                
                // Get employee's bids
                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                const remainingLeave = entitlement - totalBidDays;
            
                // Countdown timer helper
                const deadlineCountdown = (() => {
                    if (!this.state.biddingDeadline) return '';
                    const dl = new Date(this.state.biddingDeadline);
                    const now = new Date();
                    const diff = dl - now;
                    if (diff <= 0) return `<div class="mb-4 bg-red-50 border border-red-300 rounded-xl p-3 text-center"><span class="text-red-700 font-bold">‚õî Bidding deadline has passed</span></div>`;
                    const days = Math.floor(diff / 86400000);
                    const hrs  = Math.floor((diff % 86400000) / 3600000);
                    const mins = Math.floor((diff % 3600000) / 60000);
                    const secs = Math.floor((diff % 60000) / 1000);
                    const urgency = diff < 3600000 ? 'bg-red-50 border-red-300 text-red-700' : diff < 86400000 ? 'bg-yellow-50 border-yellow-300 text-yellow-700' : 'bg-green-50 border-green-300 text-green-700';
                    return `<div class="mb-4 border rounded-xl p-3 text-center ${urgency}">
                        <p class="text-xs font-semibold uppercase tracking-wide mb-1">‚è∞ Bidding Closes In</p>
                        <p class="text-2xl font-bold font-mono" id="countdownTimer">${days}d ${hrs}h ${mins}m ${secs}s</p>
                        <p class="text-xs mt-1">Deadline: ${dl.toLocaleDateString('en-US',{weekday:'long',day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})}</p>
                    </div>`;
                })();

                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        ${deadlineCountdown}
                        <!-- Header with leave entitlement -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4">Leave Bidding for ${this.state.biddingYear}</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-gray-500">${yearsOfService.toFixed(1)} years of service</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${userBids.length}/2</p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Used</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${remainingLeave}</p>
                                    <p class="text-sm text-gray-600">Days Remaining</p>
                                </div>
                            </div>
            
                            <!-- Slot types summary -->
                            <div class="border-t pt-4">
                                <p class="font-semibold mb-2">Available Slot Types:</p>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
            
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">Place New Bid</h3>
                                
                                ${this.state.isProcessed ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>
                                ` : ''}
                                
                                ${userBids.length >= 2 ? `
                                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ùå Maximum of 2 bids reached.</p>
                                    </div>
                                ` : ''}
                                
                                <!-- Month Selection -->
                                <div class="mb-4">
                                    <label class="block font-semibold mb-2">Select Month:</label>
                                    <select id="selectedMonth" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" onchange="app.updateMonthText()">
                                        ${this.state.months.map(month => `
                                            <option value="${month}">${month} ${this.state.biddingYear}</option>
                                        `).join('')}
                                    </select>
                                </div>
            
                                <!-- Slot Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => {
                                            const hasBidForThisSlot = userBids.some(bid => bid.slotType === slot.id);
                                            const isDisabled = hasBidForThisSlot || userBids.length >= 2 || this.state.isProcessed;
                                            
                                            return `
                                                <button
                                                    data-slot="${slot.id}"
                                                    data-hasbid="${hasBidForThisSlot}"
                                                    onclick="${!isDisabled ? `app.setSelectedSlot('${slot.id}')` : ''}"
                                                    class="slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all ${isDisabled ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'}"
                                                    ${isDisabled ? 'disabled' : ''}
                                                >
                                                    ${slot.name} - ${slot.days} days
                                                    ${hasBidForThisSlot ? '<span class="float-right">‚úì</span>' : ''}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
            
                                <!-- Date Selection -->
                                <div class="mb-6">
                                    <label class="block font-semibold mb-2">Select dates within <span id="selectedMonthText">January ${this.state.biddingYear}</span>:</label>
                                    
                                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                        <p class="font-semibold text-blue-800">
                                            <span id="selectedSlotText">No slot selected</span> requires exactly 
                                            <span id="selectedSlotDays">0</span> consecutive days
                                        </p>
                                    </div>
            
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block font-semibold mb-2">Start Date:</label>
                                            <input
                                                type="date"
                                                id="startDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateEndDate()"
                                            />
                                        </div>
                                        <div>
                                            <label class="block font-semibold mb-2">End Date (Auto-calculated):</label>
                                            <input
                                                type="date"
                                                id="endDate"
                                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg bg-gray-50"
                                                readonly
                                            />
                                        </div>
                                    </div>
                                    
                                    <div id="dateInfo" class="hidden"></div>
                                    
                                    <p class="text-sm text-gray-600 mt-2">
                                        End date is automatically calculated based on slot type
                                    </p>
                                </div>
            
                                <!-- Submit Button -->
                                <button
                                    onclick="app.submitBid()"
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 disabled:opacity-50"
                                    ${this.state.isProcessed || userBids.length >= 2 ? 'disabled' : ''}
                                >
                                    Submit Bid
                                </button>
                            </div>
            
                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <h3 class="text-xl font-bold mb-4">My Current Bids</h3>
                                
                                ${userBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p>No bids placed yet</p>
                                        <p class="text-sm mt-2">Place your first bid on the left</p>
                                    </div>
                                ` : `
                                    <div class="space-y-4">
                                        ${userBids.map(bid => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            return `
                                                <div class="border border-gray-200 rounded p-4">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold">${slot?.name || 'Slot'}</p>
                                                            <p class="text-sm text-gray-600">${bid.startDate} to ${bid.endDate}</p>
                                                            <p class="text-sm font-semibold">${bid.days} days</p>
                                                        </div>
                                                        <button
                                                            onclick="app.removeBid('${bid.employeeId}', '${bid.slotType}', '${bid.startDate}')"
                                                            class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                                                            ${this.state.isProcessed ? 'disabled' : ''}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                
                                <!-- Bid Summary -->
                                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <p class="font-semibold mb-2">Bid Summary:</p>
                                    <p class="text-sm">Bids placed: ${userBids.length}/2</p>
                                    <p class="text-sm">Days used: ${totalBidDays}/${entitlement}</p>
                                    <p class="text-sm">Remaining leave: ${remainingLeave} days</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            
                // Initialize selected slot if none selected
                if (!window.selectedSlot && this.state.slotTypes.length > 0) {
                    window.selectedSlot = this.state.slotTypes[0].id;
                }
                
                // Update UI elements
                this.updateMonthText();
                this.updateSlotText();
                
                // Initialize slot buttons
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === window.selectedSlot) {
                        btn.className = btn.className.replace('bg-gray-100', 'bg-blue-500 text-white');
                    }
                });

                // Live countdown ticker
                if (this.state.biddingDeadline) {
                    clearInterval(window._countdownInterval);
                    window._countdownInterval = setInterval(() => {
                        const el = document.getElementById('countdownTimer');
                        if (!el) { clearInterval(window._countdownInterval); return; }
                        const diff = new Date(this.state.biddingDeadline) - new Date();
                        if (diff <= 0) { el.textContent = 'EXPIRED'; clearInterval(window._countdownInterval); return; }
                        const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000),
                              m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                        el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                    }, 1000);
                }
            },

            renderGoldenCommandBiddingView() {
                const content = document.getElementById('contentArea');
                const gcUser = this.state.verifiedEmployee;
                if (!gcUser) { content.innerHTML = '<p class="text-center">Please login first.</p>'; return; }

                // Filter bids for THIS specific GC user
                const gcBids = this.state.bids.filter(bid => bid.employeeId === gcUser.id);
                const totalBidDays = gcBids.reduce((sum, bid) => sum + bid.days, 0);
                const entitlement = 35; // Golden Command always gets 35 days

                // Countdown
                const deadlineCountdownGC = (() => {
                    if (!this.state.biddingDeadline) return '';
                    const dl = new Date(this.state.biddingDeadline);
                    const diff = dl - new Date();
                    if (diff <= 0) return `<div class="mb-4 bg-red-50 border border-red-300 rounded-xl p-3 text-center"><span class="text-red-700 font-bold">‚õî Bidding deadline has passed</span></div>`;
                    const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
                    const urgency = diff<3600000?'bg-red-50 border-red-300 text-red-700':diff<86400000?'bg-yellow-50 border-yellow-300 text-yellow-700':'bg-green-50 border-green-300 text-green-700';
                    return `<div class="mb-4 border rounded-xl p-3 text-center ${urgency}"><p class="text-xs font-semibold uppercase tracking-wide mb-1">‚è∞ Bidding Closes In</p><p class="text-2xl font-bold font-mono" id="gcCountdownTimer">${d}d ${h}h ${m}m ${s}s</p></div>`;
                })();
            
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        ${deadlineCountdownGC}
                        <!-- Header with GC styling -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-yellow-400">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-3xl">‚≠ê</span>
                                <h2 class="text-2xl font-bold">Golden Command ‚Äî ${gcUser.name} ‚Äî Leave Bidding ${this.state.biddingYear}</h2>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <p class="text-2xl font-bold text-yellow-800">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-yellow-600">Golden Command Entitlement</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${gcBids.length} <span class="text-sm font-normal text-gray-500">unlimited</span></p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-700">‚àû</p>
                                    <p class="text-sm text-gray-600">GC Privilege ‚Äî No Limit</p>
                                </div>
                            </div>
            
                            <!-- Slot types summary -->
                            <div class="border-t pt-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <p class="font-semibold">Available Slot Types:</p>
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">‚≠ê GC: Unlimited selections, free date range</span>
                                </div>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                    <div class="flex-1 p-3 rounded-lg border border-yellow-400 bg-yellow-50">
                                        <p class="font-bold text-yellow-800">‚≠ê Custom</p>
                                        <p class="text-sm text-yellow-700">Any date range ‚Äî free choice</p>
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6 border-l-4 border-yellow-400">
                                <h3 class="text-xl font-bold mb-4">‚≠ê Place New GC Bid</h3>
                                
                                ${this.state.isProcessed ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>
                                ` : ''}

                                <!-- Slot Type Selection -->
                                <div class="mb-5">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => {
                                            const colorMap = { green: 'border-green-300 bg-green-50 hover:bg-green-100 text-green-900', blue: 'border-blue-300 bg-blue-50 hover:bg-blue-100 text-blue-900', purple: 'border-purple-300 bg-purple-50 hover:bg-purple-100 text-purple-900' };
                                            const activeMap = { green: 'bg-green-500 text-white border-green-600', blue: 'bg-blue-500 text-white border-blue-600', purple: 'bg-purple-500 text-white border-purple-600' };
                                            const isActive = window.gcSelectedSlot === slot.id;
                                            return `
                                                <button
                                                    data-slot="${slot.id}"
                                                    onclick="app.setGCSelectedSlot('${slot.id}')"
                                                    class="gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border ${this.state.isProcessed ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : (isActive ? (activeMap[slot.color] || 'bg-yellow-400 text-yellow-900 border-yellow-500') : (colorMap[slot.color] || 'bg-yellow-50 hover:bg-yellow-100 text-gray-800 border-yellow-300'))}"
                                                    ${this.state.isProcessed ? 'disabled' : ''}
                                                >
                                                    ${slot.name} ‚Äî ${slot.days} consecutive days
                                                    ${isActive ? '<span class="float-right">‚úì Selected</span>' : ''}
                                                </button>
                                            `;
                                        }).join('')}
                                        <!-- Custom / Free Choice option -->
                                        <button
                                            data-slot="gcCustom"
                                            onclick="app.setGCSelectedSlot('gcCustom')"
                                            class="gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border ${this.state.isProcessed ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : (window.gcSelectedSlot === 'gcCustom' ? 'bg-yellow-400 text-yellow-900 border-yellow-500' : 'bg-yellow-50 hover:bg-yellow-100 text-yellow-900 border-yellow-400')}"
                                            ${this.state.isProcessed ? 'disabled' : ''}
                                        >
                                            ‚≠ê Custom ‚Äî Choose any start &amp; end date freely
                                            ${window.gcSelectedSlot === 'gcCustom' ? '<span class="float-right">‚úì Selected</span>' : ''}
                                        </button>
                                    </div>
                                </div>
            
                                <!-- Date Selection -->
                                <div class="mb-6">
                                    <div class="mb-3 p-3 bg-yellow-50 border border-yellow-300 rounded">
                                        <p class="font-semibold text-yellow-800 text-sm" id="gcSlotInfoText">
                                            ${window.gcSelectedSlot === 'gcCustom' ? '‚≠ê Custom: Pick any start and end date' : (this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot) ? `${this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot).name} ‚Äî end date auto-calculated (${this.state.slotTypes.find(s=>s.id===window.gcSelectedSlot).days} days)` : 'Select a slot type above')}
                                        </p>
                                    </div>

                                    ${(() => {
                                        // On-Call schedule notice for this GC user
                                        const myOnCall = this.state.onCallDates[gcUser.id] || [];
                                        if (myOnCall.length === 0) return '';
                                        // Group consecutive dates into ranges
                                        const sorted = [...myOnCall].sort();
                                        const ranges = [];
                                        let rangeStart = sorted[0], rangeEnd = sorted[0];
                                        for (let k = 1; k < sorted.length; k++) {
                                            const prev = new Date(sorted[k-1]);
                                            const curr = new Date(sorted[k]);
                                            const diffDays = (curr - prev) / 86400000;
                                            if (diffDays === 1) {
                                                rangeEnd = sorted[k];
                                            } else {
                                                ranges.push(rangeStart === rangeEnd ? rangeStart : `${rangeStart} ‚Üí ${rangeEnd}`);
                                                rangeStart = sorted[k]; rangeEnd = sorted[k];
                                            }
                                        }
                                        ranges.push(rangeStart === rangeEnd ? rangeStart : `${rangeStart} ‚Üí ${rangeEnd}`);
                                        return `<div class="mb-4 p-3 bg-red-50 border border-red-300 rounded-lg">
                                            <p class="font-bold text-red-800 text-sm mb-2">üö´ Your On-Call Dates (leave cannot be selected on these dates):</p>
                                            <div class="flex flex-wrap gap-1">${ranges.map(r => `<span class="inline-block bg-red-100 text-red-700 text-xs font-semibold px-2 py-1 rounded border border-red-200">${r}</span>`).join('')}</div>
                                        </div>`;
                                    })()}
            
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block font-semibold mb-2">Start Date:</label>
                                            <input
                                                type="date"
                                                id="gcStartDate"
                                                class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateGCEndDate()"
                                            />
                                        </div>
                                        <div>
                                            <label class="block font-semibold mb-2">End Date:</label>
                                            <input
                                                type="date"
                                                id="gcEndDate"
                                                class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none"
                                                min="${this.state.biddingYear}-01-01"
                                                max="${this.state.biddingYear}-12-31"
                                                onchange="app.updateGCDateInfo()"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div id="gcDateInfo" class="hidden mt-2"></div>
                                </div>
            
                                <!-- Submit Button -->
                                <button
                                    onclick="app.submitGCBid()"
                                    class="w-full px-6 py-3 bg-yellow-400 text-yellow-900 rounded-lg font-semibold hover:bg-yellow-500 transition-colors shadow-sm"
                                    ${this.state.isProcessed ? 'disabled' : ''}
                                >
                                    ‚≠ê Submit Golden Command Bid
                                </button>
                            </div>
            
                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">‚≠ê My GC Bids</h3>
                                    <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">${gcBids.length} bid${gcBids.length !== 1 ? 's' : ''}</span>
                                </div>
                                
                                ${gcBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p class="text-4xl mb-2">‚≠ê</p>
                                        <p class="font-semibold">No bids placed yet</p>
                                        <p class="text-sm mt-2">Use the form on the left ‚Äî no limit on bids</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3 max-h-96 overflow-y-auto pr-1">
                                        ${gcBids.map((bid, i) => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            const slotLabel = bid.slotType === 'gcCustom' ? '‚≠ê Custom' : (slot?.name || bid.slotType);
                                            const colorBadge = bid.slotType === 'gcCustom' ? 'bg-yellow-100 text-yellow-800' : (bid.slotType === 'slotA' ? 'bg-green-100 text-green-800' : bid.slotType === 'slotB' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800');
                                            return `
                                                <div class="border border-yellow-200 rounded-lg p-3 bg-yellow-50">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="text-xs font-bold text-gray-500">#${i+1}</span>
                                                                <span class="px-2 py-0.5 rounded text-xs font-semibold ${colorBadge}">${slotLabel}</span>
                                                            </div>
                                                            <p class="text-sm text-gray-700 font-semibold">${bid.startDate} ‚Üí ${bid.endDate}</p>
                                                            <p class="text-xs text-gray-500 mt-0.5">${bid.days} day${bid.days !== 1 ? 's' : ''}</p>
                                                        </div>
                                                        <button
                                                            onclick="app.removeGCBid('${bid.slotType}', '${bid.startDate}')"
                                                            class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                                            ${this.state.isProcessed ? 'disabled' : ''}
                                                        >
                                                            ‚úï Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                
                                <!-- Bid Summary -->
                                <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <p class="font-semibold mb-2 text-yellow-800">GC Bid Summary:</p>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <p class="text-gray-600">Total bids:</p><p class="font-semibold">${gcBids.length} <span class="text-yellow-600 text-xs">(unlimited)</span></p>
                                        <p class="text-gray-600">Total days bid:</p><p class="font-semibold">${totalBidDays} days</p>
                                        <p class="text-gray-600">Leave entitlement:</p><p class="font-semibold">${entitlement} days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            
                // Initialize GC slot state ‚Äî default to Custom (free selection)
                if (!window.gcSelectedSlot) {
                    window.gcSelectedSlot = 'gcCustom';
                }

                // Live countdown ticker for GC
                if (this.state.biddingDeadline) {
                    clearInterval(window._gcCountdownInterval);
                    window._gcCountdownInterval = setInterval(() => {
                        const el = document.getElementById('gcCountdownTimer');
                        if (!el) { clearInterval(window._gcCountdownInterval); return; }
                        const diff = new Date(this.state.biddingDeadline) - new Date();
                        if (diff <= 0) { el.textContent = 'EXPIRED'; clearInterval(window._gcCountdownInterval); return; }
                        const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
                        el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                    }, 1000);
                }
            },

            setGCSelectedSlot(slotId) {
                window.gcSelectedSlot = slotId;
                
                // Update button styles
                const buttons = document.querySelectorAll('.gc-slot-btn');
                buttons.forEach(btn => {
                    const isSelected = btn.dataset.slot === slotId;
                    if (this.state.isProcessed) {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-gray-200 text-gray-500 cursor-not-allowed';
                    } else if (isSelected) {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-yellow-400 text-yellow-900 border-yellow-500';
                    } else {
                        btn.className = 'gc-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all border bg-yellow-50 hover:bg-yellow-100 text-yellow-900 border-yellow-300';
                    }
                });

                // Update info text
                const infoEl = document.getElementById('gcSlotInfoText');
                if (infoEl) {
                    if (slotId === 'gcCustom') {
                        infoEl.textContent = '‚≠ê Custom: Pick any start and end date freely';
                    } else {
                        const slot = this.state.slotTypes.find(s => s.id === slotId);
                        infoEl.textContent = slot
                            ? `${slot.name} ‚Äî end date auto-calculated (${slot.days} days)`
                            : 'Select a slot type above';
                    }
                }

                // Clear date inputs when switching slots
                const startDate = document.getElementById('gcStartDate');
                const endDate = document.getElementById('gcEndDate');
                const dateInfo = document.getElementById('gcDateInfo');
                if (startDate) startDate.value = '';
                if (endDate) {
                    endDate.value = '';
                    // Custom slot: end date is freely editable; others: readonly
                    endDate.readOnly = slotId !== 'gcCustom';
                    endDate.className = `w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:border-yellow-500 focus:outline-none ${slotId !== 'gcCustom' ? 'bg-gray-50' : ''}`;
                }
                if (dateInfo) dateInfo.classList.add('hidden');
            },

            updateGCSlotText() {
                const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                if (slot) {
                    const slotText = document.getElementById('gcSelectedSlotText');
                    const slotDays = document.getElementById('gcSelectedSlotDays');
                    if (slotText) slotText.textContent = slot.name;
                    if (slotDays) slotDays.textContent = slot.days;
                }
            },

            updateGCMonthText() {
                const monthSelect = document.getElementById('gcSelectedMonth');
                if (monthSelect) {
                    const monthText = document.getElementById('gcSelectedMonthText');
                    if (monthText) monthText.textContent = monthSelect.value + ' ' + this.state.biddingYear;
                }
            },

            updateGCEndDate() {
                const startDateInput = document.getElementById('gcStartDate');
                const endDateInput = document.getElementById('gcEndDate');
                
                if (!startDateInput || !startDateInput.value) {
                    if (endDateInput) endDateInput.value = '';
                    return;
                }

                if (window.gcSelectedSlot === 'gcCustom') {
                    // Custom: end date is free ‚Äî just update info if both dates set
                    this.updateGCDateInfo();
                    return;
                }

                if (!window.gcSelectedSlot) return;
                
                const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                if (!slot) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + slot.days - 1);
                
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                this.updateGCDateInfo();
            },

            updateGCDateInfo() {
                const startDateInput = document.getElementById('gcStartDate');
                const endDateInput = document.getElementById('gcEndDate');
                const dateInfo = document.getElementById('gcDateInfo');

                if (!startDateInput?.value || !endDateInput?.value || !dateInfo) return;

                const days = Math.ceil(Math.abs(new Date(endDateInput.value) - new Date(startDateInput.value)) / (1000 * 60 * 60 * 24)) + 1;

                // ‚îÄ‚îÄ On-Call conflict live check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const gcUser = this.state.verifiedEmployee;
                const onCallSet = new Set(gcUser ? (this.state.onCallDates[gcUser.id] || []) : []);
                const conflictDates = [];
                if (onCallSet.size > 0 && startDateInput.value && endDateInput.value) {
                    const cur = new Date(startDateInput.value);
                    const end = new Date(endDateInput.value);
                    while (cur <= end) {
                        const iso = cur.toISOString().slice(0, 10);
                        if (onCallSet.has(iso)) conflictDates.push(iso);
                        cur.setDate(cur.getDate() + 1);
                    }
                }
                const onCallWarning = conflictDates.length > 0
                    ? `<p class="font-semibold text-red-700 mt-2">üö´ On-Call conflict on: ${conflictDates.join(', ')}</p>`
                    : (onCallSet.size > 0 ? `<p class="text-green-700 text-sm mt-1">‚úÖ No On-Call conflicts in this range</p>` : '');
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                let validMsg = '';
                if (window.gcSelectedSlot === 'gcCustom') {
                    validMsg = `<p class="font-semibold text-yellow-800">‚≠ê Custom selection: ${days} day${days !== 1 ? 's' : ''} ‚úì</p>`;
                    dateInfo.className = conflictDates.length > 0 ? 'p-3 rounded mb-2 bg-red-50 border border-red-300' : 'p-3 rounded mb-2 bg-yellow-50 border border-yellow-300';
                } else {
                    const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                    const ok = slot && days === slot.days;
                    validMsg = `<p class="font-semibold ${ok ? 'text-green-800' : 'text-red-800'}">${days} day${days !== 1 ? 's' : ''} selected ${ok ? '‚úì' : `(${slot?.name} requires exactly ${slot?.days} days)`}</p>`;
                    dateInfo.className = conflictDates.length > 0 ? 'p-3 rounded mb-2 bg-red-50 border border-red-300'
                        : `p-3 rounded mb-2 ${ok ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
                }
                dateInfo.innerHTML = validMsg + `<p class="text-sm text-gray-600 mt-1">${startDateInput.value} ‚Üí ${endDateInput.value}</p>` + onCallWarning;
                dateInfo.classList.remove('hidden');
            },

            submitGCBid() {
                if (this.state.isProcessed) {
                    alert('Bidding has been processed. No more bids allowed.');
                    return;
                }

                const gcUser = this.state.verifiedEmployee;
                if (!gcUser) { alert('Please login first.'); return; }

                if (!window.gcSelectedSlot) {
                    alert('Please select a slot type first.');
                    return;
                }

                const startDate = document.getElementById('gcStartDate')?.value;
                const endDate = document.getElementById('gcEndDate')?.value;

                if (!startDate) {
                    alert('Please select a start date.');
                    return;
                }
                if (!endDate) {
                    alert('Please select an end date.');
                    return;
                }

                const days = Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

                if (days < 1) {
                    alert('End date must be on or after start date.');
                    return;
                }

                // For fixed slot types, validate exact day count
                if (window.gcSelectedSlot !== 'gcCustom') {
                    const slot = this.state.slotTypes.find(s => s.id === window.gcSelectedSlot);
                    if (slot && days !== slot.days) {
                        alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.\n\nTo choose a free date range, select the "‚≠ê Custom" option instead.`);
                        return;
                    }
                }

                // Check date overlap with existing GC bids
                const gcBids = this.state.bids.filter(bid => bid.employeeId === gcUser.id);
                for (const bid of gcBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        alert(`Date overlap with an existing bid (${bid.startDate} ‚Üí ${bid.endDate}). Please choose non-overlapping dates.`);
                        return;
                    }
                }

                // ‚îÄ‚îÄ On-Call Conflict Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Build a set of all dates in the requested leave range
                const onCallDatesForUser = new Set(this.state.onCallDates[gcUser.id] || []);
                if (onCallDatesForUser.size > 0) {
                    const conflictingOnCallDates = [];
                    const cursor = new Date(startDate);
                    const rangeEnd = new Date(endDate);
                    while (cursor <= rangeEnd) {
                        const iso = cursor.toISOString().slice(0, 10);
                        if (onCallDatesForUser.has(iso)) conflictingOnCallDates.push(iso);
                        cursor.setDate(cursor.getDate() + 1);
                    }
                    if (conflictingOnCallDates.length > 0) {
                        const conflictList = conflictingOnCallDates.join(', ');
                        alert(`‚ö†Ô∏è On-Call Conflict Detected!\n\nYour selected leave period (${startDate} ‚Üí ${endDate}) overlaps with your scheduled On-Call duties on the following date${conflictingOnCallDates.length > 1 ? 's' : ''}:\n\n${conflictList}\n\nPlease choose dates that do not conflict with your On-Call schedule.`);
                        return;
                    }
                }
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                const slotLabel = window.gcSelectedSlot === 'gcCustom'
                    ? 'Custom'
                    : (this.state.slotTypes.find(s => s.id === window.gcSelectedSlot)?.name || window.gcSelectedSlot);

                const newBid = {
                    employeeId: gcUser.id,
                    employeeName: gcUser.name,
                    seniorityDate: gcUser.seniorityDate || '2000-01-01',
                    department: 'Golden Command',
                    slotType: window.gcSelectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();
                this.writeAuditLog('BID_PLACED', { type: 'GC', slot: window.gcSelectedSlot, start: startDate, end: endDate, days });

                // Save bid immediately to Supabase so it survives refresh
                this.saveBidToSupabase(newBid).then(saved => {
                    if (saved) console.log('‚úÖ GC Bid saved to Supabase');
                });

                alert(`‚≠ê GC Bid placed!\n${slotLabel} ‚Äî ${startDate} ‚Üí ${endDate} (${days} day${days !== 1 ? 's' : ''})`);
                this.renderGoldenCommandBiddingView();
            },

            removeGCBid(slotType, startDate) {
                if (this.state.isProcessed) {
                    alert('Cannot remove bids after processing.');
                    return;
                }
                const gcUser = this.state.verifiedEmployee;
                if (confirm('Remove this Golden Command bid?')) {
                    // Remove the first matching bid (slotType + startDate)
                    const idx = this.state.bids.findIndex(bid =>
                        bid.employeeId === gcUser.id && bid.slotType === slotType && bid.startDate === startDate
                    );
                    if (idx !== -1) this.state.bids.splice(idx, 1);
                    this.saveState();

                    // Delete from Supabase immediately
                    if (this.supabase) {
                        this.supabase
                            .from('leave_requests')
                            .delete()
                            .eq('employee_id', gcUser.id)
                            .eq('slot_type', slotType)
                            .eq('start_date', startDate)
                            .then(({ error }) => {
                                if (error) console.warn('‚ö†Ô∏è Could not delete GC bid from Supabase:', error.message);
                                else console.log('‚úÖ GC Bid deleted from Supabase');
                            });
                    }

                    this.renderGoldenCommandBiddingView();
                }
            },

            // ==================== CORPORATE STAFF BIDDING ====================
            renderCorporateStaffBiddingView() {
                const content = document.getElementById('contentArea');
                const csUser = this.state.verifiedEmployee;
                if (!csUser) { content.innerHTML = '<p class="text-center">Please login first.</p>'; return; }

                const csBids = this.state.bids.filter(bid => bid.employeeId === csUser.id);
                const totalBidDays = csBids.reduce((sum, bid) => sum + bid.days, 0);
                const entitlement = 35; // Corporate Staff entitlement

                // Countdown
                const deadlineCountdownCS = (() => {
                    if (!this.state.biddingDeadline) return '';
                    const dl = new Date(this.state.biddingDeadline);
                    const diff = dl - new Date();
                    if (diff <= 0) return `<div class="mb-4 bg-red-50 border border-red-300 rounded-xl p-3 text-center"><span class="text-red-700 font-bold">‚õî Bidding deadline has passed</span></div>`;
                    const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
                    const urgency = diff<3600000?'bg-red-50 border-red-300 text-red-700':diff<86400000?'bg-yellow-50 border-yellow-300 text-yellow-700':'bg-green-50 border-green-300 text-green-700';
                    return `<div class="mb-4 border rounded-xl p-3 text-center ${urgency}"><p class="text-xs font-semibold uppercase tracking-wide mb-1">‚è∞ Bidding Closes In</p><p class="text-2xl font-bold font-mono" id="csCountdownTimer">${d}d ${h}h ${m}m ${s}s</p></div>`;
                })();

                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        ${deadlineCountdownCS}
                        <!-- Header -->
                        <div class="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-blue-500">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-3xl">üè¢</span>
                                <h2 class="text-2xl font-bold">Corporate Staff ‚Äî ${csUser.name} ‚Äî Leave Bidding ${this.state.biddingYear}</h2>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <p class="text-2xl font-bold text-blue-800">${entitlement}</p>
                                    <p class="text-sm text-gray-600">Total Leave Days</p>
                                    <p class="text-xs text-blue-600">Corporate Staff Entitlement</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${csBids.length} <span class="text-sm font-normal text-gray-500">unlimited</span></p>
                                    <p class="text-sm text-gray-600">Bids Placed</p>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${totalBidDays}</p>
                                    <p class="text-sm text-gray-600">Days Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-700">‚àû</p>
                                    <p class="text-sm text-gray-600">No Bid Limit</p>
                                </div>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <p class="font-semibold">Available Slot Types:</p>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-semibold">üè¢ Corp Staff: Unlimited selections, free date range</span>
                                </div>
                                <div class="flex gap-4">
                                    ${this.state.slotTypes.map(slot => `
                                        <div class="flex-1 p-3 rounded-lg border ${slot.color === 'green' ? 'border-green-300 bg-green-50' : slot.color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                                            <p class="font-bold">${slot.name}</p>
                                            <p class="text-sm">${slot.days} consecutive days</p>
                                        </div>
                                    `).join('')}
                                    <div class="flex-1 p-3 rounded-lg border border-blue-400 bg-blue-50">
                                        <p class="font-bold text-blue-800">üè¢ Custom</p>
                                        <p class="text-sm text-blue-700">Any date range ‚Äî free choice</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Place New Bid -->
                            <div class="bg-white rounded-xl shadow-xl p-6 border-l-4 border-blue-500">
                                <h3 class="text-xl font-bold mb-4">üè¢ Place New Corporate Staff Bid</h3>
                                ${this.state.isProcessed ? `
                                    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                                        <p class="font-semibold">‚ö†Ô∏è Bidding has been processed. No more bids allowed.</p>
                                    </div>` : ''}

                                <!-- Slot Type Selection -->
                                <div class="mb-5">
                                    <label class="block font-semibold mb-2">Select Slot Type:</label>
                                    <div class="space-y-2">
                                        ${this.state.slotTypes.map(slot => `
                                            <button
                                                onclick="app.csSetSelectedSlot('${slot.id}')"
                                                data-csslot="${slot.id}"
                                                class="cs-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-100 hover:bg-gray-200 text-gray-800 ${this.state.isProcessed ? 'opacity-50 cursor-not-allowed' : ''}"
                                                ${this.state.isProcessed ? 'disabled' : ''}
                                            >
                                                ${slot.name} ‚Äî ${slot.days} consecutive days
                                            </button>
                                        `).join('')}
                                        <button
                                            onclick="app.csSetSelectedSlot('csCustom')"
                                            data-csslot="csCustom"
                                            class="cs-slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-blue-50 border border-blue-300 hover:bg-blue-100 text-blue-800 ${this.state.isProcessed ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${this.state.isProcessed ? 'disabled' : ''}
                                        >
                                            üè¢ Custom ‚Äî Any date range (free choice)
                                        </button>
                                    </div>
                                </div>

                                <!-- Date Selection -->
                                <div class="mb-5">
                                    <label class="block font-semibold mb-2">Select Dates:</label>
                                    <div id="csSlotInfo" class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 font-medium">
                                        Select a slot type above first
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">Start Date</label>
                                            <input type="date" id="csStartDate"
                                                class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                min="${this.state.biddingYear}-01-01" max="${this.state.biddingYear}-12-31"
                                                onchange="app.csUpdateEndDate()" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">End Date <span class="text-gray-400 font-normal">(auto)</span></label>
                                            <input type="date" id="csEndDate"
                                                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg bg-gray-50"
                                                readonly />
                                        </div>
                                    </div>
                                </div>

                                <button onclick="app.submitCSBid()"
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition ${this.state.isProcessed ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${this.state.isProcessed ? 'disabled' : ''}>
                                    üè¢ Submit Corporate Staff Bid
                                </button>
                            </div>

                            <!-- Right: My Current Bids -->
                            <div class="bg-white rounded-xl shadow-xl p-6 border-l-4 border-indigo-400">
                                <h3 class="text-xl font-bold mb-4">üìã My Current Bids (${csBids.length})</h3>
                                ${csBids.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <p class="text-4xl mb-3">üì≠</p>
                                        <p class="font-semibold">No bids placed yet</p>
                                        <p class="text-sm mt-1">Place your first bid on the left</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${csBids.map(bid => {
                                            const slot = this.state.slotTypes.find(s => s.id === bid.slotType);
                                            const slotLabel = bid.slotType === 'csCustom' ? 'üè¢ Custom' : (slot?.name || bid.slotType);
                                            return `
                                                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold text-blue-900">${slotLabel}</p>
                                                            <p class="text-sm text-gray-600">${bid.startDate} ‚Üí ${bid.endDate}</p>
                                                            <p class="text-sm font-semibold text-blue-700">${bid.days} days</p>
                                                        </div>
                                                        <button onclick="app.removeCSBid('${bid.slotType}','${bid.startDate}')"
                                                            class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 font-semibold">
                                                            ‚úï Remove
                                                        </button>
                                                    </div>
                                                </div>`;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;

                // Start countdown timer
                clearInterval(window._csCountdownTimer);
                window._csCountdownTimer = setInterval(() => {
                    const el = document.getElementById('csCountdownTimer');
                    if (!el) { clearInterval(window._csCountdownTimer); return; }
                    const diff = new Date(this.state.biddingDeadline) - new Date();
                    if (diff <= 0) { el.textContent = 'EXPIRED'; clearInterval(window._csCountdownTimer); return; }
                    const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
                    el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                }, 1000);
            },

            csSetSelectedSlot(slotId) {
                window.csSelectedSlot = slotId;
                // Highlight selected
                document.querySelectorAll('.cs-slot-btn').forEach(btn => {
                    const isSelected = btn.dataset.csslot === slotId;
                    btn.classList.toggle('ring-2', isSelected);
                    btn.classList.toggle('ring-blue-500', isSelected);
                    btn.classList.toggle('bg-blue-100', isSelected);
                });
                const infoEl = document.getElementById('csSlotInfo');
                if (!infoEl) return;
                if (slotId === 'csCustom') {
                    infoEl.textContent = 'üè¢ Custom ‚Äî Choose any start and end date freely';
                } else {
                    const slot = this.state.slotTypes.find(s => s.id === slotId);
                    infoEl.textContent = slot ? `${slot.name} ‚Äî exactly ${slot.days} consecutive days. Pick a start date.` : '';
                }
                // Recalculate end date if start already filled
                this.csUpdateEndDate();
            },

            csUpdateEndDate() {
                const startInput = document.getElementById('csStartDate');
                const endInput = document.getElementById('csEndDate');
                if (!startInput || !endInput || !startInput.value) return;
                if (!window.csSelectedSlot || window.csSelectedSlot === 'csCustom') {
                    endInput.value = '';
                    endInput.removeAttribute('readonly');
                    endInput.classList.remove('bg-gray-50');
                    return;
                }
                const slot = this.state.slotTypes.find(s => s.id === window.csSelectedSlot);
                if (!slot) return;
                const start = new Date(startInput.value);
                const end = new Date(start);
                end.setDate(end.getDate() + slot.days - 1);
                endInput.value = end.toISOString().split('T')[0];
                endInput.setAttribute('readonly', true);
                endInput.classList.add('bg-gray-50');
            },

            submitCSBid() {
                if (this.state.isProcessed) { alert('Bidding has been processed. No more bids.'); return; }
                const csUser = this.state.verifiedEmployee;
                if (!csUser) return;
                if (!window.csSelectedSlot) { alert('‚ö†Ô∏è Please select a slot type first.'); return; }

                const startDate = document.getElementById('csStartDate')?.value;
                let endDate = document.getElementById('csEndDate')?.value;
                if (!startDate) { alert('‚ö†Ô∏è Please select a start date.'); return; }

                if (window.csSelectedSlot === 'csCustom') {
                    if (!endDate) { alert('‚ö†Ô∏è Please enter an end date for Custom slot.'); return; }
                    if (endDate < startDate) { alert('‚ö†Ô∏è End date must be after start date.'); return; }
                }

                const days = Math.round((new Date(endDate) - new Date(startDate)) / 86400000) + 1;

                if (window.csSelectedSlot !== 'csCustom') {
                    const slot = this.state.slotTypes.find(s => s.id === window.csSelectedSlot);
                    if (slot && days !== slot.days) {
                        alert(`${slot.name} requires exactly ${slot.days} days. Select "Custom" for free range.`);
                        return;
                    }
                }

                // Check overlap with existing CS bids
                const csBids = this.state.bids.filter(bid => bid.employeeId === csUser.id);
                for (const bid of csBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        alert(`Date overlap with an existing bid (${bid.startDate} ‚Üí ${bid.endDate}).`);
                        return;
                    }
                }

                const slotLabel = window.csSelectedSlot === 'csCustom'
                    ? 'Custom' : (this.state.slotTypes.find(s => s.id === window.csSelectedSlot)?.name || window.csSelectedSlot);

                const newBid = {
                    employeeId: csUser.id,
                    employeeName: csUser.name,
                    seniorityDate: csUser.seniorityDate || '2000-01-01',
                    department: 'Corporate Staff',
                    slotType: window.csSelectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();
                this.writeAuditLog('BID_PLACED', { type: 'CS', slot: window.csSelectedSlot, start: startDate, end: endDate, days });

                this.saveBidToSupabase(newBid).then(saved => {
                    if (saved) console.log('‚úÖ CS Bid saved to Supabase');
                });

                alert(`üè¢ Corporate Staff Bid placed!\n${slotLabel} ‚Äî ${startDate} ‚Üí ${endDate} (${days} day${days !== 1 ? 's' : ''})`);
                this.renderCorporateStaffBiddingView();
            },

            removeCSBid(slotType, startDate) {
                if (this.state.isProcessed) { alert('Cannot remove bids after processing.'); return; }
                const csUser = this.state.verifiedEmployee;
                if (confirm('Remove this Corporate Staff bid?')) {
                    const idx = this.state.bids.findIndex(bid =>
                        bid.employeeId === csUser.id && bid.slotType === slotType && bid.startDate === startDate
                    );
                    if (idx !== -1) this.state.bids.splice(idx, 1);
                    this.saveState();
                    if (this.supabase) {
                        this.supabase.from('leave_requests').delete()
                            .eq('employee_id', csUser.id)
                            .eq('slot_type', slotType)
                            .eq('start_date', startDate)
                            .then(({ error }) => {
                                if (error) console.warn('‚ö†Ô∏è Could not delete CS bid from Supabase:', error.message);
                                else console.log('‚úÖ CS Bid deleted from Supabase');
                            });
                    }
                    this.renderCorporateStaffBiddingView();
                }
            },

            renderConfigureSlotsView() {
                const content = document.getElementById('contentArea');
                
                // Get all unique departments from employees AND the predefined list
                // Filter: only L3, L46, L5 prefixes
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allRawDepartments = [...new Set([...this.state.departments, ...employeeDepts])];
                const filteredDepts = allRawDepartments.filter(d => /^(L3|L46|L5)[-\s]/i.test(d) || d === 'L3-SA' || d === 'L5 SA' || d === 'L3 SAMB' || d === 'L5 SAMB' || d === 'L46 SAMB').sort();
                const allDepartments = ['all', ...filteredDepts];
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">üìÖ Configure Bid Slot Calendar for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Define specific calendar date ranges for each bid slot per department per month (Jan‚ÄìDec). 
                                Each department has Slot A, Slot B, and Slot C for each of the 12 months, with individual capacity limits.
                            </p>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <label class="block font-semibold mb-2">Filter by Department:</label>
                                <select
                                    id="deptFilter"
                                    class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg font-semibold"
                                    onchange="app.filterDepartments()"
                                >
                                    ${allDepartments.map(dept => `
                                        <option value="${dept}">
                                            ${dept === 'all' ? 'All Departments (L3 / L46 / L5)' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
            
                            <div id="configArea">
                                ${this.renderDeptConfig('all')}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            filterDepartments() {
                const filter = document.getElementById('deptFilter').value;
                const configArea = document.getElementById('configArea');
                
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filter);
                }
            },
            
            renderDeptConfig(filter) {
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allRawDepartments = [...new Set([...this.state.departments, ...employeeDepts])];
                const allDepartments = allRawDepartments.filter(d => /^(L3|L46|L5)[-\s]/i.test(d) || d === 'L3-SA' || d === 'L5 SA' || d === 'L3 SAMB' || d === 'L5 SAMB' || d === 'L46 SAMB').sort();
                
                let departmentsToConfigure = [];
                
                if (filter === 'all') {
                    departmentsToConfigure = allDepartments;
                } else {
                    departmentsToConfigure = [filter];
                }
                
                if (departmentsToConfigure.length === 0) {
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-6 text-center">
                            <p class="text-lg font-semibold">No departments found!</p>
                            <p class="mt-2">Please upload employee data first.</p>
                        </div>
                    `;
                }
                
                let html = '';
                
                if (filter === 'all') {
                    html += `
                        <div class="mb-6 p-4 bg-green-50 border border-green-300 rounded">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">üìÖ Calendar Slot Configuration ‚Äî All Departments</h3>
                            <p class="text-green-700">Configure specific date ranges for each bid slot period across ${departmentsToConfigure.length} departments.</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                            <h3 class="text-xl font-semibold text-blue-800 mb-2">üìÖ Calendar Slot Configuration ‚Äî ${filter}</h3>
                            <p class="text-blue-700">Configure specific date ranges for each bid slot period for this department.</p>
                        </div>
                    `;
                }
                
                html += `<div class="space-y-8">`;
                
                departmentsToConfigure.forEach(dept => {
                    const hasEmployees = employeeDepts.includes(dept);
                    const employeeCount = this.state.employees.filter(e => (e.department || 'Unassigned') === dept).length;
                    
                    // Calendar slots: Slot A, Slot B, Slot C (date range based)
                    const periods = [
                        { id: 'SA', label: 'Slot A', colorClass: 'green', borderColor: 'border-green-400', bgColor: 'bg-green-50' },
                        { id: 'SB', label: 'Slot B', colorClass: 'blue', borderColor: 'border-blue-400', bgColor: 'bg-blue-50' },
                        { id: 'SC', label: 'Slot C', colorClass: 'purple', borderColor: 'border-purple-400', bgColor: 'bg-purple-50' }
                    ];
                    
                    html += `
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold">${dept}</h3>
                                    <div class="flex gap-2 mt-1">
                                        ${hasEmployees ? 
                                            `<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">${employeeCount} employees</span>` : 
                                            `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">No employees</span>`
                                        }
                                    </div>
                                </div>
                                <span class="text-sm text-gray-500">12-Month Slot Configuration</span>
                            </div>
                            <div class="p-4 overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-200 px-3 py-2 text-left font-semibold text-gray-700">Month</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-green-700 bg-green-50">Slot A ‚Äî Max</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-blue-700 bg-blue-50">Slot B ‚Äî Max</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî Start</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî End</th>
                                            <th class="border border-gray-200 px-3 py-2 text-center font-semibold text-purple-700 bg-purple-50">Slot C ‚Äî Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.state.months.map((month, monthIdx) => {
                                            const year = this.state.biddingYear;
                                            // Default start = 1st of month, end = last day of month
                                            const pad = n => String(n).padStart(2, '0');
                                            const lastDay = new Date(year, monthIdx + 1, 0).getDate();
                                            const defaultStart = `${year}-${pad(monthIdx + 1)}-01`;
                                            const defaultEnd   = `${year}-${pad(monthIdx + 1)}-${pad(lastDay)}`;
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="border border-gray-200 px-3 py-2 font-semibold text-gray-800 bg-gray-50 whitespace-nowrap">${month}</td>
                                                    ${['SA','SB','SC'].map((slotId, si) => {
                                                        const colors = ['border-green-300 focus:border-green-500','border-blue-300 focus:border-blue-500','border-purple-300 focus:border-purple-500'];
                                                        const bgCols = ['bg-green-50','bg-blue-50','bg-purple-50'];
                                                        const savedStart    = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-start`];
                                                        const savedEnd      = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-end`];
                                                        const savedCapacity = this.state.slotCapacities[`cal-${dept}-${month}-${slotId}-capacity`];
                                                        const startVal    = savedStart    !== undefined ? savedStart    : defaultStart;
                                                        const endVal      = savedEnd      !== undefined ? savedEnd      : defaultEnd;
                                                        const capacityVal = savedCapacity !== undefined ? savedCapacity : 1;
                                                        return `
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="date"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="start"
                                                                    class="cal-slot-input w-full px-1 py-1 border ${colors[si]} rounded text-xs"
                                                                    min="${year}-01-01" max="${year}-12-31"
                                                                    value="${startVal}"
                                                                />
                                                            </td>
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="date"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="end"
                                                                    class="cal-slot-input w-full px-1 py-1 border ${colors[si]} rounded text-xs"
                                                                    min="${year}-01-01" max="${year}-12-31"
                                                                    value="${endVal}"
                                                                />
                                                            </td>
                                                            <td class="border border-gray-200 px-1 py-1 ${bgCols[si]}">
                                                                <input type="number" min="0" max="200"
                                                                    data-dept="${dept}" data-month="${month}" data-slot="${slotId}" data-field="capacity"
                                                                    class="cal-slot-input slot-input w-full px-1 py-1 border ${colors[si]} rounded text-center text-xs"
                                                                    placeholder="1"
                                                                    value="${capacityVal}"
                                                                />
                                                            </td>
                                                        `;
                                                    }).join('')}
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                html += `
                    <div class="mt-8">
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                            <p class="font-semibold text-yellow-800 mb-2">üìã Calendar Configuration Summary:</p>
                            <p class="text-sm text-yellow-700">
                                ‚Ä¢ Departments: ${departmentsToConfigure.length} department${departmentsToConfigure.length === 1 ? '' : 's'}<br>
                                ‚Ä¢ Bid slots per department: 3 (Slot A, Slot B, Slot C) √ó 12 months<br>
                                ‚Ä¢ Each slot: custom start date, end date, and max capacity<br>
                                ‚Ä¢ Total configurations: ${departmentsToConfigure.length * 3} bid slots √ó 12 months
                            </p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="app.saveSlotConfiguration()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600">
                                üíæ Save All Slot Configurations
                            </button>
                            <button onclick="app.setActiveView('upload')" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            },
            
            copyToAllMonths() {
                const filter = document.getElementById('deptFilter')?.value || 'all';
                const employeeDepts = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allDepartments = [...new Set([...this.state.departments, ...employeeDepts])].sort();
                
                let departmentsToCopy = [];
                if (filter === 'all') {
                    departmentsToCopy = allDepartments;
                } else {
                    departmentsToCopy = [filter];
                }
                
                // Get January values for each department and slot
                const januaryValues = {};
                
                departmentsToCopy.forEach(dept => {
                    ['A', 'B', 'C'].forEach(slot => {
                        const key = `January-${dept}-${slot}`;
                        januaryValues[`${dept}-${slot}`] = this.state.slotCapacities[key] || 1;
                    });
                });
                
                // Apply to all months
                this.state.months.forEach(month => {
                    if (month === 'January') return; // Skip January since it's our source
                    
                    departmentsToCopy.forEach(dept => {
                        ['A', 'B', 'C'].forEach(slot => {
                            const key = `${month}-${dept}-${slot}`;
                            this.state.slotCapacities[key] = januaryValues[`${dept}-${slot}`];
                        });
                    });
                });
                
                // Update the UI
                const filterVal = document.getElementById('deptFilter')?.value || 'all';
                const configArea = document.getElementById('configArea');
                if (configArea) {
                    configArea.innerHTML = this.renderDeptConfig(filterVal);
                }
                
                this.saveConfigToSupabase();
                alert(`‚úÖ Copied January values to all months for ${departmentsToCopy.length} department(s)!`);
            },
            
            saveSlotConfiguration() {
                // Save calendar-based slot inputs (new format: cal-dept-month-slotId-field)
                const calInputs = document.querySelectorAll('.cal-slot-input');
                let savedCount = 0;
                
                calInputs.forEach(input => {
                    const dept = input.dataset.dept;
                    const month = input.dataset.month;
                    const slot = input.dataset.slot;
                    const field = input.dataset.field;
                    let value;
                    if (field === 'capacity') {
                        value = parseInt(input.value);
                        if (isNaN(value)) value = 1; // default capacity = 1
                    } else {
                        value = input.value;
                    }
                    
                    if (dept && slot && field) {
                        const key = month 
                            ? `cal-${dept}-${month}-${slot}-${field}` 
                            : `cal-${dept}-${slot}-${field}`;
                        this.state.slotCapacities[key] = value;
                        savedCount++;
                    }
                });
                
                this.saveConfigToSupabase();

                // Also push slot config to Supabase so other browsers get it
                if (this.supabase) {
                    // saveConfigToSupabase above already handles this ‚Äî no duplicate upsert needed
                }
                
                alert(`‚úÖ Slot configurations saved!\n\n‚Ä¢ ${savedCount} fields saved.\n‚Ä¢ Each department now has Slot A, B, C configured per month (Jan‚ÄìDec).`);
                
                this.setActiveView('admin');
            },

            async refreshBidsFromSupabase(silent = false) {
                if (!this.supabase) {
                    if (!silent) alert('‚ö†Ô∏è Not connected to database.');
                    return false;
                }
                if (!silent) this.updateSystemStatus('Refreshing bids...');
                try {
                    let allBids = [];
                    let from = 0;
                    const batchSize = 1000;

                    while (true) {
                        const { data: batch, error } = await this.supabase
                            .from('leave_requests')
                            .select('*')
                            .range(from, from + batchSize - 1);
                        if (error) { console.error('‚ùå Bids fetch error:', error.message); break; }
                        if (!batch || batch.length === 0) break;
                        allBids = [...allBids, ...batch];
                        if (batch.length < batchSize) break;
                        from += batchSize;
                    }

                    console.log(`‚úÖ Fetched ${allBids.length} bids from Supabase`);

                    this.state.bids = allBids.map(bid => ({
                        employeeId: bid.employee_id,
                        employeeName: bid.employee_name || this.state.employees.find(e => e.id === bid.employee_id)?.name || '',
                        seniorityDate: this.state.employees.find(e => e.id === bid.employee_id)?.seniorityDate || '',
                        department: bid.department || this.state.employees.find(e => e.id === bid.employee_id)?.department || '',
                        position: this.state.employees.find(e => e.id === bid.employee_id)?.position || '',
                        slotType: bid.slot_type || 'slotA',
                        startDate: bid.start_date,
                        endDate: bid.end_date,
                        days: bid.days_requested,
                        timestamp: bid.created_at
                    }));

                    this.saveState();
                    this.updateSystemStatus(`‚úÖ ${this.state.bids.length} bid${this.state.bids.length !== 1 ? 's' : ''} loaded`);

                    if (silent) {
                        // Silent auto-poll: update only the live elements without full re-render
                        this._liveUpdateAdminPanel();
                    } else {
                        this.renderAdminView();
                    }
                    return true;
                } catch (e) {
                    console.error('Refresh bids error:', e);
                    this.updateSystemStatus('‚ö†Ô∏è Refresh failed');
                    if (!silent) alert('Failed to refresh bids: ' + e.message);
                    return false;
                }
            },

            _liveUpdateAdminPanel() {
                // Update stats badges
                const bidCountEl = document.getElementById('adminBidCount');
                if (bidCountEl) bidCountEl.textContent = this.state.bids.length;
                const bidCount2El = document.getElementById('adminBidCount2');
                if (bidCount2El) bidCount2El.textContent = this.state.bids.length;
                const uniqueBiddersEl = document.getElementById('adminUniqueBidders');
                if (uniqueBiddersEl) uniqueBiddersEl.textContent = new Set(this.state.bids.map(b => b.employeeId)).size;
                const uniqueBidders2El = document.getElementById('adminUniqueBidders2');
                if (uniqueBidders2El) uniqueBidders2El.textContent = new Set(this.state.bids.map(b => b.employeeId)).size;
                const lastRefreshEl = document.getElementById('adminLastRefresh');
                if (lastRefreshEl) lastRefreshEl.textContent = new Date().toLocaleTimeString();
                // Re-render bids table
                const tableContainer = document.getElementById('adminBidsTableContainer');
                if (tableContainer) tableContainer.innerHTML = this._renderBidsTableHTML();
            },

            _renderBidsTableHTML() {
                if (this.state.bids.length === 0) {
                    return `
                        <div class="text-center py-10 text-gray-400">
                            <p class="text-4xl mb-3">üì≠</p>
                            <p class="font-semibold">No bids submitted yet</p>
                            <p class="text-sm mt-1">Auto-refreshing every 15 seconds. Bids appear here as soon as employees submit them.</p>
                        </div>`;
                }
                const sortedBids = [...this.state.bids].sort((a, b) => {
                    const dA = new Date(this.state.employees.find(e => e.id === a.employeeId)?.seniorityDate || 0);
                    const dB = new Date(this.state.employees.find(e => e.id === b.employeeId)?.seniorityDate || 0);
                    return dA - dB;
                });
                const colorMap = { slotA: 'bg-green-100 text-green-800', slotB: 'bg-blue-100 text-blue-800', slotC: 'bg-purple-100 text-purple-800' };
                return `
                    <div class="mb-3 flex justify-end">
                        <button onclick="app.deleteAllBids()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600">
                            üóëÔ∏è Delete All Bids
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-left">
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">#</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Employee ID</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Name</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Position</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Slot Type</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Start Date</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">End Date</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Days</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700">Submitted</th>
                                    <th class="border border-gray-200 px-3 py-2 font-semibold text-gray-700 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedBids.map((bid, idx) => {
                                    const emp = this.state.employees.find(e => e.id === bid.employeeId);
                                    const slotColor = colorMap[bid.slotType] || 'bg-gray-100 text-gray-700';
                                    const slotDisplay = this.state.slotTypes.find(s => s.id === bid.slotType)?.name || bid.slotType;
                                    const submitted = bid.timestamp ? new Date(bid.timestamp).toLocaleString() : 'N/A';
                                    const safeId = encodeURIComponent(bid.employeeId);
                                    const safeSlot = encodeURIComponent(bid.slotType);
                                    const safeStart = encodeURIComponent(bid.startDate);
                                    return `
                                        <tr class="${idx % 2 === 0 ? '' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">
                                            <td class="border border-gray-200 px-3 py-2 text-gray-500 text-center">${idx + 1}</td>
                                            <td class="border border-gray-200 px-3 py-2 font-mono text-xs text-gray-700">${bid.employeeId}</td>
                                            <td class="border border-gray-200 px-3 py-2 font-semibold text-gray-800">${bid.employeeName || emp?.name || 'Unknown'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-600">${bid.position || emp?.position || bid.department || emp?.department || 'Unassigned'}</td>
                                            <td class="border border-gray-200 px-3 py-2"><span class="px-2 py-1 rounded text-xs font-semibold ${slotColor}">${slotDisplay}</span></td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-700">${bid.startDate || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-gray-700">${bid.endDate || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-center font-semibold text-gray-800">${bid.days || '‚Äî'}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-xs text-gray-500">${submitted}</td>
                                            <td class="border border-gray-200 px-3 py-2 text-center">
                                                <button onclick="app.adminDeleteBid('${safeId}','${safeSlot}','${safeStart}')"
                                                    class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold hover:bg-red-200">
                                                    üóëÔ∏è Delete
                                                </button>
                                            </td>
                                        </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            },

            async adminDeleteBid(encodedId, encodedSlot, encodedStart) {
                const employeeId = decodeURIComponent(encodedId);
                const slotType   = decodeURIComponent(encodedSlot);
                const startDate  = decodeURIComponent(encodedStart);
                const bid = this.state.bids.find(b => b.employeeId === employeeId && b.slotType === slotType && b.startDate === startDate);
                const name = bid?.employeeName || employeeId;
                if (!confirm(`Delete bid for ${name} (${slotType}, ${startDate})?\n\nThis cannot be undone.`)) return;

                // Remove from state
                this.state.bids = this.state.bids.filter(b =>
                    !(b.employeeId === employeeId && b.slotType === slotType && b.startDate === startDate)
                );
                this.saveState();

                // Delete from Supabase
                if (this.supabase) {
                    const { error } = await this.supabase
                        .from('leave_requests')
                        .delete()
                        .eq('employee_id', employeeId)
                        .eq('slot_type', slotType)
                        .eq('start_date', startDate);
                    if (error) console.warn('‚ö†Ô∏è Supabase delete error:', error.message);
                    else console.log('‚úÖ Bid deleted from Supabase');
                }

                this._liveUpdateAdminPanel();
            },

            async deleteAllBids() {
                if (!confirm(`‚ö†Ô∏è Delete ALL ${this.state.bids.length} bids?\n\nThis will permanently remove every bid from the database and cannot be undone.`)) return;

                this.state.bids = [];
                this.saveState();

                if (this.supabase) {
                    const { error } = await this.supabase
                        .from('leave_requests')
                        .delete()
                        .neq('id', '00000000-0000-0000-0000-000000000000'); // delete all rows
                    if (error) console.warn('‚ö†Ô∏è Supabase delete all error:', error.message);
                    else console.log('‚úÖ All bids deleted from Supabase');
                }

                this._liveUpdateAdminPanel();
                alert('‚úÖ All bids have been deleted.');
            },

            startAdminPolling() {
                this.stopAdminPolling(); // clear any existing timer
                console.log('üîÑ Starting admin bid auto-poll (15s interval)');
                this._adminPollTimer = setInterval(async () => {
                    if (this.state.activeView === 'admin' && this.state.userType === 'planner') {
                        await this.refreshBidsFromSupabase(true); // silent poll
                    } else {
                        this.stopAdminPolling(); // stop if planner left admin view
                    }
                }, 15000);
            },

            stopAdminPolling() {
                if (this._adminPollTimer) {
                    clearInterval(this._adminPollTimer);
                    this._adminPollTimer = null;
                    console.log('‚èπ Admin poll stopped');
                }
            },

            renderAdminView() {
                const content = document.getElementById('contentArea');
                // Use exact same department list as Configure Slots (L3/L46/L5 codes only)
                const employeeDeptsAdmin = [...new Set(this.state.employees.map(e => e.department || 'Unassigned'))];
                const allRawDeptsAdmin = [...new Set([...this.state.departments, ...employeeDeptsAdmin])];
                const filteredDeptsAdmin = allRawDeptsAdmin.filter(d => /^(L3|L46|L5)[-\s]/i.test(d) || d === 'L3-SA' || d === 'L5 SA' || d === 'L3 SAMB' || d === 'L5 SAMB' || d === 'L46 SAMB').sort();
                const allDepts = filteredDeptsAdmin;
                const depts = ['all', ...filteredDeptsAdmin];
                
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Admin Panel</h2>
                                <div class="flex items-center gap-2 bg-green-50 border border-green-200 px-3 py-1.5 rounded-lg text-sm text-green-700">
                                    <span class="inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    Live &mdash; auto-refreshes every 15s &nbsp;|&nbsp; Last: <span id="adminLastRefresh">${new Date().toLocaleTimeString()}</span>
                                </div>
                            </div>
                            
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <label class="block font-semibold mb-2">Set Bidding Deadline:</label>
                                <input
                                    type="datetime-local"
                                    id="biddingDeadline"
                                    value="${this.state.biddingDeadline}"
                                    class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg"
                                    onchange="app.state.biddingDeadline = this.value; app.saveConfigToSupabase()"
                                />
                            </div>

                            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                                <label class="block font-semibold mb-2">Filter by Scheduling Row:</label>
                                <select
                                    id="adminDeptFilter"
                                    class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                    onchange="app.state.selectedDepartment = this.value;"
                                >
                                    ${depts.map(dept => `
                                        <option value="${dept}" ${dept === this.state.selectedDepartment ? 'selected' : ''}>
                                            ${dept === 'all' ? 'All Departments (L3 / L46 / L5)' : dept}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.employees.length}</p>
                                    <p class="text-sm text-gray-600">Total Employees</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold" id="adminBidCount">${this.state.bids.length}</p>
                                    <p class="text-sm text-gray-600">Total Bids</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold" id="adminUniqueBidders">${new Set(this.state.bids.map(b => b.employeeId)).size}</p>
                                    <p class="text-sm text-gray-600">Employees Who Bid</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-2xl font-bold">${this.state.isProcessed ? 'Yes' : 'No'}</p>
                                    <p class="text-sm text-gray-600">Processed</p>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <button
                                    onclick="app.processBids()"
                                    ${this.state.isProcessed || this.state.employees.length === 0 ? 'disabled' : ''}
                                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold ${this.state.isProcessed ? 'opacity-50' : ''}"
                                >
                                    ${this.state.isProcessed ? '‚úÖ Bids Already Processed' : 'üöÄ Process All Bids'}
                                </button>
                                
                                ${this.state.isProcessed ? `
                                    <button onclick="app.exportResults()" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-semibold">
                                        üìä Export Results to Excel
                                    </button>
                                    <button onclick="app.showEmailNotifyModal()" class="w-full px-6 py-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                                        üìß Notify Staff by Email (Results Ready)
                                    </button>
                                    <button onclick="app.setActiveView('manualOverride')" class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600">
                                        ‚úèÔ∏è Manual Override Results
                                    </button>
                                ` : ''}
                                
                                <button onclick="app.refreshBidsFromSupabase(false)" class="w-full px-6 py-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                                    üîÑ Refresh Bids Now
                                </button>
                                
                                <button onclick="app.resetSystem()" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg font-semibold">
                                    üîÑ Reset System
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">System Information</h3>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>&bull; Scheduling Rows configured: ${allDepts.length}</p>
                                    <p>&bull; Slot capacities configured: ${Object.keys(this.state.slotCapacities).length > 0 ? 'Yes' : 'No'}</p>
                                    <p>&bull; Bidding year: ${this.state.biddingYear}</p>
                                    <p>&bull; Last sync: ${this.state.employees.length > 0 ? 'Data loaded' : 'No data'}</p>
                                </div>
                            </div>

                            <!-- Staff Bids Details Section -->
                        <div class="mt-6 bg-white border-2 border-indigo-200 rounded-xl overflow-hidden">
                            <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-200 flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold text-indigo-900">üìã Staff Bid Details</h3>
                                    <p class="text-sm text-indigo-600 mt-1">All bids from staff, sorted by seniority. Updates automatically every 15 seconds.</p>
                                </div>
                                <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    <span id="adminBidCount2">${this.state.bids.length}</span> bids from <span id="adminUniqueBidders2">${new Set(this.state.bids.map(b => b.employeeId)).size}</span> staff
                                </span>
                            </div>
                            <div class="p-4" id="adminBidsTableContainer">
                                ${this._renderBidsTableHTML()}
                            </div>
                        </div>

                    </div>
                `;
            },

            addGCUser() {
                const id = document.getElementById('newGCId')?.value?.trim();
                const name = document.getElementById('newGCName')?.value?.trim();
                const password = document.getElementById('newGCPassword')?.value?.trim();
                
                if (!id || !name) {
                    alert('Please enter both a GC ID and a name.');
                    return;
                }
                
                const existing = (this.state.goldenCommandUsers || []).find(u => u.id === id);
                if (existing) {
                    alert(`GC ID "${id}" already exists.`);
                    return;
                }
                
                if (!this.state.goldenCommandUsers) this.state.goldenCommandUsers = [];
                
                this.state.goldenCommandUsers.push({
                    id: id,
                    name: name,
                    password: password || id
                });
                
                this.saveState();
                this.saveGCUsersToSupabase();
                alert(`‚úÖ Golden Command user "${name}" (ID: ${id}) added and saved to database!`);
                this.renderUploadView();
            },

            removeGCUser(index) {
                const users = this.state.goldenCommandUsers || [];
                if (index < 0 || index >= users.length) return;
                
                const user = users[index];
                if (confirm(`Remove Golden Command user "${user.name}" (${user.id})?`)) {
                    this.state.goldenCommandUsers.splice(index, 1);
                    this.saveState();
                    this.saveGCUsersToSupabase();
                    this.renderUploadView();
                }
            },

            addCSUser() {
                const id = document.getElementById('newCSId')?.value?.trim();
                const name = document.getElementById('newCSName')?.value?.trim();
                const password = document.getElementById('newCSPassword')?.value?.trim();
                
                if (!id || !name) {
                    alert('Please enter both a Staff ID and a name.');
                    return;
                }
                
                const existing = (this.state.corporateStaffUsers || []).find(u => u.id === id);
                if (existing) {
                    alert(`Staff ID "${id}" already exists.`);
                    return;
                }
                
                if (!this.state.corporateStaffUsers) this.state.corporateStaffUsers = [];
                
                this.state.corporateStaffUsers.push({
                    id: id,
                    name: name,
                    password: password || id
                });
                
                this.saveState();
                this.saveCorporateStaffUsersToSupabase();
                alert(`‚úÖ Corporate Staff user "${name}" (ID: ${id}) added and saved to database!`);
                this.renderUploadView();
            },

            removeCSUser(index) {
                const users = this.state.corporateStaffUsers || [];
                if (index < 0 || index >= users.length) return;
                
                const user = users[index];
                if (confirm(`Remove Corporate Staff user "${user.name}" (${user.id})?`)) {
                    this.state.corporateStaffUsers.splice(index, 1);
                    this.saveState();
                    this.saveCorporateStaffUsersToSupabase();
                    this.renderUploadView();
                }
            },

            async saveGCUsersToSupabase() {
                // Syncs the full golden_command_users table with current state:
                // 1. Upsert every user in state (add new, update existing)
                // 2. Delete any rows in the table that are no longer in state
                if (!this.supabase) return;
                try {
                    const currentUsers = this.state.goldenCommandUsers || [];

                    // Step 1: Upsert all current users
                    if (currentUsers.length > 0) {
                        const { error: upsertError } = await this.supabase
                            .from('golden_command_users')
                            .upsert(
                                currentUsers.map(u => ({
                                    id: u.id,
                                    tenant_id: this._tid(),
                                    name: u.name,
                                    password: u.password,
                                    updated_at: new Date().toISOString()
                                })),
                                { onConflict: 'id' }
                            );
                        if (upsertError) throw upsertError;
                    }

                    // Step 2: Delete rows no longer in state
                    // Fetch all IDs currently in the table
                    const { data: tableRows, error: fetchError } = await this.supabase
                        .from('golden_command_users')
                        .select('id')
                        .eq('tenant_id', this._tid());
                    if (fetchError) throw fetchError;

                    const currentIds = currentUsers.map(u => u.id);
                    const toDelete = (tableRows || []).map(r => r.id).filter(id => !currentIds.includes(id));

                    if (toDelete.length > 0) {
                        const { error: deleteError } = await this.supabase
                            .from('golden_command_users')
                            .delete()
                            .in('id', toDelete);
                        if (deleteError) throw deleteError;
                    }

                    console.log(`‚úÖ GC users synced to dedicated table (${currentUsers.length} users)`);
                } catch (e) {
                    console.warn('‚ö†Ô∏è GC users sync failed:', e.message);
                }
            },

            async saveCorporateStaffUsersToSupabase() {
                if (!this.supabase) return;
                try {
                    const currentUsers = this.state.corporateStaffUsers || [];

                    // Step 1: Upsert all current users
                    if (currentUsers.length > 0) {
                        const { error: upsertError } = await this.supabase
                            .from('corporate_staff_users')
                            .upsert(
                                currentUsers.map(u => ({
                                    id: u.id,
                                    tenant_id: this._tid(),
                                    name: u.name,
                                    password: u.password,
                                    updated_at: new Date().toISOString()
                                })),
                                { onConflict: 'id' }
                            );
                        if (upsertError) throw upsertError;
                    }

                    // Step 2: Delete rows no longer in state
                    const { data: tableRows, error: fetchError } = await this.supabase
                        .from('corporate_staff_users')
                        .select('id')
                        .eq('tenant_id', this._tid());
                    if (fetchError) throw fetchError;

                    const currentIds = currentUsers.map(u => u.id);
                    const toDelete = (tableRows || []).map(r => r.id).filter(id => !currentIds.includes(id));

                    if (toDelete.length > 0) {
                        const { error: deleteError } = await this.supabase
                            .from('corporate_staff_users')
                            .delete()
                            .in('id', toDelete);
                        if (deleteError) throw deleteError;
                    }

                    console.log(`‚úÖ Corporate Staff users synced to dedicated table (${currentUsers.length} users)`);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Corporate Staff users sync failed:', e.message);
                }
            },

            // ==================== OTHER FUNCTIONS ====================

            // ==================== OTHER FUNCTIONS ====================
            async processBids() {
                if (this.state.employees.length === 0) {
                    alert('No employees to process. Please upload data first.');
                    return;
                }
                
                if (Object.keys(this.state.slotCapacities).length === 0) {
                    alert('Please configure slot capacities first in "Configure Slots".');
                    this.setActiveView('configureSlots');
                    return;
                }
                
                // Calculate entitlement for each employee
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    return (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                // Track slot availability per month per department
                const slotAvailability = {};
                const slotAssignments = [];

                // Build a lookup: slotDates[dept][month][slotId] = { start, end }
                // so assignSlotToEmployee can use the real configured dates
                const slotDates = {};

                // Initialize slot availability from capacities
                // New key format: cal-{dept}-{month}-{slotId}-{field}
                // e.g. cal-L3-DEP-DC-January-SA-capacity  (dept may contain dashes!)
                // We identify field as last segment, slotId as second-last, month as third-last,
                // and dept as everything between "cal" and month.
                const months = this.state.months; // ['January','February',...]
                Object.keys(this.state.slotCapacities).forEach(key => {
                    if (!key.startsWith('cal-')) return;
                    const withoutPrefix = key.slice(4); // remove leading "cal-"
                    // Last segment is field (start / end / capacity)
                    const lastDash = withoutPrefix.lastIndexOf('-');
                    const field = withoutPrefix.slice(lastDash + 1);
                    const withoutField = withoutPrefix.slice(0, lastDash);
                    // Second-last segment is slotId (SA / SB / SC)
                    const slotIdDash = withoutField.lastIndexOf('-');
                    const slotId = withoutField.slice(slotIdDash + 1); // e.g. "SA"
                    const withoutSlot = withoutField.slice(0, slotIdDash);
                    // Third-last segment is the month name
                    const monthDash = withoutSlot.lastIndexOf('-');
                    const month = withoutSlot.slice(monthDash + 1);
                    const dept = withoutSlot.slice(0, monthDash);

                    if (!months.includes(month)) return; // skip malformed keys
                    // Map SA‚ÜíA, SB‚ÜíB, SC‚ÜíC for the availability object
                    const slotLetter = slotId === 'SA' ? 'A' : slotId === 'SB' ? 'B' : slotId === 'SC' ? 'C' : null;
                    if (!slotLetter) return;

                    const value = this.state.slotCapacities[key];

                    if (field === 'capacity') {
                        const cap = parseInt(value) || 0;
                        if (!slotAvailability[month]) slotAvailability[month] = {};
                        if (!slotAvailability[month][dept]) slotAvailability[month][dept] = { A: 0, B: 0, C: 0 };
                        slotAvailability[month][dept][slotLetter] = cap;
                    } else if (field === 'start' || field === 'end') {
                        if (!slotDates[dept]) slotDates[dept] = {};
                        if (!slotDates[dept][month]) slotDates[dept][month] = {};
                        if (!slotDates[dept][month][slotLetter]) slotDates[dept][month][slotLetter] = {};
                        slotDates[dept][month][slotLetter][field] = value;
                    }
                });
                
                // Helper function to assign slot to employee using real configured dates
                const assignSlotToEmployee = (employee, month, slotType, slotNumber) => {
                    const slot = this.state.slotTypes.find(s => s.id === `slot${slotType}`);
                    const dept = employee.department || 'Unassigned';
                    const year = this.state.biddingYear;

                    // Use real configured dates if available
                    const configuredDates = slotDates[dept]?.[month]?.[slotType];
                    let startDateStr, endDateStr;

                    if (configuredDates?.start && configuredDates?.end) {
                        startDateStr = configuredDates.start;
                        endDateStr = configuredDates.end;
                    } else {
                        // Fallback: calculate from month index
                        const monthIndex = this.state.months.indexOf(month);
                        let startDate = new Date(year, monthIndex, 1);
                        if (slotNumber === 2) {
                            if (slotType === 'A') startDate.setDate(16);
                            if (slotType === 'B') startDate.setDate(16);
                            if (slotType === 'C') startDate.setDate(11);
                        }
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + (slot ? slot.days : 15) - 1);
                        startDateStr = startDate.toISOString().split('T')[0];
                        endDateStr = endDate.toISOString().split('T')[0];
                    }

                    const days = slot ? slot.days : Math.ceil((new Date(endDateStr) - new Date(startDateStr)) / (1000 * 60 * 60 * 24)) + 1;

                    return {
                        employeeId: employee.id,
                        employeeName: employee.name,
                        position: employee.position || '',
                        department: dept,
                        slotName: `${slot ? slot.name : slotType}`,
                        slotType: `slot${slotType}`,
                        slotNumber: slotNumber || 1,
                        startDate: startDateStr,
                        endDate: endDateStr,
                        days: days,
                        month: month,
                        year: year,
                        seniorityDate: employee.seniorityDate,
                        yearsOfService: calculateYearsOfService(employee.seniorityDate).toFixed(1)
                    };
                };
                
                // Build a dept resolver: maps an employee's department value to the
                // best-matching key in slotAvailability (handles cases where the Excel
                // 'Department' column has a display name like 'Depot Controller' instead
                // of the L-code 'L3-DEP-DC' that was used when configuring slots).
                const configuredDeptKeys = new Set(
                    Object.values(slotAvailability).flatMap(monthObj => Object.keys(monthObj || {}))
                );
                const deptResolveCache = {};
                const resolveEmployeeDept = (empDept) => {
                    if (deptResolveCache[empDept] !== undefined) return deptResolveCache[empDept];
                    // Exact match first
                    if (configuredDeptKeys.has(empDept)) {
                        deptResolveCache[empDept] = empDept;
                        return empDept;
                    }
                    // Try case-insensitive exact match
                    for (const key of configuredDeptKeys) {
                        if (key.toLowerCase() === empDept.toLowerCase()) {
                            deptResolveCache[empDept] = key;
                            return key;
                        }
                    }
                    // No match found ‚Äî return original so warning logic catches it
                    deptResolveCache[empDept] = empDept;
                    return empDept;
                };

                // ‚îÄ‚îÄ PER-DEPARTMENT SENIORITY ‚îÄ‚îÄ
                // Group employees by their resolved department, sort each group by seniority,
                // then interleave: rank-1 of every dept goes first, then rank-2, etc.
                // This ensures L3-SAMB #1 and L3-DEP-DC #1 both get priority before anyone's #2.

                // First resolve all departments
                const empWithDept = this.state.employees.map(e => ({
                    ...e,
                    resolvedDept: resolveEmployeeDept(e.department || 'Unassigned')
                }));

                // Group by resolved department
                const deptGroups = {};
                empWithDept.forEach(e => {
                    if (!deptGroups[e.resolvedDept]) deptGroups[e.resolvedDept] = [];
                    deptGroups[e.resolvedDept].push(e);
                });

                // Sort each department group by seniority (oldest first = most senior)
                Object.keys(deptGroups).forEach(dept => {
                    deptGroups[dept].sort((a, b) => new Date(a.seniorityDate) - new Date(b.seniorityDate));
                });

                // Build per-department sequential processing order:
                // Process ALL employees in dept A (rank 1‚ÜíN) before moving to dept B.
                // This ensures each department is fully self-contained ‚Äî L3-SAMB rank #1
                // through #N are processed entirely before L3-DEP-DC rank #1 starts.
                // Within each department, employees are ordered oldest seniority date first.
                const sortedDeptKeys = Object.keys(deptGroups).sort();
                const sortedEmployees = [];
                const deptRankMap = {}; // employeeId ‚Üí { dept, deptRank }

                sortedDeptKeys.forEach(dept => {
                    deptGroups[dept].forEach((emp, rankIdx) => {
                        sortedEmployees.push(emp);
                        deptRankMap[emp.id] = { dept, deptRank: rankIdx + 1 };
                    });
                });

                // Warn if any employee departments have no configured slots
                const configuredDepts = new Set(Object.keys(slotAvailability).flatMap(month => Object.keys(slotAvailability[month] || {})));
                const employeeDeptSet = new Set(sortedEmployees.map(e => resolveEmployeeDept(e.department || 'Unassigned')));
                const unconfiguredDepts = [...employeeDeptSet].filter(d => !configuredDepts.has(d));
                if (unconfiguredDepts.length > 0) {
                    const proceed = confirm(
                        `‚ö†Ô∏è WARNING: The following employee departments have NO slot capacity configured:\n\n` +
                        unconfiguredDepts.map(d => `‚Ä¢ ${d}`).join('\n') +
                        `\n\nEmployees in these departments will be auto-assigned using available slots from other configured departments.\n\n` +
                        `It is strongly recommended to Cancel and configure slots for these departments first.\n\nContinue anyway?`
                    );
                    if (!proceed) return;
                }

                // Process each employee by seniority (most senior first)
                sortedEmployees.forEach((employee, index) => {
                    const employeeBids = this.state.bids.filter(bid => bid.employeeId === employee.id);
                    const entitlement  = getEmployeeEntitlement(employee);
                    // Resolve employee department to the configured slot key (L3/L46/L5 code)
                    const department   = resolveEmployeeDept(employee.department || 'Unassigned');

                    const assignedSlots = [];
                    let assignedDays    = 0;

                    // ‚îÄ‚îÄ PHASE 1: Award the employee's own bid choices in order ‚îÄ‚îÄ
                    // Bids are sorted by submission timestamp so bid 1 = first choice, bid 2 = second choice
                    const sortedBids = [...employeeBids].sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));

                    for (const bid of sortedBids) {
                        if (assignedSlots.length >= 2) break;

                        const month    = this.state.months[new Date(bid.startDate).getMonth()];
                        const slotType = bid.slotType.charAt(bid.slotType.length - 1); // 'A', 'B', or 'C'

                        const available =
                            slotAvailability[month] &&
                            slotAvailability[month][department] &&
                            slotAvailability[month][department][slotType] > 0;

                        if (available) {
                            const assignment = assignSlotToEmployee(employee, month, slotType, assignedSlots.length + 1);
                            assignment.type  = 'Bid Awarded';
                            assignment.bidChoice = assignedSlots.length + 1; // 1st or 2nd choice
                            assignedSlots.push(assignment);
                            assignedDays += assignment.days;
                            slotAvailability[month][department][slotType]--;
                        }
                        // If slot is full: seniority already handled by processing order ‚Äî
                        // we simply skip this bid and try the next bid (choice 2) below
                    }

                    // ‚îÄ‚îÄ PHASE 2: If employee still needs slots, try remaining bid choices ‚îÄ‚îÄ
                    // (e.g. choice 1 was full ‚Üí try choice 2 as first assigned slot)
                    // Already handled above in the bid loop ‚Äî we try all submitted bids in order.

                    // ‚îÄ‚îÄ PHASE 3: Auto-assign if employee still has fewer than 2 slots ‚îÄ‚îÄ
                    while (assignedSlots.length < 2) {
                        let slotAssigned = false;

                        // Priority: prefer slot types that fit the entitlement perfectly
                        const slotPriority = entitlement === 35 ? ['C', 'A', 'B'] : ['A', 'B', 'C'];

                        // First try employee's own department, then fall back to any dept with capacity
                        const deptSearchOrder = [department, ...Object.keys(slotAvailability).flatMap(m => Object.keys(slotAvailability[m] || {})).filter(d => d !== department)];
                        const uniqueDepts = [...new Set(deptSearchOrder)];

                        for (const searchMonth of this.state.months) {
                            if (slotAssigned) break;
                            for (const searchDept of uniqueDepts) {
                                if (slotAssigned) break;
                                if (!slotAvailability[searchMonth]?.[searchDept]) continue;

                                for (const slotType of slotPriority) {
                                    if (slotAvailability[searchMonth][searchDept][slotType] > 0) {
                                        const potential = assignSlotToEmployee(employee, searchMonth, slotType, assignedSlots.length + 1);

                                        if (assignedDays + potential.days <= entitlement) {
                                            // For 35-day employees ensure the combo adds up correctly
                                            if (entitlement === 35) {
                                                const remaining = entitlement - (assignedDays + potential.days);
                                                if (remaining === 15 || remaining === 20 || remaining === 0) {
                                                    potential.type = 'Auto-Assigned';
                                                    potential.bidChoice = null;
                                                    assignedSlots.push(potential);
                                                    assignedDays += potential.days;
                                                    slotAvailability[searchMonth][searchDept][slotType]--;
                                                    slotAssigned = true;
                                                    break;
                                                }
                                            } else {
                                                potential.type = 'Auto-Assigned';
                                                potential.bidChoice = null;
                                                assignedSlots.push(potential);
                                                assignedDays += potential.days;
                                                slotAvailability[searchMonth][searchDept][slotType]--;
                                                slotAssigned = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // Last resort: force-assign with no capacity check
                        if (!slotAssigned) {
                            const fallbackMonth    = this.state.months[assignedSlots.length % 12];
                            const fallbackSlotType = entitlement === 35
                                ? (assignedDays === 0 ? 'C' : 'A')
                                : (assignedSlots.length % 3 === 0 ? 'A' : assignedSlots.length % 3 === 1 ? 'B' : 'C');

                            const fallback = assignSlotToEmployee(employee, fallbackMonth, fallbackSlotType, assignedSlots.length + 1);
                            fallback.type      = 'Auto-Assigned';
                            fallback.bidChoice = null;
                            assignedSlots.push(fallback);
                            assignedDays += fallback.days;

                            if (!slotAvailability[fallbackMonth]) slotAvailability[fallbackMonth] = {};
                            if (!slotAvailability[fallbackMonth][department]) slotAvailability[fallbackMonth][department] = { A: 0, B: 0, C: 0 };
                        }
                    }

                // Add all assignments to results
                    assignedSlots.forEach((assignment, slotIndex) => {
                        const deptInfo = deptRankMap[employee.id] || {};
                        slotAssignments.push({
                            ...assignment,
                            seniorityRank: deptInfo.deptRank || (index + 1),
                            deptSeniorityRank: deptInfo.deptRank || (index + 1),
                            totalEmployeeSlots: 2,
                            slotOrder: slotIndex + 1,
                            entitlement
                        });
                    });
                });
                
                // Save results
                this.state.results = slotAssignments;
                this.state.isProcessed = true;
                this.saveConfigToSupabase();
                this.writeAuditLog('BIDS_PROCESSED', { total_employees: sortedEmployees.length, total_slots: slotAssignments.length, year: this.state.biddingYear });
                
                // Calculate statistics
                const totalSlots = slotAssignments.length;
                const totalEmployees = sortedEmployees.length;
                const bidAwarded = slotAssignments.filter(r => r.type === 'Bid Awarded').length;
                const autoAssigned = slotAssignments.filter(r => r.type === 'Auto-Assigned').length;
                const seniorEmployees = sortedEmployees.filter(e => getEmployeeEntitlement(e) === 35).length;
                const juniorEmployees = totalEmployees - seniorEmployees;
                
                const message = `‚úÖ Successfully processed ${totalEmployees} employees!\n\n` +
                               `‚Ä¢ Seniority: Per-department (each dept processed independently)\n` +
                               `‚Ä¢ Total slots assigned: ${totalSlots} (${totalEmployees} √ó 2)\n` +
                               `‚Ä¢ Senior employees (35 days): ${seniorEmployees}\n` +
                               `‚Ä¢ Junior employees (30 days): ${juniorEmployees}\n` +
                               `‚Ä¢ Bid Awards: ${bidAwarded} slots\n` +
                               `‚Ä¢ Auto-Assigned: ${autoAssigned} slots\n` +
                               `‚Ä¢ Each employee received exactly 2 slots\n` +
                               `‚Ä¢ Total leave days allocated: ${slotAssignments.reduce((sum, r) => sum + r.days, 0)}`;
                
                alert(message);
                
                this.renderAdminView();
            },
            exportResults() {
                if (this.state.results.length === 0) {
                    alert('No results to export');
                    return;
                }
                
                // Create Excel workbook
                const wsData = [
                    ['Seniority Rank', 'Employee ID', 'Employee Name', 'Position', 'Scheduling Row (Department)', 'Slot Type', 
                     'Month', 'Start Date', 'End Date', 'Days', 'Assignment Type']
                ];
                
                this.state.results.forEach(result => {
                    const emp = this.state.employees.find(e => e.id === result.employeeId);
                    wsData.push([
                        result.seniorityRank,
                        result.employeeId,
                        result.employeeName,
                        emp?.position || result.position || '',
                        result.department,
                        result.slotName,
                        result.month,
                        result.startDate,
                        result.endDate,
                        result.days,
                        result.type
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Leave Assignments');
                XLSX.writeFile(wb, `Leave_Assignments_${this.state.biddingYear}.xlsx`);
                
                alert('‚úÖ Results exported to Excel file!');
            },

            resetSystem() {
                if (confirm('‚ö†Ô∏è WARNING: This will reset ALL data including employees, bids, and results. Continue?')) {
                    this.writeAuditLog('SYSTEM_RESET', { employees: this.state.employees.length, bids: this.state.bids.length });
                    localStorage.clear();
                    this.state.employees = [];
                    this.state.bids = [];
                    this.state.results = [];
                    this.state.isProcessed = false;
                    this.state.slotCapacities = {};
                    this.state.onCallDates = {};
                    this.state.currentUser = null;
                    this.state.userType = null;
                    this.state.activeView = 'login';
                    this.saveConfigToSupabase(); // push reset state to Supabase
                    
                    // Reset UI
                    document.getElementById('userInfo').classList.add('hidden');
                    document.getElementById('plannerNav').classList.add('hidden');
                    document.getElementById('employeeNav').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                    
                    this.updateSystemStatus('System reset');
                    this.renderLoginForm();
                    
                    alert('‚úÖ System has been completely reset!');
                }
            },

            // ==================== BIDDING FUNCTIONS ====================
            setSelectedSlot(slotId) {
                window.selectedSlot = slotId;
                this.updateSlotText();
                
                // Update button styles
                const buttons = document.querySelectorAll('.slot-btn');
                buttons.forEach(btn => {
                    if (btn.dataset.slot === slotId) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-blue-500 text-white';
                    } else if (btn.dataset.hasbid === 'true' || this.state.isProcessed) {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-200 text-gray-500 cursor-not-allowed';
                    } else {
                        btn.className = 'slot-btn w-full p-3 rounded-lg font-semibold text-left transition-all bg-gray-100 hover:bg-gray-200 text-gray-800';
                    }
                });
                
                // Clear date inputs
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (startDate) startDate.value = '';
                if (endDate) endDate.value = '';
                if (dateInfo) dateInfo.classList.add('hidden');
            },

            updateSlotText() {
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (slot) {
                    const slotText = document.getElementById('selectedSlotText');
                    const slotDays = document.getElementById('selectedSlotDays');
                    if (slotText) slotText.textContent = slot.name;
                    if (slotDays) slotDays.textContent = slot.days;
                }
            },

            updateMonthText() {
                const monthSelect = document.getElementById('selectedMonth');
                if (monthSelect) {
                    const monthText = document.getElementById('selectedMonthText');
                    if (monthText) monthText.textContent = monthSelect.value + ' ' + this.state.biddingYear;
                }
            },

            updateEndDate() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const dateInfo = document.getElementById('dateInfo');
                
                if (!startDateInput || !startDateInput.value || !window.selectedSlot) {
                    if (endDateInput) endDateInput.value = '';
                    if (dateInfo) dateInfo.classList.add('hidden');
                    return;
                }
                
                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                if (!slot) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + slot.days - 1);
                
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDateInput.value, endDateInput.value);
                
                if (dateInfo) {
                    if (days === slot.days) {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-green-800">
                                Selected: ${days} days ‚úì
                            </p>
                            <p class="text-sm mt-1 text-green-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-green-50 border border-green-200';
                    } else {
                        dateInfo.innerHTML = `
                            <p class="font-semibold text-red-800">
                                Selected: ${days} days (Required: ${slot.days} days)
                            </p>
                            <p class="text-sm mt-1 text-red-700">
                                ${startDateInput.value} to ${endDateInput.value}
                            </p>
                        `;
                        dateInfo.className = 'p-3 rounded mb-4 bg-red-50 border border-red-200';
                    }
                    dateInfo.classList.remove('hidden');
                }
            },

            checkDateOverlap(startDate1, endDate1, startDate2, endDate2) {
                const start1 = new Date(startDate1);
                const end1 = new Date(endDate1);
                const start2 = new Date(startDate2);
                const end2 = new Date(endDate2);
                
                return (start1 <= end2 && end1 >= start2);
            },

            submitBid() {
                if (!this.state.verifiedEmployee) {
                    alert('Please login first');
                    return;
                }

                if (this.state.isProcessed) {
                    alert('Bidding has been processed. No more bids allowed.');
                    return;
                }

                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                const monthSelect = document.getElementById('selectedMonth');
                const month = monthSelect ? monthSelect.value : this.state.months[0];

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }

                const slot = this.state.slotTypes.find(s => s.id === window.selectedSlot);
                
                const calculateDaysBetween = (start, end) => {
                    const startD = new Date(start);
                    const endD = new Date(end);
                    const diffTime = Math.abs(endD - startD);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                };
                
                const days = calculateDaysBetween(startDate, endDate);

                if (days !== slot.days) {
                    alert(`${slot.name} requires exactly ${slot.days} days. Your selection is ${days} days.`);
                    return;
                }

                const start = new Date(startDate);
                const yearStart = new Date(this.state.biddingYear, 0, 1);
                const yearEnd = new Date(this.state.biddingYear, 11, 31);

                if (start < yearStart || start > yearEnd) {
                    alert(`Start date must be within ${this.state.biddingYear}`);
                    return;
                }

                const existingBid = this.state.bids.find(
                    bid => bid.employeeId === this.state.verifiedEmployee.id && bid.slotType === window.selectedSlot
                );
                
                if (existingBid) {
                    alert(`You have already bid for ${slot.name}. You cannot bid for the same slot twice.`);
                    return;
                }

                const userBids = this.state.bids.filter(bid => bid.employeeId === this.state.verifiedEmployee.id);
                
                // Calculate entitlement
                const calculateYearsOfService = (seniorityDate) => {
                    const today = new Date();
                    const joinDate = new Date(seniorityDate);
                    const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
                    return years;
                };
                
                const getEmployeeEntitlement = (employee) => {
                    if (!employee || !employee.seniorityDate) return 30;
                    const yearsOfService = calculateYearsOfService(employee.seniorityDate);
                    return yearsOfService >= 5 ? 35 : 30;
                };
                
                const entitlement = getEmployeeEntitlement(this.state.verifiedEmployee);
                
                if (userBids.length >= 2) {
                    alert('You can only place 2 bids maximum.');
                    return;
                }

                const totalBidDays = userBids.reduce((sum, bid) => sum + bid.days, 0);
                if (totalBidDays + days > entitlement) {
                    alert(`Your total leave days would exceed your entitlement of ${entitlement} days.\n\nCurrent bids: ${totalBidDays} days\nThis bid: ${days} days\nTotal: ${totalBidDays + days} days`);
                    return;
                }

                // Check for date overlaps
                for (const bid of userBids) {
                    if (this.checkDateOverlap(startDate, endDate, bid.startDate, bid.endDate)) {
                        const existingSlot = this.state.slotTypes.find(s => s.id === bid.slotType);
                        alert(`Date overlap detected with your existing ${existingSlot?.name || 'slot'} bid (${bid.startDate} to ${bid.endDate})`);
                        return;
                    }
                }

                const newBid = {
                    employeeId: this.state.verifiedEmployee.id,
                    employeeName: this.state.verifiedEmployee.name,
                    seniorityDate: this.state.verifiedEmployee.seniorityDate,
                    position: this.state.verifiedEmployee.position || '',
                    department: this.state.verifiedEmployee.department,
                    slotType: window.selectedSlot,
                    startDate,
                    endDate,
                    days,
                    timestamp: new Date().toISOString()
                };

                this.state.bids.push(newBid);
                this.saveState();
                this.writeAuditLog('BID_PLACED', { slot: window.selectedSlot, start: startDate, end: endDate, days, department: newBid.department });

                // Save bid immediately to Supabase so it survives refresh
                this.saveBidToSupabase(newBid).then(saved => {
                    if (saved) {
                        console.log('‚úÖ Bid saved to Supabase');
                    } else {
                        console.warn('‚ö†Ô∏è Bid saved locally only ‚Äî Supabase unavailable');
                        // Show warning so user knows the bid may not be visible to the planner
                        alert('‚ö†Ô∏è Your bid was recorded locally but could NOT be saved to the database.\n\nPlease check your internet connection and try submitting again, or contact the planner.');
                    }
                });

                alert(`‚úì Bid placed successfully for ${slot.name} (${days} days)!`);
                
                // Refresh view
                this.renderEmployeeBiddingView();
            },

            async saveBidToSupabase(bid) {
                if (!this.supabase) {
                    console.warn('‚ö†Ô∏è Supabase not initialised ‚Äî bid saved locally only');
                    return false;
                }
                try {
                    const row = {
                        tenant_id: this._tid(),
                        employee_id: bid.employeeId,
                        start_date: bid.startDate,
                        end_date: bid.endDate,
                        days_requested: bid.days,
                        status: 'pending',
                        slot_type: bid.slotType,
                        department: bid.department || '',
                        employee_name: bid.employeeName || '',
                        created_at: bid.timestamp || new Date().toISOString()
                    };

                    // Step 1: Delete any existing row for this employee+slot combo to avoid duplicates
                    const { error: delError } = await this.supabase
                        .from('leave_requests')
                        .delete()
                        .eq('employee_id', bid.employeeId)
                        .eq('slot_type', bid.slotType);

                    if (delError) {
                        console.warn('‚ö†Ô∏è Pre-delete warning (non-fatal):', delError.message);
                    }

                    // Step 2: Insert the new bid row fresh
                    const { data, error: insertError } = await this.supabase
                        .from('leave_requests')
                        .insert(row)
                        .select();

                    if (insertError) {
                        console.error('‚ùå Supabase bid insert error:', insertError.message, insertError);
                        return false;
                    }

                    console.log('‚úÖ Bid saved to Supabase:', data);
                    return true;
                } catch (e) {
                    console.error('‚ùå Supabase bid save exception:', e.message);
                    return false;
                }
            },

            removeBid(employeeId, slotType, startDate) {
                if (this.state.isProcessed) {
                    alert('Cannot remove bids after processing');
                    return;
                }
                
                if (confirm('Are you sure you want to remove this bid?')) {
                    this.state.bids = this.state.bids.filter(bid => 
                        !(bid.employeeId === employeeId && 
                          bid.slotType === slotType && 
                          bid.startDate === startDate)
                    );
                    this.saveState();
                    this.writeAuditLog('BID_REMOVED', { employee_id: employeeId, slot_type: slotType, start_date: startDate });

                    // Delete from Supabase immediately
                    if (this.supabase) {
                        this.supabase
                            .from('leave_requests')
                            .delete()
                            .eq('employee_id', employeeId)
                            .eq('slot_type', slotType)
                            .eq('start_date', startDate)
                            .then(({ error }) => {
                                if (error) console.warn('‚ö†Ô∏è Could not delete bid from Supabase:', error.message);
                                else console.log('‚úÖ Bid deleted from Supabase');
                            });
                    }

                    this.renderEmployeeBiddingView();
                }
            },
               
            loadAvailableSlots() {
                const slotsContainer = document.getElementById('slotsContainer');
                if (!slotsContainer) return;

                slotsContainer.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Loading available slots...</p>';

                setTimeout(() => {
                    const employee = this.state.verifiedEmployee;
                    const dept = employee?.department || '';
                    const months = this.state.months;
                    const caps = this.state.slotCapacities;

                    // Parse all real configured slots from slotCapacities
                    // Key format: cal-{dept}-{month}-{slotId}-{field}
                    const slotMap = {}; // key: "dept||month||slotLetter" ‚Üí { start, end, capacity, dept, month, slotLetter }

                    Object.keys(caps).forEach(key => {
                        if (!key.startsWith('cal-')) return;
                        const withoutPrefix = key.slice(4);
                        const lastDash = withoutPrefix.lastIndexOf('-');
                        const field = withoutPrefix.slice(lastDash + 1);
                        const withoutField = withoutPrefix.slice(0, lastDash);
                        const slotIdDash = withoutField.lastIndexOf('-');
                        const slotId = withoutField.slice(slotIdDash + 1);
                        const withoutSlot = withoutField.slice(0, slotIdDash);
                        const monthDash = withoutSlot.lastIndexOf('-');
                        const month = withoutSlot.slice(monthDash + 1);
                        const deptKey = withoutSlot.slice(0, monthDash);

                        if (!months.includes(month)) return;
                        const slotLetter = slotId === 'SA' ? 'A' : slotId === 'SB' ? 'B' : slotId === 'SC' ? 'C' : null;
                        if (!slotLetter) return;

                        const mapKey = `${deptKey}||${month}||${slotLetter}`;
                        if (!slotMap[mapKey]) slotMap[mapKey] = { dept: deptKey, month, slotLetter, start: '', end: '', capacity: 0 };

                        if (field === 'start') slotMap[mapKey].start = caps[key];
                        if (field === 'end') slotMap[mapKey].end = caps[key];
                        if (field === 'capacity') slotMap[mapKey].capacity = parseInt(caps[key]) || 0;
                    });

                    // Convert to array and filter: only slots with dates + capacity > 0
                    let allSlots = Object.values(slotMap).filter(s => s.start && s.end && s.capacity > 0);

                    if (allSlots.length === 0) {
                        slotsContainer.innerHTML = `
                            <div class="text-center py-10 text-gray-400">
                                <p class="text-4xl mb-3">üì≠</p>
                                <p class="font-semibold text-gray-600">No slots configured yet</p>
                                <p class="text-sm mt-1">The planner needs to configure slots with dates and capacity in <strong>Configure Slots</strong> first.</p>
                            </div>`;
                        return;
                    }

                    // Sort slots: employee's own department first, then by month order
                    allSlots.sort((a, b) => {
                        const aIsMyDept = a.dept === dept ? 0 : 1;
                        const bIsMyDept = b.dept === dept ? 0 : 1;
                        if (aIsMyDept !== bIsMyDept) return aIsMyDept - bIsMyDept;
                        return months.indexOf(a.month) - months.indexOf(b.month);
                    });

                    // Count how many bids have already been placed per slot (dept+month+slot)
                    const bidCounts = {};
                    this.state.bids.forEach(bid => {
                        const bDept = bid.department || '';
                        const bMonth = bid.startDate ? months[new Date(bid.startDate).getMonth()] : '';
                        const bSlotLetter = bid.slotType === 'slotA' ? 'A' : bid.slotType === 'slotB' ? 'B' : bid.slotType === 'slotC' ? 'C' : '';
                        if (bDept && bMonth && bSlotLetter) {
                            const k = `${bDept}||${bMonth}||${bSlotLetter}`;
                            bidCounts[k] = (bidCounts[k] || 0) + 1;
                        }
                    });

                    const colorMap = { A: { bg: 'bg-green-50', border: 'border-green-300', badge: 'bg-green-100 text-green-800', label: 'Slot A' }, B: { bg: 'bg-blue-50', border: 'border-blue-300', badge: 'bg-blue-100 text-blue-800', label: 'Slot B' }, C: { bg: 'bg-purple-50', border: 'border-purple-300', badge: 'bg-purple-100 text-purple-800', label: 'Slot C' } };

                    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    allSlots.forEach(slot => {
                        const isMyDept = slot.dept === dept;
                        const mapKey = `${slot.dept}||${slot.month}||${slot.slotLetter}`;
                        const taken = bidCounts[mapKey] || 0;
                        const remaining = Math.max(0, slot.capacity - taken);
                        const isFull = remaining === 0;
                        const c = colorMap[slot.slotLetter] || colorMap['A'];
                        const slotTypeDef = this.state.slotTypes.find(s => s.id === `slot${slot.slotLetter}`);
                        const days = slotTypeDef ? slotTypeDef.days : '?';

                        html += `
                            <div class="border-2 ${isFull ? 'border-gray-200 bg-gray-50 opacity-60' : (isMyDept ? 'border-yellow-400 ' + c.bg : c.border + ' ' + c.bg)} rounded-lg p-4 transition hover:shadow-md">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="flex items-center gap-2 flex-wrap mb-1">
                                            <span class="px-2 py-0.5 rounded text-xs font-bold ${c.badge}">${c.label}</span>
                                            ${isMyDept ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">‚≠ê Your Dept</span>' : ''}
                                            ${isFull ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700">Full</span>' : ''}
                                        </div>
                                        <p class="font-semibold text-gray-800 text-sm">${slot.dept}</p>
                                        <p class="text-xs text-gray-500">${slot.month} ${this.state.biddingYear}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-gray-800">${days} <span class="text-xs font-normal text-gray-500">days</span></p>
                                        <p class="text-xs ${isFull ? 'text-red-600' : 'text-green-600'} font-semibold">${remaining}/${slot.capacity} spots left</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mb-3 font-mono">${slot.start} ‚Üí ${slot.end}</p>
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center gap-2 cursor-pointer ${isFull ? 'opacity-40 cursor-not-allowed' : ''}">
                                        <input type="checkbox" class="slot-checkbox w-4 h-4" value="${mapKey}" ${isFull ? 'disabled' : ''}>
                                        <span class="text-sm text-gray-700">Select to bid</span>
                                    </label>
                                    <span class="text-xs text-gray-400">${slot.start}</span>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                    slotsContainer.innerHTML = html;
                }, 300);
            },

            previewSlot(slotId) {
                alert(`Previewing slot #${slotId}. In a real application, this would show detailed information about the selected slot.`);
            },

            renderMyResultsView() {
                const content = document.getElementById('contentArea');
                const user = this.state.verifiedEmployee;
                const myResults = this.state.results.filter(r => r.employeeId === user?.id)
                    .sort((a, b) => (a.slotOrder || 0) - (b.slotOrder || 0));

                const totalDays = myResults.reduce((sum, r) => sum + (r.days || 0), 0);
                const entitlement = myResults[0]?.entitlement || (user ? (this.state.results.find(r => r.employeeId === user.id)?.entitlement) : 0) || '‚Äî';
                const rank = myResults[0]?.seniorityRank || '‚Äî';
                const yos = myResults[0]?.yearsOfService || '‚Äî';
                const allAwarded = myResults.length > 0 && myResults.every(r => r.type === 'Bid Awarded');
                const anyAwarded = myResults.some(r => r.type === 'Bid Awarded');

                // Format date nicely
                const fmtDate = (d) => {
                    if (!d) return '‚Äî';
                    try { return new Date(d).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }); }
                    catch(e) { return d; }
                };

                // Slot color config
                const slotColors = {
                    'Bid Awarded': { bg: 'bg-green-50', border: 'border-green-300', badge: 'bg-green-100 text-green-800', icon: '‚úÖ', label: 'Bid Awarded' },
                    'Auto-Assigned': { bg: 'bg-blue-50', border: 'border-blue-300', badge: 'bg-blue-100 text-blue-800', icon: 'üìã', label: 'Auto-Assigned' }
                };

                content.innerHTML = `
                    <div class="max-w-3xl mx-auto">

                        <!-- Page Header -->
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">üìã My Leave Results ‚Äî ${this.state.biddingYear}</h2>
                            <p class="text-gray-500 text-sm mt-1">Your annual leave assignments for ${this.state.biddingYear}</p>
                        </div>

                        ${!this.state.isProcessed ? `
                            <!-- Not processed yet -->
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8 text-center">
                                <div class="text-5xl mb-4">‚è≥</div>
                                <h3 class="text-xl font-bold text-yellow-800 mb-2">Results Not Yet Available</h3>
                                <p class="text-yellow-700 text-sm">The planner has not processed the bids yet. Please check back later.</p>
                            </div>
                        ` : myResults.length === 0 ? `
                            <!-- Processed but no results for this user -->
                            <div class="bg-orange-50 border-2 border-orange-200 rounded-xl p-8 text-center">
                                <div class="text-5xl mb-4">üîç</div>
                                <h3 class="text-xl font-bold text-orange-800 mb-2">No Assignment Found</h3>
                                <p class="text-orange-700 text-sm">Bids have been processed but no assignment was found for your ID. Please contact the planner.</p>
                            </div>
                        ` : `

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                <div class="bg-white rounded-xl shadow p-4 text-center border-t-4 border-blue-400">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Dept. Seniority Rank</p>
                                    <p class="text-2xl font-bold text-blue-600">#${rank}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow p-4 text-center border-t-4 border-purple-400">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Years of Service</p>
                                    <p class="text-2xl font-bold text-purple-600">${yos}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow p-4 text-center border-t-4 border-green-400">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Days</p>
                                    <p class="text-2xl font-bold text-green-600">${totalDays}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow p-4 text-center border-t-4 border-yellow-400">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Entitlement</p>
                                    <p class="text-2xl font-bold text-yellow-600">${entitlement} days</p>
                                </div>
                            </div>

                            <!-- Overall Status Banner -->
                            <div class="mb-6 rounded-xl p-4 text-center font-semibold text-sm
                                ${allAwarded ? 'bg-green-100 border border-green-300 text-green-800' :
                                  anyAwarded ? 'bg-yellow-100 border border-yellow-300 text-yellow-800' :
                                  'bg-blue-100 border border-blue-300 text-blue-800'}">
                                ${allAwarded ? 'üéâ All your bids were awarded!' :
                                  anyAwarded ? '‚ö° Partial bid award ‚Äî one slot bid awarded, one auto-assigned.' :
                                  'üìã Both slots were auto-assigned by the system.'}
                            </div>

                            <!-- Slot Cards -->
                            <div class="space-y-4 mb-6">
                                ${myResults.map((result, i) => {
                                    const colors = slotColors[result.type] || slotColors['Auto-Assigned'];
                                    return `
                                    <div class="bg-white rounded-xl shadow-md border-l-4 ${result.type === 'Bid Awarded' ? 'border-green-400' : 'border-blue-400'} overflow-hidden">
                                        <div class="p-5">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg font-bold text-gray-700">Slot ${result.slotOrder || i + 1}</span>
                                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${result.type === 'Bid Awarded' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                        ${colors.icon} ${colors.label}
                                                    </span>
                                                </div>
                                                <span class="text-2xl font-bold text-gray-800">${result.days} <span class="text-sm font-normal text-gray-500">days</span></span>
                                            </div>

                                            <h3 class="text-xl font-bold text-gray-800 mb-3">${result.slotName || '‚Äî'}</h3>

                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="bg-gray-50 rounded-lg p-3">
                                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Start Date</p>
                                                    <p class="font-semibold text-gray-800">${fmtDate(result.startDate)}</p>
                                                </div>
                                                <div class="bg-gray-50 rounded-lg p-3">
                                                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">End Date</p>
                                                    <p class="font-semibold text-gray-800">${fmtDate(result.endDate)}</p>
                                                </div>
                                            </div>

                                            ${result.type === 'Bid Awarded' ? `
                                                <p class="text-xs text-green-600 mt-3 font-medium">‚úì This slot matched your bid preference (choice ${result.bidChoice || i + 1})</p>
                                            ` : `
                                                <p class="text-xs text-blue-600 mt-3 font-medium">‚Ñπ This slot was automatically assigned based on availability</p>
                                            `}
                                        </div>

                                        <!-- Calendar mini-bar -->
                                        <div class="bg-gray-50 border-t px-5 py-3 flex items-center gap-2 text-xs text-gray-500">
                                            <span>üìÖ</span>
                                            <span>${fmtDate(result.startDate)} ‚Üí ${fmtDate(result.endDate)}</span>
                                            <span class="ml-auto font-semibold text-gray-700">${result.days} calendar days</span>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Note -->
                            <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm text-gray-600">
                                <p class="font-semibold text-gray-700 mb-1">üìå Important Notes</p>
                                <ul class="list-disc list-inside space-y-1 text-xs">
                                    <li>Leave assignments are final once processed by the planner.</li>
                                    <li>If you have questions about your assignment, contact your planner directly.</li>
                                    <li>Total allocated: <strong>${totalDays} days</strong> out of your <strong>${entitlement}-day</strong> entitlement.</li>
                                </ul>
                            </div>
                        `}
                    </div>
                `;
            },

            renderResultsView() {
                const content = document.getElementById('contentArea');
                
                // Group results by employee
                const employeeResults = {};
                this.state.results.forEach(result => {
                    if (!employeeResults[result.employeeId]) {
                        employeeResults[result.employeeId] = [];
                    }
                    employeeResults[result.employeeId].push(result);
                });
                
                content.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-6">Leave Assignments for ${this.state.biddingYear}</h2>
                            <p class="text-gray-600 mb-6">
                                Each employee receives exactly 2 slots. Senior employees (5+ years) get 35 days total,
                                others get 30 days total.
                            </p>
                            
                            ${this.state.results.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600">No results yet. Process bids first.</p>
                                    <button onclick="app.setActiveView('admin')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                        Go to Admin Panel
                                    </button>
                                </div>
                            ` : `
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3 text-left">Dept. Rank</th>
                                                <th class="p-3 text-left">Employee</th>
                                                <th class="p-3 text-left">Department</th>
                                                <th class="p-3 text-left">Seniority</th>
                                                <th class="p-3 text-left">Slot 1</th>
                                                <th class="p-3 text-left">Slot 2</th>
                                                <th class="p-3 text-left">Total Days</th>
                                                <th class="p-3 text-left">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(employeeResults).map(([empId, slots]) => {
                                                const employee = this.state.employees.find(e => e.id === empId);
                                                const slot1 = slots.find(s => s.slotOrder === 1);
                                                const slot2 = slots.find(s => s.slotOrder === 2);
                                                const totalDays = slots.reduce((sum, s) => sum + s.days, 0);
                                                const allAwarded = slots.every(s => s.type === 'Bid Awarded');
                                                const anyAwarded = slots.some(s => s.type === 'Bid Awarded');
                                                
                                                return `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-3 font-mono text-sm">#${slot1?.deptSeniorityRank || slot1?.seniorityRank || 'N/A'}</td>
                                                        <td class="p-3">${employee?.name || 'Unknown'}<br>
                                                            <span class="text-xs text-gray-500">${empId}</span>
                                                        </td>
                                                        <td class="p-3 text-xs">${slot1?.department || employee?.department || '‚Äî'}</td>
                                                        <td class="p-3">${slot1?.yearsOfService || 'N/A'} yrs</td>
                                                        <td class="p-3">
                                                            ${slot1?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot1?.startDate || ''} to ${slot1?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot1?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot1?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3">
                                                            ${slot2?.slotName || 'N/A'}<br>
                                                            <span class="text-xs text-gray-500">${slot2?.startDate || ''} to ${slot2?.endDate || ''}</span><br>
                                                            <span class="text-xs ${slot2?.type === 'Bid Awarded' ? 'text-green-600' : 'text-blue-600'}">
                                                                ${slot2?.type || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="p-3 font-bold">${totalDays} days</td>
                                                        <td class="p-3">
                                                            <span class="px-2 py-1 rounded text-xs ${
                                                                allAwarded ? 'bg-green-100 text-green-800' : 
                                                                anyAwarded ? 'bg-yellow-100 text-yellow-800' : 
                                                                'bg-blue-100 text-blue-800'
                                                            }">
                                                                ${allAwarded ? 'All Bids Awarded' : 
                                                                  anyAwarded ? 'Partial Award' : 
                                                                  'Auto-Assigned'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            renderChangePasswordView() {
                const content = document.getElementById('contentArea');
                const backView = this.state.userType === 'goldencommand' ? 'goldenCommand' : this.state.userType === 'corporatestaff' ? 'corporateStaff' : 'employee';
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-2">üîë Change Password</h2>
                            <p class="text-gray-500 text-sm mb-6">Update your login password below.</p>
                            <div id="cpMsg"></div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Current Password:</label>
                                    <input type="password" id="cpCurrent" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter current password" />
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" id="cpNew" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter new password (min 4 chars)" />
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm New Password:</label>
                                    <input type="password" id="cpConfirm" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Repeat new password" />
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.doChangePassword()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                                    üíæ Save Password
                                </button>
                                <button onclick="app.setActiveView('${backView}')" class="flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            async doChangePassword() {
                const current = document.getElementById('cpCurrent').value;
                const newPass = document.getElementById('cpNew').value;
                const confirm = document.getElementById('cpConfirm').value;
                const msg = document.getElementById('cpMsg');

                const showMsg = (text, color) => {
                    msg.innerHTML = `<div class="mb-4 p-3 rounded-lg border ${color}">${text}</div>`;
                };

                const user = this.state.currentUser;
                const userId = user.id;
                const userType = this.state.userType;

                // Verify current password
                let storedPass;
                if (userType === 'goldencommand') {
                    const gcUser = (this.state.goldenCommandUsers || []).find(u => u.id === userId);
                    storedPass = gcUser ? (gcUser.password || gcUser.id) : userId;
                } else if (userType === 'corporatestaff') {
                    const csUser = (this.state.corporateStaffUsers || []).find(u => u.id === userId);
                    storedPass = csUser ? (csUser.password || csUser.id) : userId;
                } else {
                    storedPass = this.state.employeePasswords[userId] || userId;
                }

                if (current !== storedPass) {
                    showMsg('‚ùå Current password is incorrect.', 'bg-red-50 border-red-300 text-red-700');
                    return;
                }
                if (newPass.length < 4) {
                    showMsg('‚ö†Ô∏è New password must be at least 4 characters.', 'bg-yellow-50 border-yellow-300 text-yellow-700');
                    return;
                }
                if (newPass !== confirm) {
                    showMsg('‚ùå New passwords do not match.', 'bg-red-50 border-red-300 text-red-700');
                    return;
                }

                try {
                    if (userType === 'goldencommand') {
                        // Update in Supabase golden_command_users table
                        if (this.supabase) {
                            const { error } = await this.supabase
                                .from('golden_command_users')
                                .update({ password: newPass })
                                .eq('id', userId);
                            if (error) throw error;
                        }
                        // Update local state
                        const gcUser = (this.state.goldenCommandUsers || []).find(u => u.id === userId);
                        if (gcUser) gcUser.password = newPass;
                    } else if (userType === 'corporatestaff') {
                        // Update in Supabase corporate_staff_users table
                        if (this.supabase) {
                            const { error } = await this.supabase
                                .from('corporate_staff_users')
                                .update({ password: newPass })
                                .eq('id', userId);
                            if (error) throw error;
                        }
                        // Update local state
                        const csUser = (this.state.corporateStaffUsers || []).find(u => u.id === userId);
                        if (csUser) csUser.password = newPass;
                    } else {
                        // Employee: update local state + employeePasswords
                        this.state.employeePasswords[userId] = newPass;
                        // Also update the employees table password column if it exists
                        if (this.supabase) {
                            const { error } = await this.supabase
                                .from('employees')
                                .update({ password: newPass })
                                .eq('id', userId);
                            // ignore error if column doesn't exist
                        }
                    }

                    this.saveState();
                    showMsg('‚úÖ Password changed successfully!', 'bg-green-50 border-green-300 text-green-700');
                    this.writeAuditLog('PASSWORD_CHANGED', { user_type: userType });
                    // Clear fields
                    document.getElementById('cpCurrent').value = '';
                    document.getElementById('cpNew').value = '';
                    document.getElementById('cpConfirm').value = '';
                } catch (err) {
                    console.error('Password change error:', err);
                    showMsg('‚ùå Failed to save password. Changes saved locally.', 'bg-red-50 border-red-300 text-red-700');
                    // Still update locally
                    if (userType === 'goldencommand') {
                        const gcUser = (this.state.goldenCommandUsers || []).find(u => u.id === userId);
                        if (gcUser) gcUser.password = newPass;
                    } else if (userType === 'corporatestaff') {
                        const csUser = (this.state.corporateStaffUsers || []).find(u => u.id === userId);
                        if (csUser) csUser.password = newPass;
                    } else {
                        this.state.employeePasswords[userId] = newPass;
                    }
                    this.saveState();
                }
            },

            // ==================== PLANNER DASHBOARD ====================
            renderDashboardView() {
                const content = document.getElementById('contentArea');
                const total = this.state.employees.length;
                const biddedIds = new Set(this.state.bids.map(b => b.employeeId));
                const bidded = biddedIds.size;
                const notBidded = total - bidded;
                const pct = total > 0 ? Math.round((bidded / total) * 100) : 0;
                const processed = this.state.isProcessed;

                // Deadline countdown
                let deadlineHtml = '<p class="text-gray-400 text-sm">No deadline set</p>';
                if (this.state.biddingDeadline) {
                    const dl = new Date(this.state.biddingDeadline);
                    const diff = dl - new Date();
                    if (diff <= 0) {
                        deadlineHtml = '<p class="text-red-600 font-bold text-lg">‚õî Deadline Passed</p>';
                    } else {
                        const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000);
                        const color = diff < 86400000 ? 'text-red-600' : diff < 259200000 ? 'text-yellow-600' : 'text-green-600';
                        deadlineHtml = `<p class="text-2xl font-bold ${color}" id="dashCountdown">${d}d ${h}h ${m}m</p>
                            <p class="text-xs text-gray-500 mt-1">${dl.toLocaleDateString('en-US',{weekday:'short',day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}</p>`;
                    }
                }

                // Dept breakdown for chart
                const deptBidMap = {};
                this.state.bids.forEach(b => {
                    const emp = this.state.employees.find(e => e.id === b.employeeId);
                    const dept = emp?.department || 'Unknown';
                    deptBidMap[dept] = (deptBidMap[dept] || new Set());
                    deptBidMap[dept].add(b.employeeId);
                });
                const deptTotalMap = {};
                this.state.employees.forEach(e => {
                    const dept = e.department || 'Unknown';
                    deptTotalMap[dept] = (deptTotalMap[dept] || 0) + 1;
                });
                const depts = Object.keys(deptTotalMap).sort();
                const maxEmp = Math.max(...depts.map(d => deptTotalMap[d] || 0), 1);

                // Bid type breakdown (if processed)
                const awardedCount = this.state.results.filter(r => r.type === 'Bid Awarded').length;
                const autoCount = this.state.results.filter(r => r.type === 'Auto-Assigned').length;

                // Staff who haven't bid
                const notBiddedStaff = this.state.employees.filter(e => !biddedIds.has(e.id));

                content.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìä Planner Dashboard ‚Äî ${this.state.biddingYear}</h2>

                        <!-- Top KPI Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white rounded-xl shadow p-5 border-t-4 border-blue-500">
                                <p class="text-3xl font-bold text-blue-600">${total}</p>
                                <p class="text-sm text-gray-500 mt-1">Total Staff</p>
                            </div>
                            <div class="bg-white rounded-xl shadow p-5 border-t-4 border-green-500">
                                <p class="text-3xl font-bold text-green-600">${bidded}</p>
                                <p class="text-sm text-gray-500 mt-1">Staff Bid</p>
                                <div class="mt-2 bg-gray-100 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width:${pct}%"></div></div>
                                <p class="text-xs text-gray-400 mt-1">${pct}% participation</p>
                            </div>
                            <div class="bg-white rounded-xl shadow p-5 border-t-4 border-orange-400">
                                <p class="text-3xl font-bold text-orange-500">${notBidded}</p>
                                <p class="text-sm text-gray-500 mt-1">Not Bid Yet</p>
                            </div>
                            <div class="bg-white rounded-xl shadow p-5 border-t-4 border-purple-500">
                                <p class="text-3xl font-bold ${processed ? 'text-green-600' : 'text-gray-400'}">${processed ? '‚úÖ Done' : '‚è≥ Pending'}</p>
                                <p class="text-sm text-gray-500 mt-1">Processing Status</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Deadline Card -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h3 class="font-bold text-gray-700 mb-3">‚è∞ Bidding Deadline</h3>
                                ${deadlineHtml}
                            </div>

                            <!-- Result Breakdown (if processed) -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h3 class="font-bold text-gray-700 mb-3">üéØ Result Breakdown</h3>
                                ${processed && this.state.results.length > 0 ? `
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-green-700 font-semibold">‚úÖ Bid Awarded</span>
                                                <span>${awardedCount} slots</span>
                                            </div>
                                            <div class="bg-gray-100 rounded-full h-3">
                                                <div class="bg-green-500 h-3 rounded-full" style="width:${Math.round(awardedCount/(awardedCount+autoCount)*100)}%"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-blue-700 font-semibold">üìã Auto-Assigned</span>
                                                <span>${autoCount} slots</span>
                                            </div>
                                            <div class="bg-gray-100 rounded-full h-3">
                                                <div class="bg-blue-400 h-3 rounded-full" style="width:${Math.round(autoCount/(awardedCount+autoCount)*100)}%"></div>
                                            </div>
                                        </div>
                                        <button onclick="app.setActiveView('manualOverride')" class="mt-2 w-full px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold hover:bg-orange-600">
                                            ‚úèÔ∏è Manual Override
                                        </button>
                                    </div>
                                ` : `<p class="text-gray-400 text-sm">${processed ? 'No results yet.' : 'Process bids to see breakdown.'}</p>
                                    <button onclick="app.setActiveView('admin')" class="mt-3 w-full px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600">üöÄ Go to Admin Panel</button>`}
                            </div>
                        </div>

                        <!-- Department Participation Chart -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="font-bold text-gray-700">üè¢ Department Participation</h3>
                                <div class="flex items-center gap-3 text-xs text-gray-500">
                                    <span class="flex items-center gap-1"><span style="width:10px;height:10px;border-radius:2px;background:#2d6a4f;display:inline-block;"></span> 100%</span>
                                    <span class="flex items-center gap-1"><span style="width:10px;height:10px;border-radius:2px;background:#3b82f6;display:inline-block;"></span> ‚â•50%</span>
                                    <span class="flex items-center gap-1"><span style="width:10px;height:10px;border-radius:2px;background:#f97316;display:inline-block;"></span> &lt;50%</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mb-4">${bidded} of ${total} staff have submitted bids (${pct}% overall)</p>
                            <div style="overflow-y:auto; max-height:420px; padding-right:4px;">
                                <canvas id="deptBarChart" width="700" height="${Math.max(depts.length * 34, 60)}"></canvas>
                            </div>
                        </div>

                        <!-- Staff Who Haven't Bid -->
                        ${notBiddedStaff.length > 0 ? `
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="font-bold text-gray-700 mb-4">‚ö†Ô∏è Staff Who Haven't Bid Yet (${notBiddedStaff.length})</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-left">ID</th>
                                            <th class="p-2 text-left">Name</th>
                                            <th class="p-2 text-left">Department</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${notBiddedStaff.map(e => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="p-2 font-mono text-xs text-gray-500">${e.id}</td>
                                                <td class="p-2 font-semibold">${e.name}</td>
                                                <td class="p-2 text-gray-500">${e.department || '‚Äî'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : processed ? '' : `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center text-green-700 font-semibold">
                            üéâ All staff have submitted their bids!
                        </div>`}

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="font-bold text-gray-700 mb-4">‚ö° Quick Actions</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onclick="app.setActiveView('upload')" class="px-4 py-3 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-sm font-semibold hover:bg-blue-100">üì§ Upload Data</button>
                                <button onclick="app.setActiveView('configureSlots')" class="px-4 py-3 bg-purple-50 text-purple-700 border border-purple-200 rounded-lg text-sm font-semibold hover:bg-purple-100">‚öôÔ∏è Configure Slots</button>
                                <button onclick="app.setActiveView('admin')" class="px-4 py-3 bg-green-50 text-green-700 border border-green-200 rounded-lg text-sm font-semibold hover:bg-green-100">üõ†Ô∏è Admin Panel</button>
                                <button onclick="app.setActiveView('results')" class="px-4 py-3 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg text-sm font-semibold hover:bg-yellow-100">üìã View Results</button>
                            </div>
                        </div>
                    </div>
                `;

                // Live dashboard countdown
                if (this.state.biddingDeadline) {
                    clearInterval(window._dashInterval);
                    window._dashInterval = setInterval(() => {
                        const el = document.getElementById('dashCountdown');
                        if (!el) { clearInterval(window._dashInterval); return; }
                        const diff = new Date(this.state.biddingDeadline) - new Date();
                        if (diff <= 0) { el.textContent = 'EXPIRED'; clearInterval(window._dashInterval); return; }
                        const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000);
                        el.textContent = `${d}d ${h}h ${m}m`;
                    }, 30000);
                }

                // ‚îÄ‚îÄ Draw horizontal bar chart ‚îÄ‚îÄ
                requestAnimationFrame(() => {
                    const barCanvas = document.getElementById('deptBarChart');
                    if (!barCanvas) return;

                    const barData = depts.map(dept => ({
                        label: dept,
                        bidded: deptBidMap[dept]?.size || 0,
                        total: deptTotalMap[dept] || 0
                    })).sort((a, b) => {
                        // Sort by participation % desc, then name
                        const pa = a.total > 0 ? a.bidded / a.total : 0;
                        const pb = b.total > 0 ? b.bidded / b.total : 0;
                        return pb - pa || a.label.localeCompare(b.label);
                    });

                    const rowH   = 34;
                    const labelW = 160;
                    const padR   = 60;
                    const W      = barCanvas.width;
                    const barMaxW = W - labelW - padR;

                    barCanvas.height = Math.max(barData.length * rowH + 10, 60);
                    const ctx = barCanvas.getContext('2d');
                    ctx.clearRect(0, 0, W, barCanvas.height);

                    // Subtle vertical gridlines at 25%, 50%, 75%, 100%
                    [0.25, 0.5, 0.75, 1].forEach(frac => {
                        const x = labelW + Math.round(frac * barMaxW);
                        ctx.beginPath();
                        ctx.strokeStyle = '#e5e7eb';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([3, 3]);
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, barCanvas.height);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        // tick label
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '9px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${Math.round(frac * 100)}%`, x, barCanvas.height - 2);
                    });

                    barData.forEach((d, i) => {
                        const y    = i * rowH + 4;
                        const midY = y + (rowH - 8) / 2;
                        const pct2 = d.total > 0 ? d.bidded / d.total : 0;
                        const fillW = Math.round(pct2 * barMaxW);
                        const color = pct2 === 1 ? '#2d6a4f' : pct2 >= 0.5 ? '#3b82f6' : '#f97316';

                        // Department label
                        ctx.fillStyle = '#374151';
                        ctx.font = '11px sans-serif';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'middle';
                        const shortLabel = d.label.length > 22 ? d.label.slice(0, 21) + '‚Ä¶' : d.label;
                        ctx.fillText(shortLabel, labelW - 8, midY);

                        // Background track
                        ctx.fillStyle = '#f3f4f6';
                        ctx.beginPath();
                        ctx.roundRect(labelW, y + 2, barMaxW, rowH - 12, 5);
                        ctx.fill();

                        // Filled bar
                        if (fillW > 4) {
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.roundRect(labelW, y + 2, fillW, rowH - 12, 5);
                            ctx.fill();

                            // Percentage text inside bar (if wide enough)
                            if (fillW > 38) {
                                ctx.fillStyle = '#fff';
                                ctx.font = 'bold 10px sans-serif';
                                ctx.textAlign = 'left';
                                ctx.fillText(`${Math.round(pct2 * 100)}%`, labelW + 7, midY);
                            }
                        }

                        // Count label to the right
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '10px sans-serif';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${d.bidded}/${d.total}`, labelW + barMaxW + 5, midY);
                    });
                });
            },

            // ==================== MANUAL OVERRIDE ====================
            renderManualOverrideView() {
                const content = document.getElementById('contentArea');
                if (!this.state.isProcessed || this.state.results.length === 0) {
                    content.innerHTML = `
                        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-xl p-8 text-center">
                            <p class="text-2xl mb-4">‚ö†Ô∏è</p>
                            <p class="text-gray-600">No results to override. Process bids first.</p>
                            <button onclick="app.setActiveView('admin')" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg">Go to Admin Panel</button>
                        </div>`;
                    return;
                }

                // Group results by employee
                const empMap = {};
                this.state.results.forEach(r => {
                    if (!empMap[r.employeeId]) empMap[r.employeeId] = [];
                    empMap[r.employeeId].push(r);
                });

                content.innerHTML = `
                    <div class="max-w-5xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold">‚úèÔ∏è Manual Override</h2>
                                    <p class="text-sm text-gray-500 mt-1">Edit any employee's assigned leave slots directly.</p>
                                </div>
                                <button onclick="app.setActiveView('dashboard')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm">‚Üê Back</button>
                            </div>
                            <div id="overrideMsg"></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-600">
                                        <tr>
                                            <th class="p-3 text-left">Employee</th>
                                            <th class="p-3 text-left">Slot</th>
                                            <th class="p-3 text-left">Slot Name</th>
                                            <th class="p-3 text-left">Start Date</th>
                                            <th class="p-3 text-left">End Date</th>
                                            <th class="p-3 text-left">Days</th>
                                            <th class="p-3 text-left">Type</th>
                                            <th class="p-3 text-left">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(empMap).map(([empId, slots]) => {
                                            const emp = this.state.employees.find(e => e.id === empId);
                                            return slots.sort((a,b)=>(a.slotOrder||0)-(b.slotOrder||0)).map((r, i) => `
                                                <tr class="border-b hover:bg-gray-50" id="row-${empId}-${r.slotOrder}">
                                                    ${i===0 ? `<td class="p-3 font-semibold" rowspan="${slots.length}">${emp?.name||empId}<br><span class="text-xs text-gray-400">${empId}</span></td>` : ''}
                                                    <td class="p-3 text-gray-500">Slot ${r.slotOrder}</td>
                                                    <td class="p-3">
                                                        <input type="text" class="border rounded px-2 py-1 w-28 text-xs" value="${r.slotName||''}" id="ov-slotName-${empId}-${r.slotOrder}" />
                                                    </td>
                                                    <td class="p-3">
                                                        <input type="date" class="border rounded px-2 py-1 text-xs" value="${r.startDate||''}" id="ov-start-${empId}-${r.slotOrder}" />
                                                    </td>
                                                    <td class="p-3">
                                                        <input type="date" class="border rounded px-2 py-1 text-xs" value="${r.endDate||''}" id="ov-end-${empId}-${r.slotOrder}" />
                                                    </td>
                                                    <td class="p-3">
                                                        <input type="number" class="border rounded px-2 py-1 w-16 text-xs" value="${r.days||0}" id="ov-days-${empId}-${r.slotOrder}" min="1" max="60" />
                                                    </td>
                                                    <td class="p-3">
                                                        <select class="border rounded px-2 py-1 text-xs" id="ov-type-${empId}-${r.slotOrder}">
                                                            <option value="Bid Awarded" ${r.type==='Bid Awarded'?'selected':''}>Bid Awarded</option>
                                                            <option value="Auto-Assigned" ${r.type==='Auto-Assigned'?'selected':''}>Auto-Assigned</option>
                                                            <option value="Manual Override" ${r.type==='Manual Override'?'selected':''}>Manual Override</option>
                                                        </select>
                                                    </td>
                                                    <td class="p-3">
                                                        <button onclick="app.saveOverride('${empId}', ${r.slotOrder})" class="px-3 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600 font-semibold">Save</button>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-6 flex gap-3">
                                <button onclick="app.saveAllOverrides()" class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">üíæ Save All Changes to Database</button>
                                <button onclick="app.setActiveView('dashboard')" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            saveOverride(empId, slotOrder) {
                const idx = this.state.results.findIndex(r => r.employeeId === empId && r.slotOrder === slotOrder);
                if (idx === -1) { alert('Result not found'); return; }
                this.state.results[idx].slotName  = document.getElementById(`ov-slotName-${empId}-${slotOrder}`)?.value || this.state.results[idx].slotName;
                this.state.results[idx].startDate = document.getElementById(`ov-start-${empId}-${slotOrder}`)?.value || this.state.results[idx].startDate;
                this.state.results[idx].endDate   = document.getElementById(`ov-end-${empId}-${slotOrder}`)?.value   || this.state.results[idx].endDate;
                this.state.results[idx].days      = parseInt(document.getElementById(`ov-days-${empId}-${slotOrder}`)?.value) || this.state.results[idx].days;
                this.state.results[idx].type      = document.getElementById(`ov-type-${empId}-${slotOrder}`)?.value || this.state.results[idx].type;
                this.saveState();
                const msg = document.getElementById('overrideMsg');
                if (msg) { msg.innerHTML = `<div class="mb-3 p-2 bg-green-50 border border-green-200 rounded text-green-700 text-sm">‚úÖ Slot ${slotOrder} for ${this.state.employees.find(e=>e.id===empId)?.name||empId} updated locally. Click "Save All" to push to database.</div>`; }
            },

            async saveAllOverrides() {
                this.saveState();
                this.writeAuditLog('MANUAL_OVERRIDE', { total_results: this.state.results.length });
                try {
                    if (this.supabase) {
                        const { error } = await this.supabase.from('system_config').update({ results: this.state.results }).eq('tenant_id', this._tid());
                        if (error) throw error;
                    }
                    const msg = document.getElementById('overrideMsg');
                    if (msg) msg.innerHTML = `<div class="mb-3 p-2 bg-green-50 border border-green-200 rounded text-green-700 text-sm">‚úÖ All overrides saved to database successfully!</div>`;
                } catch(err) {
                    console.error(err);
                    const msg = document.getElementById('overrideMsg');
                    if (msg) msg.innerHTML = `<div class="mb-3 p-2 bg-red-50 border border-red-200 rounded text-red-700 text-sm">‚ùå Database save failed. Changes saved locally only.</div>`;
                }
            },

            // ==================== ON-CALL MANAGER ====================
            renderManageOnCallView() {
                const content = document.getElementById('contentArea');
                const onCallDates = this.state.onCallDates || {};
                const year = this.state.biddingYear;

                // Get all staff names from GC users + look up employees
                const gcUsers = this.state.goldenCommandUsers || [];

                // Build staff list combining GC users + any onCallDates keys that may be freestanding
                const staffIds = new Set([
                    ...gcUsers.map(u => u.id),
                    ...Object.keys(onCallDates)
                ]);

                const getStaffName = (id) => {
                    const gc = gcUsers.find(u => u.id === id);
                    if (gc) return gc.name;
                    const emp = (this.state.employees || []).find(e => e.id === id);
                    if (emp) return emp.name;
                    return id;
                };

                // Compute which week number a date string belongs to (max 52 ‚Äî week 53 = week 1 of next year)
                const getWeekNum = (dateStr) => {
                    const dt = new Date(dateStr + 'T00:00:00');
                    const jan1 = new Date(dt.getFullYear(), 0, 1);
                    const jan1Day = jan1.getDay();
                    const week1Sun = new Date(jan1);
                    week1Sun.setDate(jan1.getDate() - jan1Day);
                    const diffMs = dt - week1Sun;
                    const wn = Math.floor(diffMs / (7 * 24 * 60 * 60 * 1000)) + 1;
                    return wn >= 53 ? 1 : wn; // week 53 is really week 1 of the next year
                };

                // ‚îÄ‚îÄ Coverage & Overlap Audit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Build a map: dateStr ‚Üí [empId, ...] for all staff
                const dateOwners = {};
                [...staffIds].forEach(id => {
                    (onCallDates[id] || []).forEach(d => {
                        if (!dateOwners[d]) dateOwners[d] = [];
                        dateOwners[d].push(id);
                    });
                });

                // Collect all weeks in the year ‚Äî always Week 1 through Week 52 only
                const allWeeks = [];
                for (let w = 1; w <= 52; w++) {
                    const r = this.weekNumberToDateRange(w, year);
                    allWeeks.push({ week: w, from: r.from, to: r.to });
                }

                // For each week, check coverage and overlaps
                const uncoveredWeeks = [];
                const overlappingWeeks = [];
                allWeeks.forEach(({ week, from, to }) => {
                    const cur = new Date(from + 'T00:00:00');
                    const end = new Date(to   + 'T00:00:00');
                    const fmtD = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                    let covered = false;
                    let overlapping = false;
                    while (cur <= end) {
                        const iso = fmtD(cur);
                        const owners = dateOwners[iso] || [];
                        if (owners.length > 0) covered = true;
                        if (owners.length > 1) overlapping = true;
                        cur.setDate(cur.getDate() + 1);
                    }
                    if (!covered) uncoveredWeeks.push(week);
                    if (overlapping) overlappingWeeks.push(week);
                });

                const auditBanner = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="rounded-xl p-4 border ${uncoveredWeeks.length === 0 ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${uncoveredWeeks.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span class="font-bold text-sm ${uncoveredWeeks.length === 0 ? 'text-green-800' : 'text-red-800'}">
                                Coverage ‚Äî ${uncoveredWeeks.length === 0 ? 'All weeks covered' : uncoveredWeeks.length + ' week(s) not covered'}
                            </span>
                        </div>
                        ${uncoveredWeeks.length === 0
                            ? `<p class="text-xs text-green-700">Every week in ${year} has at least one GC assigned.</p>`
                            : `<p class="text-xs text-red-700 mb-1">The following weeks have no On-Call assignment:</p>
                               <div class="flex flex-wrap gap-1">${uncoveredWeeks.map(w => `<span class="bg-red-200 text-red-800 text-xs font-bold px-2 py-0.5 rounded">Wk ${w}</span>`).join('')}</div>`
                        }
                    </div>
                    <div class="rounded-xl p-4 border ${overlappingWeeks.length === 0 ? 'bg-green-50 border-green-300' : 'bg-orange-50 border-orange-300'}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${overlappingWeeks.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span class="font-bold text-sm ${overlappingWeeks.length === 0 ? 'text-green-800' : 'text-orange-800'}">
                                Overlaps ‚Äî ${overlappingWeeks.length === 0 ? 'No overlapping weeks' : overlappingWeeks.length + ' week(s) overlap'}
                            </span>
                        </div>
                        ${overlappingWeeks.length === 0
                            ? `<p class="text-xs text-green-700">No two GC users share the same On-Call dates.</p>`
                            : `<p class="text-xs text-orange-700 mb-1">Multiple GC users assigned on same dates:</p>
                               <div class="flex flex-wrap gap-1">${overlappingWeeks.map(w => `<span class="bg-orange-200 text-orange-800 text-xs font-bold px-2 py-0.5 rounded">Wk ${w}</span>`).join('')}</div>`
                        }
                    </div>
                </div>`;

                const renderStaffRows = () => [...staffIds].map(id => {
                    const dates = (onCallDates[id] || []).slice().sort();
                    // Group into week blocks (consecutive 7-day groups starting on Sunday)
                    const grouped = {};
                    dates.forEach(d => {
                        const dt = new Date(d + 'T00:00:00');
                        const day = dt.getDay();
                        const weekStart = new Date(dt);
                        weekStart.setDate(dt.getDate() - day);
                        const key = weekStart.getFullYear() + '-' + String(weekStart.getMonth()+1).padStart(2,'0') + '-' + String(weekStart.getDate()).padStart(2,'0');
                        if (!grouped[key]) grouped[key] = [];
                        grouped[key].push(d);
                    });

                    const dateChips = dates.length === 0
                        ? '<p class="text-sm text-gray-400 italic">No On-Call dates assigned.</p>'
                        : Object.entries(grouped).map(([weekStartKey, wDates]) => {
                            const wNum = getWeekNum(wDates[0]);
                            const isOverlap = wDates.some(d => (dateOwners[d] || []).length > 1);
                            const chipColor = isOverlap
                                ? 'bg-orange-100 text-orange-800 border-orange-300'
                                : 'bg-red-100 text-red-700 border-red-200';
                            const label = wDates.length >= 7
                                ? `Week ${wNum} (${wDates[0]} ‚Üí ${wDates[wDates.length-1]})`
                                : `Week ${wNum} ‚Äî ${wDates.join(', ')}`;
                            const overlapIcon = isOverlap ? ' ‚ö†Ô∏è' : '';
                            return `<div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="inline-block ${chipColor} text-xs font-semibold px-2 py-1 rounded border whitespace-nowrap">${label}${overlapIcon}</span>
                                <button onclick="app.deleteOnCallBlock('${id}','${wDates[0]}','${wDates[wDates.length-1]}')"
                                    class="text-xs text-red-500 hover:text-red-700 underline whitespace-nowrap">üóë Delete block</button>
                            </div>`;
                        }).join('');

                    return `
                    <div class="bg-white rounded-xl shadow border border-gray-100 p-5 mb-4" id="staff-card-${id}">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="font-bold text-gray-800">${getStaffName(id)}</p>
                                <p class="text-xs text-gray-400">ID: ${id}</p>
                            </div>
                            <span class="text-sm font-semibold text-red-600 bg-red-50 border border-red-200 px-3 py-1 rounded-full">${dates.length} date${dates.length !== 1 ? 's' : ''}</span>
                        </div>

                        <div class="mb-4">${dateChips}</div>

                        <!-- Add dates form -->
                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm font-semibold text-blue-600 hover:text-blue-800 select-none">‚ûï Add On-Call dates for this person</summary>
                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <!-- Mode toggle -->
                                <div class="flex gap-2 mb-3">
                                    <button type="button"
                                        onclick="document.getElementById('ocDateMode-${id}').value='date';document.getElementById('ocDateFields-${id}').classList.remove('hidden');document.getElementById('ocWeekFields-${id}').classList.add('hidden');document.getElementById('ocMultiFields-${id}').classList.add('hidden');this.classList.add('bg-blue-600','text-white');this.classList.remove('bg-white','text-blue-600');document.getElementById('ocWeekBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocWeekBtn-${id}').classList.add('bg-white','text-blue-600');document.getElementById('ocMultiBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocMultiBtn-${id}').classList.add('bg-white','text-blue-600');"
                                        id="ocDateBtn-${id}"
                                        class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-blue-400 bg-blue-600 text-white transition-colors">
                                        üìÖ Date Range
                                    </button>
                                    <button type="button"
                                        onclick="document.getElementById('ocDateMode-${id}').value='week';document.getElementById('ocWeekFields-${id}').classList.remove('hidden');document.getElementById('ocDateFields-${id}').classList.add('hidden');document.getElementById('ocMultiFields-${id}').classList.add('hidden');this.classList.add('bg-blue-600','text-white');this.classList.remove('bg-white','text-blue-600');document.getElementById('ocDateBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocDateBtn-${id}').classList.add('bg-white','text-blue-600');document.getElementById('ocMultiBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocMultiBtn-${id}').classList.add('bg-white','text-blue-600');"
                                        id="ocWeekBtn-${id}"
                                        class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-blue-400 bg-white text-blue-600 transition-colors">
                                        üóì Week Number
                                    </button>
                                    <button type="button"
                                        onclick="document.getElementById('ocDateMode-${id}').value='multi';document.getElementById('ocMultiFields-${id}').classList.remove('hidden');document.getElementById('ocDateFields-${id}').classList.add('hidden');document.getElementById('ocWeekFields-${id}').classList.add('hidden');this.classList.add('bg-blue-600','text-white');this.classList.remove('bg-white','text-blue-600');document.getElementById('ocDateBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocDateBtn-${id}').classList.add('bg-white','text-blue-600');document.getElementById('ocWeekBtn-${id}').classList.remove('bg-blue-600','text-white');document.getElementById('ocWeekBtn-${id}').classList.add('bg-white','text-blue-600');"
                                        id="ocMultiBtn-${id}"
                                        class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-blue-400 bg-white text-blue-600 transition-colors">
                                        üìã Multi-Week ‚ú®
                                    </button>
                                </div>
                                <input type="hidden" id="ocDateMode-${id}" value="date" />

                                <!-- Date range fields -->
                                <div id="ocDateFields-${id}">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">From Date</label>
                                            <input type="date" id="ocFrom-${id}" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">To Date</label>
                                            <input type="date" id="ocTo-${id}" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" />
                                        </div>
                                    </div>
                                    <button onclick="app.addOnCallRange('${id}')"
                                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">
                                        ‚úÖ Add On-Call Block
                                    </button>
                                </div>

                                <!-- Week number fields -->
                                <div id="ocWeekFields-${id}" class="hidden">
                                    <div class="grid grid-cols-2 gap-3 mb-2">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Week Number</label>
                                            <input type="number" id="ocWeek-${id}" min="1" max="52" placeholder="e.g. 10"
                                                oninput="(function(el,id){const w=parseInt(el.value);const y=parseInt(document.getElementById('ocWeekYear-'+id).value)||app.state.biddingYear;if(w>=1&&w<=52){const r=app.weekNumberToDateRange(w,y);document.getElementById('ocWeekPreview-'+id).textContent='‚Üí '+r.from+' to '+r.to;}else{document.getElementById('ocWeekPreview-'+id).textContent='';}})(this,'${id}')"
                                                class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Year</label>
                                            <input type="number" id="ocWeekYear-${id}" value="${this.state.biddingYear}" min="2020" max="2040"
                                                oninput="(function(el,id){const w=parseInt(document.getElementById('ocWeek-'+id).value);const y=parseInt(el.value);if(w>=1&&w<=52&&y>=2020){const r=app.weekNumberToDateRange(w,y);document.getElementById('ocWeekPreview-'+id).textContent='‚Üí '+r.from+' to '+r.to;}else{document.getElementById('ocWeekPreview-'+id).textContent='';}})(this,'${id}')"
                                                class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" />
                                        </div>
                                    </div>
                                    <p id="ocWeekPreview-${id}" class="text-xs text-blue-700 font-semibold mb-3 min-h-[1.2em]"></p>
                                    <button onclick="app.addOnCallWeek('${id}')"
                                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">
                                        ‚úÖ Add Week Block
                                    </button>
                                </div>

                                <!-- Multi-Week fields -->
                                <div id="ocMultiFields-${id}" class="hidden">
                                    <div class="mb-2 p-2 bg-blue-100 border border-blue-300 rounded text-xs text-blue-900">
                                        <strong>Multi-week:</strong> e.g. <span class="font-mono bg-blue-200 px-1 rounded">1-4, 10, 22-26</span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div class="col-span-2">
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Weeks / Ranges</label>
                                            <input type="text" id="ocMultiWeekInput-${id}" placeholder="e.g. 1-4, 10, 22-26"
                                                oninput="_previewOcMultiChips('${id}')"
                                                class="w-full px-2 py-2 border border-blue-300 rounded-lg text-xs focus:outline-none focus:border-blue-500 font-mono"/>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Year</label>
                                            <input type="number" id="ocMultiWeekYear-${id}" value="${this.state.biddingYear}" min="2020" max="2040"
                                                class="w-full px-2 py-2 border border-blue-300 rounded-lg text-xs"/>
                                        </div>
                                    </div>
                                    <div id="ocMultiPreview-${id}" class="flex flex-wrap gap-1 mb-2 min-h-[26px] p-1.5 bg-blue-100 rounded border border-blue-200">
                                        <span style="font-size:0.7rem;color:#93c5fd;font-style:italic;">Chips appear here‚Ä¶</span>
                                    </div>
                                    <button onclick="app.addOnCallMultiWeek('${id}')"
                                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">
                                        ‚úÖ Add All Weeks
                                    </button>
                                </div>
                            </div>
                        </details>
                    </div>`;
                }).join('');

                content.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">üìÖ On-Call Date Manager</h2>
                            <p class="text-sm text-gray-500 mt-1">Add or remove On-Call dates per staff member. Leave bids that conflict with these dates will be blocked.</p>
                        </div>
                        <button onclick="app.setActiveView('admin')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200">‚Üê Back</button>
                    </div>

                    ${auditBanner}

                    <!-- Add a new staff member section -->
                    <div class="bg-yellow-50 border border-yellow-300 rounded-xl p-5 mb-6">
                        <h3 class="font-bold text-yellow-800 mb-3">‚ûï Add On-Call dates for a new / unlisted person</h3>

                        <!-- Employee ID (always shown) -->
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Employee ID</label>
                            <input type="text" id="newOcId" placeholder="e.g. 1003752" class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                        </div>

                        <!-- Mode toggle -->
                        <div class="flex gap-2 mb-3">
                            <button type="button"
                                onclick="document.getElementById('newOcMode').value='date';document.getElementById('newOcDateFields').classList.remove('hidden');document.getElementById('newOcWeekFields').classList.add('hidden');document.getElementById('newOcMultiFields').classList.add('hidden');this.classList.add('bg-yellow-500','text-white');this.classList.remove('bg-white','text-yellow-700');document.getElementById('newOcWeekBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcWeekBtn').classList.add('bg-white','text-yellow-700');document.getElementById('newOcMultiBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcMultiBtn').classList.add('bg-white','text-yellow-700');"
                                id="newOcDateBtn"
                                class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-yellow-500 bg-yellow-500 text-white transition-colors">
                                üìÖ Date Range
                            </button>
                            <button type="button"
                                onclick="document.getElementById('newOcMode').value='week';document.getElementById('newOcWeekFields').classList.remove('hidden');document.getElementById('newOcDateFields').classList.add('hidden');document.getElementById('newOcMultiFields').classList.add('hidden');this.classList.add('bg-yellow-500','text-white');this.classList.remove('bg-white','text-yellow-700');document.getElementById('newOcDateBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcDateBtn').classList.add('bg-white','text-yellow-700');document.getElementById('newOcMultiBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcMultiBtn').classList.add('bg-white','text-yellow-700');"
                                id="newOcWeekBtn"
                                class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-yellow-500 bg-white text-yellow-700 transition-colors">
                                üóì Week Number
                            </button>
                            <button type="button"
                                onclick="document.getElementById('newOcMode').value='multi';document.getElementById('newOcMultiFields').classList.remove('hidden');document.getElementById('newOcDateFields').classList.add('hidden');document.getElementById('newOcWeekFields').classList.add('hidden');this.classList.add('bg-yellow-500','text-white');this.classList.remove('bg-white','text-yellow-700');document.getElementById('newOcDateBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcDateBtn').classList.add('bg-white','text-yellow-700');document.getElementById('newOcWeekBtn').classList.remove('bg-yellow-500','text-white');document.getElementById('newOcWeekBtn').classList.add('bg-white','text-yellow-700');"
                                id="newOcMultiBtn"
                                class="flex-1 px-3 py-1.5 text-xs font-semibold rounded-lg border border-yellow-500 bg-white text-yellow-700 transition-colors">
                                üìã Multi-Week ‚ú®
                            </button>
                        </div>
                        <input type="hidden" id="newOcMode" value="date" />

                        <!-- Date range fields -->
                        <div id="newOcDateFields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">From Date</label>
                                    <input type="date" id="newOcFrom" class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">To Date</label>
                                    <input type="date" id="newOcTo" class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                                </div>
                            </div>
                            <button onclick="app.addOnCallRangeNew()"
                                class="px-6 py-2 bg-yellow-500 text-white rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors">
                                ‚úÖ Add Block
                            </button>
                        </div>

                        <!-- Week number fields -->
                        <div id="newOcWeekFields" class="hidden">
                            <div class="grid grid-cols-2 gap-3 mb-2">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Week Number</label>
                                    <input type="number" id="newOcWeekNum" min="1" max="52" placeholder="e.g. 10"
                                        oninput="(function(el){const w=parseInt(el.value);const y=parseInt(document.getElementById('newOcWeekYear').value)||app.state.biddingYear;if(w>=1&&w<=52){const r=app.weekNumberToDateRange(w,y);document.getElementById('newOcWeekPreview').textContent='‚Üí '+r.from+' to '+r.to;}else{document.getElementById('newOcWeekPreview').textContent='';}})(this)"
                                        class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Year</label>
                                    <input type="number" id="newOcWeekYear" value="${this.state.biddingYear}" min="2020" max="2040"
                                        oninput="(function(el){const w=parseInt(document.getElementById('newOcWeekNum').value);const y=parseInt(el.value);if(w>=1&&w<=52&&y>=2020){const r=app.weekNumberToDateRange(w,y);document.getElementById('newOcWeekPreview').textContent='‚Üí '+r.from+' to '+r.to;}else{document.getElementById('newOcWeekPreview').textContent='';}})(this)"
                                        class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                                </div>
                            </div>
                            <p id="newOcWeekPreview" class="text-xs text-yellow-800 font-semibold mb-3 min-h-[1.2em]"></p>
                            <button onclick="app.addOnCallWeekNew()"
                                class="px-6 py-2 bg-yellow-500 text-white rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors">
                                ‚úÖ Add Week Block
                            </button>
                        </div>

                        <!-- Multi-Week fields -->
                        <div id="newOcMultiFields" class="hidden">
                            <div class="mb-3 p-3 bg-yellow-100 border border-yellow-400 rounded-lg text-xs text-yellow-900 leading-relaxed">
                                <strong>How to use:</strong> Type week numbers separated by commas. Use a dash for ranges.<br/>
                                <span class="font-mono mt-1 block">e.g. <span class="bg-yellow-200 px-1 rounded">1-4, 10, 22-26, 40</span></span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div class="col-span-2">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Week Numbers / Ranges</label>
                                    <input type="text" id="newOcMultiWeekInput" placeholder="e.g. 1-4, 10, 22-26, 40"
                                        oninput="_previewNewOcMultiChips()"
                                        class="w-full px-3 py-2 border-2 border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600 font-mono" />
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Year</label>
                                    <input type="number" id="newOcMultiWeekYear" value="${this.state.biddingYear}" min="2020" max="2040"
                                        class="w-full px-3 py-2 border border-yellow-400 rounded-lg text-sm focus:outline-none focus:border-yellow-600" />
                                </div>
                            </div>
                            <div id="newOcMultiPreview" class="flex flex-wrap gap-1 mb-3 min-h-[34px] p-2 bg-yellow-100 rounded-lg border border-yellow-300">
                                <span class="text-xs text-yellow-600 italic">Week chips appear here‚Ä¶</span>
                            </div>
                            <button onclick="app.addOnCallMultiWeekNew()"
                                class="px-8 py-2.5 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600 transition-colors shadow">
                                ‚úÖ Add All Weeks
                            </button>
                        </div>
                    </div>

                    <!-- Staff cards -->
                    <div id="onCallStaffList">
                        ${staffIds.size === 0
                            ? '<p class="text-center text-gray-400 py-12">No staff found. Add GC users in the Admin panel first.</p>'
                            : renderStaffRows()
                        }
                    </div>
                </div>`;
            },

            addOnCallRange(empId) {
                const from = document.getElementById(`ocFrom-${empId}`)?.value;
                const to   = document.getElementById(`ocTo-${empId}`)?.value;
                this._applyOnCallRange(empId, from, to);
            },

            addOnCallRangeNew() {
                const empId = document.getElementById('newOcId')?.value?.trim();
                const from  = document.getElementById('newOcFrom')?.value;
                const to    = document.getElementById('newOcTo')?.value;
                if (!empId) { alert('Please enter an Employee ID.'); return; }
                this._applyOnCallRange(empId, from, to, true);
            },

            // Returns { from: 'YYYY-MM-DD', to: 'YYYY-MM-DD' } for a Sun-Sat week number.
            // Week 1 starts on the Sunday on or before Jan 1 of the given year.
            // e.g. for 2026: Jan 1 is Thursday ‚Üí Week 1 = Dec 28 2025 (Sun) ‚Üí Jan 3 2026 (Sat).
            // Always 52 weeks max. What would be Week 53 is labelled Week 1 of the next year.
            weekNumberToDateRange(weekNum, year) {
                // Use local date parts to avoid UTC offset shifting the date (e.g. UTC+3 turns midnight into previous day in UTC)
                const fmt = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                const jan1 = new Date(year, 0, 1);
                const jan1Day = jan1.getDay(); // 0=Sun, 6=Sat
                // Roll back to the Sunday on or before Jan 1
                const week1Sun = new Date(jan1);
                week1Sun.setDate(jan1.getDate() - jan1Day);
                // Week N starts (weekNum-1)*7 days after week1Sun
                const weekSun = new Date(week1Sun);
                weekSun.setDate(week1Sun.getDate() + (weekNum - 1) * 7);
                const weekSat = new Date(weekSun);
                weekSat.setDate(weekSun.getDate() + 6);
                return { from: fmt(weekSun), to: fmt(weekSat) };
            },

            addOnCallWeek(empId) {
                const weekInput = document.getElementById(`ocWeek-${empId}`)?.value;
                const yearInput = document.getElementById(`ocWeekYear-${empId}`)?.value;
                const weekNum = parseInt(weekInput);
                const year = parseInt(yearInput) || this.state.biddingYear;
                if (!weekNum || weekNum < 1 || weekNum > 53) { alert('Please enter a valid week number (1‚Äì53).'); return; }
                const { from, to } = this.weekNumberToDateRange(weekNum, year);
                this._applyOnCallRange(empId, from, to);
            },

            addOnCallWeekNew() {
                const empId = document.getElementById('newOcId')?.value?.trim();
                if (!empId) { alert('Please enter an Employee ID.'); return; }
                const weekNum = parseInt(document.getElementById('newOcWeekNum')?.value);
                const year = parseInt(document.getElementById('newOcWeekYear')?.value) || this.state.biddingYear;
                if (!weekNum || weekNum < 1 || weekNum > 53) { alert('Please enter a valid week number (1‚Äì53).'); return; }
                const { from, to } = this.weekNumberToDateRange(weekNum, year);
                this._applyOnCallRange(empId, from, to, true);
            },

            // ---- MULTI-WEEK helpers ----
            _parseMultiWeekInput(raw, year) {
                const tokens = raw.split(/[\s,;]+/).filter(Boolean);
                const weeks = new Set();
                for (const tok of tokens) {
                    const m = tok.match(/^(\d+)-(\d+)$/);
                    if (m) { for (let w = Math.max(1, +m[1]); w <= Math.min(53, +m[2]); w++) weeks.add(w); }
                    else { const n = +tok; if (!isNaN(n) && n >= 1 && n <= 53) weeks.add(n); }
                }
                return [...weeks].sort((a, b) => a - b);
            },

            addOnCallMultiWeekNew() {
                const empId = document.getElementById('newOcId')?.value?.trim();
                if (!empId) { alert('Please enter an Employee ID.'); return; }
                const raw  = document.getElementById('newOcMultiWeekInput')?.value || '';
                const year = parseInt(document.getElementById('newOcMultiWeekYear')?.value) || this.state.biddingYear;
                if (!raw.trim()) { alert('Please enter at least one week number.'); return; }
                const weeks = this._parseMultiWeekInput(raw, year);
                if (!weeks.length) { alert('No valid weeks found. Example: 1-4, 10, 22-26'); return; }

                if (!this.state.onCallDates) this.state.onCallDates = {};
                if (!this.state.onCallDates[empId]) this.state.onCallDates[empId] = [];
                const existing = new Set(this.state.onCallDates[empId]);
                let added = 0;
                for (const w of weeks) {
                    const { from, to } = this.weekNumberToDateRange(w, year);
                    const cur = new Date(from + 'T00:00:00'), end = new Date(to + 'T00:00:00');
                    while (cur <= end) {
                        const iso = cur.getFullYear() + '-' + String(cur.getMonth()+1).padStart(2,'0') + '-' + String(cur.getDate()).padStart(2,'0');
                        if (!existing.has(iso)) { existing.add(iso); added++; }
                        cur.setDate(cur.getDate() + 1);
                    }
                }
                this.state.onCallDates[empId] = [...existing].sort();
                this.saveOnCallDatesToSupabase();
                this.writeAuditLog('MANUAL_OVERRIDE', { action: 'on_call_multi_add', empId, weeks: weeks.join(','), added });
                alert(`‚úÖ Added ${added} new date${added !== 1 ? 's' : ''} across ${weeks.length} week${weeks.length !== 1 ? 's' : ''} for "${empId}".\nTotal on-call dates: ${this.state.onCallDates[empId].length}`);
                this.renderManageOnCallView();
            },

            addOnCallMultiWeek(empId) {
                const raw  = document.getElementById(`ocMultiWeekInput-${empId}`)?.value || '';
                const year = parseInt(document.getElementById(`ocMultiWeekYear-${empId}`)?.value) || this.state.biddingYear;
                if (!raw.trim()) { alert('Please enter at least one week number.'); return; }
                const weeks = this._parseMultiWeekInput(raw, year);
                if (!weeks.length) { alert('No valid weeks found. Example: 1-4, 10, 22-26'); return; }

                if (!this.state.onCallDates) this.state.onCallDates = {};
                if (!this.state.onCallDates[empId]) this.state.onCallDates[empId] = [];
                const existing = new Set(this.state.onCallDates[empId]);
                let added = 0;
                for (const w of weeks) {
                    const { from, to } = this.weekNumberToDateRange(w, year);
                    const cur = new Date(from + 'T00:00:00'), end = new Date(to + 'T00:00:00');
                    while (cur <= end) {
                        const iso = cur.getFullYear() + '-' + String(cur.getMonth()+1).padStart(2,'0') + '-' + String(cur.getDate()).padStart(2,'0');
                        if (!existing.has(iso)) { existing.add(iso); added++; }
                        cur.setDate(cur.getDate() + 1);
                    }
                }
                this.state.onCallDates[empId] = [...existing].sort();
                this.saveOnCallDatesToSupabase();
                this.writeAuditLog('MANUAL_OVERRIDE', { action: 'on_call_multi_add', empId, weeks: weeks.join(','), added });
                alert(`‚úÖ Added ${added} new date${added !== 1 ? 's' : ''} across ${weeks.length} week${weeks.length !== 1 ? 's' : ''} for "${empId}".\nTotal: ${this.state.onCallDates[empId].length} dates`);
                this.renderManageOnCallView();
            },

            // Saves all system_config fields (deadline, year, slots, on-call, password, results) to Supabase + localStorage
            async saveConfigToSupabase() {
                this.saveState(); // always write localStorage first
                if (!this.supabase) return;
                try {
                    const payload = {

                        tenant_id: this._tid(),
                        bidding_deadline: this.state.biddingDeadline,
                        bidding_year: this.state.biddingYear,
                        is_processed: this.state.isProcessed,
                        planner_password: this.state.plannerPassword,
                        slot_capacities: this.state.slotCapacities,
                        results: this.state.results,
                        last_updated: new Date().toISOString()
                        // on_call_dates intentionally omitted ‚Äî now stored in oncall_dates table
                    };
                    const { error } = await this.supabase
                        .from('system_config')
                        .upsert(payload, { onConflict: 'tenant_id' });
                    if (error) {
                        console.error('‚ùå Could not save on-call config to Supabase:', error.message);
                        // Show a brief warning in the status bar so the planner is aware
                        this.updateSystemStatus('‚ö†Ô∏è On-call save failed ‚Äî data saved locally only');
                        setTimeout(() => this.updateSystemStatus('Ready'), 5000);
                    } else {
                        console.log('‚úÖ Config (incl. on-call dates) saved to Supabase:', Object.keys(this.state.onCallDates || {}).length, 'staff entries');
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Supabase config save error:', e.message);
                    this.updateSystemStatus('‚ö†Ô∏è On-call save failed ‚Äî data saved locally only');
                    setTimeout(() => this.updateSystemStatus('Ready'), 5000);
                }
            },

            // Persists onCallDates to dedicated oncall_dates table + localStorage
            async saveOnCallDatesToSupabase() {
                this.saveState(); // always write localStorage first
                if (!this.supabase) return;
                try {
                    const onCallDates = this.state.onCallDates || {};
                    const rows = [];
                    for (const [empId, dates] of Object.entries(onCallDates)) {
                        for (const date of dates) {
                            const d = new Date(date + 'T00:00:00');
                            const jan1 = new Date(d.getFullYear(), 0, 1);
                            const weekNum = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
                            rows.push({ tenant_id: this._tid(), employee_id: empId, date: date, week_number: weekNum, year: d.getFullYear() });
                        }
                    }
                    if (rows.length === 0) return;
                    const chunkSize = 500;
                    for (let i = 0; i < rows.length; i += chunkSize) {
                        const batch = rows.slice(i, i + chunkSize);
                        const { error } = await this.supabase
                            .from('oncall_dates')
                            .upsert(batch, { onConflict: 'employee_id,date', ignoreDuplicates: true });
                        if (error) {
                            console.error('‚ùå oncall_dates save error:', error.message);
                            this.updateSystemStatus('‚ö†Ô∏è On-call save failed ‚Äî check console');
                            setTimeout(() => this.updateSystemStatus('Ready'), 5000);
                            return;
                        }
                    }
                    console.log(`‚úÖ Saved ${rows.length} on-call date rows to oncall_dates table`);
                    this.updateSystemStatus(`‚úÖ On-call dates saved (${rows.length} rows)`);
                    setTimeout(() => this.updateSystemStatus('Ready'), 3000);
                } catch (e) {
                    console.warn('‚ö†Ô∏è oncall_dates save error:', e.message);
                    this.updateSystemStatus('‚ö†Ô∏è On-call save failed ‚Äî data saved locally only');
                    setTimeout(() => this.updateSystemStatus('Ready'), 5000);
                }
            },

            _applyOnCallRange(empId, from, to, isNew = false) {
                if (!from || !to) { alert('Please select both a start and end date.'); return; }
                if (from > to)    { alert('Start date must be on or before end date.'); return; }

                if (!this.state.onCallDates) this.state.onCallDates = {};
                if (!this.state.onCallDates[empId]) this.state.onCallDates[empId] = [];

                const existing = new Set(this.state.onCallDates[empId]);
                const cur = new Date(from + 'T00:00:00');
                const end = new Date(to   + 'T00:00:00');
                let added = 0;
                while (cur <= end) {
                    const iso = cur.getFullYear() + '-' + String(cur.getMonth()+1).padStart(2,'0') + '-' + String(cur.getDate()).padStart(2,'0');
                    if (!existing.has(iso)) { existing.add(iso); added++; }
                    cur.setDate(cur.getDate() + 1);
                }
                this.state.onCallDates[empId] = [...existing].sort();
                this.saveOnCallDatesToSupabase();
                this.writeAuditLog('MANUAL_OVERRIDE', { action: 'on_call_add', empId, from, to, added });
                alert(`‚úÖ Added ${added} date${added !== 1 ? 's' : ''} to On-Call schedule for ${empId}.`);
                this.renderManageOnCallView();
            },

            deleteOnCallBlock(empId, blockFrom, blockTo) {
                if (!confirm(`Remove all On-Call dates from ${blockFrom} to ${blockTo} for ${empId}?`)) return;
                if (!this.state.onCallDates?.[empId]) return;

                const from = new Date(blockFrom + 'T00:00:00');
                const to   = new Date(blockTo   + 'T00:00:00');
                const toDelete = new Set();
                const cur = new Date(from);
                while (cur <= to) {
                    toDelete.add(cur.getFullYear() + '-' + String(cur.getMonth()+1).padStart(2,'0') + '-' + String(cur.getDate()).padStart(2,'0'));
                    cur.setDate(cur.getDate() + 1);
                }

                const before = this.state.onCallDates[empId].length;
                this.state.onCallDates[empId] = this.state.onCallDates[empId].filter(d => !toDelete.has(d));
                const removed = before - this.state.onCallDates[empId].length;

                // Delete from dedicated oncall_dates table
                if (this.supabase && toDelete.size > 0) {
                    this.supabase
                        .from('oncall_dates')
                        .delete()
                        .eq('employee_id', empId)
                        .eq('tenant_id', this._tid())
                        .in('date', [...toDelete])
                        .then(({ error }) => {
                            if (error) console.error('‚ùå oncall_dates delete error:', error.message);
                            else console.log(`‚úÖ Deleted ${toDelete.size} rows from oncall_dates for ${empId}`);
                        });
                }
                this.saveState(); // keep localStorage in sync
                this.writeAuditLog('MANUAL_OVERRIDE', { action: 'on_call_delete', empId, blockFrom, blockTo, removed });
                alert(`üóë Removed ${removed} date${removed !== 1 ? 's' : ''} from On-Call schedule.`);
                this.renderManageOnCallView();
            },

            renderChangePlannerPasswordView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-8">
                            <h2 class="text-2xl font-bold mb-2">üîê Change Planner Password</h2>
                            <p class="text-gray-500 text-sm mb-6">Update the planner login password. This is saved to the database.</p>
                            <div id="ppMsg"></div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Current Password:</label>
                                    <input type="password" id="ppCurrent" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Enter current planner password" />
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">New Password:</label>
                                    <input type="password" id="ppNew" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Enter new password (min 4 chars)" />
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Confirm New Password:</label>
                                    <input type="password" id="ppConfirm" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Repeat new password" />
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="app.doChangePlannerPassword()" class="flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold">
                                    üíæ Save Password
                                </button>
                                <button onclick="app.setActiveView('admin')" class="flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            async doChangePlannerPassword() {
                const current = document.getElementById('ppCurrent').value;
                const newPass = document.getElementById('ppNew').value;
                const confirm = document.getElementById('ppConfirm').value;
                const msg = document.getElementById('ppMsg');

                const showMsg = (text, color) => {
                    msg.innerHTML = `<div class="mb-4 p-3 rounded-lg border ${color}">${text}</div>`;
                };

                if (current !== this.state.plannerPassword) {
                    showMsg('‚ùå Current password is incorrect.', 'bg-red-50 border-red-300 text-red-700');
                    return;
                }
                if (newPass.length < 4) {
                    showMsg('‚ö†Ô∏è New password must be at least 4 characters.', 'bg-yellow-50 border-yellow-300 text-yellow-700');
                    return;
                }
                if (newPass !== confirm) {
                    showMsg('‚ùå New passwords do not match.', 'bg-red-50 border-red-300 text-red-700');
                    return;
                }

                this.state.plannerPassword = newPass;

                try {
                    await this.saveConfigToSupabase();
                    if (this.supabase) {
                        showMsg('‚úÖ Planner password updated and saved to database!', 'bg-green-50 border-green-300 text-green-700');
                    } else {
                        showMsg('‚úÖ Password updated locally (database not connected).', 'bg-green-50 border-green-300 text-green-700');
                    }
                } catch (err) {
                    console.error('Planner password change error:', err);
                    showMsg('‚úÖ Password updated locally. ‚ö†Ô∏è Database save failed ‚Äî reconnect and try again.', 'bg-yellow-50 border-yellow-300 text-yellow-700');
                }

                document.getElementById('ppCurrent').value = '';
                document.getElementById('ppNew').value = '';
                document.getElementById('ppConfirm').value = '';
            },

            // ==================== FORGOT PASSWORD ====================
            renderForgotPasswordView() {
                const loginView = document.getElementById('loginView');
                const content = loginView.querySelector('.bg-white');
                content.innerHTML = `
                    <h1 class="text-2xl font-bold text-center mb-2 text-blue-600">Forgot Password</h1>
                    <p class="text-gray-500 text-sm text-center mb-6">Reset your password to your Employee ID (default).</p>
                    <div id="fpMsg"></div>
                    <div class="space-y-4">
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input type="text" id="fpId" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter your Employee ID" />
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="app.doForgotPassword()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                            üîÑ Reset Password
                        </button>
                        <button onclick="app.showLoginView()" class="flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold">
                            ‚Üê Back to Login
                        </button>
                    </div>
                `;
            },

            async doForgotPassword() {
                const empId = document.getElementById('fpId').value.trim();
                const msg = document.getElementById('fpMsg');

                const showMsg = (text, color) => {
                    msg.innerHTML = `<div class="mb-4 p-3 rounded-lg border ${color}">${text}</div>`;
                };

                if (!empId) {
                    showMsg('‚ö†Ô∏è Please enter your Employee ID.', 'bg-yellow-50 border-yellow-300 text-yellow-700');
                    return;
                }

                const employee = this.state.employees.find(e => e.id === empId);
                if (!employee) {
                    showMsg('‚ùå Employee ID not found. Make sure data is loaded.', 'bg-red-50 border-red-300 text-red-700');
                    return;
                }

                // Reset password to default (Employee ID)
                this.state.employeePasswords[empId] = empId;
                this.saveState();

                try {
                    if (this.supabase) {
                        // Try to update password column if it exists
                        await this.supabase.from('employees').update({ password: empId }).eq('id', empId);
                    }
                } catch (err) {
                    console.warn('Could not update password in DB:', err);
                }

                showMsg(`‚úÖ Password for <strong>${employee.name}</strong> has been reset to your Employee ID: <strong>${empId}</strong>. Please log in and change your password immediately.`, 'bg-green-50 border-green-300 text-green-700');
            },

            showLoginView() {
                const loginView = document.getElementById('loginView');
                const content = loginView.querySelector('.bg-white');
                // Rebuild original login content
                content.innerHTML = `
                    <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">Annual Leave Bidding System</h1>
                    <div class="mb-4 text-center">
                        <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                            <p class="text-sm font-semibold text-blue-800">System Status:</p>
                            <p id="systemStatus" class="text-xs text-blue-700">${document.getElementById('systemStatus')?.textContent || 'Ready'}</p>
                        </div>
                        <button onclick="app.syncWithSupabase()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-semibold mb-4">
                            üîÑ Sync with Database
                        </button>
                    </div>
                    <div class="mb-6">
                        <label class="block font-semibold mb-3">Login As:</label>
                        <div class="flex gap-4">
                            <button onclick="app.setLoginType('employee')" class="flex-1 px-4 py-3 rounded-lg font-semibold ${this.state.loginType === 'employee' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Employee</button>
                            <button onclick="app.setLoginType('planner')" class="flex-1 px-4 py-3 rounded-lg font-semibold ${this.state.loginType === 'planner' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Planner</button>
                            <button onclick="app.setLoginType('goldencommand')" class="flex-1 px-4 py-3 rounded-lg font-semibold bg-yellow-400 text-yellow-900 hover:bg-yellow-500">‚≠ê Golden Command</button>
                        </div>
                    </div>
                    <div id="loginForm"></div>
                    <button onclick="app.handleLogin()" class="w-full mt-6 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">Login</button>
                    <div class="mt-4 text-center">
                        <button onclick="app.renderForgotPasswordView()" class="text-sm text-blue-500 hover:underline">Forgot Password?</button>
                    </div>
                `;
                this.renderLoginForm();
            },

            // ==================== EMAIL NOTIFICATION ====================
            showEmailNotifyModal() {
                document.getElementById('emailModal').style.display = 'flex';
                document.getElementById('emailModalMsg').innerHTML = '';
                document.getElementById('emailProgress').style.display = 'none';
            },

            async sendResultsNotification() {
                const serviceId  = document.getElementById('ejsServiceId').value.trim();
                const templateId = document.getElementById('ejsTemplateId').value.trim();
                const publicKey  = document.getElementById('ejsPublicKey').value.trim();
                const msgEl = document.getElementById('emailModalMsg');

                if (!serviceId || !templateId || !publicKey) {
                    msgEl.innerHTML = '<div style="padding:10px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;font-size:0.8rem;margin-bottom:12px;">‚ö†Ô∏è Please fill in all three EmailJS fields.</div>';
                    return;
                }

                // Save keys for next time
                localStorage.setItem('ejs_service', serviceId);
                localStorage.setItem('ejs_template', templateId);
                localStorage.setItem('ejs_pubkey', publicKey);

                // Get unique employees with emails
                const staffToNotify = this.state.employees.filter(e => e.email);
                if (staffToNotify.length === 0) {
                    msgEl.innerHTML = '<div style="padding:10px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;font-size:0.8rem;margin-bottom:12px;">‚ùå No employee emails found. Make sure emails are loaded from the database.</div>';
                    return;
                }

                // Init EmailJS
                try { emailjs.init(publicKey); } catch(e) { console.warn('EmailJS init:', e); }

                // Show progress
                const prog = document.getElementById('emailProgress');
                const bar  = document.getElementById('emailProgressBar');
                const txt  = document.getElementById('emailProgressText');
                prog.style.display = 'block';
                msgEl.innerHTML = '';

                let sent = 0, failed = 0;
                for (let i = 0; i < staffToNotify.length; i++) {
                    const emp = staffToNotify[i];
                    try {
                        await emailjs.send(serviceId, templateId, {
                            to_email: emp.email,
                            to_name: emp.name,
                            employee_id: emp.id,
                            year: this.state.biddingYear
                        });
                        sent++;
                    } catch(err) {
                        console.warn(`Failed to send to ${emp.email}:`, err);
                        failed++;
                    }
                    const pct = Math.round(((i+1)/staffToNotify.length)*100);
                    bar.style.width = pct + '%';
                    txt.textContent = `Sending... ${i+1}/${staffToNotify.length} (${sent} sent, ${failed} failed)`;
                    // Small delay to avoid rate limiting
                    await new Promise(r => setTimeout(r, 300));
                }

                prog.style.display = 'none';
                const color = failed === 0 ? '#f0fdf4;border-color:#bbf7d0;color:#166534' : '#fef2f2;border-color:#fecaca;color:#991b1b';
                msgEl.innerHTML = `<div style="padding:10px;background:${color};border:1px solid;border-radius:8px;font-size:0.8rem;margin-bottom:12px;">
                    ${failed===0?'‚úÖ':'‚ö†Ô∏è'} Done! ${sent} emails sent${failed>0?`, ${failed} failed`:''}.</div>`;
            },

            // ==================== AUDIT LOG ====================
            async writeAuditLog(action, details = {}) {
                const entry = {
                    action,
                    user_id: this.state.currentUser?.id || this.state.currentUser?.name || 'unknown',
                    user_name: this.state.currentUser?.name || 'unknown',
                    user_type: this.state.userType || 'unknown',
                    details: JSON.stringify(details),
                    timestamp: new Date().toISOString()
                };

                // Always save locally
                try {
                    const local = JSON.parse(localStorage.getItem('auditLog') || '[]');
                    local.unshift(entry);
                    localStorage.setItem('auditLog', JSON.stringify(local.slice(0, 500))); // keep last 500
                } catch(e) { console.warn('Audit local save failed', e); }

                // Also save to Supabase audit_logs table
                if (this.supabase) {
                    try {
                        await this.supabase.from('audit_logs').insert({
                            tenant_id: this._tid(),
                            action: entry.action,
                            user_id: entry.user_id,
                            user_name: entry.user_name,
                            user_type: entry.user_type,
                            details: entry.details,
                            created_at: entry.timestamp
                        });
                    } catch(e) { console.warn('Audit Supabase save failed', e); }
                }
            },

            async renderAuditLogView() {
                const content = document.getElementById('contentArea');
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold">üîç Audit Log</h2>
                                    <p class="text-sm text-gray-500 mt-1">All system activity ‚Äî logins, bids, overrides, password changes</p>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="app.renderAuditLogView()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200">üîÑ Refresh</button>
                                    <button onclick="app.clearAuditLog()" class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg text-sm font-semibold hover:bg-red-100">üóë Clear Local</button>
                                </div>
                            </div>

                            <!-- Filters -->
                            <div class="flex gap-3 mb-5 flex-wrap">
                                <select id="auditFilterType" onchange="app.filterAuditLog()" class="px-3 py-2 border rounded-lg text-sm">
                                    <option value="all">All Actions</option>
                                    <option value="LOGIN">Login</option>
                                    <option value="LOGOUT">Logout</option>
                                    <option value="BID_PLACED">Bid Placed</option>
                                    <option value="BID_REMOVED">Bid Removed</option>
                                    <option value="BIDS_PROCESSED">Bids Processed</option>
                                    <option value="PASSWORD_CHANGED">Password Changed</option>
                                    <option value="MANUAL_OVERRIDE">Manual Override</option>
                                    <option value="DATA_UPLOADED">Data Uploaded</option>
                                    <option value="SYSTEM_RESET">System Reset</option>
                                </select>
                                <select id="auditFilterRole" onchange="app.filterAuditLog()" class="px-3 py-2 border rounded-lg text-sm">
                                    <option value="all">All Roles</option>
                                    <option value="employee">Employee</option>
                                    <option value="planner">Planner</option>
                                    <option value="goldencommand">Golden Command</option>
                                </select>
                                <input type="text" id="auditSearch" oninput="app.filterAuditLog()" placeholder="Search name or ID..." class="px-3 py-2 border rounded-lg text-sm flex-1 min-w-40" />
                            </div>

                            <div id="auditTableContainer">
                                <div class="text-center py-8 text-gray-400">‚è≥ Loading audit log...</div>
                            </div>
                        </div>
                    </div>
                `;

                // Load from Supabase first, fallback to localStorage
                let logs = [];
                if (this.supabase) {
                    try {
                        const { data, error } = await this.supabase
                            .from('audit_logs')
                            .select('*')
                            .order('created_at', { ascending: false })
                            .limit(500);
                        if (!error && data) {
                            logs = data.map(r => ({
                                action: r.action,
                                user_id: r.user_id,
                                user_name: r.user_name,
                                user_type: r.user_type,
                                details: r.details,
                                timestamp: r.created_at
                            }));
                        }
                    } catch(e) { console.warn('Audit load from Supabase failed', e); }
                }

                // Merge with local if Supabase had nothing
                if (logs.length === 0) {
                    logs = JSON.parse(localStorage.getItem('auditLog') || '[]');
                }

                this._auditLogs = logs;
                this.filterAuditLog();
            },

            filterAuditLog() {
                const logs = this._auditLogs || [];
                const typeFilter = document.getElementById('auditFilterType')?.value || 'all';
                const roleFilter = document.getElementById('auditFilterRole')?.value || 'all';
                const search = (document.getElementById('auditSearch')?.value || '').toLowerCase();

                const filtered = logs.filter(l => {
                    if (typeFilter !== 'all' && l.action !== typeFilter) return false;
                    if (roleFilter !== 'all' && l.user_type !== roleFilter) return false;
                    if (search && !l.user_name?.toLowerCase().includes(search) && !l.user_id?.toLowerCase().includes(search)) return false;
                    return true;
                });

                const actionColors = {
                    'LOGIN':            'bg-green-100 text-green-800',
                    'LOGOUT':           'bg-gray-100 text-gray-700',
                    'BID_PLACED':       'bg-blue-100 text-blue-800',
                    'BID_REMOVED':      'bg-orange-100 text-orange-800',
                    'BIDS_PROCESSED':   'bg-purple-100 text-purple-800',
                    'PASSWORD_CHANGED': 'bg-yellow-100 text-yellow-800',
                    'MANUAL_OVERRIDE':  'bg-red-100 text-red-800',
                    'DATA_UPLOADED':    'bg-indigo-100 text-indigo-800',
                    'SYSTEM_RESET':     'bg-red-200 text-red-900',
                };

                const roleIcons = { employee: 'üë§', planner: 'üõ†Ô∏è', goldencommand: '‚≠ê', corporatestaff: 'üè¢' };

                const container = document.getElementById('auditTableContainer');
                if (!container) return;

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="text-center py-12 text-gray-400">
                        <p class="text-3xl mb-3">üì≠</p>
                        <p>No audit entries found${search ? ' matching your search' : ''}.</p>
                    </div>`;
                    return;
                }

                container.innerHTML = `
                    <p class="text-xs text-gray-400 mb-3">${filtered.length} entr${filtered.length===1?'y':'ies'} found</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wide">
                                <tr>
                                    <th class="p-3 text-left">Timestamp</th>
                                    <th class="p-3 text-left">Action</th>
                                    <th class="p-3 text-left">User</th>
                                    <th class="p-3 text-left">Role</th>
                                    <th class="p-3 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filtered.map(l => {
                                    const ts = l.timestamp ? new Date(l.timestamp).toLocaleString('en-US', {day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '‚Äî';
                                    const colorClass = actionColors[l.action] || 'bg-gray-100 text-gray-700';
                                    const roleIcon = roleIcons[l.user_type] || 'üë§';
                                    let detailsObj = {};
                                    try { detailsObj = JSON.parse(l.details || '{}'); } catch(e) {}
                                    const detailStr = Object.entries(detailsObj).map(([k,v]) => `<span class="text-gray-500">${k}:</span> <span class="font-medium">${v}</span>`).join(' ¬∑ ');
                                    return `
                                        <tr class="border-b hover:bg-gray-50 transition-colors">
                                            <td class="p-3 text-xs text-gray-500 whitespace-nowrap font-mono">${ts}</td>
                                            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${colorClass}">${l.action}</span></td>
                                            <td class="p-3">
                                                <p class="font-semibold text-gray-800">${l.user_name || '‚Äî'}</p>
                                                <p class="text-xs text-gray-400">${l.user_id || ''}</p>
                                            </td>
                                            <td class="p-3 text-xs">${roleIcon} ${l.user_type || '‚Äî'}</td>
                                            <td class="p-3 text-xs text-gray-600">${detailStr || '‚Äî'}</td>
                                        </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            clearAuditLog() {
                if (!confirm('Clear local audit log? (Supabase records will remain)')) return;
                localStorage.removeItem('auditLog');
                this._auditLogs = [];
                this.filterAuditLog();
            },

            _updateLandingStats() {
                const count = this.state.employees ? this.state.employees.length : 0;
                const countStr = count > 0 ? count.toLocaleString() : '‚Äî';
                ['statsEmpCount','statsEmpBadge','statsEmpStatus'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = count > 0 ? countStr : '‚Äî';
                });
            },

            _startClock() {
                const tick = () => {
                    const now = new Date();
                    const clockEl = document.getElementById('liveClock');
                    const dateEl = document.getElementById('liveDate');
                    if (clockEl) {
                        clockEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    }
                    if (dateEl) {
                        dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    }
                };
                tick();
                setInterval(tick, 1000);
            },

            // ==================== INITIALIZATION ====================
            async init() {
                console.log('App initializing...');
                this.updateSystemStatus('Initializing...');
                
                // Initialize Supabase
                const supabaseReady = await this.initSupabase();
                if (supabaseReady) {
                    this.updateSystemStatus('Connected to Supabase');
                    
                    // Try to load from Supabase first
                    setTimeout(async () => {
                        await this.loadFromSupabase();
                    }, 500);
                } else {
                    // Fallback to localStorage
                    const localLoaded = this.loadFromLocalStorage();
                    if (localLoaded) {
                        this.updateSystemStatus(`‚úÖ ${this.state.employees.length} employees from local storage`);
                    } else {
                        this.updateSystemStatus('Ready - No data loaded');
                    }
                }
                
                this.renderLoginForm();
                
                // Update landing page stats
                this._updateLandingStats();
                
                // Add Enter key support ‚Äî detect which card the user is typing in
                document.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter' || this.state.activeView !== 'login') return;
                    const focused = document.activeElement;
                    if (focused) {
                        const id = focused.id;
                        if (id === 'empLoginId' || id === 'empLoginPwd') {
                            this.state.loginType = 'employee';
                        } else if (id === 'csLoginId' || id === 'csLoginPwd') {
                            this.state.loginType = 'corporatestaff';
                        } else if (id === 'plannerLoginPwd') {
                            this.state.loginType = 'planner';
                        } else if (id === 'gcLoginId' || id === 'gcLoginPwd') {
                            this.state.loginType = 'goldencommand';
                        }
                    }
                    this.handleLogin();
                });
                
                // Start live clock
                this._startClock();
                
                console.log('App ready');
            }
        };

        // ---- Multi-Week chip preview helpers (global, called from oninput) ----
        function _parseWeeksForPreview(raw, year) {
            const tokens = raw.split(/[\s,;]+/).filter(Boolean);
            const weeks = new Set();
            for (const t of tokens) {
                const m = t.match(/^(\d+)-(\d+)$/);
                if (m) { for (let w = Math.max(1, +m[1]); w <= Math.min(53, +m[2]); w++) weeks.add(w); }
                else { const n = +t; if (!isNaN(n) && n >= 1 && n <= 53) weeks.add(n); }
            }
            return [...weeks].sort((a, b) => a - b);
        }

        function _previewNewOcMultiChips() {
            const raw  = document.getElementById('newOcMultiWeekInput')?.value || '';
            const year = parseInt(document.getElementById('newOcMultiWeekYear')?.value) || (app.state?.biddingYear || new Date().getFullYear());
            const box  = document.getElementById('newOcMultiPreview');
            if (!box) return;
            const arr = _parseWeeksForPreview(raw, year);
            if (!arr.length) {
                box.innerHTML = '<span class="text-xs text-yellow-600 italic">Week chips appear here‚Ä¶</span>';
                return;
            }
            box.innerHTML = arr.map(w => {
                const r = app.weekNumberToDateRange(w, year);
                return `<span style="display:inline-flex;align-items:center;gap:4px;background:#fef3c7;border:1px solid #f59e0b;color:#92400e;font-size:0.7rem;font-weight:700;padding:2px 8px;border-radius:20px;margin:2px;">Wk ${w} <span style="opacity:.6;font-weight:400">${r.from}‚Üí${r.to}</span></span>`;
            }).join('');
        }

        function _previewOcMultiChips(empId) {
            const raw  = document.getElementById(`ocMultiWeekInput-${empId}`)?.value || '';
            const year = parseInt(document.getElementById(`ocMultiWeekYear-${empId}`)?.value) || (app.state?.biddingYear || new Date().getFullYear());
            const box  = document.getElementById(`ocMultiPreview-${empId}`);
            if (!box) return;
            const arr = _parseWeeksForPreview(raw, year);
            if (!arr.length) {
                box.innerHTML = '<span style="font-size:0.7rem;color:#93c5fd;font-style:italic;">Chips appear here‚Ä¶</span>';
                return;
            }
            box.innerHTML = arr.map(w => {
                const r = app.weekNumberToDateRange(w, year);
                return `<span style="display:inline-flex;align-items:center;gap:3px;background:#dbeafe;border:1px solid #3b82f6;color:#1e3a8a;font-size:0.68rem;font-weight:700;padding:2px 7px;border-radius:20px;margin:1px;">Wk ${w} <span style="opacity:.6;font-weight:400">${r.from}‚Üí${r.to}</span></span>`;
            }).join('');
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
    <!-- Email Notification Modal -->
    <div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:16px;padding:32px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:6px;">üìß Notify Staff ‚Äî Results Ready</h3>
            <p style="font-size:0.8rem;color:#6b7280;margin-bottom:20px;">Send an email to all staff notifying them their leave results are available. Requires EmailJS setup.</p>
            <div id="emailModalMsg"></div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:0.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">EmailJS Service ID</label>
                <input type="text" id="ejsServiceId" placeholder="service_xxxxxxx" style="width:100%;padding:9px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;" value="${localStorage.getItem('ejs_service')||''}" />
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:0.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">EmailJS Template ID</label>
                <input type="text" id="ejsTemplateId" placeholder="template_xxxxxxx" style="width:100%;padding:9px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;" value="${localStorage.getItem('ejs_template')||''}" />
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;font-size:0.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">EmailJS Public Key</label>
                <input type="text" id="ejsPublicKey" placeholder="xxxxxxxxxxxxxxxxx" style="width:100%;padding:9px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;" value="${localStorage.getItem('ejs_pubkey')||''}" />
            </div>
            <div style="margin-bottom:16px;padding:10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-size:0.75rem;color:#166534;">
                <strong>Template variables needed:</strong><br/>
                <code>{{to_email}}</code>, <code>{{to_name}}</code>, <code>{{employee_id}}</code>, <code>{{year}}</code>
            </div>
            <div id="emailProgress" style="display:none;margin-bottom:12px;">
                <div style="height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">
                    <div id="emailProgressBar" style="height:100%;background:#2d6a4f;border-radius:3px;width:0%;transition:width 0.3s;"></div>
                </div>
                <p id="emailProgressText" style="font-size:0.75rem;color:#6b7280;margin-top:4px;"></p>
            </div>
            <div style="display:flex;gap:10px;">
                <button onclick="app.sendResultsNotification()" style="flex:1;padding:11px;background:#2d6a4f;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">üì§ Send to All Staff</button>
                <button onclick="document.getElementById('emailModal').style.display='none'" style="flex:1;padding:11px;background:#f3f4f6;color:#374151;border:none;border-radius:10px;font-weight:600;cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

</body>
</html>
