<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Bidding System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .gradient-yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center fade-in">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                Annual Leave Bidding System
            </h1>
            <div id="userInfo" class="hidden flex justify-center items-center gap-4 mt-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow">
                    <span class="text-sm text-gray-600">Logged in as: </span>
                    <span id="currentUserName" class="font-semibold"></span>
                    <span id="userTypeBadge" class="ml-2 px-2 py-1 text-xs rounded"></span>
                </div>
                <button
                    onclick="handleLogout()"
                    class="px-4 py-2 gradient-red text-white rounded-lg hover:shadow-lg font-semibold transition-shadow"
                >
                    Logout
                </button>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="max-w-md mx-auto mt-10 fade-in">
            <div class="bg-white rounded-xl shadow-xl p-8">
                <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
                    Annual Leave Bidding System
                </h1>
                
                <div class="mb-4 text-center">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                        <p class="text-sm font-semibold text-blue-800">System Status:</p>
                        <p id="systemStatus" class="text-xs text-blue-700">Loading system data...</p>
                    </div>
                    
                    <button onclick="syncWithCloud()" class="px-4 py-2 gradient-green text-white rounded-lg hover:shadow-lg text-sm font-semibold mb-4">
                        üîÑ Sync with Cloud
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-3">Login As:</label>
                    <div class="flex gap-4">
                        <button
                            id="loginTypeEmployee"
                            onclick="setLoginType('employee')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold gradient-blue text-white"
                        >
                            Employee
                        </button>
                        <button
                            id="loginTypePlanner"
                            onclick="setLoginType('planner')"
                            class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300"
                        >
                            Planner
                        </button>
                    </div>
                </div>

                <div id="loginForm">
                    <!-- Login fields will be inserted here -->
                </div>

                <button
                    onclick="handleLogin()"
                    class="w-full mt-6 px-6 py-3 gradient-blue text-white rounded-lg hover:shadow-lg font-semibold transition-shadow"
                >
                    Login
                </button>
                
                <!-- Manual import for employees -->
                <div id="manualImportSection" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <p class="text-sm font-semibold text-yellow-800 mb-2">‚ö†Ô∏è No employee data found</p>
                    <button onclick="showManualImport()" class="w-full px-4 py-2 gradient-yellow text-white rounded text-sm font-semibold">
                        üì• Import Data Manually
                    </button>
                </div>
            </div>
        </div>

        <!-- Planner Navigation -->
        <div id="plannerNav" class="hidden flex justify-center space-x-4 mb-6 fade-in">
            <button onclick="setActiveView('upload')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Upload Data
            </button>
            <button onclick="setActiveView('configureSlots')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Configure Slots
            </button>
            <button onclick="setActiveView('admin')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Admin Panel
            </button>
            <button onclick="publishToCloud()" class="px-4 py-2 gradient-green text-white rounded-lg hover:shadow-lg font-semibold">
                üåê Publish Data
            </button>
            <button onclick="setActiveView('changePlannerPassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Change Password
            </button>
        </div>

        <!-- Employee Navigation -->
        <div id="employeeNav" class="hidden flex justify-center space-x-4 mb-6 fade-in">
            <button onclick="setActiveView('employee')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Place Bids
            </button>
            <button onclick="setActiveView('myResults')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                My Results
            </button>
            <button onclick="setActiveView('changePassword')" class="px-4 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100">
                Change Password
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea"></div>
        
        <!-- Manual Import Modal -->
        <div id="manualImportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full">
                <h3 class="text-xl font-bold mb-4">üì• Import System Data</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Ask the planner for the system data JSON and paste it below:
                </p>
                <textarea 
                    id="manualImportData" 
                    class="w-full h-48 p-3 border-2 border-gray-300 rounded-lg font-mono text-sm"
                    placeholder='Paste JSON data here...'
                ></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="processManualImport()" class="flex-1 px-4 py-2 gradient-blue text-white rounded-lg font-semibold">
                        Import
                    </button>
                    <button onclick="hideManualImport()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- XLSX for Excel processing -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // ==================== CLOUD CONFIGURATION ====================
        // Updated Gist URL format - CORRECTED
        const GIST_ID = '2f3f246ef97e1165830bf95529d01b78';
        const CLOUD_DATA_URL = `https://gist.githubusercontent.com/AboGhassan2/${GIST_ID}/raw/system_data.json`;
        
        // ==================== STATE MANAGEMENT ====================
        let state = {
            employees: [],
            employeePasswords: {},
            bids: [],
            biddingDeadline: '',
            biddingYear: 2026,
            isProcessed: false,
            activeView: 'login',
            selectedEmployeeId: '',
            verifiedEmployee: null,
            currentUser: null,
            userType: null,
            plannerPassword: 'admin123',
            results: [],
            selectedDepartment: 'all',
            slotCapacities: {},
            
            departments: [
                'L4/6-SA', 'L4/6-DEP-DM', 'L4/6-DEP-EFC', 'L3-DEP-DC', 'L3-DEP-TC',
                'L5-LSS/SS', 'L5-DEP-DC', 'L3465-DEP-TCC', 'L3-DEP-DM', 'L5-DEP-DM',
                'L46-DEP-TC', 'L3-DEP- LTSS/TSS', 'L5-DEP-GSM', 'L5-DEP-SC', 'L5-DEP- LTSS/TSS',
                'L3-DEP-EFC', 'L3-DEP-GSM', 'L46-TA-T', 'L46-DEP- LTSS/TSS', 'L3-TA-T',
                'L3-DS', 'L5-DEP-TC', 'L3-P&R', 'L5-DEP-EFC', 'L46-DEP-DC',
                'L3-LSS/SS', 'L3-DEP-SC', 'L46-LSS/SS', 'L46-DEP-GSM', 'L46-DEP-SC',
                'L46 SAMB', 'L5 SA', 'L3-SA', 'L3 SAMB', 'L5 - TA-T',
                'L46-P&R', 'L5 SAMB', 'L46-AOCC'
            ],
            
            slotTypes: [
                { id: 'slotA', name: 'Slot A', days: 15, color: 'green' },
                { id: 'slotB', name: 'Slot B', days: 15, color: 'blue' },
                { id: 'slotC', name: 'Slot C', days: 20, color: 'purple' }
            ],
            
            months: [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ],
            loginType: 'employee'
        };

        // ==================== UTILITY FUNCTIONS ====================
        function saveState() {
            localStorage.setItem('employees', JSON.stringify(state.employees));
            localStorage.setItem('employeePasswords', JSON.stringify(state.employeePasswords));
            localStorage.setItem('bids', JSON.stringify(state.bids));
            localStorage.setItem('biddingDeadline', state.biddingDeadline);
            localStorage.setItem('biddingYear', state.biddingYear.toString());
            localStorage.setItem('isProcessed', JSON.stringify(state.isProcessed));
            localStorage.setItem('plannerPassword', state.plannerPassword);
            localStorage.setItem('results', JSON.stringify(state.results));
            localStorage.setItem('slotCapacities', JSON.stringify(state.slotCapacities));
            console.log('üíæ State saved to localStorage');
        }

        function calculateYearsOfService(seniorityDate) {
            const today = new Date();
            const joinDate = new Date(seniorityDate);
            const years = (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
            return years;
        }

        function getEmployeeEntitlement(employee) {
            const yearsOfService = calculateYearsOfService(employee.seniorityDate);
            return yearsOfService >= 5 ? 35 : 30;
        }

        function calculateDaysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function checkDateOverlap(startDate1, endDate1, startDate2, endDate2) {
            const start1 = new Date(startDate1);
            const end1 = new Date(endDate1);
            const start2 = new Date(startDate2);
            const end2 = new Date(endDate2);
            
            return (start1 <= end2 && end1 >= start2);
        }

        function formatExcelDate(dateValue) {
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return jsDate;
            } else if (typeof dateValue === 'string') {
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } else if (dateValue instanceof Date) {
                return dateValue;
            }
            
            return new Date();
        }
        
        // ==================== IMPROVED CLOUD FUNCTIONS ====================
        async function syncWithCloud() {
            console.log('üîÑ Syncing with cloud...');
            updateSystemStatus('Syncing with cloud...');
            
            try {
                const success = await loadFromCloud();
                if (success) {
                    updateSystemStatus(`‚úÖ Synced! ${state.employees.length} employees loaded`);
                    renderView();
                    setTimeout(() => updateSystemStatus('Ready'), 2000);
                } else {
                    updateSystemStatus('‚ö†Ô∏è No cloud data found');
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSystemStatus('‚ùå Sync failed');
            }
        }
        
        async function loadFromCloud() {
            console.log('üåê Loading from cloud URL:', CLOUD_DATA_URL);
            
            try {
                // Add cache busting and timeout
                const timestamp = Date.now();
                const response = await fetch(`${CLOUD_DATA_URL}?t=${timestamp}`, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Cloud response not OK:', response.status);
                    return loadFromLocalStorage();
                }
                
                const cloudData = await response.json();
                console.log('üì• Cloud data received:', cloudData);
                
                if (!cloudData || !Array.isArray(cloudData.employees)) {
                    console.warn('‚ö†Ô∏è Invalid cloud data structure');
                    return loadFromLocalStorage();
                }
                
                // IMPORTANT: Only update state if cloud data is valid
                if (cloudData.employees && cloudData.employees.length > 0) {
                    state.employees = cloudData.employees || [];
                    state.employeePasswords = cloudData.employeePasswords || {};
                    state.bids = cloudData.bids || [];
                    state.biddingDeadline = cloudData.biddingDeadline || '';
                    state.biddingYear = cloudData.biddingYear || 2026;
                    state.isProcessed = cloudData.isProcessed || false;
                    state.plannerPassword = cloudData.plannerPassword || 'admin123';
                    state.results = cloudData.results || [];
                    state.slotCapacities = cloudData.slotCapacities || {};
                    
                    console.log(`‚úÖ Cloud data loaded: ${state.employees.length} employees`);
                    
                    // Save to localStorage as backup
                    saveState();
                    
                    return true;
                }
                
                return loadFromLocalStorage();
                
            } catch (error) {
                console.error('‚ùå Cloud load error:', error);
                return loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const savedEmployees = JSON.parse(localStorage.getItem('employees'));
                
                if (savedEmployees && Array.isArray(savedEmployees) && savedEmployees.length > 0) {
                    state.employees = savedEmployees;
                    state.employeePasswords = JSON.parse(localStorage.getItem('employeePasswords')) || {};
                    state.bids = JSON.parse(localStorage.getItem('bids')) || [];
                    state.biddingDeadline = localStorage.getItem('biddingDeadline') || '';
                    state.biddingYear = parseInt(localStorage.getItem('biddingYear')) || 2026;
                    state.isProcessed = JSON.parse(localStorage.getItem('isProcessed')) || false;
                    state.plannerPassword = localStorage.getItem('plannerPassword') || 'admin123';
                    state.results = JSON.parse(localStorage.getItem('results')) || [];
                    state.slotCapacities = JSON.parse(localStorage.getItem('slotCapacities')) || {};
                    
                    console.log(`üíæ Local data loaded: ${state.employees.length} employees`);
                    return true;
                }
            } catch (error) {
                console.error('LocalStorage error:', error);
            }
            return false;
        }
        
        function updateSystemStatus(message) {
            const statusElement = document.getElementById('systemStatus');
            if (statusElement) {
                statusElement.textContent = message;
                
                // Add color based on message
                if (message.includes('‚úÖ') || message.includes('Synced')) {
                    statusElement.className = 'text-xs text-green-700 font-semibold';
                } else if (message.includes('‚ö†Ô∏è') || message.includes('No data')) {
                    statusElement.className = 'text-xs text-yellow-700 font-semibold';
                } else if (message.includes('‚ùå') || message.includes('failed')) {
                    statusElement.className = 'text-xs text-red-700 font-semibold';
                } else {
                    statusElement.className = 'text-xs text-blue-700';
                }
            }
        }
        
        function publishToCloud() {
            const employeeCount = state.employees.length;
            
            if (employeeCount === 0) {
                alert('‚ö†Ô∏è No employee data to publish. Please upload data first.');
                return;
            }
            
            const message = `üåê PUBLISH SYSTEM DATA\n\n` +
                          `üìä Current Data Summary:\n` +
                          `‚Ä¢ Employees: ${employeeCount}\n` +
                          `‚Ä¢ Slot Configurations: ${Object.keys(state.slotCapacities).length}\n` +
                          `‚Ä¢ Bids: ${state.bids.length}\n` +
                          `‚Ä¢ Results: ${state.results.length}\n\n` +
                          `This will publish your system data to the cloud.`;
            
            if (confirm(message)) {
                saveToGist();
            }
        }
        
        async function saveToGist() {
            try {
                // Prepare system data
                const systemData = {
                    employees: state.employees,
                    employeePasswords: state.employeePasswords,
                    bids: state.bids,
                    biddingDeadline: state.biddingDeadline,
                    biddingYear: state.biddingYear,
                    isProcessed: state.isProcessed,
                    plannerPassword: state.plannerPassword,
                    results: state.results,
                    slotCapacities: state.slotCapacities,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(systemData, null, 2);
                
                // Create downloadable file
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `system_data_${state.biddingYear}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Instructions for planner
                alert(`‚úÖ System data ready for cloud publishing!\n\n` +
                      `1. A file named "system_data_${state.biddingYear}.json" has been downloaded\n` +
                      `2. Go to: https://gist.github.com/AboGhassan2/2f3f246ef97e1165830bf95529d01b78\n` +
                      `3. Click "Edit" on your Gist\n` +
                      `4. Delete existing content\n` +
                      `5. Upload/download the JSON file OR copy-paste the content\n` +
                      `6. Click "Update secret gist"\n\n` +
                      `After publishing, employees can sync to get latest data!`);
                
            } catch (error) {
                console.error('Publish error:', error);
                alert('Error publishing data. Please try again.');
            }
        }
        
        // ==================== MANUAL IMPORT FUNCTIONS ====================
        function showManualImport() {
            document.getElementById('manualImportModal').classList.remove('hidden');
        }
        
        function hideManualImport() {
            document.getElementById('manualImportModal').classList.add('hidden');
        }
        
        function processManualImport() {
            const jsonData = document.getElementById('manualImportData').value;
            
            if (!jsonData.trim()) {
                alert('Please paste JSON data');
                return;
            }
            
            try {
                const importedData = JSON.parse(jsonData);
                
                // Validate imported data
                if (!importedData.employees || !Array.isArray(importedData.employees)) {
                    alert('Invalid data format: Missing employees array');
                    return;
                }
                
                // Update state
                state.employees = importedData.employees || [];
                state.employeePasswords = importedData.employeePasswords || {};
                state.bids = importedData.bids || [];
                state.biddingDeadline = importedData.biddingDeadline || '';
                state.biddingYear = importedData.biddingYear || 2026;
                state.isProcessed = importedData.isProcessed || false;
                state.plannerPassword = importedData.plannerPassword || 'admin123';
                state.results = importedData.results || [];
                state.slotCapacities = importedData.slotCapacities || {};
                
                // Save to localStorage
                saveState();
                
                hideManualImport();
                updateSystemStatus(`‚úÖ Imported ${state.employees.length} employees`);
                
                // Refresh the view
                setTimeout(() => {
                    renderView();
                    alert(`Successfully imported ${state.employees.length} employees!`);
                }, 500);
                
            } catch (error) {
                alert('Invalid JSON data. Please check the format.');
                console.error('Import error:', error);
            }
        }
        
        // ==================== VIEW RENDERING ====================
        function renderView() {
            const contentArea = document.getElementById('contentArea');
            
            // Update system status
            if (state.employees.length > 0) {
                updateSystemStatus(`‚úÖ ${state.employees.length} employees loaded`);
                document.getElementById('manualImportSection').classList.add('hidden');
            } else {
                updateSystemStatus('‚ö†Ô∏è No employee data found');
                document.getElementById('manualImportSection').classList.remove('hidden');
            }
            
            switch(state.activeView) {
                case 'login':
                    renderLoginView();
                    break;
                case 'upload':
                    renderUploadView();
                    break;
                case 'configureSlots':
                    renderConfigureSlotsView();
                    break;
                case 'admin':
                    renderAdminView();
                    break;
                case 'employee':
                    renderEmployeeBiddingView();
                    break;
                case 'changePassword':
                    renderChangePasswordView();
                    break;
                case 'changePlannerPassword':
                    renderChangePlannerPasswordView();
                    break;
                case 'myResults':
                    renderMyResultsView();
                    break;
                case 'results':
                    renderResultsView();
                    break;
            }
            
            // Update navigation visibility
            document.getElementById('plannerNav').classList.toggle('hidden', state.userType !== 'planner');
            document.getElementById('employeeNav').classList.toggle('hidden', state.userType !== 'employee');
            document.getElementById('userInfo').classList.toggle('hidden', !state.currentUser);
            
            if (state.currentUser) {
                document.getElementById('currentUserName').textContent = state.currentUser.name;
                const badge = document.getElementById('userTypeBadge');
                badge.textContent = state.userType === 'planner' ? 'Planner' : 'Employee';
                badge.className = state.userType === 'planner' 
                    ? 'ml-2 px-2 py-1 text-xs rounded bg-purple-100 text-purple-800' 
                    : 'ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800';
            }
        }

        function renderLoginView() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('contentArea').innerHTML = '';
            
            const loginForm = document.getElementById('loginForm');
            if (state.loginType === 'planner') {
                loginForm.innerHTML = `
                    <div>
                        <label class="block font-semibold mb-2">Planner Password:</label>
                        <input
                            type="password"
                            id="loginPassword"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Enter planner password"
                        />
                        <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded">
                            <p class="text-sm font-semibold text-purple-800">üîë Default Planner Password:</p>
                            <p class="text-lg font-mono font-bold text-purple-900 mt-1">admin123</p>
                        </div>
                    </div>
                `;
            } else {
                loginForm.innerHTML = `
                    <div class="space-y-4">
                        ${state.employees.length === 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                                <span class="text-sm">No employee data loaded. Please sync with cloud or import data.</span>
                            </div>
                        ` : ''}
                        <div>
                            <label class="block font-semibold mb-2">Employee ID:</label>
                            <input
                                type="text"
                                id="loginId"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your ID"
                                ${state.employees.length === 0 ? 'disabled' : ''}
                            />
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Password:</label>
                            <input
                                type="password"
                                id="loginPassword"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="Enter your password"
                                ${state.employees.length === 0 ? 'disabled' : ''}
                            />
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm font-semibold text-blue-800">üìå Default Password:</p>
                                <p class="text-xs text-blue-700 mt-1">Your password is the same as your Employee ID</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add manual import button if no data
            if (state.employees.length === 0) {
                const importBtn = document.createElement('button');
                importBtn.onclick = showManualImport;
                importBtn.className = 'w-full mt-4 px-4 py-2 gradient-yellow text-white rounded-lg font-semibold';
                importBtn.textContent = 'üì• Import Data Manually';
                loginForm.appendChild(importBtn);
            }
        }

        // [Keep all the other render functions exactly as they were - renderUploadView, renderConfigureSlotsView, etc.]
        // I'm keeping the structure short here, but you should include ALL your existing render functions

        function renderUploadView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-2xl mx-auto text-center fade-in">
                    <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                        <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <label class="block font-semibold mb-2 text-lg">Select Bidding Year:</label>
                            <select
                                id="biddingYearSelect"
                                class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-semibold"
                                ${state.isProcessed || state.bids.length > 0 ? 'disabled' : ''}
                            >
                                ${[2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032].map(year => `
                                    <option value="${year}" ${year === state.biddingYear ? 'selected' : ''}>${year}</option>
                                `).join('')}
                            </select>
                            ${(state.isProcessed || state.bids.length > 0) ? `
                                <p class="text-xs text-red-600 mt-2 font-semibold">
                                    ‚ö†Ô∏è Year cannot be changed after bids have been placed or processed
                                </p>
                            ` : ''}
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-blue-800 mb-2">Leave Entitlement Rules:</h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Employees with 5+ years of service: <span class="font-bold">35 days</span></li>
                                <li>‚Ä¢ Employees with less than 5 years: <span class="font-bold">30 days</span></li>
                                <li>‚Ä¢ Each employee can place <span class="font-bold">2 bids</span> only</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-xl p-8">
                        <i data-lucide="upload" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                        <h2 class="text-2xl font-bold mb-4">Upload Employee Data</h2>
                        <p class="text-gray-600 mb-6">
                            Upload an Excel file with employee information
                        </p>
                        
                        <div
                            id="dropZone"
                            class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4 transition-colors hover:border-blue-500 hover:bg-blue-50"
                        >
                            <p class="mb-4 text-gray-600">
                                Drag and drop your Excel file here or click to browse
                            </p>
                            <label class="cursor-pointer">
                                <input
                                    type="file"
                                    id="excelFile"
                                    accept=".xlsx,.xls"
                                    class="hidden"
                                />
                                <span class="px-6 py-2 gradient-blue text-white rounded-lg hover:shadow-lg inline-block">
                                    Browse Files
                                </span>
                            </label>
                        </div>

                        ${state.employees.length > 0 ? `
                            <div class="mt-6">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <i data-lucide="check-circle" class="inline mr-2 text-green-600"></i>
                                    <span class="text-green-800 font-semibold">
                                        ‚úì ${state.employees.length} employees loaded for ${state.biddingYear}
                                    </span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            
            // Add event listeners
            document.getElementById('biddingYearSelect').addEventListener('change', (e) => {
                state.biddingYear = parseInt(e.target.value);
                renderView();
            });
            
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            
            // Add drag and drop functionality
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length) {
                    handleFileUpload({ target: { files: e.dataTransfer.files } });
                }
            });
        }

        // [Include ALL your other existing functions here exactly as they were:
        // renderConfigureSlotsView, renderEmployeeBiddingView, renderAdminView, 
        // renderResultsView, renderMyResultsView, renderChangePasswordView, 
        // renderChangePlannerPasswordView, setLoginType, handleLogin, handleLogout,
        // setActiveView, handleFileUpload, saveSlotConfiguration, setSelectedSlot,
        // updateSlotText, updateMonthText, updateEndDate, submitBid, removeBid,
        // changePassword, changePlannerPassword, processBids, exportResults, resetSystem]

        // ==================== EVENT HANDLERS ====================
        function setLoginType(type) {
            state.loginType = type;
            const employeeBtn = document.getElementById('loginTypeEmployee');
            const plannerBtn = document.getElementById('loginTypePlanner');
            
            if (type === 'employee') {
                employeeBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold gradient-blue text-white';
                plannerBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
            } else {
                employeeBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                plannerBtn.className = 'flex-1 px-4 py-3 rounded-lg font-semibold gradient-purple text-white';
            }
            
            renderLoginView();
        }

        function handleLogin() {
            if (state.loginType === 'planner') {
                const password = document.getElementById('loginPassword').value;
                if (password === state.plannerPassword) {
                    state.currentUser = { type: 'planner', name: 'Planner Admin' };
                    state.userType = 'planner';
                    state.activeView = 'upload';
                    alert('Welcome, Planner!');
                    renderView();
                } else {
                    alert('Incorrect planner password');
                }
            } else {
                const id = document.getElementById('loginId')?.value;
                const password = document.getElementById('loginPassword')?.value;
                
                if (!id || !password) {
                    alert('Please enter both ID and password');
                    return;
                }
                
                const employee = state.employees.find(emp => emp.id === id);
                if (!employee) {
                    alert('Employee ID not found');
                    return;
                }
                
                const storedPassword = state.employeePasswords[id] || id;
                if (password === storedPassword) {
                    state.currentUser = { type: 'employee', ...employee };
                    state.userType = 'employee';
                    state.verifiedEmployee = employee;
                    state.selectedEmployeeId = id;
                    state.activeView = 'employee';
                    alert(`Welcome, ${employee.name}!`);
                    renderView();
                } else {
                    alert('Incorrect password');
                }
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please upload a valid Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellText: false,
                        cellDates: true
                    });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        raw: false,
                        defval: ''
                    });

                    console.log('Processing Excel file...');

                    const employeeData = jsonData.map((row, index) => {
                        const id = String(
                            row['Personnel number'] || 
                            row['Personnel Number'] || 
                            row['Personnel_number'] ||
                            row['Personnelnumber'] ||
                            row['ID'] || 
                            row['id'] || 
                            row['EmployeeID'] || 
                            row['Employee ID'] || 
                            ''
                        );
                        
                        const forename = String(
                            row['Forename'] || 
                            row['forename'] ||
                            row['FORENAME'] ||
                            row['Name'] || 
                            row['name'] || 
                            row['First Name'] || 
                            row['EmployeeName'] || 
                            ''
                        );
                        
                        const surname = String(
                            row['Surname'] || 
                            row['surname'] ||
                            row['SURNAME'] ||
                            row['Last Name'] || 
                            row['LastName'] || 
                            ''
                        );
                        
                        const name = surname ? `${forename} ${surname}` : forename;
                        
                        const seniorityDate = row['Seniority Date'] || 
                            row['SeniorityDate'] || 
                            row['seniorityDate'] ||
                            row['Start of staff membership'] || 
                            row['Start_of_staff_membership'] ||
                            row['Start Date'] || 
                            row['start date'] ||
                            row['StartDate'] || 
                            row['Seniority'] ||
                            row['Joining Date'] ||
                            row['JoiningDate'] ||
                            row['Date of Joining'] ||
                            new Date();

                        const role = String(
                            row['Role'] ||
                            row['role'] ||
                            row['ROLE'] ||
                            row['Position'] ||
                            row['Job Title'] ||
                            row['Designation'] ||
                            row['Job title'] ||
                            ''
                        );

                        let department = '';
                        
                        // Check for "Scheduling row" column
                        if (row['Scheduling row'] || row['Scheduling_row'] || row['SchedulingRow']) {
                            const schedValue = String(row['Scheduling row'] || row['Scheduling_row'] || row['SchedulingRow'] || '');
                            if (schedValue.trim() !== '') {
                                department = schedValue.split('.')[0].trim();
                            }
                        }
                        
                        // Fallback: Try standard department columns
                        if (!department) {
                            const allKeys = Object.keys(row);
                            for (const key of allKeys) {
                                const value = row[key];
                                const lowerKey = key.toLowerCase();
                                
                                if (lowerKey === 'department' || 
                                    lowerKey === 'departments' ||
                                    lowerKey === 'dept') {
                                    
                                    if (value && String(value).trim() !== '') {
                                        department = String(value).trim();
                                        break;
                                    }
                                }
                            }
                        }

                        return {
                            id: id.trim(),
                            name: name.trim(),
                            seniorityDate: formatExcelDate(seniorityDate).toISOString(),
                            role: role.trim(),
                            department: department,
                            gender: String(row['Gender'] || row['gender'] || '').trim(),
                            nationality: String(row['Nationality'] || row['nationality'] || '').trim()
                        };
                    }).filter(emp => emp.id && emp.name);

                    employeeData.sort((a, b) => new Date(a.seniorityDate) - new Date(b.seniorityDate));
                    
                    state.employees = employeeData;
                    
                    // Initialize passwords for new employees
                    employeeData.forEach(emp => {
                        if (!state.employeePasswords[emp.id]) {
                            state.employeePasswords[emp.id] = emp.id;
                        }
                    });
                    
                    saveState();
                    renderView();
                    
                    alert(`Successfully loaded ${employeeData.length} employees`);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert('Error processing Excel file. Please check the format.');
                }
            };
            
            reader.onerror = () => {
                alert('Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            console.log('üöÄ Initializing system...');
            
            // Try to load from cloud first
            const cloudLoaded = await loadFromCloud();
            
            if (!cloudLoaded) {
                console.log('üì± Using local data only');
                updateSystemStatus('üì± Using local data');
            }
            
            // Render initial view
            renderView();
            
            // Add Enter key support for login
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && state.activeView === 'login') {
                    handleLogin();
                }
            });
            
            // Auto-sync every 30 seconds if logged in as employee
            setInterval(() => {
                if (state.userType === 'employee' && state.employees.length === 0) {
                    loadFromCloud();
                }
            }, 30000);
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
